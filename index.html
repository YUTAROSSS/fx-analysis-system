<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXé€šè²¨ãƒšã‚¢åˆ†æç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-primary: #4285f4;
            --accent-success: #28a745;
            --accent-warning: #ffc107;
            --accent-danger: #dc3545;
            --accent-info: #17a2b8;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #555555;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            background: var(--bg-primary);
            box-shadow: var(--shadow);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(180deg);
        }

        /* åŒæœŸçŠ¶æ…‹è¡¨ç¤º */
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
            max-width: 300px;
        }

        .sync-status.connected {
            background: var(--accent-success);
            color: white;
        }

        .sync-status.syncing {
            background: var(--accent-warning);
            color: #212529;
        }

        .sync-status.error {
            background: var(--accent-danger);
            color: white;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€š */
        .section {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-buttons {
            display: flex;
            gap: 8px;
        }

        .section-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn {
            background: var(--accent-success);
            color: white;
        }

        .delete-btn {
            background: var(--accent-danger);
            color: white;
        }

        .save-btn {
            background: var(--accent-primary);
            color: white;
        }

        /* é€šè²¨ãƒšã‚¢ã‚¿ãƒ– */
        .currency-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .currency-tabs {
                justify-content: flex-start;
            }
        }

        .currency-tab {
            padding: 8px 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-primary);
        }

        .currency-tab.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ */
        .scenario-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .scenario-buttons {
                justify-content: flex-start;
            }
        }

        .scenario-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .scenario-btn {
            padding: 8px 16px;
            border: 2px solid var(--accent-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 80px;
            font-weight: 600;
            background: var(--accent-primary);
            color: white;
        }

        .scenario-btn.active {
            box-shadow: 0 8px 16px rgba(66, 133, 244, 0.6);
            transform: translateY(-3px);
        }

        .status-label {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-considering { background: #007bff; color: white; }
        .status-skip { background: #6c757d; color: white; }
        .status-missed { background: #6c757d; color: white; }
        .status-pending { background: var(--accent-danger); color: white; }
        .status-holding { background: var(--accent-danger); color: white; }
        .status-completed { background: #6c757d; color: white; }

        /* é€šè²¨ãƒšã‚¢åè¡¨ç¤º */
        .currency-info {
            text-align: center;
            margin: 20px 0;
        }

        .currency-pair {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
        .chart-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .chart-container {
            width: 100%;
            max-width: 800px;
            height: 60vh;
            min-height: 400px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-primary);
        }

        .chart-container:hover {
            transform: scale(1.01);
            box-shadow: var(--shadow);
        }

        .chart-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .chart-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--bg-secondary) 25%, transparent 25%), 
                        linear-gradient(-45deg, var(--bg-secondary) 25%, transparent 25%);
            background-size: 20px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .chart-navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .return-btn {
            background: var(--accent-success);
        }

        .return-btn:hover {
            background: #218838;
        }

        /* åˆ†æã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .analysis-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .analysis-controls {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (min-width: 1024px) {
            .analysis-controls {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        .control-section {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .status-buttons, .wave-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        @media (min-width: 768px) {
            .status-buttons, .wave-buttons {
                grid-template-columns: 1fr;
            }
        }

        .status-btn, .wave-btn {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            text-align: center;
            font-weight: 600;
            color: var(--text-primary);
        }

        .status-btn.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        .wave-btn.unselected.active {
            border-color: #6c757d;
            background: #6c757d;
            color: white;
        }

        .wave-btn.wave-1h.active {
            border-color: #9acd32;
            background: #9acd32;
            color: white;
        }

        .wave-btn.wave-4h.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .wave-btn.wave-1d.active {
            border-color: var(--accent-danger);
            background: var(--accent-danger);
            color: white;
        }

        /* åˆ†æãƒ¡ãƒ¢ */
        .memo-area {
            grid-column: 1 / -1;
        }

        .analysis-memo {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: vertical;
            font-size: 12px;
            line-height: 1.4;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .analysis-memo:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        /* ChatGPTé€£æº */
        .chatgpt-section {
            background: #e8f4fd;
            border: 2px solid #007bff;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
        }

        [data-theme="dark"] .chatgpt-section {
            background: #1a2332;
            border-color: #4a90e2;
        }

        .chatgpt-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chatgpt-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .chatgpt-open-btn {
            background: var(--accent-success);
            color: white;
            font-size: 14px;
            padding: 10px 20px;
        }

        .copy-btn {
            background: #007bff;
            color: white;
        }

        .prompt-textarea, .copy-textarea {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: vertical;
            font-size: 12px;
            line-height: 1.4;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: monospace;
        }

        .copy-area {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .copy-area.active {
            display: block;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer {
            background: var(--bg-secondary);
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .page-info {
            color: var(--text-secondary);
            font-size: 12px;
            text-align: center;
        }

        .debug-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .debug-btn {
            padding: 5px 10px;
            font-size: 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .debug-save { background: #007bff; color: white; }
        .debug-check { background: var(--accent-success); color: white; }
        .debug-firebase { background: var(--accent-info); color: white; }
        .debug-reset { background: var(--accent-danger); color: white; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 95%;
            max-height: 95%;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .modal img {
            width: 100%;
            height: auto;
            display: block;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            z-index: 1001;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .management-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .management-modal.active {
            display: flex;
        }

        .management-modal-content {
            background: var(--bg-primary);
            padding: 25px;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .management-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .management-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .mgmt-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cancel-btn { background: #6c757d; color: white; }

        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drop-zone.dragover {
            border-color: var(--accent-primary);
            background: rgba(66, 133, 244, 0.1);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 767px) {
            .header h1 { font-size: 16px; }
            .main-content { padding: 15px; }
            .chart-container { height: 50vh; min-height: 300px; }
            .currency-pair { font-size: 22px; }
            .analysis-controls { grid-template-columns: 1fr; }
            .memo-area { grid-column: 1; }
            .chart-navigation { flex-direction: column; gap: 10px; }
            .nav-btn { width: 100%; }
            .section-buttons { flex-direction: column; gap: 5px; }
            .section-btn { width: 100%; }
            .scenario-item { flex-direction: column; align-items: flex-start; gap: 4px; }
            .debug-buttons { flex-direction: column; gap: 5px; }
            .debug-btn { width: 100%; }
            .chatgpt-controls { flex-direction: column; gap: 8px; }
            .chatgpt-btn { width: 100%; }
            .sync-status { position: relative; top: auto; right: auto; margin-bottom: 10px; max-width: 100%; }
        }
    </style>
</head>
<body>
    <!-- åŒæœŸçŠ¶æ…‹è¡¨ç¤º -->
    <div class="sync-status error" id="syncStatus">
        ğŸ”´ Supabaseæ¥ç¶šç¢ºèªä¸­...
    </div>

    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>ğŸ” FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">ğŸŒ™</span>
                </button>
                <button class="btn btn-secondary" onclick="shareAnalysis()">ğŸ“¤ å…±æœ‰</button>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content">
            <!-- é€šè²¨ãƒšã‚¢é¸æŠ -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">é€šè²¨ãƒšã‚¢é¸æŠ</div>
                    <div class="section-buttons">
                        <button class="section-btn add-btn" onclick="showAddCurrencyModal()">â• é€šè²¨ãƒšã‚¢è¿½åŠ </button>
                        <button class="section-btn delete-btn" onclick="showDeleteCurrencyModal()">ğŸ—‘ï¸ é€šè²¨ãƒšã‚¢å‰Šé™¤</button>
                    </div>
                </div>
                <div class="currency-tabs" id="currencyTabs">
                    <!-- JavaScript ã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>

            <!-- ã‚·ãƒŠãƒªã‚ªé¸æŠ -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">ã‚·ãƒŠãƒªã‚ªé¸æŠ</div>
                    <div class="section-buttons">
                        <button class="section-btn add-btn" onclick="showAddScenarioModal()">â• ã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
                        <button class="section-btn delete-btn" onclick="showDeleteScenarioModal()">ğŸ—‘ï¸ ã‚·ãƒŠãƒªã‚ªå‰Šé™¤</button>
                        <button class="section-btn save-btn" onclick="manualSave()">ğŸ’¾ æ‰‹å‹•ä¿å­˜</button>
                    </div>
                </div>
                <div class="scenario-buttons" id="scenarioButtons">
                    <!-- JavaScript ã§å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>

            <!-- é€šè²¨ãƒšã‚¢åè¡¨ç¤º -->
            <div class="currency-info">
                <div class="currency-pair" id="currentPair">USD/JPY</div>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
            <div class="chart-area">
                <div class="chart-container" onclick="openChartModal()">
                    <div class="chart-placeholder" id="chartDisplay">
                        ğŸ“ˆ USD/JPY ãƒãƒ£ãƒ¼ãƒˆ
                        <small style="margin-top: 10px; display: block;">
                            ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>
                            ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§è¡¨ç¤º
                        </small>
                    </div>
                    <img id="chartImage" class="chart-image" style="display: none;" alt="ãƒãƒ£ãƒ¼ãƒˆç”»åƒ">
                </div>
                
                <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <div class="chart-navigation">
                    <button class="nav-btn" onclick="previousScenario()" id="prevBtn">â† å‰ã®ã‚·ãƒŠãƒªã‚ª</button>
                    <button class="nav-btn" onclick="nextScenario()" id="nextBtn">æ¬¡ã®ã‚·ãƒŠãƒªã‚ª â†’</button>
                    <button class="nav-btn return-btn" onclick="returnToTop()">ğŸ  ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
                </div>
            </div>

            <!-- åˆ†æã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="analysis-controls">
                <!-- åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div class="control-section">
                    <div class="section-title">åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                    <div class="status-buttons">
                        <div class="status-btn active" onclick="setStatus(this, 'considering')">ğŸ¤” æ¤œè¨ä¸­</div>
                        <div class="status-btn" onclick="setStatus(this, 'skip')">â­ï¸ è¦‹é€ã‚Š</div>
                        <div class="status-btn" onclick="setStatus(this, 'missed')">ğŸ˜ è¦‹é€ƒã—</div>
                        <div class="status-btn" onclick="setStatus(this, 'pending')">ğŸ“‹ æŒ‡å€¤ä¸­</div>
                        <div class="status-btn" onclick="setStatus(this, 'holding')">ğŸ’¼ ä¿æŒä¸­</div>
                        <div class="status-btn" onclick="setStatus(this, 'completed')">âœ… å®Œäº†</div>
                    </div>
                </div>

                <!-- ç‹™ã†æ³¢ -->
                <div class="control-section">
                    <div class="section-title">ç‹™ã†æ³¢</div>
                    <div class="wave-buttons">
                        <div class="wave-btn unselected active" onclick="setWave(this, 'unselected')">æœªé¸æŠ</div>
                        <div class="wave-btn wave-1h" onclick="setWave(this, '1h')">1æ™‚é–“è¶³</div>
                        <div class="wave-btn wave-4h" onclick="setWave(this, '4h')">4æ™‚é–“è¶³</div>
                        <div class="wave-btn wave-1d" onclick="setWave(this, '1d')">æ—¥è¶³</div>
                    </div>
                </div>

                <!-- åˆ†æãƒ¡ãƒ¢ -->
                <div class="memo-area">
                    <div class="control-section">
                        <div class="section-title">ğŸ“ åˆ†æãƒ¡ãƒ¢</div>
                        <textarea class="analysis-memo" id="analysisMemo" placeholder="ã“ã®ã‚·ãƒŠãƒªã‚ªã®åˆ†æå†…å®¹ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„..." oninput="autoSaveMemo()"></textarea>
                    </div>
                </div>
            </div>

            <!-- ChatGPTé€£æº -->
            <div class="chatgpt-section">
                <div class="section-title">ğŸ¤– ChatGPTé€£æº</div>
                
                <!-- å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š:</label>
                    <textarea class="prompt-textarea" id="fixedPrompt" placeholder="ChatGPTã«é€ä¿¡ã™ã‚‹å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®š...">ã‚ãªãŸã¯çµŒé¨“è±Šå¯ŒãªFXãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ãƒãƒ£ãƒ¼ãƒˆåˆ†æãƒ‡ãƒ¼ã‚¿ã‚’è©•ä¾¡ã—ã€å®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ç‰¹ã«ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š
1. ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã®å¦¥å½“æ€§
2. ãƒªã‚¹ã‚¯ç®¡ç†ã®è¦³ç‚¹
3. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ»ã‚¨ã‚°ã‚¸ãƒƒãƒˆæˆ¦ç•¥
4. å¸‚å ´ç’°å¢ƒã¨ã®æ•´åˆæ€§

å…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</textarea>
                </div>

                <div class="chatgpt-controls">
                    <button class="chatgpt-btn chatgpt-open-btn" onclick="openChatGPT()">ğŸ¤– ChatGPTã‚’é–‹ã</button>
                    <button class="chatgpt-btn save-btn" onclick="saveFixedPrompt()">ğŸ’¾ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜</button>
                    <button class="chatgpt-btn" style="background: #6c757d;" onclick="resetFixedPrompt()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                    <button class="chatgpt-btn copy-btn" onclick="toggleCopyArea()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º</button>
                </div>

                <!-- ã‚³ãƒ”ãƒ¼ã‚¨ãƒªã‚¢ -->
                <div class="copy-area" id="copyArea">
                    <h4>ğŸ“‹ ChatGPTç”¨ãƒ†ã‚­ã‚¹ãƒˆ</h4>
                    <textarea class="copy-textarea" id="copyTextarea" readonly></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="chatgpt-btn copy-btn" onclick="copyAllText()">ğŸ“‹ å…¨æ–‡ã‚³ãƒ”ãƒ¼</button>
                        <button class="chatgpt-btn copy-btn" onclick="copyMemoOnly()">ğŸ“ ãƒ¡ãƒ¢ã®ã¿</button>
                        <button class="chatgpt-btn" style="background: #6c757d;" onclick="closeCopyArea()">âœ• é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="footer">
            <div class="page-info">
                é€šè²¨ãƒšã‚¢: <span id="currentCurrencyDisplay">USD/JPY</span> | 
                ã‚·ãƒŠãƒªã‚ª: <span id="currentScenarioDisplay">ã‚·ãƒŠãƒªã‚ª1</span> | 
                æœ€çµ‚æ›´æ–°: <span id="lastUpdateDisplay">2025-01-25 14:30</span>
            </div>
            
            <div class="debug-buttons">
                <button class="debug-btn debug-save" onclick="manualSave()">æ‰‹å‹•ä¿å­˜</button>
                <button class="debug-btn debug-check" onclick="checkDataIntegrity()">ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
                <button class="debug-btn debug-firebase" onclick="testSupabaseConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                <button class="debug-btn" style="background: #28a745;" onclick="createBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                <button class="debug-btn debug-reset" onclick="resetAllData()">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="chartModal">
        <div class="close-modal" onclick="closeChartModal()">Ã—</div>
        <div class="modal-content">
            <img id="modalChart" src="" alt="Chart">
        </div>
    </div>

    <!-- ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ -->
    <!-- é€šè²¨ãƒšã‚¢è¿½åŠ  -->
    <div class="management-modal" id="addCurrencyModal">
        <div class="management-modal-content">
            <h3>â• é€šè²¨ãƒšã‚¢è¿½åŠ </h3>
            <input type="text" id="newCurrencyCode" class="management-input" placeholder="é€šè²¨ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ (ä¾‹: EURJPY)">
            <input type="text" id="newCurrencyName" class="management-input" placeholder="è¡¨ç¤ºå (ä¾‹: EUR/JPY)">
            <div class="management-buttons">
                <button class="mgmt-btn cancel-btn" onclick="closeAddCurrencyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="mgmt-btn add-btn" onclick="addNewCurrency()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <!-- é€šè²¨ãƒšã‚¢å‰Šé™¤ -->
    <div class="management-modal" id="deleteCurrencyModal">
        <div class="management-modal-content">
            <h3>ğŸ—‘ï¸ é€šè²¨ãƒšã‚¢å‰Šé™¤</h3>
            <p style="color: var(--accent-danger); margin-bottom: 15px;">âš ï¸ å‰Šé™¤ã™ã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“</p>
            <select id="deleteCurrencySelect" class="management-input">
                <option value="">å‰Šé™¤ã™ã‚‹é€šè²¨ãƒšã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
            <div class="management-buttons">
                <button class="mgmt-btn cancel-btn" onclick="closeDeleteCurrencyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="mgmt-btn delete-btn" onclick="deleteCurrency()">å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <!-- ã‚·ãƒŠãƒªã‚ªè¿½åŠ  -->
    <div class="management-modal" id="addScenarioModal">
        <div class="management-modal-content">
            <h3>â• ã‚·ãƒŠãƒªã‚ªè¿½åŠ </h3>
            <input type="text" id="newScenarioLabel" class="management-input" placeholder="ã‚·ãƒŠãƒªã‚ªå (ä¾‹: ã‚·ãƒŠãƒªã‚ª5)">
            
            <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
            <div class="drop-zone" id="dropZone" onclick="document.getElementById('newScenarioImage').click()">
                <p>ğŸ“ ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                <small>å¯¾å¿œå½¢å¼: JPEG, PNG, WebP (æœ€å¤§10MB)</small>
            </div>
            <input type="file" id="newScenarioImage" style="display: none;" accept="image/*">
            
            <div id="imagePreview" style="display: none; margin: 10px 0;">
                <img id="previewImg" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                <p id="imageInfo" style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;"></p>
            </div>
            
            <div class="management-buttons">
                <button class="mgmt-btn cancel-btn" onclick="closeAddScenarioModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="mgmt-btn add-btn" onclick="addNewScenario()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <!-- ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ -->
    <div class="management-modal" id="deleteScenarioModal">
        <div class="management-modal-content">
            <h3>ğŸ—‘ï¸ ã‚·ãƒŠãƒªã‚ªå‰Šé™¤</h3>
            <p style="color: var(--accent-danger); margin-bottom: 15px;">âš ï¸ å‰Šé™¤ã™ã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“</p>
            <select id="deleteScenarioSelect" class="management-input">
                <option value="">å‰Šé™¤ã™ã‚‹ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
            <div class="management-buttons">
                <button class="mgmt-btn cancel-btn" onclick="closeDeleteScenarioModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="mgmt-btn delete-btn" onclick="deleteScenario()">å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://jfwvyuanautsybdjlah.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impmcnd5dW5hdWF0c3liZGxqbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTMxODksImV4cCI6MjA2OTA4OTE4OX0.cyhPTiN4WAQ2p86JBZObjSljt2i1K_bK-cGGo3soxAo';
        
        let supabase = null;
        let appData = {
            currencies: ['USDJPY', 'EURUSD', 'GBPUSD', 'AUDUSD', 'SILVER', 'GOLD'],
            currentCurrency: 'USDJPY',
            currentScenario: 'scenario1',
            scenarios: {
                'USDJPY': ['scenario1', 'scenario2', 'scenario3'],
                'EURUSD': ['scenario1', 'scenario2'],
                'GBPUSD': ['scenario1', 'scenario2', 'scenario3', 'scenario4'],
                'AUDUSD': ['scenario1', 'scenario2'],
                'SILVER': ['scenario1', 'scenario2'],
                'GOLD': ['scenario1']
            },
            scenarioLabels: {
                'scenario1': 'ã‚·ãƒŠãƒªã‚ª1',
                'scenario2': 'ã‚·ãƒŠãƒªã‚ª2',
                'scenario3': 'ã‚·ãƒŠãƒªã‚ª3',
                'scenario4': 'ã‚·ãƒŠãƒªã‚ª4'
            },
            scenarioMemos: {},
            scenarioStatuses: {},
            waveSettings: {},
            uploadedImages: {}
        };

        const currencyDisplayNames = {
            'USDJPY': 'USD/JPY',
            'EURUSD': 'EUR/USD',
            'GBPUSD': 'GBP/USD',
            'AUDUSD': 'AUD/USD',
            'SILVER': 'SILVER',
            'GOLD': 'GOLD'
        };

        let saveInProgress = false;
        let currentTheme = 'light';

        // SupabaseåˆæœŸåŒ–
        async function initializeSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase SDK not loaded');
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // æ¥ç¶šãƒ†ã‚¹ãƒˆ
                const { data, error } = await supabase.from('fx_analysis_data').select('id').limit(1);
                
                if (error) {
                    throw error;
                }
                
                updateSyncStatus('connected', 'ğŸŸ¢ Supabaseæ¥ç¶šæ¸ˆã¿');
                console.log('âœ… SupabaseåˆæœŸåŒ–æˆåŠŸ');
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                await loadData();
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸè¨­å®š
                setupRealtimeSync();
                
                return true;
            } catch (error) {
                console.error('âŒ SupabaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateSyncStatus('error', `âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ç¶™ç¶š
                loadLocalData();
                return false;
            }
        }

        // åŒæœŸçŠ¶æ…‹æ›´æ–°
        function updateSyncStatus(status, message) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.className = `sync-status ${status}`;
            statusElement.textContent = message;
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadData() {
            try {
                if (!supabase) {
                    loadLocalData();
                    return;
                }
                
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('*')
                    .eq('id', 'main')
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                if (data && data.data) {
                    appData = { ...appData, ...data.data };
                    if (data.images) {
                        appData.uploadedImages = data.images;
                    }
                    console.log('âœ… Supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ');
                } else {
                    console.log('â„¹ï¸ Supabaseã«ãƒ‡ãƒ¼ã‚¿ãªã— - åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨');
                }
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                localStorage.setItem('fx_analysis_data', JSON.stringify(appData));
                
            } catch (error) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                loadLocalData();
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadLocalData() {
            try {
                const savedData = localStorage.getItem('fx_analysis_data');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    appData = { ...appData, ...parsedData };
                    console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ');
                }
            } catch (error) {
                console.error('âŒ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function saveData() {
            if (saveInProgress) return;
            
            saveInProgress = true;
            
            try {
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('fx_analysis_data', JSON.stringify(appData));
                
                // Supabaseã«ä¿å­˜
                if (supabase) {
                    updateSyncStatus('syncing', 'ğŸ”„ åŒæœŸä¸­...');
                    
                    const savePayload = {
                        id: 'main',
                        data: appData,
                        images: appData.uploadedImages || {},
                        updated_at: new Date().toISOString()
                    };
                    
                    const { error } = await supabase
                        .from('fx_analysis_data')
                        .upsert(savePayload);
                    
                    if (error) {
                        throw error;
                    }
                    
                    updateSyncStatus('connected', 'âœ… åŒæœŸå®Œäº†');
                    console.log('âœ… ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ');
                }
                
            } catch (error) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                updateSyncStatus('error', 'âŒ åŒæœŸã‚¨ãƒ©ãƒ¼');
            } finally {
                saveInProgress = false;
            }
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
        function setupRealtimeSync() {
            if (!supabase) return;
            
            try {
                supabase
                    .channel('fx_analysis_changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'fx_analysis_data' },
                        (payload) => {
                            if (payload.new && payload.new.id === 'main' && payload.new.data) {
                                console.log('ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°å—ä¿¡');
                                appData = { ...appData, ...payload.new.data };
                                if (payload.new.images) {
                                    appData.uploadedImages = payload.new.images;
                                }
                                refreshAllUI();
                            }
                        }
                    )
                    .subscribe();
                    
                console.log('âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸè¨­å®šå®Œäº†');
            } catch (error) {
                console.error('âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // UIæ›´æ–°
        function refreshAllUI() {
            updateCurrencyTabs();
            updateScenarioButtons();
            updateDisplay();
            loadCurrentChart();
            generateChatGPTText();
            updatePageInfo();
        }

        // é€šè²¨ãƒšã‚¢ã‚¿ãƒ–æ›´æ–°
        function updateCurrencyTabs() {
            const container = document.getElementById('currencyTabs');
            container.innerHTML = '';
            
            appData.currencies.forEach(currency => {
                const tab = document.createElement('div');
                tab.className = 'currency-tab' + (currency === appData.currentCurrency ? ' active' : '');
                tab.textContent = currencyDisplayNames[currency] || currency;
                tab.onclick = () => selectCurrency(currency);
                container.appendChild(tab);
            });
        }

        // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³æ›´æ–°
        function updateScenarioButtons() {
            const container = document.getElementById('scenarioButtons');
            container.innerHTML = '';
            
            const scenarios = appData.scenarios[appData.currentCurrency] || [];
            scenarios.forEach(scenarioId => {
                const scenarioItem = document.createElement('div');
                scenarioItem.className = 'scenario-item';
                
                const btn = document.createElement('div');
                btn.className = 'scenario-btn' + (scenarioId === appData.currentScenario ? ' active' : '');
                btn.textContent = appData.scenarioLabels[scenarioId] || scenarioId;
                btn.onclick = () => selectScenario(scenarioId);
                
                const statusKey = `${appData.currentCurrency}_${scenarioId}`;
                const status = appData.scenarioStatuses[statusKey] || 'considering';
                const statusLabel = document.createElement('div');
                statusLabel.className = `status-label status-${status}`;
                statusLabel.textContent = getStatusText(status);
                
                scenarioItem.appendChild(btn);
                scenarioItem.appendChild(statusLabel);
                container.appendChild(scenarioItem);
            });
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
        function getStatusText(status) {
            const statusTexts = {
                'considering': 'ğŸ¤” æ¤œè¨ä¸­',
                'skip': 'â­ï¸ è¦‹é€ã‚Š',
                'missed': 'ğŸ˜ è¦‹é€ƒã—',
                'pending': 'ğŸ“‹ æŒ‡å€¤ä¸­',
                'holding': 'ğŸ’¼ ä¿æŒä¸­',
                'completed': 'âœ… å®Œäº†'
            };
            return statusTexts[status] || 'ğŸ¤” æ¤œè¨ä¸­';
        }

        // é€šè²¨ãƒšã‚¢é¸æŠ
        function selectCurrency(currency) {
            appData.currentCurrency = currency;
            appData.currentScenario = (appData.scenarios[currency] && appData.scenarios[currency][0]) || 'scenario1';
            
            refreshAllUI();
            saveData();
        }

        // ã‚·ãƒŠãƒªã‚ªé¸æŠ
        function selectScenario(scenarioId) {
            appData.currentScenario = scenarioId;
            
            updateScenarioButtons();
            updateDisplay();
            loadCurrentChart();
            generateChatGPTText();
            saveData();
        }

        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            // é€šè²¨ãƒšã‚¢åè¡¨ç¤º
            document.getElementById('currentPair').textContent = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
            
            // ãƒ•ãƒƒã‚¿ãƒ¼æƒ…å ±æ›´æ–°
            document.getElementById('currentCurrencyDisplay').textContent = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
            document.getElementById('currentScenarioDisplay').textContent = appData.scenarioLabels[appData.currentScenario] || appData.currentScenario;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³æ›´æ–°
            const scenarioKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            const currentStatus = appData.scenarioStatuses[scenarioKey] || 'considering';
            
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            
            const statusButtons = document.querySelectorAll('.status-btn');
            const statusMap = {
                'considering': 0, 'skip': 1, 'missed': 2,
                'pending': 3, 'holding': 4, 'completed': 5
            };
            
            const statusIndex = statusMap[currentStatus];
            if (statusButtons[statusIndex]) {
                statusButtons[statusIndex].classList.add('active');
            }
            
            // ç‹™ã†æ³¢ãƒœã‚¿ãƒ³æ›´æ–°
            const currentWave = appData.waveSettings[appData.currentCurrency] || 'unselected';
            
            document.querySelectorAll('.wave-btn').forEach(btn => btn.classList.remove('active'));
            
            const waveButtons = document.querySelectorAll('.wave-btn');
            const waveMap = {
                'unselected': 0, '1h': 1, '4h': 2, '1d': 3
            };
            
            const waveIndex = waveMap[currentWave];
            if (waveButtons[waveIndex]) {
                waveButtons[waveIndex].classList.add('active');
            }
            
            // åˆ†æãƒ¡ãƒ¢æ›´æ–°
            const memoKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            document.getElementById('analysisMemo').value = appData.scenarioMemos[memoKey] || '';
        }

        // ãƒãƒ£ãƒ¼ãƒˆç”»åƒèª­ã¿è¾¼ã¿
        function loadCurrentChart() {
            const scenarioKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒã‚’å„ªå…ˆ
            if (appData.uploadedImages && appData.uploadedImages[scenarioKey]) {
                displayImage(appData.uploadedImages[scenarioKey]);
                return;
            }
            
            // æ—¢å­˜ç”»åƒãƒ‘ã‚¹ã§æ¤œç´¢
            const imagePaths = [];
            
            if (appData.currentCurrency === 'USDJPY') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/USDJPY.jpeg');
                if (appData.currentScenario === 'scenario2') imagePaths.push('images/USDJPY2.jpeg');
                if (appData.currentScenario === 'scenario3') imagePaths.push('images/USDJPY3.jpeg');
            } else if (appData.currentCurrency === 'EURUSD') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/EURUSD.jpeg');
                if (appData.currentScenario === 'scenario2') imagePaths.push('images/EURUSD2.jpeg');
            } else if (appData.currentCurrency === 'GBPUSD') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/GBPUSD.jpeg');
                if (appData.currentScenario === 'scenario2') imagePaths.push('images/GBPUSD2.jpeg');
                if (appData.currentScenario === 'scenario3') imagePaths.push('images/GBPUSD3.jpeg');
                if (appData.currentScenario === 'scenario4') imagePaths.push('images/GBPUSD4.jpeg');
            } else if (appData.currentCurrency === 'AUDUSD') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/AUDUSD.jpeg');
                if (appData.currentScenario === 'scenario2') imagePaths.push('images/AUDUSD2.jpeg');
            } else if (appData.currentCurrency === 'SILVER') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/SILVER.jpeg');
                if (appData.currentScenario === 'scenario2') imagePaths.push('images/SILVER2.jpeg');
            } else if (appData.currentCurrency === 'GOLD') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/GOLD.png');
            }
            
            // æ±ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚è¿½åŠ 
            imagePaths.push(`images/${appData.currentCurrency}_${appData.currentScenario}.jpeg`);
            imagePaths.push(`images/${appData.currentCurrency}.jpeg`);
            imagePaths.push(`images/${appData.currentCurrency}.png`);
            
            tryLoadImage(imagePaths, 0);
        }

        function tryLoadImage(paths, index) {
            if (index >= paths.length) {
                showPlaceholder();
                return;
            }

            const img = new Image();
            img.onload = () => displayImage(paths[index]);
            img.onerror = () => tryLoadImage(paths, index + 1);
            img.src = paths[index];
        }

        function displayImage(src) {
            const chartImage = document.getElementById('chartImage');
            const placeholder = document.getElementById('chartDisplay');
            
            chartImage.src = src;
            chartImage.style.display = 'block';
            placeholder.style.display = 'none';
        }

        function showPlaceholder() {
            const chartImage = document.getElementById('chartImage');
            const placeholder = document.getElementById('chartDisplay');
            
            chartImage.style.display = 'none';
            placeholder.style.display = 'flex';
            
            const currencyName = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
            const scenarioName = appData.scenarioLabels[appData.currentScenario] || appData.currentScenario;
            
            placeholder.innerHTML = `
                ğŸ“ˆ ${currencyName} - ${scenarioName}
                <small style="margin-top: 10px; display: block;">
                    ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>
                    ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§è¡¨ç¤º
                </small>
            `;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
        function setStatus(element, status) {
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            
            const scenarioKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            appData.scenarioStatuses[scenarioKey] = status;
            
            updateScenarioButtons();
            generateChatGPTText();
            saveData();
        }

        // ç‹™ã†æ³¢è¨­å®š
        function setWave(element, wave) {
            document.querySelectorAll('.wave-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            
            appData.waveSettings[appData.currentCurrency] = wave;
            generateChatGPTText();
            saveData();
        }

        // åˆ†æãƒ¡ãƒ¢è‡ªå‹•ä¿å­˜
        function autoSaveMemo() {
            const memoKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            appData.scenarioMemos[memoKey] = document.getElementById('analysisMemo').value;
            
            generateChatGPTText();
            
            // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
            clearTimeout(window.memoSaveTimeout);
            window.memoSaveTimeout = setTimeout(saveData, 3000);
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        function previousScenario() {
            const scenarios = appData.scenarios[appData.currentCurrency] || [];
            const currentIndex = scenarios.indexOf(appData.currentScenario);
            
            if (currentIndex > 0) {
                selectScenario(scenarios[currentIndex - 1]);
            } else {
                // å‰ã®é€šè²¨ãƒšã‚¢ã®æœ€å¾Œã®ã‚·ãƒŠãƒªã‚ªã«ç§»å‹•
                const currencyIndex = appData.currencies.indexOf(appData.currentCurrency);
                if (currencyIndex > 0) {
                    const prevCurrency = appData.currencies[currencyIndex - 1];
                    const prevScenarios = appData.scenarios[prevCurrency] || [];
                    if (prevScenarios.length > 0) {
                        selectCurrency(prevCurrency);
                        selectScenario(prevScenarios[prevScenarios.length - 1]);
                    }
                }
            }
        }

        function nextScenario() {
            const scenarios = appData.scenarios[appData.currentCurrency] || [];
            const currentIndex = scenarios.indexOf(appData.currentScenario);
            
            if (currentIndex < scenarios.length - 1) {
                selectScenario(scenarios[currentIndex + 1]);
            } else {
                // æ¬¡ã®é€šè²¨ãƒšã‚¢ã®æœ€åˆã®ã‚·ãƒŠãƒªã‚ªã«ç§»å‹•
                const currencyIndex = appData.currencies.indexOf(appData.currentCurrency);
                if (currencyIndex < appData.currencies.length - 1) {
                    const nextCurrency = appData.currencies[currencyIndex + 1];
                    const nextScenarios = appData.scenarios[nextCurrency] || [];
                    if (nextScenarios.length > 0) {
                        selectCurrency(nextCurrency);
                        selectScenario(nextScenarios[0]);
                    }
                }
            }
        }

        function returnToTop() {
            appData.currentCurrency = 'USDJPY';
            appData.currentScenario = 'scenario1';
            
            refreshAllUI();
            saveData();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ChatGPTé€£æºæ©Ÿèƒ½
        function generateChatGPTText() {
            const currencyName = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
            const scenarioName = appData.scenarioLabels[appData.currentScenario] || appData.currentScenario;
            const memoKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            const statusKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            
            const memo = appData.scenarioMemos[memoKey] || '';
            const status = appData.scenarioStatuses[statusKey] || 'considering';
            const wave = appData.waveSettings[appData.currentCurrency] || 'unselected';
            
            const statusTexts = {
                'considering': 'ğŸ¤” æ¤œè¨ä¸­',
                'skip': 'â­ï¸ è¦‹é€ã‚Š',
                'missed': 'ğŸ˜ è¦‹é€ƒã—',
                'pending': 'ğŸ“‹ æŒ‡å€¤ä¸­',
                'holding': 'ğŸ’¼ ä¿æŒä¸­',
                'completed': 'âœ… å®Œäº†'
            };
            
            const waveTexts = {
                'unselected': 'æœªé¸æŠ',
                '1h': '1æ™‚é–“è¶³',
                '4h': '4æ™‚é–“è¶³',
                '1d': 'æ—¥è¶³'
            };
            
            const fixedPrompt = document.getElementById('fixedPrompt').value || '';
            
            const chatgptText = `${fixedPrompt}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š **åŸºæœ¬æƒ…å ±**
ãƒ»é€šè²¨ãƒšã‚¢: ${currencyName}
ãƒ»ã‚·ãƒŠãƒªã‚ª: ${scenarioName}
ãƒ»åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusTexts[status]}
ãƒ»ç‹™ã†æ³¢: ${waveTexts[wave]}
ãƒ»åˆ†ææ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}

ğŸ“ **åˆ†æãƒ¡ãƒ¢**
${memo || 'è¨˜è¼‰ãªã—'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**æ³¨æ„**: ã“ã®å¾Œã«ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã®ã§ã€ç”»åƒã¨åˆã‚ã›ã¦ç·åˆçš„ãªåˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;

            document.getElementById('copyTextarea').value = chatgptText;
        }

        function openChatGPT() {
            window.open('https://chat.openai.com/', '_blank');
        }

        function saveFixedPrompt() {
            const prompt = document.getElementById('fixedPrompt').value;
            localStorage.setItem('fx_fixed_prompt', prompt);
            alert('å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function resetFixedPrompt() {
            const defaultPrompt = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯ŒãªFXãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ãƒãƒ£ãƒ¼ãƒˆåˆ†æãƒ‡ãƒ¼ã‚¿ã‚’è©•ä¾¡ã—ã€å®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ç‰¹ã«ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š
1. ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã®å¦¥å½“æ€§
2. ãƒªã‚¹ã‚¯ç®¡ç†ã®è¦³ç‚¹
3. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ»ã‚¨ã‚°ã‚¸ãƒƒãƒˆæˆ¦ç•¥
4. å¸‚å ´ç’°å¢ƒã¨ã®æ•´åˆæ€§

å…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;
            
            document.getElementById('fixedPrompt').value = defaultPrompt;
            localStorage.removeItem('fx_fixed_prompt');
            generateChatGPTText();
            alert('å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }

        function toggleCopyArea() {
            const copyArea = document.getElementById('copyArea');
            if (copyArea.classList.contains('active')) {
                copyArea.classList.remove('active');
            } else {
                copyArea.classList.add('active');
                generateChatGPTText();
            }
        }

        function closeCopyArea() {
            document.getElementById('copyArea').classList.remove('active');
        }

        function copyAllText() {
            const textarea = document.getElementById('copyTextarea');
            textarea.select();
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert('å…¨æ–‡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(() => {
                document.execCommand('copy');
                alert('å…¨æ–‡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
        }

        function copyMemoOnly() {
            const memoKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            const memo = appData.scenarioMemos[memoKey] || 'è¨˜è¼‰ãªã—';
            
            navigator.clipboard.writeText(memo).then(() => {
                alert('åˆ†æãƒ¡ãƒ¢ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = memo;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('åˆ†æãƒ¡ãƒ¢ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
        }

        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('themeIcon').textContent = currentTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
            localStorage.setItem('theme', currentTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            currentTheme = savedTheme;
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('themeIcon').textContent = currentTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function setupImageUpload() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('newScenarioImage');
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageFile(e.target.files[0]);
                }
            });
        }

        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ10MBä»¥ä¸‹ï¼‰');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // ç”»åƒãƒªã‚µã‚¤ã‚º
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // æœ€å¤§ã‚µã‚¤ã‚ºã‚’è¨­å®š
                    const maxWidth = 1024;
                    const maxHeight = 768;
                    
                    let { width, height } = img;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // åœ§ç¸®ã—ã¦Base64ã«å¤‰æ›
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    document.getElementById('previewImg').src = compressedDataUrl;
                    document.getElementById('imageInfo').textContent = 
                        `å…ƒã‚µã‚¤ã‚º: ${img.width}Ã—${img.height} â†’ åœ§ç¸®å¾Œ: ${width}Ã—${height} (${Math.round(compressedDataUrl.length / 1024)}KB)`;
                    document.getElementById('imagePreview').style.display = 'block';
                    
                    // ä¸€æ™‚ä¿å­˜
                    window.tempImageData = compressedDataUrl;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ç®¡ç†
        function showAddCurrencyModal() {
            document.getElementById('addCurrencyModal').classList.add('active');
        }

        function closeAddCurrencyModal() {
            document.getElementById('addCurrencyModal').classList.remove('active');
            document.getElementById('newCurrencyCode').value = '';
            document.getElementById('newCurrencyName').value = '';
        }

        function addNewCurrency() {
            const code = document.getElementById('newCurrencyCode').value.trim().toUpperCase();
            const name = document.getElementById('newCurrencyName').value.trim();
            
            if (!code || !name) {
                alert('é€šè²¨ãƒšã‚¢ã‚³ãƒ¼ãƒ‰ã¨è¡¨ç¤ºåã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (appData.currencies.includes(code)) {
                alert('ã“ã®é€šè²¨ãƒšã‚¢ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
                return;
            }
            
            appData.currencies.push(code);
            currencyDisplayNames[code] = name;
            appData.scenarios[code] = ['scenario1'];
            
            updateCurrencyTabs();
            closeAddCurrencyModal();
            saveData();
            
            alert(`${name} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        function showDeleteCurrencyModal() {
            const select = document.getElementById('deleteCurrencySelect');
            select.innerHTML = '<option value="">å‰Šé™¤ã™ã‚‹é€šè²¨ãƒšã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            appData.currencies.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = currencyDisplayNames[currency] || currency;
                select.appendChild(option);
            });
            
            document.getElementById('deleteCurrencyModal').classList.add('active');
        }

        function closeDeleteCurrencyModal() {
            document.getElementById('deleteCurrencyModal').classList.remove('active');
        }

        function deleteCurrency() {
            const currency = document.getElementById('deleteCurrencySelect').value;
            if (!currency) {
                alert('å‰Šé™¤ã™ã‚‹é€šè²¨ãƒšã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (appData.currencies.length <= 1) {
                alert('æœ€å¾Œã®é€šè²¨ãƒšã‚¢ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
                return;
            }
            
            if (!confirm(`${currencyDisplayNames[currency]} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            const index = appData.currencies.indexOf(currency);
            if (index !== -1) {
                appData.currencies.splice(index, 1);
            }
            
            delete appData.scenarios[currency];
            delete currencyDisplayNames[currency];
            
            if (appData.currentCurrency === currency) {
                appData.currentCurrency = appData.currencies[0];
                appData.currentScenario = appData.scenarios[appData.currentCurrency][0] || 'scenario1';
            }
            
            refreshAllUI();
            closeDeleteCurrencyModal();
            saveData();
            
            alert('é€šè²¨ãƒšã‚¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        function showAddScenarioModal() {
            document.getElementById('addScenarioModal').classList.add('active');
            document.getElementById('imagePreview').style.display = 'none';
            window.tempImageData = null;
        }

        function closeAddScenarioModal() {
            document.getElementById('addScenarioModal').classList.remove('active');
            document.getElementById('newScenarioLabel').value = '';
            document.getElementById('newScenarioImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            window.tempImageData = null;
        }

        function addNewScenario() {
            const label = document.getElementById('newScenarioLabel').value.trim();
            
            if (!label) {
                alert('ã‚·ãƒŠãƒªã‚ªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const scenarioId = `scenario${Date.now()}`;
            
            appData.scenarioLabels[scenarioId] = label;
            
            if (!appData.scenarios[appData.currentCurrency]) {
                appData.scenarios[appData.currentCurrency] = [];
            }
            appData.scenarios[appData.currentCurrency].push(scenarioId);
            
            // ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ä¿å­˜
            if (window.tempImageData) {
                const scenarioKey = `${appData.currentCurrency}_${scenarioId}`;
                if (!appData.uploadedImages) {
                    appData.uploadedImages = {};
                }
                appData.uploadedImages[scenarioKey] = window.tempImageData;
            }
            
            updateScenarioButtons();
            closeAddScenarioModal();
            saveData();
            
            alert(`${label} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        function showDeleteScenarioModal() {
            const select = document.getElementById('deleteScenarioSelect');
            select.innerHTML = '<option value="">å‰Šé™¤ã™ã‚‹ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            const scenarios = appData.scenarios[appData.currentCurrency] || [];
            scenarios.forEach(scenarioId => {
                const option = document.createElement('option');
                option.value = scenarioId;
                option.textContent = appData.scenarioLabels[scenarioId] || scenarioId;
                select.appendChild(option);
            });
            
            document.getElementById('deleteScenarioModal').classList.add('active');
        }

        function closeDeleteScenarioModal() {
            document.getElementById('deleteScenarioModal').classList.remove('active');
        }

        function deleteScenario() {
            const scenarioId = document.getElementById('deleteScenarioSelect').value;
            if (!scenarioId) {
                alert('å‰Šé™¤ã™ã‚‹ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!confirm(`${appData.scenarioLabels[scenarioId]} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            const scenarios = appData.scenarios[appData.currentCurrency] || [];
            const index = scenarios.indexOf(scenarioId);
            if (index !== -1) {
                scenarios.splice(index, 1);
            }
            
            delete appData.scenarioLabels[scenarioId];
            const scenarioKey = `${appData.currentCurrency}_${scenarioId}`;
            delete appData.scenarioMemos[scenarioKey];
            delete appData.scenarioStatuses[scenarioKey];
            if (appData.uploadedImages) {
                delete appData.uploadedImages[scenarioKey];
            }
            
            if (appData.currentScenario === scenarioId) {
                appData.currentScenario = scenarios[0] || 'scenario1';
            }
            
            refreshAllUI();
            closeDeleteScenarioModal();
            saveData();
            
            alert('ã‚·ãƒŠãƒªã‚ªã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ãƒãƒ£ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
        function openChartModal() {
            const modal = document.getElementById('chartModal');
            modal.classList.add('active');
            
            const modalChart = document.getElementById('modalChart');
            const chartImage = document.getElementById('chartImage');
            
            if (chartImage.style.display !== 'none' && chartImage.src) {
                modalChart.src = chartImage.src;
            } else {
                const currencyName = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
                const scenarioName = appData.scenarioLabels[appData.currentScenario] || appData.currentScenario;
                
                modalChart.src = 'data:image/svg+xml;base64,' + btoa(`
                    <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                        <rect width="800" height="600" fill="#f8f9fa"/>
                        <text x="400" y="280" text-anchor="middle" font-size="24" fill="#6c757d">
                            ${currencyName} - ${scenarioName}
                        </text>
                        <text x="400" y="320" text-anchor="middle" font-size="16" fill="#6c757d">
                            ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
                        </text>
                    </svg>
                `);
            }
        }

        function closeChartModal() {
            document.getElementById('chartModal').classList.remove('active');
        }

        // ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
        async function manualSave() {
            try {
                await saveData();
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                alert(`ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function checkDataIntegrity() {
            console.log('=== ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ ===');
            console.log('appData:', appData);
            console.log('Supabaseæ¥ç¶šçŠ¶æ…‹:', !!supabase);
            console.log('currencyDisplayNames:', currencyDisplayNames);
            console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒæ•°:', Object.keys(appData.uploadedImages || {}).length);
            alert('ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        }

        async function testSupabaseConnection() {
            if (!supabase) {
                alert('SupabaseæœªåˆæœŸåŒ–');
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'ğŸ”„ æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
                
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                updateSyncStatus('connected', 'âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ');
                alert('Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼');
            } catch (error) {
                updateSyncStatus('error', `âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
                alert(`æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function createBackup() {
            const backupData = {
                appData: appData,
                backupDate: new Date().toISOString(),
                version: "1.0"
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `fx_analysis_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ');
        }

        function resetAllData() {
            if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem('fx_analysis_data');
                localStorage.removeItem('fx_fixed_prompt');
                localStorage.removeItem('theme');
                
                if (supabase) {
                    supabase.from('fx_analysis_data').delete().eq('id', 'main').then(() => {
                        location.reload();
                    });
                } else {
                    location.reload();
                }
            }
        }

        // å…±æœ‰æ©Ÿèƒ½
        function shareAnalysis() {
            const currencyName = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
            const scenarioName = appData.scenarioLabels[appData.currentScenario] || appData.currentScenario;
            const memoKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            const statusKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            
            const memo = appData.scenarioMemos[memoKey] || '';
            const status = appData.scenarioStatuses[statusKey] || 'considering';
            const wave = appData.waveSettings[appData.currentCurrency] || 'unselected';
            
            const statusTexts = {
                'considering': 'ğŸ¤” æ¤œè¨ä¸­',
                'skip': 'â­ï¸ è¦‹é€ã‚Š',
                'missed': 'ğŸ˜ è¦‹é€ƒã—',
                'pending': 'ğŸ“‹ æŒ‡å€¤ä¸­',
                'holding': 'ğŸ’¼ ä¿æŒä¸­',
                'completed': 'âœ… å®Œäº†'
            };
            
            const waveTexts = {
                'unselected': 'æœªé¸æŠ',
                '1h': '1æ™‚é–“è¶³',
                '4h': '4æ™‚é–“è¶³',
                '1d': 'æ—¥è¶³'
            };
            
            const shareText = `${currencyName} - ${scenarioName} åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusTexts[status]}
ç‹™ã†æ³¢: ${waveTexts[wave]}
åˆ†æãƒ¡ãƒ¢: ${memo}

#FXåˆ†æ #${currencyName.replace('/', '')}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `${currencyName} åˆ†æãƒ¬ãƒãƒ¼ãƒˆ`,
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText);
                alert('åˆ†æå†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }

        // ãƒšãƒ¼ã‚¸æƒ…å ±æ›´æ–°
        function updatePageInfo() {
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
            
            document.getElementById('lastUpdateDisplay').textContent = timeString;
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            
            // ãƒ†ãƒ¼ãƒèª­ã¿è¾¼ã¿
            loadTheme();
            
            // å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿
            const savedPrompt = localStorage.getItem('fx_fixed_prompt');
            if (savedPrompt) {
                document.getElementById('fixedPrompt').value = savedPrompt;
            }
            
            // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š
            setupImageUpload();
            
            // SupabaseåˆæœŸåŒ–
            await initializeSupabase();
            
            // UIåˆæœŸåŒ–
            refreshAllUI();
            updatePageInfo();
            
            // å®šæœŸæ›´æ–°
            setInterval(updatePageInfo, 60000);
            
            console.log('âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeChartModal();
            }
            if (e.target.classList.contains('management-modal')) {
                e.target.classList.remove('active');
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                previousScenario();
            } else if (e.key === 'ArrowRight') {
                nextScenario();
            } else if (e.key === 'Escape') {
                closeChartModal();
                document.querySelectorAll('.management-modal').forEach(modal => {
                    modal.classList.remove('active');
                });
                closeCopyArea();
            } else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                manualSave();
            }
        });

        window.addEventListener('beforeunload', function() {
            if (!saveInProgress) {
                localStorage.setItem('fx_analysis_data', JSON.stringify(appData));
            }
        });
    </script>
</body>
</html>
