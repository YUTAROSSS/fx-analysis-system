<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXé€šè²¨ãƒšã‚¢åˆ†æç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getDatabase, ref, set, get, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

      const firebaseConfig = {
        apiKey: "AIzaSyBMwI1i8DSnFYSBhz_zv80oGYaRmqvXEzA",
        authDomain: "fx-analysis-system.firebaseapp.com",
        databaseURL: "https://fx-analysis-system-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fx-analysis-system",
        storageBucket: "fx-analysis-system.firebasestorage.app",
        messagingSenderId: "286393020262",
        appId: "1:286393020262:web:eee0ede07040002b4762a7"
      };

      try {
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
        console.log('âœ… FirebaseåˆæœŸåŒ–æˆåŠŸ');
      } catch (error) {
        console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        window.firebaseApp = null;
        window.firebaseDatabase = null;
      }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
        .container { max-width: 1280px; margin: 0 auto; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        
        .main-content { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .section { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #e9ecef; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .section-title { font-size: 14px; font-weight: 600; color: #495057; }
        .mgmt-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; margin: 0 4px; }
        .add-btn { background: #28a745; color: white; }
        .delete-btn { background: #dc3545; color: white; }
        
        .currency-tabs { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .currency-tab { padding: 8px 16px; background: white; border: 2px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease; }
        .currency-tab.active { background: #4285f4; color: white; border-color: #4285f4; }
        
        .image-buttons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .scenario-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .image-btn { padding: 8px 16px !important; border: 2px solid #4285f4 !important; border-radius: 8px !important; cursor: pointer !important; font-size: 11px !important; text-align: center !important; min-width: 80px !important; font-weight: 600 !important; background: #4285f4 !important; color: white !important; transition: box-shadow 0.3s ease, transform 0.3s ease !important; }
        .image-btn.selected { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important; transform: translateY(-3px) !important; }
        .image-btn:hover { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important; transform: translateY(-1px) !important; }
        
        .status-label { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; white-space: nowrap; }
        .status-considering { background: #007bff; color: white; }
        .status-skip { background: #6c757d; color: white; }
        .status-missed { background: #6c757d; color: white; }
        .status-pending { background: #dc3545; color: white; }
        .status-holding { background: #dc3545; color: white; }
        .status-completed { background: #6c757d; color: white; }
        
        .sync-status { position: fixed; top: 10px; right: 20px; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 1000; }
        .sync-status.connected { background: #28a745; color: white; }
        .sync-status.disconnected { background: #dc3545; color: white; }
        .sync-status.syncing { background: #ffc107; color: #212529; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sync-status" id="syncStatus">æ¥ç¶šç¢ºèªä¸­...</div>
        
        <div class="header">
            <h1>ğŸ” FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
            <button class="btn" onclick="shareAnalysis()">ğŸ“¤ å…±æœ‰</button>
        </div>

        <div class="main-content">
            <!-- é€šè²¨ãƒšã‚¢é¸æŠ -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">é€šè²¨ãƒšã‚¢é¸æŠ</div>
                    <div>
                        <button class="mgmt-btn add-btn" onclick="showAddCurrencyModal()">â• é€šè²¨ãƒšã‚¢è¿½åŠ </button>
                        <button class="mgmt-btn delete-btn" onclick="showDeleteCurrencyModal()">ğŸ—‘ï¸ é€šè²¨ãƒšã‚¢å‰Šé™¤</button>
                    </div>
                </div>
                <div class="currency-tabs" id="currencyTabs"></div>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆé¸æŠ -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">ãƒãƒ£ãƒ¼ãƒˆé¸æŠ</div>
                    <div>
                        <button class="mgmt-btn add-btn" onclick="showAddImageModal()">â• ã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
                        <button class="mgmt-btn delete-btn" onclick="showDeleteImageModal()">ğŸ—‘ï¸ ã‚·ãƒŠãƒªã‚ªå‰Šé™¤</button>
                    </div>
                </div>
                <div class="image-buttons" id="imageButtons"></div>
            </div>
            
            <!-- ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">ğŸ”§ ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½</div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="mgmt-btn" style="background: #17a2b8; color: white;" onclick="testFirebaseConnection()">Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                    <button class="mgmt-btn" style="background: #28a745; color: white;" onclick="manualSave()">æ‰‹å‹•ä¿å­˜</button>
                    <button class="mgmt-btn" style="background: #6f42c1; color: white;" onclick="forceSyncData()">å¼·åˆ¶åŒæœŸ</button>
                    <button class="mgmt-btn" style="background: #dc3545; color: white;" onclick="resetAllData()">å®Œå…¨ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¤‰æ›´
        let appData = {
            currencies: {
                USDJPY: { 
                    pair: "USD/JPY", 
                    images: ["USDJPY.jpeg", "USDJPY2.jpeg", "USDJPY3.jpeg"],
                    labels: ["ã‚·ãƒŠãƒªã‚ª1", "ã‚·ãƒŠãƒªã‚ª2", "ã‚·ãƒŠãƒªã‚ª3"]
                },
                EURUSD: { 
                    pair: "EUR/USD", 
                    images: ["EURUSD.jpeg", "EURUSD2.jpeg"],
                    labels: ["ã‚·ãƒŠãƒªã‚ª1", "ã‚·ãƒŠãƒªã‚ª2"]
                },
                GBPUSD: { 
                    pair: "GBP/USD", 
                    images: ["GBPUSD.jpeg", "GBPUSD2.jpeg", "GBPUSD3.jpeg", "GBPUSD4.jpeg"],
                    labels: ["ã‚·ãƒŠãƒªã‚ª1", "ã‚·ãƒŠãƒªã‚ª2", "ã‚·ãƒŠãƒªã‚ª3", "ã‚·ãƒŠãƒªã‚ª4"]
                }
            },
            currentCurrency: "USDJPY",
            currentImage: "USDJPY.jpeg",
            lastUpdated: Date.now()
        };

        let isFirebaseConnected = false;

        function updateSyncStatus(status, message) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.textContent = message;
            statusDiv.className = `sync-status ${status}`;
            isFirebaseConnected = (status === 'connected');
        }

        // Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
        function testFirebaseConnection() {
            console.log('ğŸ”§ Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
            updateSyncStatus('syncing', 'ãƒ†ã‚¹ãƒˆä¸­...');
            
            if (!window.firebaseDatabase) {
                console.error('âŒ FirebaseæœªåˆæœŸåŒ–');
                updateSyncStatus('disconnected', 'FirebaseæœªåˆæœŸåŒ–');
                return;
            }

            const testRef = window.firebaseRef(window.firebaseDatabase, 'test');
            const testData = {
                message: "Hello Firebase",
                timestamp: Date.now()
            };

            window.firebaseSet(testRef, testData)
                .then(() => {
                    console.log('âœ… Firebaseæ›¸ãè¾¼ã¿æˆåŠŸ');
                    return window.firebaseGet(testRef);
                })
                .then(snapshot => {
                    if (snapshot.exists()) {
                        console.log('âœ… Firebaseèª­ã¿è¾¼ã¿æˆåŠŸ:', snapshot.val());
                        updateSyncStatus('connected', 'Firebaseæ¥ç¶šOK');
                    } else {
                        console.log('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—');
                        updateSyncStatus('disconnected', 'èª­ã¿è¾¼ã¿å¤±æ•—');
                    }
                })
                .catch(error => {
                    console.error('âŒ Firebaseæ“ä½œå¤±æ•—:', error);
                    updateSyncStatus('disconnected', 'æ¥ç¶šã‚¨ãƒ©ãƒ¼');
                });
        }

        // ã‚·ãƒ³ãƒ—ãƒ«ãªä¿å­˜é–¢æ•°
        function saveDataSync() {
            return new Promise((resolve, reject) => {
                console.log('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹...');
                updateSyncStatus('syncing', 'ä¿å­˜ä¸­...');

                const saveData = {
                    ...appData,
                    lastUpdated: Date.now()
                };

                // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
                try {
                    localStorage.setItem('fx_app_data', JSON.stringify(saveData));
                    console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å®Œäº†');
                } catch (error) {
                    console.error('âŒ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å¤±æ•—:', error);
                    updateSyncStatus('disconnected', 'ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å¤±æ•—');
                    reject(error);
                    return;
                }

                // Firebaseä¿å­˜
                if (window.firebaseDatabase) {
                    const dataRef = window.firebaseRef(window.firebaseDatabase, 'appData');
                    window.firebaseSet(dataRef, saveData)
                        .then(() => {
                            console.log('âœ… Firebaseä¿å­˜å®Œäº†');
                            updateSyncStatus('connected', 'ä¿å­˜å®Œäº†');
                            resolve();
                        })
                        .catch(error => {
                            console.error('âŒ Firebaseä¿å­˜å¤±æ•—:', error);
                            updateSyncStatus('disconnected', 'Firebaseä¿å­˜å¤±æ•—');
                            // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã¯æˆåŠŸã—ã¦ã„ã‚‹ã®ã§resolve
                            resolve();
                        });
                } else {
                    console.log('âš ï¸ Firebaseæœªæ¥ç¶š');
                    updateSyncStatus('disconnected', 'Firebaseæœªæ¥ç¶š');
                    resolve();
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadData() {
            console.log('ğŸ“– ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');
            
            if (window.firebaseDatabase) {
                const dataRef = window.firebaseRef(window.firebaseDatabase, 'appData');
                window.firebaseGet(dataRef)
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const firebaseData = snapshot.val();
                            const localData = getLocalData();
                            
                            // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
                            if (firebaseData.lastUpdated > localData.lastUpdated) {
                                console.log('ğŸ“¥ Firebaseãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨');
                                appData = firebaseData;
                            } else {
                                console.log('ğŸ“¥ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨');
                                appData = localData;
                            }
                            
                            updateSyncStatus('connected', 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
                        } else {
                            console.log('ğŸ“¥ Firebaseãƒ‡ãƒ¼ã‚¿ãªã—');
                            appData = getLocalData();
                            updateSyncStatus('disconnected', 'Firebaseãƒ‡ãƒ¼ã‚¿ãªã—');
                        }
                        updateUI();
                    })
                    .catch(error => {
                        console.error('âŒ Firebaseèª­ã¿è¾¼ã¿å¤±æ•—:', error);
                        appData = getLocalData();
                        updateSyncStatus('disconnected', 'Firebaseèª­ã¿è¾¼ã¿å¤±æ•—');
                        updateUI();
                    });
            } else {
                appData = getLocalData();
                updateSyncStatus('disconnected', 'FirebaseæœªåˆæœŸåŒ–');
                updateUI();
            }
        }

        function getLocalData() {
            const saved = localStorage.getItem('fx_app_data');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (error) {
                    console.error('âŒ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿è§£æå¤±æ•—:', error);
                }
            }
            return appData; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
        }

        function updateUI() {
            updateCurrencyTabs();
            updateImageButtons();
        }

        function updateCurrencyTabs() {
            const container = document.getElementById('currencyTabs');
            container.innerHTML = '';
            
            Object.keys(appData.currencies).forEach(currency => {
                const tab = document.createElement('div');
                tab.className = 'currency-tab' + (currency === appData.currentCurrency ? ' active' : '');
                tab.textContent = appData.currencies[currency].pair;
                tab.onclick = function() { 
                    appData.currentCurrency = currency;
                    appData.currentImage = appData.currencies[currency].images[0];
                    updateUI();
                    saveDataSync();
                };
                container.appendChild(tab);
            });
        }

        function updateImageButtons() {
            const container = document.getElementById('imageButtons');
            container.innerHTML = '';
            
            const currentData = appData.currencies[appData.currentCurrency];
            if (!currentData) return;
            
            currentData.images.forEach((image, index) => {
                const scenarioItem = document.createElement('div');
                scenarioItem.className = 'scenario-item';
                
                const btn = document.createElement('div');
                btn.className = 'image-btn';
                btn.textContent = currentData.labels[index] || `ã‚·ãƒŠãƒªã‚ª${index + 1}`;
                btn.onclick = function() { 
                    appData.currentImage = image;
                    updateImageButtons();
                    saveDataSync();
                };
                
                if (image === appData.currentImage) {
                    btn.classList.add('selected');
                }
                
                const statusLabel = document.createElement('div');
                statusLabel.className = 'status-label status-considering';
                statusLabel.textContent = 'ğŸ¤” æ¤œè¨ä¸­';
                
                scenarioItem.appendChild(btn);
                scenarioItem.appendChild(statusLabel);
                container.appendChild(scenarioItem);
            });
        }

        // æ‰‹å‹•ä¿å­˜
        function manualSave() {
            saveDataSync()
                .then(() => {
                    alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ä¿å­˜ã—ã¾ã—ãŸï¼');
                })
                .catch(error => {
                    alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                });
        }

        // å¼·åˆ¶åŒæœŸ
        function forceSyncData() {
            loadData();
            setTimeout(() => {
                saveDataSync();
            }, 1000);
        }

        // å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
        function resetAllData() {
            if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.clear();
                if (window.firebaseDatabase) {
                    const dataRef = window.firebaseRef(window.firebaseDatabase, 'appData');
                    window.firebaseSet(dataRef, null);
                }
                location.reload();
            }
        }

        // å…±æœ‰æ©Ÿèƒ½ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
        function shareAnalysis() {
            alert('å…±æœ‰æ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
        function showAddCurrencyModal() { alert('é€šè²¨ãƒšã‚¢è¿½åŠ ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        function showDeleteCurrencyModal() { alert('é€šè²¨ãƒšã‚¢å‰Šé™¤ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        function showAddImageModal() { alert('ã‚·ãƒŠãƒªã‚ªè¿½åŠ ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        function showDeleteImageModal() { alert('ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ï¼ˆé–‹ç™ºä¸­ï¼‰'); }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
            
            // Firebaseæ¥ç¶šç¢ºèª
            setTimeout(() => {
                testFirebaseConnection();
            }, 1000);
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            setTimeout(() => {
                loadData();
            }, 2000);
        });
    </script>
</body>
</html>
