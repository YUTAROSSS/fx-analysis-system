<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX通貨ペア分析システム</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background: #f5f5f5; 
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            min-height: 100vh; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .section { 
            padding: 20px; 
            border-bottom: 1px solid #ddd; 
        }
        
        .btn { 
            padding: 8px 15px; 
            margin: 3px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .btn-primary { 
            background: #007bff; 
            color: white; 
        }
        
        .btn-secondary { 
            background: #6c757d; 
            color: white; 
        }
        
        .btn-success { 
            background: #28a745; 
            color: white; 
        }
        
        .btn-danger { 
            background: #dc3545; 
            color: white; 
        }
        
        .btn.active { 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            transform: translateY(1px);
        }
        
        .image-area { 
            border: 2px dashed #ddd; 
            padding: 20px; 
            margin: 10px 0; 
            min-height: 200px; 
            text-align: center; 
            background: #fafafa; 
            border-radius: 5px; 
        }
        
        .image-area img { 
            max-width: 100%; 
            max-height: 300px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .image-area h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            resize: vertical; 
            font-family: inherit;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .scenario-item { 
            display: flex; 
            align-items: center; 
            margin: 5px 0; 
            padding: 5px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .scenario-status { 
            margin-left: 10px; 
            font-size: 12px; 
            color: #666; 
            padding: 2px 6px;
            background: #e9ecef;
            border-radius: 3px;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
            display: none;
        }
        
        #storage-history {
            max-height: 200px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        .history-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 3px;
            border-left: 3px solid #007bff;
            font-size: 12px;
        }
        
        .status-buttons, .wave-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 0;
            }
            
            .section {
                padding: 15px;
            }
            
            .btn {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .status-buttons, .wave-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .status-buttons .btn, .wave-buttons .btn {
                width: 200px;
                margin: 2px 0;
            }
        }
        
        .dark-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .dark-mode .container {
            background: #2d2d2d;
        }
        
        .dark-mode .section {
            border-color: #555;
        }
        
        .dark-mode .image-area {
            background: #3a3a3a;
            border-color: #555;
        }
        
        .dark-mode textarea {
            background: #3a3a3a;
            color: #e0e0e0;
            border-color: #555;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div>処理中...</div>
    </div>
    
    <div class="container">
        <!-- 1. ヘッダー -->
        <header style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; position: relative;">
            <h1 style="margin: 0; display: inline-block; font-size: 24px;">🔄 FX通貨ペア分析システム</h1>
            <div style="position: absolute; top: 20px; right: 20px;">
                <button onclick="createBackup()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">💾 バックアップ</button>
                <button onclick="toggleTheme()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" id="theme-btn">🌙</button>
            </div>
        </header>

        <!-- エラー・成功メッセージ -->
        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>

        <!-- 2. 通貨ペア部分 -->
        <div class="section">
            <h3>📈 通貨ペア選択</h3>
            <div id="currency-buttons">
                <button class="btn btn-primary active" onclick="selectCurrency('USDJPY')" data-currency="USDJPY">USDJPY</button>
                <button class="btn btn-primary" onclick="selectCurrency('EURUSD')" data-currency="EURUSD">EURUSD</button>
                <button class="btn btn-primary" onclick="selectCurrency('GBPUSD')" data-currency="GBPUSD">GBPUSD</button>
                <button class="btn btn-primary" onclick="selectCurrency('AUDUSD')" data-currency="AUDUSD">AUDUSD</button>
                <button class="btn btn-primary" onclick="selectCurrency('SILVER')" data-currency="SILVER">SILVER</button>
                <button class="btn btn-primary" onclick="selectCurrency('GOLD')" data-currency="GOLD">GOLD</button>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="addCurrency()" class="btn btn-success">➕ 通貨ペア追加</button>
                <button onclick="removeCurrency()" class="btn btn-danger">❌ 通貨ペア削除</button>
            </div>
        </div>

        <!-- 3. シナリオ部分 -->
        <div class="section">
            <h3>📊 シナリオ選択</h3>
            <div id="scenario-list">
                <div class="scenario-item">
                    <button class="btn btn-success active" onclick="selectScenario('scenario1')" data-scenario="scenario1">シナリオ1</button>
                    <span class="scenario-status" id="status-scenario1">🔍 検討中</span>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="addScenario()" class="btn btn-success">➕ シナリオ追加</button>
                <button onclick="deleteScenario()" class="btn btn-danger">❌ シナリオ削除</button>
            </div>
        </div>

        <!-- 4. 画像表示部分 -->
        <div class="section">
            <h2 id="currency-name" style="text-align: center; margin-bottom: 30px; color: #333; font-size: 28px;">USDJPY</h2>
            
            <div id="image1-area" class="image-area">
                <h4>📸 チャート画像1枚目</h4>
                <div id="image1-display">
                    <p style="color: #666; margin: 50px 0;">画像1が表示されます</p>
                </div>
            </div>
            
            <div id="image2-area" class="image-area">
                <h4>📸 チャート画像2枚目</h4>
                <div id="image2-display">
                    <p style="color: #666; margin: 50px 0;">画像2が表示されます（もしあれば）</p>
                </div>
            </div>
        </div>

        <!-- 5. ナビゲーション -->
        <div class="section" style="text-align: center; background: #f8f9fa;">
            <h3>🧭 ナビゲーション</h3>
            <button onclick="prevScenario()" class="btn btn-primary" style="margin: 0 10px;">← 前のシナリオ</button>
            <button onclick="nextScenario()" class="btn btn-primary" style="margin: 0 10px;">次のシナリオ →</button>
            <button onclick="topScenario()" class="btn btn-secondary" style="margin: 0 10px;">🔝 最初に戻る</button>
        </div>

        <!-- 6. 分析ステータス -->
        <div class="section">
            <h3>📋 分析ステータス</h3>
            <div class="status-buttons">
                <button class="btn active" onclick="setStatus('検討中')" style="background: #007bff; color: white;" id="status-検討中">🔍 検討中</button>
                <button class="btn" onclick="setStatus('見送り')" style="background: #6c757d; color: white;" id="status-見送り">🙅‍♂️ 見送り</button>
                <button class="btn" onclick="setStatus('見逃し')" style="background: #6c757d; color: white;" id="status-見逃し">😅 見逃し</button>
                <button class="btn" onclick="setStatus('指値逆指値中')" style="background: #dc3545; color: white;" id="status-指値逆指値中">🎯 指値逆指値中</button>
                <button class="btn" onclick="setStatus('保持中')" style="background: #dc3545; color: white;" id="status-保持中">💼 保持中</button>
                <button class="btn" onclick="setStatus('完了')" style="background: #28a745; color: white;" id="status-完了">✅ 完了</button>
            </div>
        </div>

        <!-- 7. 狙う波 -->
        <div class="section">
            <h3>🌊 狙う波</h3>
            <div class="wave-buttons">
                <button class="btn active" onclick="setWave('未選択')" style="background: #6c757d; color: white;" id="wave-未選択">未選択</button>
                <button class="btn" onclick="setWave('1時間足')" style="background: #28a745; color: white;" id="wave-1時間足">1時間足</button>
                <button class="btn" onclick="setWave('4時間足')" style="background: #007bff; color: white;" id="wave-4時間足">4時間足</button>
                <button class="btn" onclick="setWave('日足')" style="background: #dc3545; color: white;" id="wave-日足">日足</button>
            </div>
        </div>

        <!-- 8. メモ・ChatGPT部分 -->
        <div class="section">
            <div style="margin-bottom: 30px;">
                <h3>📝 分析メモ</h3>
                <textarea id="memo" rows="5" placeholder="分析メモを入力してください..." onchange="saveMemo()"></textarea>
                <button onclick="copyMemo()" class="btn btn-secondary" style="margin-top: 10px;">📋 メモをコピー</button>
            </div>
            
            <div>
                <h3>🤖 ChatGPT固定プロンプト</h3>
                <textarea id="prompt" rows="5" placeholder="ChatGPT用のプロンプトを入力してください..." onchange="savePrompt()"></textarea>
                <div style="margin-top: 10px;">
                    <button onclick="copyPrompt()" class="btn btn-secondary">📋 プロンプトコピー</button>
                    <button onclick="openChatGPT()" class="btn" style="background: #10a37f; color: white; margin-left: 10px;">🤖 CHATGPT分析</button>
                </div>
            </div>
        </div>

        <!-- 9. STORAGE履歴 -->
        <div class="section">
            <h3>📚 STORAGE履歴</h3>
            <div id="storage-history">
                <p style="color: #666; text-align: center; margin: 20px 0;">履歴を読み込み中...</p>
            </div>
            <button onclick="refreshHistory()" class="btn btn-secondary" style="margin-top: 10px;">🔄 履歴更新</button>
        </div>
    </div>

    <script>
        // グローバル変数
        let supabase;
        let currentCurrency = 'USDJPY';
        let currentScenario = 'scenario1';
        let isDarkMode = false;
        let mainData = {};

        // Supabase初期化
        function initSupabase() {
            try {
                const supabaseUrl = 'https://jfrwyunauatsybdljlah.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impmcnd5dW5hdWF0c3liZGxqbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTMxODksImV4cCI6MjA2OTA4OTE4OX0.cyhPTiN4WAQ2p86JBZObjSljt2i1K_bK-cGGo3soxAo';
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                console.log('Supabase initialized successfully');
                return true;
            } catch (error) {
                console.error('Supabase initialization error:', error);
                showError('データベース接続に失敗しました');
                return false;
            }
        }

        // 安全なDOM要素取得
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element not found: ${id}`);
                return null;
            }
            return element;
        }

        // 安全な処理実行
        async function safeExecute(fn, errorMessage = 'エラーが発生しました') {
            try {
                showLoading();
                const result = await fn();
                hideLoading();
                return result;
            } catch (error) {
                hideLoading();
                console.error('Safe execute error:', error);
                showError(errorMessage + ': ' + error.message);
                return null;
            }
        }

        // エラー対策済みデータ読み込み
        async function loadData(key) {
            try {
                console.log('Loading data for key:', key);
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('data')
                    .eq('id', key)
                    .maybeSingle();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Load error:', error);
                    return null;
                }
                
                const result = data?.data || null;
                console.log('Loaded data:', result);
                return result;
            } catch (err) {
                console.error('Load exception:', err);
                return null;
            }
        }

        // エラー対策済みデータ保存
        async function saveData(key, value) {
            try {
                console.log('Saving data for key:', key, 'value:', value);
                const { error } = await supabase
                    .from('fx_analysis_data')
                    .upsert([{
                        id: key,
                        data: value,
                        updated_at: new Date().toISOString()
                    }], {
                        onConflict: 'id',
                        ignoreDuplicates: false
                    });
                
                if (error) {
                    console.error('Save error:', error);
                    return false;
                }
                console.log('Data saved successfully');
                return true;
            } catch (err) {
                console.error('Save exception:', err);
                return false;
            }
        }

        // 初期化
        async function initialize() {
            console.log('Starting initialization...');
            
            if (!initSupabase()) {
                return;
            }

            await safeExecute(async () => {
                // メインデータ読み込み
                mainData = await loadData('main') || {
                    currencies: ['USDJPY', 'EURUSD', 'GBPUSD', 'AUDUSD', 'SILVER', 'GOLD'],
                    scenarios: {
                        USDJPY: ['scenario1'],
                        EURUSD: ['scenario1'],
                        GBPUSD: ['scenario1'],
                        AUDUSD: ['scenario1'],
                        SILVER: ['scenario1'],
                        GOLD: ['scenario1']
                    },
                    images: {},
                    scenarioNames: {},
                    fixedPrompt: 'FXチャート分析をお願いします。'
                };

                // 初期データ保存
                await saveData('main', mainData);

                // UI初期化
                updateCurrencyButtons();
                updateScenarioButtons();
                await loadCurrentData();
                
                // 固定プロンプト読み込み
                const promptElement = safeGetElement('prompt');
                if (promptElement && mainData.fixedPrompt) {
                    promptElement.value = mainData.fixedPrompt;
                }

                // 履歴更新
                await refreshHistory();

                showSuccess('システムが正常に初期化されました');
                console.log('Initialization completed');
            }, 'システムの初期化に失敗しました');
        }

        // 通貨ペア選択
        async function selectCurrency(currency) {
            if (currency === currentCurrency) return;
            
            await safeExecute(async () => {
                // 現在のデータを保存
                await saveCurrentData();
                
                // 通貨ペア切り替え
                currentCurrency = currency;
                
                // 最初のシナリオに切り替え
                const scenarios = mainData.scenarios[currency] || ['scenario1'];
                currentScenario = scenarios[0];
                
                // UI更新
                updateCurrencyButtons();
                updateScenarioButtons();
                await loadCurrentData();
                
                console.log('Currency switched to:', currency);
            }, '通貨ペアの切り替えに失敗しました');
        }

        // シナリオ選択
        async function selectScenario(scenario) {
            if (scenario === currentScenario) return;
            
            await safeExecute(async () => {
                // 現在のデータを保存
                await saveCurrentData();
                
                // シナリオ切り替え
                currentScenario = scenario;
                
                // UI更新
                updateScenarioButtons();
                await loadCurrentData();
                
                console.log('Scenario switched to:', scenario);
            }, 'シナリオの切り替えに失敗しました');
        }

        // 通貨ペアボタン更新
        function updateCurrencyButtons() {
            const buttons = document.querySelectorAll('#currency-buttons .btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.currency === currentCurrency) {
                    btn.classList.add('active');
                }
            });
            
            const nameElement = safeGetElement('currency-name');
            if (nameElement) {
                nameElement.textContent = currentCurrency;
            }
        }

        // シナリオボタン更新
        function updateScenarioButtons() {
            const scenarios = mainData.scenarios[currentCurrency] || ['scenario1'];
            const container = safeGetElement('scenario-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            scenarios.forEach(scenario => {
                const item = document.createElement('div');
                item.className = 'scenario-item';
                
                const button = document.createElement('button');
                button.className = 'btn btn-success';
                button.onclick = () => selectScenario(scenario);
                button.dataset.scenario = scenario;
                button.textContent = getScenarioName(scenario);
                
                if (scenario === currentScenario) {
                    button.classList.add('active');
                }
                
                const status = document.createElement('span');
                status.className = 'scenario-status';
                status.id = `status-${scenario}`;
                status.textContent = '🔍 検討中';
                
                item.appendChild(button);
                item.appendChild(status);
                container.appendChild(item);
            });
        }

        // 現在のデータ読み込み
        async function loadCurrentData() {
            try {
                console.log('Loading current data for:', currentCurrency, currentScenario);
                
                // 画像表示
                await displayImages();
                
                // ステータス読み込み
                const status = await loadData(`${currentCurrency}_${currentScenario}_status`) || '検討中';
                updateStatusButtons(status);
                updateScenarioStatus(currentScenario, status);
                
                // 波読み込み
                const wave = await loadData(`${currentCurrency}_${currentScenario}_wave`) || '未選択';
                updateWaveButtons(wave);
                
                // メモ読み込み
                const memo = await loadData(`${currentCurrency}_${currentScenario}_memo`) || '';
                const memoElement = safeGetElement('memo');
                if (memoElement) {
                    memoElement.value = memo;
                }
                
                console.log('Current data loaded successfully');
            } catch (error) {
                console.error('Load current data error:', error);
                showError('データの読み込みに失敗しました');
            }
        }

        // 現在のデータ保存
        async function saveCurrentData() {
            try {
                const memoElement = safeGetElement('memo');
                if (memoElement && memoElement.value.trim()) {
                    await saveData(`${currentCurrency}_${currentScenario}_memo`, memoElement.value);
                }
                console.log('Current data saved');
            } catch (error) {
                console.error('Save current data error:', error);
            }
        }

        // 画像表示
        async function displayImages() {
            const images = mainData.images?.[currentCurrency]?.[currentScenario] || [];
            
            const image1Display = safeGetElement('image1-display');
            const image2Display = safeGetElement('image2-display');
            
            if (image1Display) {
                if (images[0]) {
                    image1Display.innerHTML = `<img src="${images[0]}" alt="チャート画像1" onclick="openImageInNewTab('${images[0]}')">`;
                } else {
                    image1Display.innerHTML = '<p style="color: #666; margin: 50px 0;">画像1が表示されます</p>';
                }
            }
            
            if (image2Display) {
                if (images[1]) {
                    image2Display.innerHTML = `<img src="${images[1]}" alt="チャート画像2" onclick="openImageInNewTab('${images[1]}')">`;
                } else {
                    image2Display.innerHTML = '<p style="color: #666; margin: 50px 0;">画像2が表示されます（もしあれば）</p>';
                }
            }
        }

        // 画像を新しいタブで開く
        function openImageInNewTab(url) {
            window.open(url, '_blank');
        }

        // ステータス設定
        async function setStatus(status) {
            await safeExecute(async () => {
                await saveData(`${currentCurrency}_${currentScenario}_status`, status);
                updateStatusButtons(status);
                updateScenarioStatus(currentScenario, status);
                showSuccess(`ステータスを「${status}」に設定しました`);
            }, 'ステータスの設定に失敗しました');
        }

        // 波設定
        async function setWave(wave) {
            await safeExecute(async () => {
                await saveData(`${currentCurrency}_${currentScenario}_wave`, wave);
                updateWaveButtons(wave);
                showSuccess(`狙う波を「${wave}」に設定しました`);
            }, '狙う波の設定に失敗しました');
        }

        // ステータスボタン更新
        function updateStatusButtons(activeStatus) {
            const buttons = document.querySelectorAll('.status-buttons .btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeButton = safeGetElement(`status-${activeStatus}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // 波ボタン更新
        function updateWaveButtons(activeWave) {
            const buttons = document.querySelectorAll('.wave-buttons .btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeButton = safeGetElement(`wave-${activeWave}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // シナリオステータス更新
        function updateScenarioStatus(scenario, status) {
            const statusElement = safeGetElement(`status-${scenario}`);
            if (statusElement) {
                const icon = getStatusIcon(status);
                statusElement.textContent = `${icon} ${status}`;
            }
        }

        // ステータスアイコン取得
        function getStatusIcon(status) {
            const icons = {
                '検討中': '🔍',
                '見送り': '🙅‍♂️',
                '見逃し': '😅',
                '指値逆指値中': '🎯',
                '保持中': '💼',
                '完了': '✅'
            };
            return icons[status] || '🔍';
        }

        // シナリオ名取得
        function getScenarioName(scenario) {
            if (mainData.scenarioNames?.[currentCurrency]?.[scenario]) {
                return mainData.scenarioNames[currentCurrency][scenario];
            }
            return scenario.replace('scenario', 'シナリオ').replace('_', ' ');
        }

        // ナビゲーション機能
        function prevScenario() {
            const scenarios = mainData.scenarios[currentCurrency] || ['scenario1'];
            const currentIndex = scenarios.indexOf(currentScenario);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : scenarios.length - 1;
            selectScenario(scenarios[prevIndex]);
        }

        function nextScenario() {
            const scenarios = mainData.scenarios[currentCurrency] || ['scenario1'];
            const currentIndex = scenarios.indexOf(currentScenario);
            const nextIndex = currentIndex < scenarios.length - 1 ? currentIndex + 1 : 0;
            selectScenario(scenarios[nextIndex]);
        }

        function topScenario() {
            const scenarios = mainData.scenarios[currentCurrency] || ['scenario1'];
            selectScenario(scenarios[0]);
        }

        // シナリオ追加（安全なファイル選択）
        function addScenario() {
            const name = prompt('シナリオ名を入力してください:');
            if (!name || name.trim() === '') {
                showError('シナリオ名を入力してください');
                return;
            }
            
            // ユーザーアクティベーション確保
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.style.display = 'none';
            
            const handleFileSelect = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) {
                    showError('画像を選択してください');
                    return;
                }
                if (files.length > 2) {
                    showError('画像は最大2枚まで選択できます');
                    return;
                }
                
                document.body.removeChild(input);
                await uploadScenarioImages(name.trim(), files);
            };
            
            input.addEventListener('change', handleFileSelect, { once: true });
            document.body.appendChild(input);
            
            // 安全なクリック実行
            setTimeout(() => {
                input.click();
            }, 100);
        }

        // 安全な画像アップロード
        async function uploadScenarioImages(scenarioName, files) {
            return await safeExecute(async () => {
                const imageUrls = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `${Date.now()}_${i + 1}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                    
                    console.log('Uploading file:', fileName);
                    
                    const { data, error } = await supabase.storage
                        .from('fx-images')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) {
                        console.error('Upload error:', error);
                        continue;
                    }
                    
                    const { data: { publicUrl } } = supabase.storage
                        .from('fx-images')
                        .getPublicUrl(fileName);
                    
                    imageUrls.push(publicUrl);
                    console.log('Image uploaded:', publicUrl);
                }
                
                if (imageUrls.length === 0) {
                    throw new Error('画像のアップロードに失敗しました');
                }
                
                // メインデータ更新
                const scenarioId = `scenario_${Date.now()}`;
                
                if (!mainData.scenarios[currentCurrency]) {
                    mainData.scenarios[currentCurrency] = [];
                }
                mainData.scenarios[currentCurrency].push(scenarioId);
                
                if (!mainData.images[currentCurrency]) {
                    mainData.images[currentCurrency] = {};
                }
                mainData.images[currentCurrency][scenarioId] = imageUrls;
                
                if (!mainData.scenarioNames[currentCurrency]) {
                    mainData.scenarioNames[currentCurrency] = {};
                }
                mainData.scenarioNames[currentCurrency][scenarioId] = scenarioName;
                
                const success = await saveData('main', mainData);
                if (!success) {
                    throw new Error('データの保存に失敗しました');
                }
                
                // UI更新
                updateScenarioButtons();
                await selectScenario(scenarioId);
                
                showSuccess(`シナリオ「${scenarioName}」が追加されました`);
                console.log('Scenario added successfully');
                
            }, 'シナリオの追加に失敗しました');
        }

        // シナリオ削除
        async function deleteScenario() {
            const scenarios = mainData.scenarios[currentCurrency] || ['scenario1'];
            if (scenarios.length <= 1) {
                showError('最後のシナリオは削除できません');
                return;
            }
            
            const scenarioName = getScenarioName(currentScenario);
            if (!confirm(`シナリオ「${scenarioName}」を削除しますか？`)) {
                return;
            }
            
            await safeExecute(async () => {
                // シナリオをメインデータから削除
                mainData.scenarios[currentCurrency] = mainData.scenarios[currentCurrency].filter(s => s !== currentScenario);
                
                // 画像データ削除
                if (mainData.images[currentCurrency]) {
                    delete mainData.images[currentCurrency][currentScenario];
                }
                
                // シナリオ名削除
                if (mainData.scenarioNames[currentCurrency]) {
                    delete mainData.scenarioNames[currentCurrency][currentScenario];
                }
                
                // 関連データ削除
                await deleteScenarioData(currentScenario);
                
                // メインデータ保存
                await saveData('main', mainData);
                
                // 別のシナリオに切り替え
                const remainingScenarios = mainData.scenarios[currentCurrency];
                currentScenario = remainingScenarios[0];
                
                // UI更新
                updateScenarioButtons();
                await loadCurrentData();
                
                showSuccess(`シナリオ「${scenarioName}」が削除されました`);
                console.log('Scenario deleted successfully');
                
            }, 'シナリオの削除に失敗しました');
        }

        // シナリオデータ削除
        async function deleteScenarioData(scenario) {
            const keys = [
                `${currentCurrency}_${scenario}_status`,
                `${currentCurrency}_${scenario}_wave`,
                `${currentCurrency}_${scenario}_memo`
            ];
            
            for (const key of keys) {
                try {
                    await supabase.from('fx_analysis_data').delete().eq('id', key);
                } catch (error) {
                    console.error(`Delete error for ${key}:`, error);
                }
            }
        }

        // 通貨ペア追加
        async function addCurrency() {
            const currency = prompt('通貨ペア名を入力してください（例：EURJPY）:');
            if (!currency || currency.trim() === '') {
                showError('通貨ペア名を入力してください');
                return;
            }
            
            const normalizedCurrency = currency.trim().toUpperCase();
            if (!/^[A-Z]{6}$/.test(normalizedCurrency)) {
                showError('通貨ペア名は6文字の大文字英字で入力してください');
                return;
            }
            
            if (mainData.currencies.includes(normalizedCurrency)) {
                showError('この通貨ペアは既に存在します');
                return;
            }
            
            await safeExecute(async () => {
                mainData.currencies.push(normalizedCurrency);
                mainData.scenarios[normalizedCurrency] = ['scenario1'];
                mainData.images[normalizedCurrency] = {};
                mainData.scenarioNames[normalizedCurrency] = {};
                
                await saveData('main', mainData);
                
                // 通貨ペアボタンを動的に追加
                const container = safeGetElement('currency-buttons');
                if (container) {
                    const button = document.createElement('button');
                    button.className = 'btn btn-primary';
                    button.onclick = () => selectCurrency(normalizedCurrency);
                    button.dataset.currency = normalizedCurrency;
                    button.textContent = normalizedCurrency;
                    
                    // 追加・削除ボタンの前に挿入
                    const addButton = container.parentNode.querySelector('.btn-success');
                    container.appendChild(button);
                }
                
                showSuccess(`通貨ペア「${normalizedCurrency}」が追加されました`);
                console.log('Currency added successfully');
                
            }, '通貨ペアの追加に失敗しました');
        }

        // 通貨ペア削除
        async function removeCurrency() {
            if (mainData.currencies.length <= 1) {
                showError('最後の通貨ペアは削除できません');
                return;
            }
            
            if (!confirm(`通貨ペア「${currentCurrency}」を削除しますか？`)) {
                return;
            }
            
            await safeExecute(async () => {
                // 通貨ペアをメインデータから削除
                mainData.currencies = mainData.currencies.filter(c => c !== currentCurrency);
                delete mainData.scenarios[currentCurrency];
                delete mainData.images[currentCurrency];
                delete mainData.scenarioNames[currentCurrency];
                
                // 関連データ削除
                await deleteCurrencyData(currentCurrency);
                
                // メインデータ保存
                await saveData('main', mainData);
                
                // 別の通貨ペアに切り替え
                currentCurrency = mainData.currencies[0];
                currentScenario = mainData.scenarios[currentCurrency][0];
                
                // UI更新
                updateCurrencyButtons();
                updateScenarioButtons();
                await loadCurrentData();
                
                showSuccess('通貨ペアが削除されました');
                console.log('Currency removed successfully');
                
            }, '通貨ペアの削除に失敗しました');
        }

        // 通貨ペアデータ削除
        async function deleteCurrencyData(currency) {
            const scenarios = mainData.scenarios[currency] || [];
            const dataTypes = ['status', 'wave', 'memo'];
            
            for (const scenario of scenarios) {
                for (const type of dataTypes) {
                    const key = `${currency}_${scenario}_${type}`;
                    try {
                        await supabase.from('fx_analysis_data').delete().eq('id', key);
                    } catch (error) {
                        console.error(`Delete error for ${key}:`, error);
                    }
                }
            }
        }

        // メモ保存
        async function saveMemo() {
            const memoElement = safeGetElement('memo');
            if (memoElement) {
                await saveData(`${currentCurrency}_${currentScenario}_memo`, memoElement.value);
            }
        }

        // プロンプト保存
        async function savePrompt() {
            const promptElement = safeGetElement('prompt');
            if (promptElement) {
                mainData.fixedPrompt = promptElement.value;
                await saveData('main', mainData);
            }
        }

        // メモコピー
        async function copyMemo() {
            const memoElement = safeGetElement('memo');
            if (memoElement) {
                await copyToClipboard(memoElement.value);
                showSuccess('分析メモをコピーしました');
            }
        }

        // プロンプトコピー
        async function copyPrompt() {
            const promptElement = safeGetElement('prompt');
            if (promptElement) {
                await copyToClipboard(promptElement.value);
                showSuccess('固定プロンプトをコピーしました');
            }
        }

        // ChatGPT分析
        async function openChatGPT() {
            const memoElement = safeGetElement('memo');
            const promptElement = safeGetElement('prompt');
            
            const memo = memoElement ? memoElement.value : '';
            const prompt = promptElement ? promptElement.value : '';
            const combinedText = `${memo}\n\n${prompt}`;
            
            await copyToClipboard(combinedText);
            window.open('https://chat.openai.com', '_blank');
            showSuccess('分析データをクリップボードにコピーしてChatGPTを開きました');
        }

        // クリップボードにコピー
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
            } catch (err) {
                // フォールバック
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
        }

        // テーマ切り替え
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            const themeBtn = safeGetElement('theme-btn');
            if (themeBtn) {
                themeBtn.textContent = isDarkMode ? '☀️' : '🌙';
            }
        }

        // バックアップ作成
        async function createBackup() {
            await safeExecute(async () => {
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('*');
                
                if (error) throw error;
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    data: data
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fx_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('バックアップが作成されました');
                
            }, 'バックアップの作成に失敗しました');
        }

        // 履歴更新
        async function refreshHistory() {
            await safeExecute(async () => {
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('id, created_at, updated_at')
                    .order('updated_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                const historyContainer = safeGetElement('storage-history');
                if (!historyContainer) return;
                
                if (data.length === 0) {
                    historyContainer.innerHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">履歴がありません</p>';
                    return;
                }
                
                const historyHTML = data.map(item => `
                    <div class="history-item">
                        <strong>${item.id}</strong><br>
                        <small>更新: ${new Date(item.updated_at).toLocaleString('ja-JP')}</small>
                    </div>
                `).join('');
                
                historyContainer.innerHTML = historyHTML;
                console.log('History refreshed');
                
            }, '履歴の更新に失敗しました');
        }

        // UI表示関数
        function showLoading() {
            const loading = safeGetElement('loading');
            if (loading) {
                loading.style.display = 'block';
            }
        }

        function hideLoading() {
            const loading = safeGetElement('loading');
            if (loading) {
                loading.style.display = 'none';
            }
        }

        function showError(message) {
            console.error('Error:', message);
            const errorElement = safeGetElement('error-message');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        function showSuccess(message) {
            console.log('Success:', message);
            const successElement = safeGetElement('success-message');
            if (successElement) {
                successElement.textContent = message;
                successElement.style.display = 'block';
                setTimeout(() => {
                    successElement.style.display = 'none';
                }, 3000);
            }
        }

        // 初期化実行
        document.addEventListener('DOMContentLoaded', initialize);
        
        console.log('FX Analysis System loaded successfully');
    </script>
</body>
</html>
