<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXé€šè²¨ãƒšã‚¢åˆ†æç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

      const firebaseConfig = {
        apiKey: "AIzaSyBMwI1i8DSnFYSBhz_zv80oGYaRmqvXEzA",
        authDomain: "fx-analysis-system.firebaseapp.com",
        databaseURL: "https://fx-analysis-system-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fx-analysis-system",
        storageBucket: "fx-analysis-system.firebasestorage.app",
        messagingSenderId: "286393020262",
        appId: "1:286393020262:web:eee0ede07040002b4762a7"
      };

      try {
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        console.log('FirebaseåˆæœŸåŒ–æˆåŠŸ');
      } catch (error) {
        console.error('FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        window.firebaseApp = null;
        window.firebaseDatabase = null;
      }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
        .container { max-width: 1280px; margin: 0 auto; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .section { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #e9ecef; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .section-title { font-size: 14px; font-weight: 600; color: #495057; }
        .mgmt-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; margin: 0 4px; }
        .add-btn { background: #28a745; color: white; }
        .delete-btn { background: #dc3545; color: white; }
        
        /* é€šè²¨ãƒšã‚¢ã‚¿ãƒ– */
        .currency-tabs { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .currency-tab { padding: 8px 16px; background: white; border: 2px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease; }
        .currency-tab.active { background: #4285f4; color: white; border-color: #4285f4; }
        
        /* ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ - è‰²ã‚’å®Œå…¨å›ºå®š */
        .image-buttons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .scenario-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .image-btn { padding: 8px 16px !important; border: 2px solid #4285f4 !important; border-radius: 8px !important; cursor: pointer !important; font-size: 11px !important; text-align: center !important; min-width: 80px !important; font-weight: 600 !important; background: #4285f4 !important; color: white !important; transition: box-shadow 0.3s ease, transform 0.3s ease !important; }
        .image-btn, .image-btn:hover, .image-btn:focus, .image-btn:active, .image-btn.selected, .image-btn.active, .image-btn:visited, .image-btn:link, .image-btn[style] { background: #4285f4 !important; color: white !important; border-color: #4285f4 !important; }
        .image-btn.selected { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important; transform: translateY(-3px) !important; }
        .image-btn:hover { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important; transform: translateY(-1px) !important; }
        .image-btn.missing { background: #f8d7da !important; border-color: #dc3545 !important; color: #721c24 !important; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ©ãƒ™ãƒ« */
        .status-label { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; white-space: nowrap; }
        .status-considering { background: #007bff; color: white; }
        .status-skip { background: #6c757d; color: white; }
        .status-missed { background: #6c757d; color: white; }
        .status-pending { background: #dc3545; color: white; }
        .status-holding { background: #dc3545; color: white; }
        .status-completed { background: #6c757d; color: white; }
        
        /* é€šè²¨ãƒšã‚¢è¡¨ç¤º */
        .currency-info { text-align: center; margin: 20px 0; }
        .currency-pair { font-size: 28px; font-weight: 700; color: #2c3e50; }
        
        /* ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
        .chart-area { display: flex; flex-direction: column; align-items: center; margin: 20px 0; }
        .chart-container { width: 100%; max-width: 800px; height: 60vh; min-height: 400px; border: 2px solid #e9ecef; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; background: white; }
        .chart-container:hover { transform: scale(1.01); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .chart-image { width: 100%; height: 100%; object-fit: contain; display: block; }
        .chart-placeholder { width: 100%; height: 100%; background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%), linear-gradient(-45deg, #f8f9fa 25%, transparent 25%); background-size: 20px 20px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 16px; font-weight: 600; flex-direction: column; text-align: center; padding: 20px; }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .chart-navigation { display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .nav-btn { padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
        .nav-btn:hover { background: #3367d6; transform: translateY(-2px); }
        .nav-btn:disabled { background: #dee2e6; color: #6c757d; cursor: not-allowed; transform: none; }
        .return-btn { background: #28a745; }
        .return-btn:hover { background: #218838; }
        
        /* åˆ†æã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .analysis-controls { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .control-section { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #e9ecef; }
        .control-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .control-btn { padding: 10px 12px; border: 2px solid #dee2e6; background: white; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; text-align: center; font-weight: 600; }
        .control-btn.active { border-color: #4285f4; background: #4285f4; color: white; }
        .wave-btn.unselected.active { border-color: #6c757d; background: #6c757d; color: white; }
        .wave-btn.wave-1h.active { border-color: #9acd32; background: #9acd32; color: white; }
        .wave-btn.wave-4h.active { border-color: #007bff; background: #007bff; color: white; }
        .wave-btn.wave-1d.active { border-color: #dc3545; background: #dc3545; color: white; }
        
        /* ãƒ¡ãƒ¢ã‚¨ãƒªã‚¢ */
        .memo-area { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr; gap: 20px; }
        .analysis-memo { height: 200px; width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; resize: vertical; font-size: 12px; line-height: 1.4; background: white; }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ª */
        .scenario-add-section { background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .add-scenario-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-bottom: 15px; }
        .scenario-input { display: none; background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 15px; }
        .scenario-input input, .scenario-input textarea { width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 8px; font-size: 12px; }
        .scenario-input textarea { height: 60px; resize: vertical; }
        .scenario-input-buttons { display: flex; gap: 8px; }
        .scenario-input-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .scenario-save-btn { background: #007bff; color: white; }
        .scenario-cancel-btn { background: #6c757d; color: white; }
        .custom-scenario-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #28a745; position: relative; border: 1px solid #e9ecef; }
        .delete-scenario-btn { position: absolute; top: 8px; right: 8px; background: #dc3545; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 10px; cursor: pointer; }
        .scenario-title { font-weight: 600; color: #2c3e50; margin-bottom: 5px; font-size: 13px; }
        .scenario-desc { font-size: 12px; color: #6c757d; line-height: 1.4; }
        
        /* ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š */
        .prompt-settings { background: #e8f4fd; border: 2px solid #007bff; padding: 15px; border-radius: 12px; }
        .prompt-textarea { width: 100%; height: 180px; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; resize: vertical; font-size: 12px; line-height: 1.4; background: white; }
        .prompt-controls { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .prompt-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .save-prompt-btn { background: #007bff; color: white; }
        .reset-prompt-btn { background: #6c757d; color: white; }
        .chatgpt-btn { background: #28a745; color: white; font-size: 14px; font-weight: 600; padding: 10px 20px; }
        
        /* ã‚³ãƒ”ãƒ¼ã‚¨ãƒªã‚¢ */
        .copy-text-toggle { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; margin-top: 15px; width: 100%; transition: all 0.3s ease; }
        .copy-text-toggle:hover { background: #218838; }
        .copy-text-area { background: #f8f9fa; border: 2px solid #28a745; padding: 20px; margin-top: 15px; border-radius: 12px; display: none; }
        .copy-text-area.active { display: block; }
        .copy-textarea { width: 100%; height: 300px; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; resize: vertical; font-size: 12px; line-height: 1.4; background: white; font-family: monospace; }
        .copy-controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .copy-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.3s ease; }
        .copy-all-btn { background: #28a745; color: white; }
        .copy-memo-btn { background: #007bff; color: white; }
        .copy-scenarios-btn { background: #ffc107; color: #212529; }
        .close-copy-btn { background: #6c757d; color: white; }
        
        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer { background: #f8f9fa; padding: 15px 20px; border-top: 1px solid #e9ecef; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .page-info { color: #6c757d; font-size: 12px; text-align: center; }
        .usage-info { display: flex; flex-wrap: wrap; gap: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
        .usage-item { display: flex; flex-direction: column; align-items: center; min-width: 100px; }
        .usage-label { font-size: 10px; color: #6c757d; margin-bottom: 2px; }
        .usage-value { font-size: 12px; font-weight: 600; color: #2c3e50; }
        .usage-value.warning { color: #ffc107; }
        .usage-value.danger { color: #dc3545; }
        .debug-buttons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .debug-btn { padding: 5px 10px; font-size: 10px; border: none; border-radius: 3px; cursor: pointer; transition: all 0.3s ease; }
        .debug-save { background: #007bff; color: white; }
        .debug-check { background: #28a745; color: white; }
        .debug-reset { background: #dc3545; color: white; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; padding: 10px; }
        .modal.active { display: flex; }
        .modal-content { max-width: 95%; max-height: 95%; border-radius: 8px; overflow: hidden; background: white; }
        .modal img { width: 100%; height: auto; display: block; }
        .close-modal { position: absolute; top: 15px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 1001; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .management-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .management-modal.active { display: flex; }
        .management-modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .management-modal h3 { margin-bottom: 20px; color: #2c3e50; }
        .management-input { width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 15px; font-size: 14px; }
        .management-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .mgmt-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .add-currency-btn { background: #28a745; color: white; }
        .add-image-btn { background: #007bff; color: white; }
        .delete-currency-btn { background: #dc3545; color: white; }
        .auto-save-indicator { position: fixed; top: 20px; right: 20px; padding: 8px 12px; background: #28a745; color: white; border-radius: 6px; font-size: 12px; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; }
        .auto-save-indicator.show { opacity: 1; }
        .current-image-info { background: #f8f9fa; padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 11px; color: #495057; text-align: center; }
        .chart-info { margin-top: 15px; text-align: center; color: #6c757d; font-size: 12px; }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (min-width: 768px) {
            .currency-tabs, .image-buttons { justify-content: flex-start; }
            .control-buttons { grid-template-columns: 1fr; }
            .analysis-controls { grid-template-columns: 1fr 1fr; }
            .memo-area { grid-template-columns: 1fr 1fr 1fr; }
            .analysis-memo { height: 250px; font-size: 13px; }
            .chart-container { height: 500px; }
        }
        @media (min-width: 1024px) {
            .analysis-controls { grid-template-columns: 1fr 1fr 2fr; }
        }
        @media (max-width: 767px) {
            .header h1 { font-size: 16px; }
            .btn { font-size: 11px; padding: 5px 10px; }
            .main-content { padding: 15px; }
            .chart-container { height: 50vh; min-height: 300px; }
            .currency-pair { font-size: 22px; }
            .analysis-controls { grid-template-columns: 1fr; }
            .memo-area { grid-template-columns: 1fr; }
            .copy-controls, .prompt-controls { flex-direction: column; }
            .copy-btn, .prompt-btn { width: 100%; margin-bottom: 5px; }
            .chart-navigation { flex-direction: column; gap: 10px; }
            .nav-btn { width: 100%; justify-content: center; }
            .scenario-item { flex-direction: column; align-items: flex-start; gap: 4px; }
            .debug-buttons { flex-direction: column; gap: 5px; }
            .debug-btn { width: 100%; }
            .usage-info { flex-direction: column; gap: 8px; }
            .usage-item { flex-direction: row; justify-content: space-between; min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="auto-save-indicator" id="autoSaveIndicator">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ</div>

        <div class="header">
            <h1>ğŸ” FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
            <button class="btn" onclick="shareAnalysis()">ğŸ“¤ å…±æœ‰</button>
        </div>

        <div class="main-content">
            <!-- é€šè²¨ãƒšã‚¢é¸æŠ -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">é€šè²¨ãƒšã‚¢é¸æŠ</div>
                    <div>
                        <button class="mgmt-btn add-btn" onclick="showAddCurrencyModal()">â• é€šè²¨ãƒšã‚¢è¿½åŠ </button>
                        <button class="mgmt-btn delete-btn" onclick="showDeleteCurrencyModal()">ğŸ—‘ï¸ é€šè²¨ãƒšã‚¢å‰Šé™¤</button>
                    </div>
                </div>
                <div class="currency-tabs" id="currencyTabs"></div>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆé¸æŠ -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">ãƒãƒ£ãƒ¼ãƒˆé¸æŠ</div>
                    <div>
                        <button class="mgmt-btn add-btn" onclick="showAddImageModal()">â• ã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
                        <button class="mgmt-btn delete-btn" onclick="showDeleteImageModal()">ğŸ—‘ï¸ ã‚·ãƒŠãƒªã‚ªå‰Šé™¤</button>
                    </div>
                </div>
                <div class="image-buttons" id="imageButtons"></div>
            </div>

            <!-- é€šè²¨ãƒšã‚¢åè¡¨ç¤º -->
            <div class="currency-info">
                <div class="currency-pair" id="currentPair">USD/JPY</div>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
            <div class="chart-area">
                <div class="chart-container" onclick="openChartModal()">
                    <div class="chart-placeholder" id="chartDisplay">
                        ğŸ“ˆ USD/JPY ãƒãƒ£ãƒ¼ãƒˆ
                        <small style="margin-top: 10px; display: block;">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ãã ã•ã„<br>ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§è¡¨ç¤º</small>
                    </div>
                    <img id="chartImage" class="chart-image" style="display: none;" alt="ãƒãƒ£ãƒ¼ãƒˆç”»åƒ">
                </div>
                
                <div class="chart-navigation">
                    <button class="nav-btn" onclick="previousPage()" id="prevBtn" disabled>â† å‰ã®ãƒãƒ£ãƒ¼ãƒˆ</button>
                    <button class="nav-btn" onclick="nextPage()" id="nextBtn">æ¬¡ã®ãƒãƒ£ãƒ¼ãƒˆ â†’</button>
                    <button class="nav-btn return-btn" onclick="returnToTop()">ğŸ  ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
                </div>
                
                <div class="chart-info">
                    <strong>æ™‚é–“è»¸:</strong> <span id="timeframe">4æ™‚é–“è¶³</span> | 
                    <strong>æ›´æ–°:</strong> <span id="lastUpdate">2025-07-24 14:30</span>
                </div>
                <div class="current-image-info" id="currentImageInfo">ç¾åœ¨ã®ç”»åƒ: USDJPY.jpeg | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>

            <!-- åˆ†æã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
            <div class="analysis-controls">
                <!-- åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div class="control-section">
                    <div class="section-title">åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                    <div class="control-buttons">
                        <div class="control-btn active" onclick="setStatus(this, 'considering')">ğŸ¤” æ¤œè¨ä¸­</div>
                        <div class="control-btn" onclick="setStatus(this, 'skip')">â­ï¸ è¦‹é€ã‚Š</div>
                        <div class="control-btn" onclick="setStatus(this, 'missed')">ğŸ˜ è¦‹é€ƒã—</div>
                        <div class="control-btn" onclick="setStatus(this, 'pending')">ğŸ“‹ æŒ‡å€¤é€†æŒ‡å€¤ä¸­</div>
                        <div class="control-btn" onclick="setStatus(this, 'holding')">ğŸ’¼ ä¿æŒä¸­</div>
                        <div class="control-btn" onclick="setStatus(this, 'completed')">âœ… å®Œäº†</div>
                    </div>
                </div>

                <!-- ç‹™ã†æ³¢ -->
                <div class="control-section">
                    <div class="section-title">ç‹™ã†æ³¢</div>
                    <div class="control-buttons">
                        <div class="control-btn wave-btn unselected active" onclick="setWave(this, 'unselected')">æœªé¸æŠ</div>
                        <div class="control-btn wave-btn wave-1h" onclick="setWave(this, '1h')">1æ™‚é–“è¶³</div>
                        <div class="control-btn wave-btn wave-4h" onclick="setWave(this, '4h')">4æ™‚é–“è¶³</div>
                        <div class="control-btn wave-btn wave-1d" onclick="setWave(this, '1d')">æ—¥è¶³</div>
                    </div>
                </div>

                <!-- åˆ†æãƒ¡ãƒ¢ã€ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ªã€å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ -->
                <div class="memo-area">
                    <div class="control-section">
                        <div class="section-title">ğŸ“ åˆ†æãƒ¡ãƒ¢</div>
                        <textarea class="analysis-memo" id="analysisMemo" placeholder="è‡ªç”±ã«åˆ†æå†…å®¹ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„..."></textarea>
                    </div>

                    <div class="control-section">
                        <div class="section-title">ğŸ¯ ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ª</div>
                        <div class="scenario-add-section">
                            <button class="add-scenario-btn" onclick="showScenarioInput()">+ ã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
                            
                            <div class="scenario-input" id="scenarioInput">
                                <input type="text" id="scenarioTitle" placeholder="ã‚·ãƒŠãƒªã‚ªã‚¿ã‚¤ãƒˆãƒ«">
                                <textarea id="scenarioDesc" placeholder="ã‚·ãƒŠãƒªã‚ªã®è©³ç´°èª¬æ˜"></textarea>
                                <div class="scenario-input-buttons">
                                    <button class="scenario-input-btn scenario-save-btn" onclick="saveScenario()">ä¿å­˜</button>
                                    <button class="scenario-input-btn scenario-cancel-btn" onclick="hideScenarioInput()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                </div>
                            </div>
                            
                            <div id="customScenariosContainer"></div>
                        </div>
                    </div>

                    <!-- å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š -->
                    <div class="control-section">
                        <div class="section-title">ğŸ¤– ChatGPTå›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</div>
                        <div class="prompt-settings">
                            <textarea class="prompt-textarea" id="fixedPrompt" placeholder="ChatGPTã«é€ä¿¡ã™ã‚‹éš›ã®å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®šã—ã¦ãã ã•ã„...">ã‚ãªãŸã¯çµŒé¨“è±Šå¯ŒãªFXãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ãƒãƒ£ãƒ¼ãƒˆåˆ†æãƒ‡ãƒ¼ã‚¿ã‚’è©•ä¾¡ã—ã€å®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ç‰¹ã«ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š
1. ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã®å¦¥å½“æ€§
2. ãƒªã‚¹ã‚¯ç®¡ç†ã®è¦³ç‚¹
3. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ»ã‚¨ã‚°ã‚¸ãƒƒãƒˆæˆ¦ç•¥
4. å¸‚å ´ç’°å¢ƒã¨ã®æ•´åˆæ€§

å…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</textarea>
                            <div class="prompt-controls">
                                <button class="prompt-btn save-prompt-btn" onclick="saveFixedPrompt()">ğŸ’¾ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜</button>
                                <button class="prompt-btn reset-prompt-btn" onclick="resetFixedPrompt()">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                                <button class="prompt-btn chatgpt-btn" onclick="sendToChatGPTBrowser()">ğŸ¤– ChatGPTåˆ†æ</button>
                            </div>
                            
                            <button class="copy-text-toggle" onclick="toggleCopyTextArea()">ğŸ“‹ ChatGPTç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º/éè¡¨ç¤º</button>
                            
                            <div class="copy-text-area" id="copyTextArea">
                                <h3>ğŸ“‹ ChatGPTç”¨ãƒ†ã‚­ã‚¹ãƒˆ</h3>
                                <p style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ChatGPTã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</p>
                                <textarea class="copy-textarea" id="copyTextarea" readonly></textarea>
                                <div class="copy-controls">
                                    <button class="copy-btn copy-all-btn" onclick="copyAllText()">ğŸ“‹ å…¨æ–‡ã‚³ãƒ”ãƒ¼</button>
                                    <button class="copy-btn copy-memo-btn" onclick="copyMemoOnly()">ğŸ“ åˆ†æãƒ¡ãƒ¢ã®ã¿ã‚³ãƒ”ãƒ¼</button>
                                    <button class="copy-btn copy-scenarios-btn" onclick="copyScenariosOnly()">ğŸ¯ ã‚·ãƒŠãƒªã‚ªã®ã¿ã‚³ãƒ”ãƒ¼</button>
                                    <button class="copy-btn close-copy-btn" onclick="closeCopyArea()">âœ• é–‰ã˜ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="footer">
            <div class="page-info">
                ãƒšãƒ¼ã‚¸ <span id="currentPage">1</span> / <span id="totalPages">14</span> | 
                æœ€çµ‚æ›´æ–°: <span id="footerUpdate">2025-07-24 14:30</span>
            </div>
            
            <div class="usage-info">
                <div class="usage-item">
                    <span class="usage-label">ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨é‡:</span>
                    <span id="dataUsage" class="usage-value">è¨ˆç®—ä¸­...</span>
                </div>
                <div class="usage-item">
                    <span class="usage-label">ç”»åƒæ•°:</span>
                    <span id="imageCount" class="usage-value">0æš</span>
                </div>
                <div class="usage-item">
                    <span class="usage-label">Firebaseä½¿ç”¨ç‡:</span>
                    <span id="firebaseUsage" class="usage-value">0%</span>
                </div>
            </div>
            
            <div class="debug-buttons">
                <button class="debug-btn debug-save" onclick="manualSave()">æ‰‹å‹•ä¿å­˜</button>
                <button class="debug-btn debug-check" onclick="checkDataIntegrity()">ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
                <button class="debug-btn" style="background: #17a2b8; color: white;" onclick="showDetailedUsage()">è©³ç´°ä½¿ç”¨é‡</button>
                <button class="debug-btn" style="background: #ffc107; color: #212529;" onclick="showCleanupModal()">ãƒ‡ãƒ¼ã‚¿æ•´ç†</button>
                <button class="debug-btn debug-reset" onclick="resetAllData()">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ -->
    <div class="modal" id="chartModal">
        <div class="close-modal" onclick="closeChartModal()">Ã—</div>
        <div class="modal-content"><img id="modalChart" src="" alt="Chart"></div>
    </div>

    <div class="management-modal" id="addCurrencyModal">
        <div class="management-modal-content">
            <h3>â• é€šè²¨ãƒšã‚¢è¿½åŠ </h3>
            <input type="text" id="newCurrencyName" class="management-input" placeholder="é€šè²¨ãƒšã‚¢å (ä¾‹: EURJPY)">
            <input type="text" id="newCurrencyDisplay" class="management-input" placeholder="è¡¨ç¤ºå (ä¾‹: EUR/JPY)">
            <input type="text" id="newCurrencyTimeframe" class="management-input" placeholder="æ™‚é–“è»¸ (ä¾‹: 4æ™‚é–“è¶³)">
            <div class="management-buttons">
                <button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeAddCurrencyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="mgmt-btn add-currency-btn" onclick="addNewCurrency()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <div class="management-modal" id="addImageModal">
        <div class="management-modal-content">
            <h3>ğŸ–¼ï¸ ã‚·ãƒŠãƒªã‚ªè¿½åŠ </h3>
            <select id="targetCurrency" class="management-input"></select>
            <input type="file" id="newImageFile" class="management-input" accept="image/*">
            <input type="text" id="newImageLabel" class="management-input" placeholder="ã‚·ãƒŠãƒªã‚ªå (ä¾‹: ã‚·ãƒŠãƒªã‚ª3)">
            <div class="management-buttons">
                <button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeAddImageModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="mgmt-btn add-image-btn" onclick="addNewImage()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <div class="management-modal" id="deleteImageModal">
        <div class="management-modal-content">
            <h3>ğŸ—‘ï¸ ã‚·ãƒŠãƒªã‚ªå‰Šé™¤</h3>
            <p style="color: #dc3545; margin-bottom: 15px;">âš ï¸ å‰Šé™¤ã™ã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“</p>
            <select id="deleteImageCurrency" class="management-input"></select>
            <select id="deleteImageSelect" class="management-input"></select>
            <div class="management-buttons">
                <button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeDeleteImageModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="mgmt-btn delete-currency-btn" onclick="deleteImage()">å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <div class="management-modal" id="deleteCurrencyModal">
        <div class="management-modal-content">
            <h3>ğŸ—‘ï¸ é€šè²¨ãƒšã‚¢å‰Šé™¤</h3>
            <p style="color: #dc3545; margin-bottom: 15px;">âš ï¸ å‰Šé™¤ã™ã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“</p>
            <select id="deleteCurrency" class="management-input"></select>
            <div class="management-buttons">
                <button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeDeleteCurrencyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="mgmt-btn delete-currency-btn" onclick="deleteCurrency()">å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <script>
        // å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ä¿æŒ
        let allImages = ['USDJPY.jpeg','USDJPY2.jpeg','USDJPY3.jpeg','EURUSD.jpeg','EURUSD2.jpeg','GBPUSD.jpeg','GBPUSD2.jpeg','GBPUSD3.jpeg','GBPUSD4.jpeg','AUDUSD.jpeg','AUDUSD2.jpeg','SILVER.jpeg','SILVER2.jpeg','GOLD.png'];
        
        let currencyData = {
            'USDJPY': { pair: 'USD/JPY', status: 'considering', wave: 'unselected', timeframe: '4æ™‚é–“è¶³', images: ['USDJPY.jpeg', 'USDJPY2.jpeg', 'USDJPY3.jpeg'], imageLabels: ['ã‚·ãƒŠãƒªã‚ª1', 'ã‚·ãƒŠãƒªã‚ª2', 'ã‚·ãƒŠãƒªã‚ª3'], imageStatuses: { 'USDJPY.jpeg': 'considering', 'USDJPY2.jpeg': 'considering', 'USDJPY3.jpeg': 'considering' }, memo: '', customScenarios: [] },
            'EURUSD': { pair: 'EUR/USD', status: 'considering', wave: 'unselected', timeframe: 'æ—¥è¶³', images: ['EURUSD.jpeg', 'EURUSD2.jpeg'], imageLabels: ['ã‚·ãƒŠãƒªã‚ª1', 'ã‚·ãƒŠãƒªã‚ª2'], imageStatuses: { 'EURUSD.jpeg': 'considering', 'EURUSD2.jpeg': 'considering' }, memo: '', customScenarios: [] },
            'GBPUSD': { pair: 'GBP/USD', status: 'considering', wave: 'unselected', timeframe: '4æ™‚é–“è¶³', images: ['GBPUSD.jpeg', 'GBPUSD2.jpeg', 'GBPUSD3.jpeg', 'GBPUSD4.jpeg'], imageLabels: ['ã‚·ãƒŠãƒªã‚ª1', 'ã‚·ãƒŠãƒªã‚ª2', 'ã‚·ãƒŠãƒªã‚ª3', 'ã‚·ãƒŠãƒªã‚ª4'], imageStatuses: { 'GBPUSD.jpeg': 'considering', 'GBPUSD2.jpeg': 'considering', 'GBPUSD3.jpeg': 'considering', 'GBPUSD4.jpeg': 'considering' }, memo: '', customScenarios: [] },
            'AUDUSD': { pair: 'AUD/USD', status: 'considering', wave: 'unselected', timeframe: 'æ—¥è¶³', images: ['AUDUSD.jpeg', 'AUDUSD2.jpeg'], imageLabels: ['ã‚·ãƒŠãƒªã‚ª1', 'ã‚·ãƒŠãƒªã‚ª2'], imageStatuses: { 'AUDUSD.jpeg': 'considering', 'AUDUSD2.jpeg': 'considering' }, memo: '', customScenarios: [] },
            'SILVER': { pair: 'SILVER', status: 'considering', wave: 'unselected', timeframe: '4æ™‚é–“è¶³', images: ['SILVER.jpeg', 'SILVER2.jpeg'], imageLabels: ['ã‚·ãƒŠãƒªã‚ª1', 'ã‚·ãƒŠãƒªã‚ª2'], imageStatuses: { 'SILVER.jpeg': 'considering', 'SILVER2.jpeg': 'considering' }, memo: '', customScenarios: [] },
            'GOLD': { pair: 'GOLD', status: 'considering', wave: 'unselected', timeframe: 'æ—¥è¶³', images: ['GOLD.png'], imageLabels: ['ã‚·ãƒŠãƒªã‚ª1'], imageStatuses: { 'GOLD.png': 'considering' }, memo: '', customScenarios: [] }
        };

        let currentCurrency = 'USDJPY', currentImage = 'USDJPY.jpeg', currentPageNum = 1, uploadedImages = {}, imageStatusMap = {};
        const defaultFixedPrompt = `ã‚ãªãŸã¯çµŒé¨“è±Šå¯ŒãªFXãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ãƒãƒ£ãƒ¼ãƒˆåˆ†æãƒ‡ãƒ¼ã‚¿ã‚’è©•ä¾¡ã—ã€å®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚\n\nç‰¹ã«ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š\n1. ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã®å¦¥å½“æ€§\n2. ãƒªã‚¹ã‚¯ç®¡ç†ã®è¦³ç‚¹\n3. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ»ã‚¨ã‚°ã‚¸ãƒƒãƒˆæˆ¦ç•¥\n4. å¸‚å ´ç’°å¢ƒã¨ã®æ•´åˆæ€§\n\nå…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;

        // Firebaseå¯¾å¿œã®ä¿å­˜æ©Ÿèƒ½
        function saveData() {
            const dataToSave = { currencyData, allImages, currentCurrency, currentImage, currentPageNum, uploadedImages, lastSaved: new Date().toISOString() };
            try {
                localStorage.setItem('fx_analysis_data', JSON.stringify(dataToSave));
                if (window.firebaseDatabase && window.firebaseRef && window.firebaseSet) {
                    const userRef = window.firebaseRef(window.firebaseDatabase, 'fx_analysis_data');
                    window.firebaseSet(userRef, dataToSave).then(() => { console.log('FirebaseåŒæœŸæˆåŠŸ'); showSyncIndicator('åŒæœŸå®Œäº†'); }).catch((error) => { console.error('FirebaseåŒæœŸã‚¨ãƒ©ãƒ¼:', error); showSyncIndicator('åŒæœŸã‚¨ãƒ©ãƒ¼', 'error'); });
                }
                updateUsageDisplay();
            } catch (error) { console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error); }
        }

        function loadData() {
            if (window.firebaseDatabase && window.firebaseRef && window.firebaseGet) {
                const userRef = window.firebaseRef(window.firebaseDatabase, 'fx_analysis_data');
                window.firebaseGet(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        currencyData = data.currencyData || currencyData;
                        allImages = data.allImages || allImages;
                        currentCurrency = data.currentCurrency || currentCurrency;
                        currentImage = data.currentImage || currentImage;
                        currentPageNum = data.currentPageNum || currentPageNum;
                        uploadedImages = data.uploadedImages || uploadedImages;
                        console.log('Firebase ãƒ‡ãƒ¼ã‚¿å¾©å…ƒæˆåŠŸ'); showSyncIndicator('ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†');
                    } else { loadFromLocalStorage(); }
                }).catch((error) => { console.error('Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error); loadFromLocalStorage(); });
            } else { loadFromLocalStorage(); }
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('fx_analysis_data');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    currencyData = data.currencyData || currencyData;
                    allImages = data.allImages || allImages;
                    currentCurrency = data.currentCurrency || currentCurrency;
                    currentImage = data.currentImage || currentImage;
                    currentPageNum = data.currentPageNum || currentPageNum;
                    uploadedImages = data.uploadedImages || uploadedImages;
                    console.log('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿å¾©å…ƒæˆåŠŸ');
                } catch (error) { console.error('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ:', error); }
            }
        }

        function enableRealtimeSync() {
            if (window.firebaseDatabase && window.firebaseRef && window.firebaseOnValue) {
                const userRef = window.firebaseRef(window.firebaseDatabase, 'fx_analysis_data');
                window.firebaseOnValue(userRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const lastSyncTime = localStorage.getItem('last_sync_timestamp');
                        if (data.lastSaved !== lastSyncTime) {
                            currencyData = data.currencyData || currencyData; allImages = data.allImages || allImages; currentCurrency = data.currentCurrency || currentCurrency; currentImage = data.currentImage || currentImage; currentPageNum = data.currentPageNum || currentPageNum; uploadedImages = data.uploadedImages || uploadedImages;
                            updateCurrencyTabs(); updateDisplay(); updateImageButtons(); loadCurrentImage(); updateCustomScenarios(); updatePageInfo(); generateCopyText();
                            localStorage.setItem('last_sync_timestamp', data.lastSaved); showSyncIndicator('ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰æ›´æ–°');
                        }
                    }
                });
            }
        }

        function showSyncIndicator(message, type = 'success') {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.textContent = `ğŸ”„ ${message}`;
            indicator.className = `auto-save-indicator ${type}`;
            indicator.classList.add('show');
            setTimeout(() => { indicator.classList.remove('show'); }, 3000);
        }

        // ä½¿ç”¨é‡ç›£è¦–æ©Ÿèƒ½
        function calculateDataUsage() {
            const dataStr = JSON.stringify({ currencyData, allImages, uploadedImages });
            const sizeInBytes = new Blob([dataStr]).size;
            const sizeInMB = sizeInBytes / 1024 / 1024;
            const imageCount = Object.keys(uploadedImages).length;
            const firebaseUsagePercent = (sizeInMB / 1024) * 100;
            return { sizeInBytes, sizeInMB, imageCount, firebaseUsagePercent };
        }

        function updateUsageDisplay() {
            const usage = calculateDataUsage();
            const dataUsageElement = document.getElementById('dataUsage');
            if (usage.sizeInMB < 1) { dataUsageElement.textContent = `${(usage.sizeInMB * 1024).toFixed(0)}KB`; dataUsageElement.className = 'usage-value'; }
            else if (usage.sizeInMB < 100) { dataUsageElement.textContent = `${usage.sizeInMB.toFixed(1)}MB`; dataUsageElement.className = 'usage-value'; }
            else if (usage.sizeInMB < 500) { dataUsageElement.textContent = `${usage.sizeInMB.toFixed(1)}MB`; dataUsageElement.className = 'usage-value warning'; }
            else { dataUsageElement.textContent = `${usage.sizeInMB.toFixed(1)}MB`; dataUsageElement.className = 'usage-value danger'; }
            document.getElementById('imageCount').textContent = `${usage.imageCount}æš`;
            const firebaseUsageElement = document.getElementById('firebaseUsage');
            if (usage.firebaseUsagePercent < 50) { firebaseUsageElement.textContent = `${usage.firebaseUsagePercent.toFixed(1)}%`; firebaseUsageElement.className = 'usage-value'; }
            else if (usage.firebaseUsagePercent < 80) { firebaseUsageElement.textContent = `${usage.firebaseUsagePercent.toFixed(1)}%`; firebaseUsageElement.className = 'usage-value warning'; }
            else { firebaseUsageElement.textContent = `${usage.firebaseUsagePercent.toFixed(1)}%`; firebaseUsageElement.className = 'usage-value danger'; }
        }

        function showDetailedUsage() {
            const usage = calculateDataUsage();
            const modalContent = `<h3>ğŸ“Š è©³ç´°ä½¿ç”¨é‡ãƒ¬ãƒãƒ¼ãƒˆ</h3><div class="usage-details"><h4>ğŸ“ˆ å…¨ä½“ä½¿ç”¨é‡</h4><div class="usage-breakdown"><p><strong>ç·ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:</strong> ${usage.sizeInMB.toFixed(2)}MB</p><p><strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒæ•°:</strong> ${usage.imageCount}æš</p><p><strong>Firebaseä½¿ç”¨ç‡:</strong> ${usage.firebaseUsagePercent.toFixed(2)}%</p><div class="usage-bar"><div class="usage-bar-fill" style="width: ${Math.min(usage.firebaseUsagePercent, 100)}%"></div></div><p style="font-size: 11px; color: #6c757d;">ç„¡æ–™æ : 1GB (1024MB)</p></div></div><div class="management-buttons"><button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeUsageModal()">é–‰ã˜ã‚‹</button><button class="mgmt-btn" style="background: #ffc107; color: #212529;" onclick="closeUsageModal(); showCleanupModal();">ãƒ‡ãƒ¼ã‚¿æ•´ç†</button></div>`;
            if (!document.getElementById('usageModal')) { const modal = document.createElement('div'); modal.id = 'usageModal'; modal.className = 'usage-modal'; modal.innerHTML = `<div class="usage-modal-content">${modalContent}</div>`; document.body.appendChild(modal); } else { document.querySelector('#usageModal .usage-modal-content').innerHTML = modalContent; }
            document.getElementById('usageModal').classList.add('active');
        }

        function closeUsageModal() { const modal = document.getElementById('usageModal'); if (modal) { modal.classList.remove('active'); } }

        function showCleanupModal() {
            const modalContent = `<h3>ğŸ§¹ ãƒ‡ãƒ¼ã‚¿æ•´ç†ãƒ»æœ€é©åŒ–</h3><p style="color: #6c757d; margin-bottom: 20px;">ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ã‚’æœ€é©åŒ–ã§ãã¾ã™ã€‚</p><div class="cleanup-option"><h4>ğŸ’¾ å…¨ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h4><p>æ•´ç†å‰ã«ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™</p><button class="cleanup-btn cleanup-btn-info" onclick="createBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button></div><div class="management-buttons"><button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeCleanupModal()">é–‰ã˜ã‚‹</button></div>`;
            if (!document.getElementById('cleanupModal')) { const modal = document.createElement('div'); modal.id = 'cleanupModal'; modal.className = 'cleanup-modal'; modal.innerHTML = `<div class="cleanup-modal-content">${modalContent}</div>`; document.body.appendChild(modal); } else { document.querySelector('#cleanupModal .cleanup-modal-content').innerHTML = modalContent; }
            document.getElementById('cleanupModal').classList.add('active');
        }

        function closeCleanupModal() { const modal = document.getElementById('cleanupModal'); if (modal) { modal.classList.remove('active'); } }

        function createBackup() {
            const backupData = { currencyData, allImages, uploadedImages, backupDate: new Date().toISOString(), version: "backup_1.0" };
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `fx_analysis_backup_${new Date().toISOString().split('T')[0]}_${new Date().getHours()}${new Date().getMinutes()}.json`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            showStatus('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
        }

        // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã®è‰²ã‚’å®Œå…¨å›ºå®šã™ã‚‹ç›£è¦–æ©Ÿèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(function() {
                document.querySelectorAll('.image-btn:not(.missing)').forEach(btn => {
                    btn.style.background = '#4285f4'; btn.style.color = 'white'; btn.style.borderColor = '#4285f4';
                });
            }, 100);
        });

        // åŸºæœ¬æ©Ÿèƒ½ç¾¤
        function getTotalPages() { return allImages.length; }
        function checkDataIntegrity() { console.log('=== ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ ==='); console.log('é€šè²¨ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿:', currencyData); console.log('å…¨ç”»åƒãƒªã‚¹ãƒˆ:', allImages); console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ:', uploadedImages); console.log('ç¾åœ¨ã®é€šè²¨:', currentCurrency); console.log('ç¾åœ¨ã®ç”»åƒ:', currentImage); }
        function manualSave() { saveData(); alert('ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ä¿å­˜ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); }
        function resetAllData() { if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) { localStorage.removeItem('fx_analysis_data'); location.reload(); } }

        function initializePage() {
            setTimeout(() => { enableRealtimeSync(); }, 1000);
            loadData(); updateCurrencyTabs(); updateDisplay(); updatePageInfo(); updateImageButtons(); loadCurrentImage(); checkAllImageStatus(); loadFixedPrompt(); generateCopyText(); updateUsageDisplay();
            setInterval(updateUsageDisplay, 5000);
        }

        function loadFixedPrompt() { const savedPrompt = localStorage.getItem('fx_fixed_prompt'); if (savedPrompt) { document.getElementById('fixedPrompt').value = savedPrompt; } }
        function saveFixedPrompt() { const prompt = document.getElementById('fixedPrompt').value; localStorage.setItem('fx_fixed_prompt', prompt); showStatus('å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success'); }
        function resetFixedPrompt() { document.getElementById('fixedPrompt').value = defaultFixedPrompt; localStorage.removeItem('fx_fixed_prompt'); showStatus('å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸ', 'info'); }

        function updateCurrencyTabs() {
            const container = document.getElementById('currencyTabs');
            container.innerHTML = '';
            Object.keys(currencyData).forEach(currency => {
                const tab = document.createElement('div');
                tab.className = 'currency-tab' + (currency === currentCurrency ? ' active' : '');
                tab.textContent = currencyData[currency].pair;
                tab.onclick = function() { selectCurrency(currency); };
                container.appendChild(tab);
            });
        }

        function checkAllImageStatus() { allImages.forEach(imageName => { checkImageStatus(imageName); }); }
        function checkImageStatus(imageName) { const img = new Image(); img.onload = function() { imageStatusMap[imageName] = 'loaded'; }; img.onerror = function() { imageStatusMap[imageName] = 'missing'; }; img.src = `images/${imageName}`; }

        function selectCurrency(currency) {
            currentCurrency = currency; currentImage = currencyData[currency].images[0];
            updateCurrencyTabs(); updateDisplay(); updateImageButtons(); loadCurrentImage(); updateCustomScenarios(); generateCopyText(); saveData();
        }

        function selectImage(element, imageName) {
            currentImage = imageName;
            updateImageButtons(); loadCurrentImage(); updateCurrentImageInfo();
            const imageIndex = allImages.indexOf(imageName);
            if (imageIndex !== -1) { currentPageNum = imageIndex + 1; updatePageInfo(); }
            generateCopyText(); saveData();
        }

        function getStatusText(status) {
            const statusTexts = { 'considering': 'ğŸ¤” æ¤œè¨ä¸­', 'skip': 'â­ï¸ è¦‹é€ã‚Š', 'missed': 'ğŸ˜ è¦‹é€ƒã—', 'pending': 'ğŸ“‹ æŒ‡å€¤é€†æŒ‡å€¤ä¸­', 'holding': 'ğŸ’¼ ä¿æŒä¸­', 'completed': 'âœ… å®Œäº†' };
            return statusTexts[status] || 'ğŸ¤” æ¤œè¨ä¸­';
        }

        function updateImageButtons() {
            const data = currencyData[currentCurrency];
            const container = document.getElementById('imageButtons');
            container.innerHTML = '';
            
            data.images.forEach((image, index) => {
                const scenarioItem = document.createElement('div');
                scenarioItem.className = 'scenario-item';
                
                const btn = document.createElement('div');
                btn.className = 'image-btn';
                btn.textContent = data.imageLabels[index];
                btn.onclick = function() { selectImage(this, image); };
                
                // é¸æŠçŠ¶æ…‹ã¯å½±ã®ã¿ã§è¡¨ç¾ï¼ˆè‰²ã¯å¤‰æ›´ã—ãªã„ï¼‰
                if (image === currentImage) {
                    btn.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.3)';
                    btn.style.transform = 'translateY(-3px)';
                }
                
                // ç”»åƒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã¿ä¾‹å¤–
                if (imageStatusMap[image] === 'missing') {
                    btn.classList.add('missing');
                    btn.title = 'ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                }
                
                const imageStatus = data.imageStatuses[image] || 'considering';
                const statusLabel = document.createElement('div');
                statusLabel.className = `status-label status-${imageStatus}`;
                statusLabel.textContent = getStatusText(imageStatus);
                
                scenarioItem.appendChild(btn);
                scenarioItem.appendChild(statusLabel);
                container.appendChild(scenarioItem);
            });
        }

        function loadCurrentImage() {
            if (uploadedImages[currentImage]) { displayUploadedImage(uploadedImages[currentImage]); return; }
            const imagePaths = [`images/${currentImage}`, currentImage];
            tryLoadImage(imagePaths, 0);
        }

        function tryLoadImage(paths, index) {
            if (index >= paths.length) { showPlaceholder(); return; }
            const img = new Image();
            img.onload = function() { displayImage(paths[index]); };
            img.onerror = function() { tryLoadImage(paths, index + 1); };
            img.src = paths[index];
        }

        function displayImage(src) { const chartImage = document.getElementById('chartImage'); const placeholder = document.getElementById('chartDisplay'); chartImage.src = src; chartImage.style.display = 'block'; placeholder.style.display = 'none'; updateCurrentImageInfo('èª­ã¿è¾¼ã¿æˆåŠŸ'); }
        function displayUploadedImage(src) { const chartImage = document.getElementById('chartImage'); const placeholder = document.getElementById('chartDisplay'); chartImage.src = src; chartImage.style.display = 'block'; placeholder.style.display = 'none'; updateCurrentImageInfo('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ'); }

        function showPlaceholder() {
            const chartImage = document.getElementById('chartImage');
            const placeholder = document.getElementById('chartDisplay');
            chartImage.style.display = 'none'; placeholder.style.display = 'flex';
            const data = currencyData[currentCurrency];
            placeholder.innerHTML = `ğŸ“ˆ ${data.pair} ãƒãƒ£ãƒ¼ãƒˆ<small style="margin-top: 10px; display: block;">${currentImage} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br>imagesãƒ•ã‚©ãƒ«ãƒ€ã«ç”»åƒã‚’é…ç½®ã—ã¦ãã ã•ã„<br>ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§è¡¨ç¤º</small>`;
            updateCurrentImageInfo('ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }

        function updateCurrentImageInfo(status = '') { document.getElementById('currentImageInfo').textContent = `ç¾åœ¨ã®ç”»åƒ: ${currentImage} | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${status}`; }

        function showStatus(message, type) {
            let statusDiv = document.getElementById('globalStatus');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'globalStatus';
                statusDiv.style.cssText = `position: fixed; top: 80px; right: 20px; padding: 12px 16px; border-radius: 6px; font-size: 13px; z-index: 1500; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; transform: translateX(100%);`;
                document.body.appendChild(statusDiv);
            }
            const styles = { success: { background: '#d4edda', color: '#155724', border: '1px solid #c3e6cb' }, error: { background: '#f8d7da', color: '#721c24', border: '1px solid #f5c6cb' }, info: { background: '#d1ecf1', color: '#0c5460', border: '1px solid #bee5eb' }, warning: { background: '#fff3cd', color: '#856404', border: '1px solid #ffeaa7' } };
            const style = styles[type] || styles.info;
            statusDiv.style.background = style.background; statusDiv.style.color = style.color; statusDiv.style.border = style.border; statusDiv.textContent = message;
            statusDiv.style.transform = 'translateX(0)';
            setTimeout(() => { statusDiv.style.transform = 'translateX(100%)'; setTimeout(() => { if (statusDiv.parentNode) { statusDiv.parentNode.removeChild(statusDiv); } }, 300); }, 4000);
            console.log(`${type}: ${message}`);
        }

        function updateDisplay() {
            const data = currencyData[currentCurrency];
            document.getElementById('currentPair').textContent = data.pair;
            document.getElementById('timeframe').textContent = data.timeframe;
            const currentImageStatus = data.imageStatuses[currentImage] || 'considering';
            document.querySelectorAll('.control-btn').forEach(btn => { btn.classList.remove('active'); });
            const statusButtons = document.querySelectorAll('.control-btn');
            const statusMap = { 'considering': 0, 'skip': 1, 'missed': 2, 'pending': 3, 'holding': 4, 'completed': 5 };
            const statusIndex = statusMap[currentImageStatus] || 0;
            if (statusButtons[statusIndex]) { statusButtons[statusIndex].classList.add('active'); }
            document.querySelectorAll('.wave-btn').forEach(btn => { btn.classList.remove('active'); });
            const waveButtons = document.querySelectorAll('.wave-btn');
            const waveMap = { 'unselected': 0, '1h': 1, '4h': 2, '1d': 3 };
            const waveIndex = waveMap[data.wave] || 0;
            if (waveButtons[waveIndex]) { waveButtons[waveIndex].classList.add('active'); }
            document.getElementById('analysisMemo').value = data.memo;
        }

        function setStatus(element, status) {
            document.querySelectorAll('.control-btn').forEach(btn => { btn.classList.remove('active'); });
            element.classList.add('active');
            currencyData[currentCurrency].imageStatuses[currentImage] = status;
            updateImageButtons(); generateCopyText(); saveData();
        }

        function setWave(element, wave) {
            document.querySelectorAll('.wave-btn').forEach(btn => { btn.classList.remove('active'); });
            element.classList.add('active');
            currencyData[currentCurrency].wave = wave;
            generateCopyText(); saveData();
        }

        function showScenarioInput() { document.getElementById('scenarioInput').style.display = 'block'; document.getElementById('scenarioTitle').focus(); }
        function hideScenarioInput() { document.getElementById('scenarioInput').style.display = 'none'; document.getElementById('scenarioTitle').value = ''; document.getElementById('scenarioDesc').value = ''; }

        function saveScenario() {
            const title = document.getElementById('scenarioTitle').value.trim();
            const desc = document.getElementById('scenarioDesc').value.trim();
            if (!title || !desc) { alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            const scenario = { id: Date.now(), title: title, desc: desc };
            currencyData[currentCurrency].customScenarios.push(scenario);
            updateCustomScenarios(); hideScenarioInput(); generateCopyText(); saveData();
        }

        function deleteScenario(scenarioId) {
            if (confirm('ã“ã®ã‚·ãƒŠãƒªã‚ªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const scenarios = currencyData[currentCurrency].customScenarios;
                const index = scenarios.findIndex(s => s.id === scenarioId);
                if (index !== -1) { scenarios.splice(index, 1); updateCustomScenarios(); generateCopyText(); saveData(); }
            }
        }

        function updateCustomScenarios() {
            const container = document.getElementById('customScenariosContainer');
            container.innerHTML = '';
            const scenarios = currencyData[currentCurrency].customScenarios || [];
            scenarios.forEach(scenario => {
                const scenarioDiv = document.createElement('div');
                scenarioDiv.className = 'custom-scenario-item';
                scenarioDiv.innerHTML = `<button class="delete-scenario-btn" onclick="deleteScenario(${scenario.id})">Ã—</button><div class="scenario-title">${scenario.title}</div><div class="scenario-desc">${scenario.desc}</div>`;
                container.appendChild(scenarioDiv);
            });
        }

        function sendToChatGPTBrowser() { window.open('https://chat.openai.com/', '_blank'); showStatus('ChatGPTãŒæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã‹ã‚Œã¾ã—ãŸã€‚', 'success'); }
        function toggleCopyTextArea() { const copyArea = document.getElementById('copyTextArea'); if (copyArea.classList.contains('active')) { copyArea.classList.remove('active'); } else { copyArea.classList.add('active'); generateCopyText(); } }
        function closeCopyArea() { document.getElementById('copyTextArea').classList.remove('active'); }

        function generateCopyText() {
            const data = currencyData[currentCurrency];
            const currentImageStatus = data.imageStatuses[currentImage] || 'considering';
            const statusText = { 'considering': 'ğŸ¤” æ¤œè¨ä¸­', 'skip': 'â­ï¸ è¦‹é€ã‚Š', 'missed': 'ğŸ˜ è¦‹é€ƒã—', 'pending': 'ğŸ“‹ ç¾åœ¨æŒ‡å€¤ä¸­', 'holding': 'ğŸ’¼ ä¿æŒä¸­', 'completed': 'âœ… å®Œäº†' };
            const waveText = { 'unselected': 'æœªé¸æŠ', '1h': '1æ™‚é–“è¶³', '4h': '4æ™‚é–“è¶³', '1d': 'æ—¥è¶³' };
            const fixedPrompt = document.getElementById('fixedPrompt').value || defaultFixedPrompt;
            let message = `${fixedPrompt}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ“Š **åŸºæœ¬æƒ…å ±**\nãƒ»é€šè²¨ãƒšã‚¢: ${data.pair}\nãƒ»ç¾åœ¨ã®ç”»åƒ: ${currentImage}\nãƒ»åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusText[currentImageStatus]}\nãƒ»ç‹™ã†æ³¢: ${waveText[data.wave]}\nãƒ»æ™‚é–“è»¸: ${data.timeframe}\nãƒ»åˆ†ææ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}\n\nğŸ“ **åˆ†æãƒ¡ãƒ¢**\n${document.getElementById('analysisMemo').value || 'è¨˜è¼‰ãªã—'}\n`;
            if (data.customScenarios.length > 0) { message += `\nğŸ¯ **ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ª**\n`; data.customScenarios.forEach((scenario, index) => { message += `${index + 1}. **${scenario.title}**: ${scenario.desc}\n`; }); }
            message += `\n**æ³¨æ„**: ã“ã®å¾Œã«ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã®ã§ã€ç”»åƒã¨åˆã‚ã›ã¦ç·åˆçš„ãªåˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;
            document.getElementById('copyTextarea').value = message;
        }

        function copyAllText() { const textarea = document.getElementById('copyTextarea'); textarea.select(); navigator.clipboard.writeText(textarea.value).then(() => { showStatus('å…¨æ–‡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'); }).catch(() => { document.execCommand('copy'); showStatus('å…¨æ–‡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'); }); }

        function copyMemoOnly() {
            const memo = document.getElementById('analysisMemo').value || 'è¨˜è¼‰ãªã—';
            const fixedPrompt = document.getElementById('fixedPrompt').value || defaultFixedPrompt;
            const data = currencyData[currentCurrency];
            const memoText = `${fixedPrompt}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ“ **${data.pair} åˆ†æãƒ¡ãƒ¢**\n${memo}\n\n**æ³¨æ„**: ã“ã®å¾Œã«ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã®ã§ã€ç”»åƒã¨åˆã‚ã›ã¦ç·åˆçš„ãªåˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;
            navigator.clipboard.writeText(memoText).then(() => { showStatus('åˆ†æãƒ¡ãƒ¢ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'); }).catch(() => { const textarea = document.createElement('textarea'); textarea.value = memoText; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); showStatus('åˆ†æãƒ¡ãƒ¢ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'); });
        }

        function copyScenariosOnly() {
            const data = currencyData[currentCurrency];
            const fixedPrompt = document.getElementById('fixedPrompt').value || defaultFixedPrompt;
            let scenarioText = `${fixedPrompt}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ¯ **${data.pair} ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ª**\n`;
            if (data.customScenarios.length > 0) { data.customScenarios.forEach((scenario, index) => { scenarioText += `${index + 1}. **${scenario.title}**: ${scenario.desc}\n`; }); } else { scenarioText += 'è¨­å®šã•ã‚ŒãŸã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ªã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'; }
            scenarioText += `\n**æ³¨æ„**: ã“ã®å¾Œã«ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã®ã§ã€ç”»åƒã¨åˆã‚ã›ã¦ç·åˆçš„ãªåˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`;
            navigator.clipboard.writeText(scenarioText).then(() => { showStatus('ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ªã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'); }).catch(() => { const textarea = document.createElement('textarea'); textarea.value = scenarioText; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); showStatus('ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ªã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success'); });
        }

        // ç®¡ç†æ©Ÿèƒ½ï¼ˆå®Œå…¨å®Ÿè£…ï¼‰
        function showAddImageModal() { updateCurrencySelectors(); document.getElementById('addImageModal').classList.add('active'); }
        function closeAddImageModal() { document.getElementById('addImageModal').classList.remove('active'); document.getElementById('newImageFile').value = ''; document.getElementById('newImageLabel').value = ''; }

        function addNewImage() {
            const currency = document.getElementById('targetCurrency').value;
            const file = document.getElementById('newImageFile').files[0];
            const label = document.getElementById('newImageLabel').value.trim();
            if (!currency || !file || !label) { alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageName = `${currency}_${Date.now()}.${file.name.split('.').pop()}`;
                currencyData[currency].images.push(imageName); currencyData[currency].imageLabels.push(label); currencyData[currency].imageStatuses[imageName] = 'considering'; allImages.push(imageName); uploadedImages[imageName] = e.target.result;
                if (currentCurrency === currency) { updateImageButtons(); }
                updatePageInfo(); closeAddImageModal(); showStatus(`${label} ã‚’ ${currencyData[currency].pair} ã«è¿½åŠ ã—ã¾ã—ãŸï¼`, 'success'); saveData();
            };
            reader.readAsDataURL(file);
        }

        function showDeleteImageModal() { updateImageSelectors(); document.getElementById('deleteImageModal').classList.add('active'); }
        function closeDeleteImageModal() { document.getElementById('deleteImageModal').classList.remove('active'); }

        function updateImageSelectors() {
            const currencySelector = document.getElementById('deleteImageCurrency');
            const imageSelector = document.getElementById('deleteImageSelect');
            currencySelector.innerHTML = '';
            Object.keys(currencyData).forEach(currency => { const option = document.createElement('option'); option.value = currency; option.textContent = currencyData[currency].pair; currencySelector.appendChild(option); });
            currencySelector.onchange = function() { updateImageSelectOptions(); };
            updateImageSelectOptions();
        }

        function updateImageSelectOptions() {
            const currency = document.getElementById('deleteImageCurrency').value;
            const imageSelector = document.getElementById('deleteImageSelect');
            imageSelector.innerHTML = '';
            if (currency && currencyData[currency]) { currencyData[currency].images.forEach((image, index) => { const option = document.createElement('option'); option.value = image; option.textContent = currencyData[currency].imageLabels[index]; imageSelector.appendChild(option); }); }
        }

        function deleteImage() {
            const currency = document.getElementById('deleteImageCurrency').value;
            const imageName = document.getElementById('deleteImageSelect').value;
            if (!currency || !imageName) { alert('å‰Šé™¤ã™ã‚‹ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
            const data = currencyData[currency];
            const imageIndex = data.images.indexOf(imageName);
            if (imageIndex === -1) { alert('é¸æŠã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }
            const scenarioName = data.imageLabels[imageIndex];
            if (!confirm(`${currencyData[currency].pair} ã®ã€Œ${scenarioName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) { return; }
            data.images.splice(imageIndex, 1); data.imageLabels.splice(imageIndex, 1); delete data.imageStatuses[imageName];
            const allImageIndex = allImages.indexOf(imageName);
            if (allImageIndex !== -1) { allImages.splice(allImageIndex, 1); }
            delete uploadedImages[imageName];
            if (currentImage === imageName) {
                if (data.images.length > 0) { currentImage = data.images[0]; } else {
                    const remainingCurrencies = Object.keys(currencyData).filter(c => currencyData[c].images.length > 0);
                    if (remainingCurrencies.length > 0) { currentCurrency = remainingCurrencies[0]; currentImage = currencyData[currentCurrency].images[0]; updateCurrencyTabs(); updateDisplay(); updateCustomScenarios(); }
                }
            }
            if (currentCurrency === currency) { updateImageButtons(); loadCurrentImage(); }
            updatePageInfo(); closeDeleteImageModal(); showStatus(`${scenarioName} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`, 'success'); saveData();
        }

        function showAddCurrencyModal() { document.getElementById('addCurrencyModal').classList.add('active'); }
        function closeAddCurrencyModal() { document.getElementById('addCurrencyModal').classList.remove('active'); document.getElementById('newCurrencyName').value = ''; document.getElementById('newCurrencyDisplay').value = ''; document.getElementById('newCurrencyTimeframe').value = ''; }

        function addNewCurrency() {
            const name = document.getElementById('newCurrencyName').value.trim().toUpperCase();
            const display = document.getElementById('newCurrencyDisplay').value.trim();
            const timeframe = document.getElementById('newCurrencyTimeframe').value.trim();
            if (!name || !display || !timeframe) { alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
            if (currencyData[name]) { alert('ã“ã®é€šè²¨ãƒšã‚¢ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚'); return; }
            currencyData[name] = { pair: display, status: 'considering', wave: 'unselected', timeframe: timeframe, images: [], imageLabels: [], imageStatuses: {}, memo: '', customScenarios: [] };
            updateCurrencyTabs(); updateCurrencySelectors(); closeAddCurrencyModal(); showStatus(`${display} ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`, 'success'); saveData();
        }

        function showDeleteCurrencyModal() { updateCurrencySelectors(); document.getElementById('deleteCurrencyModal').classList.add('active'); }
        function closeDeleteCurrencyModal() { document.getElementById('deleteCurrencyModal').classList.remove('active'); }

        function deleteCurrency() {
            const currency = document.getElementById('deleteCurrency').value;
            if (!currency) { alert('å‰Šé™¤ã™ã‚‹é€šè²¨ãƒšã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
            if (!confirm(`${currencyData[currency].pair} ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) { return; }
            currencyData[currency].images.forEach(imageName => { const index = allImages.indexOf(imageName); if (index !== -1) { allImages.splice(index, 1); } delete uploadedImages[imageName]; });
            delete currencyData[currency];
            if (currentCurrency === currency) { const remainingCurrencies = Object.keys(currencyData); if (remainingCurrencies.length > 0) { selectCurrency(remainingCurrencies[0]); } }
            updateCurrencyTabs(); updatePageInfo(); closeDeleteCurrencyModal(); showStatus(`é€šè²¨ãƒšã‚¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`, 'success'); saveData();
        }

        function updateCurrencySelectors() {
            const selectors = ['targetCurrency', 'deleteCurrency'];
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) { selector.innerHTML = ''; Object.keys(currencyData).forEach(currency => { const option = document.createElement('option'); option.value = currency; option.textContent = currencyData[currency].pair; selector.appendChild(option); }); }
            });
        }

        function returnToTop() { currentPageNum = 1; currentCurrency = 'USDJPY'; currentImage = 'USDJPY.jpeg'; updateCurrencyTabs(); updateDisplay(); updateImageButtons(); loadCurrentImage(); updateCustomScenarios(); updatePageInfo(); window.scrollTo({ top: 0, behavior: 'smooth' }); saveData(); }

        function nextPage() { const totalPages = getTotalPages(); if (currentPageNum < totalPages) { currentPageNum++; const nextImageName = allImages[currentPageNum - 1]; switchToImagePage(nextImageName); updatePageInfo(); } }
        function previousPage() { if (currentPageNum > 1) { currentPageNum--; const prevImageName = allImages[currentPageNum - 1]; switchToImagePage(prevImageName); updatePageInfo(); } }

        function switchToImagePage(imageName) {
            currentImage = imageName;
            for (const [currency, data] of Object.entries(currencyData)) {
                if (data.images.includes(imageName)) {
                    if (currentCurrency !== currency) { currentCurrency = currency; updateCurrencyTabs(); updateDisplay(); updateCustomScenarios(); }
                    updateImageButtons(); break;
                }
            }
            loadCurrentImage(); updateCurrentImageInfo(); generateCopyText(); saveData();
        }

        function updatePageInfo() { const totalPages = getTotalPages(); document.getElementById('currentPage').textContent = currentPageNum; document.getElementById('totalPages').textContent = totalPages; document.getElementById('prevBtn').disabled = currentPageNum === 1; document.getElementById('nextBtn').disabled = currentPageNum === totalPages; }

        function openChartModal() {
            const modal = document.getElementById('chartModal');
            modal.classList.add('active');
            const modalChart = document.getElementById('modalChart');
            const chartImage = document.getElementById('chartImage');
            if (chartImage.style.display !== 'none' && chartImage.src) { modalChart.src = chartImage.src; } else { modalChart.src = 'data:image/svg+xml;base64,' + btoa(`<svg width="800" height="600" xmlns="http://www.w3.org/2000/svg"><rect width="800" height="600" fill="#f8f9fa"/><text x="400" y="280" text-anchor="middle" font-size="24" fill="#6c757d">${currencyData[currentCurrency].pair} ãƒãƒ£ãƒ¼ãƒˆ</text><text x="400" y="320" text-anchor="middle" font-size="16" fill="#6c757d">${currentImage} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</text></svg>`); }
        }

        function closeChartModal() { document.getElementById('chartModal').classList.remove('active'); }

        function shareAnalysis() {
            const data = currencyData[currentCurrency];
            const currentImageStatus = data.imageStatuses[currentImage] || 'considering';
            const statusText = { 'considering': 'ğŸ¤” æ¤œè¨ä¸­', 'skip': 'â­ï¸ è¦‹é€ã‚Š', 'missed': 'ğŸ˜ è¦‹é€ƒã—', 'pending': 'ğŸ“‹ æŒ‡å€¤é€†æŒ‡å€¤ä¸­', 'holding': 'ğŸ’¼ ä¿æŒä¸­', 'completed': 'âœ… å®Œäº†' };
            const waveText = { 'unselected': 'æœªé¸æŠ', '1h': '1æ™‚é–“è¶³', '4h': '4æ™‚é–“è¶³', '1d': 'æ—¥è¶³' };
            let shareText = `${data.pair} åˆ†æãƒ¬ãƒãƒ¼ãƒˆ\nç”»åƒ: ${currentImage}\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${statusText[currentImageStatus]}\nç‹™ã†æ³¢: ${waveText[data.wave]}\n\nåˆ†æãƒ¡ãƒ¢:\n${document.getElementById('analysisMemo').value}\n\n`;
            if (data.customScenarios.length > 0) { shareText += `ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ª:\n`; data.customScenarios.forEach(scenario => { shareText += `ãƒ»${scenario.title}: ${scenario.desc}\n`; }); }
            if (navigator.share) { navigator.share({ title: `${data.pair} åˆ†æãƒ¬ãƒãƒ¼ãƒˆ`, text: shareText, url: window.location.href }); } else { navigator.clipboard.writeText(shareText); alert('åˆ†æå†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
        }

        function updateTimestamp() { const now = new Date(); const timeString = now.toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); document.getElementById('lastUpdate').textContent = timeString; document.getElementById('footerUpdate').textContent = timeString; }
        function autoSaveMemo() { const currentMemo = document.getElementById('analysisMemo').value; currencyData[currentCurrency].memo = currentMemo; generateCopyText(); saveData(); }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('DOMContentLoaded', function() { initializePage(); updateTimestamp(); setInterval(updateTimestamp, 300000); setInterval(autoSaveMemo, 5000); });
        document.getElementById('chartModal').addEventListener('click', function(e) { if (e.target === this) { closeChartModal(); } });
        document.querySelectorAll('.management-modal').forEach(modal => { modal.addEventListener('click', function(e) { if (e.target === this) { this.classList.remove('active'); } }); });
        document.addEventListener('click', function(e) { if (e.target.classList.contains('usage-modal')) { closeUsageModal(); } if (e.target.classList.contains('cleanup-modal')) { closeCleanupModal(); } });
        document.addEventListener('keydown', function(e) { if (e.key === 'ArrowLeft') { previousPage(); } else if (e.key === 'ArrowRight') { nextPage(); } else if (e.key === 'Escape') { closeChartModal(); hideScenarioInput(); document.querySelectorAll('.management-modal').forEach(modal => { modal.classList.remove('active'); }); closeUsageModal(); closeCleanupModal(); } });
    </script>
</body>
</html>
