<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX通貨ペア分析管理システム</title>
    
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

      const firebaseConfig = {
        apiKey: "AIzaSyBMwI1i8DSnFYSBhz_zv80oGYaRmqvXEzA",
        authDomain: "fx-analysis-system.firebaseapp.com",
        databaseURL: "https://fx-analysis-system-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fx-analysis-system",
        storageBucket: "fx-analysis-system.firebasestorage.app",
        messagingSenderId: "286393020262",
        appId: "1:286393020262:web:eee0ede07040002b4762a7"
      };

      try {
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        console.log('Firebase初期化成功');
      } catch (error) {
        console.error('Firebase初期化エラー:', error);
        window.firebaseApp = null;
        window.firebaseDatabase = null;
      }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
        .container { max-width: 1280px; margin: 0 auto; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; }
        
        /* ヘッダー */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        
        /* メインコンテンツ */
        .main-content { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .section { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #e9ecef; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .section-title { font-size: 14px; font-weight: 600; color: #495057; }
        .mgmt-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; margin: 0 4px; }
        .add-btn { background: #28a745; color: white; }
        .delete-btn { background: #dc3545; color: white; }
        
        /* 通貨ペアタブ */
        .currency-tabs { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .currency-tab { padding: 8px 16px; background: white; border: 2px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease; }
        .currency-tab.active { background: #4285f4; color: white; border-color: #4285f4; }
        
        /* シナリオボタン - 色を完全固定 */
        .image-buttons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .scenario-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .image-btn { padding: 8px 16px !important; border: 2px solid #4285f4 !important; border-radius: 8px !important; cursor: pointer !important; font-size: 11px !important; text-align: center !important; min-width: 80px !important; font-weight: 600 !important; background: #4285f4 !important; color: white !important; transition: box-shadow 0.3s ease, transform 0.3s ease !important; }
        .image-btn, .image-btn:hover, .image-btn:focus, .image-btn:active, .image-btn.selected, .image-btn.active, .image-btn:visited, .image-btn:link, .image-btn[style] { background: #4285f4 !important; color: white !important; border-color: #4285f4 !important; }
        .image-btn.selected { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important; transform: translateY(-3px) !important; }
        .image-btn:hover { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important; transform: translateY(-1px) !important; }
        .image-btn.missing { background: #f8d7da !important; border-color: #dc3545 !important; color: #721c24 !important; }
        
        /* ステータスラベル */
        .status-label { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; white-space: nowrap; }
        .status-considering { background: #007bff; color: white; }
        .status-skip { background: #6c757d; color: white; }
        .status-missed { background: #6c757d; color: white; }
        .status-pending { background: #dc3545; color: white; }
        .status-holding { background: #dc3545; color: white; }
        .status-completed { background: #6c757d; color: white; }
        
        /* 通貨ペア表示 */
        .currency-info { text-align: center; margin: 20px 0; }
        .currency-pair { font-size: 28px; font-weight: 700; color: #2c3e50; }
        
        /* チャートエリア */
        .chart-area { display: flex; flex-direction: column; align-items: center; margin: 20px 0; }
        .chart-container { width: 100%; max-width: 800px; height: 60vh; min-height: 400px; border: 2px solid #e9ecef; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; background: white; }
        .chart-container:hover { transform: scale(1.01); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .chart-image { width: 100%; height: 100%; object-fit: contain; display: block; }
        .chart-placeholder { width: 100%; height: 100%; background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%), linear-gradient(-45deg, #f8f9fa 25%, transparent 25%); background-size: 20px 20px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 16px; font-weight: 600; flex-direction: column; text-align: center; padding: 20px; }
        
        /* ナビゲーション */
        .chart-navigation { display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .nav-btn { padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
        .nav-btn:hover { background: #3367d6; transform: translateY(-2px); }
        .nav-btn:disabled { background: #dee2e6; color: #6c757d; cursor: not-allowed; transform: none; }
        .return-btn { background: #28a745; }
        .return-btn:hover { background: #218838; }
        
        /* 分析コントロール */
        .analysis-controls { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .control-section { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #e9ecef; }
        .control-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .control-btn { padding: 10px 12px; border: 2px solid #dee2e6; background: white; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 12px; text-align: center; font-weight: 600; }
        .control-btn.active { border-color: #4285f4; background: #4285f4; color: white; }
        .wave-btn.unselected.active { border-color: #6c757d; background: #6c757d; color: white; }
        .wave-btn.wave-1h.active { border-color: #9acd32; background: #9acd32; color: white; }
        .wave-btn.wave-4h.active { border-color: #007bff; background: #007bff; color: white; }
        .wave-btn.wave-1d.active { border-color: #dc3545; background: #dc3545; color: white; }
        
        /* メモエリア */
        .memo-area { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr; gap: 20px; }
        .analysis-memo { height: 200px; width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; resize: vertical; font-size: 12px; line-height: 1.4; background: white; }
        
        /* カスタムシナリオ */
        .scenario-add-section { background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .add-scenario-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; margin-bottom: 15px; }
        .scenario-input { display: none; background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 15px; }
        .scenario-input input, .scenario-input textarea { width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; margin-bottom: 8px; font-size: 12px; }
        .scenario-input textarea { height: 60px; resize: vertical; }
        .scenario-input-buttons { display: flex; gap: 8px; }
        .scenario-input-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .scenario-save-btn { background: #007bff; color: white; }
        .scenario-cancel-btn { background: #6c757d; color: white; }
        .custom-scenario-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #28a745; position: relative; border: 1px solid #e9ecef; }
        .delete-scenario-btn { position: absolute; top: 8px; right: 8px; background: #dc3545; color: white; border: none; border-radius: 3px; padding: 4px 8px; font-size: 10px; cursor: pointer; }
        .scenario-title { font-weight: 600; color: #2c3e50; margin-bottom: 5px; font-size: 13px; }
        .scenario-desc { font-size: 12px; color: #6c757d; line-height: 1.4; }
        
        /* プロンプト設定 */
        .prompt-settings { background: #e8f4fd; border: 2px solid #007bff; padding: 15px; border-radius: 12px; }
        .prompt-textarea { width: 100%; height: 180px; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; resize: vertical; font-size: 12px; line-height: 1.4; background: white; }
        .prompt-controls { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .prompt-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .save-prompt-btn { background: #007bff; color: white; }
        .reset-prompt-btn { background: #6c757d; color: white; }
        .chatgpt-btn { background: #28a745; color: white; font-size: 14px; font-weight: 600; padding: 10px 20px; }
        
        /* コピーエリア */
        .copy-text-toggle { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; margin-top: 15px; width: 100%; transition: all 0.3s ease; }
        .copy-text-toggle:hover { background: #218838; }
        .copy-text-area { background: #f8f9fa; border: 2px solid #28a745; padding: 20px; margin-top: 15px; border-radius: 12px; display: none; }
        .copy-text-area.active { display: block; }
        .copy-textarea { width: 100%; height: 300px; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; resize: vertical; font-size: 12px; line-height: 1.4; background: white; font-family: monospace; }
        .copy-controls { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .copy-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.3s ease; }
        .copy-all-btn { background: #28a745; color: white; }
        .copy-memo-btn { background: #007bff; color: white; }
        .copy-scenarios-btn { background: #ffc107; color: #212529; }
        .close-copy-btn { background: #6c757d; color: white; }
        
        /* フッター */
        .footer { background: #f8f9fa; padding: 15px 20px; border-top: 1px solid #e9ecef; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .page-info { color: #6c757d; font-size: 12px; text-align: center; }
        .usage-info { display: flex; flex-wrap: wrap; gap: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
        .usage-item { display: flex; flex-direction: column; align-items: center; min-width: 100px; }
        .usage-label { font-size: 10px; color: #6c757d; margin-bottom: 2px; }
        .usage-value { font-size: 12px; font-weight: 600; color: #2c3e50; }
        .usage-value.warning { color: #ffc107; }
        .usage-value.danger { color: #dc3545; }
        .debug-buttons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .debug-btn { padding: 5px 10px; font-size: 10px; border: none; border-radius: 3px; cursor: pointer; transition: all 0.3s ease; }
        .debug-save { background: #007bff; color: white; }
        .debug-check { background: #28a745; color: white; }
        .debug-reset { background: #dc3545; color: white; }
        
        /* モーダル */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; padding: 10px; }
        .modal.active { display: flex; }
        .modal-content { max-width: 95%; max-height: 95%; border-radius: 8px; overflow: hidden; background: white; }
        .modal img { width: 100%; height: auto; display: block; }
        .close-modal { position: absolute; top: 15px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 1001; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .management-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .management-modal.active { display: flex; }
        .management-modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .management-modal h3 { margin-bottom: 20px; color: #2c3e50; }
        .management-input { width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 15px; font-size: 14px; }
        .management-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .mgmt-btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; }
        .add-currency-btn { background: #28a745; color: white; }
        .add-image-btn { background: #007bff; color: white; }
        .delete-currency-btn { background: #dc3545; color: white; }
        .auto-save-indicator { position: fixed; top: 20px; right: 20px; padding: 8px 12px; background: #28a745; color: white; border-radius: 6px; font-size: 12px; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; }
        .auto-save-indicator.show { opacity: 1; }
        .current-image-info { background: #f8f9fa; padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 11px; color: #495057; text-align: center; }
        .chart-info { margin-top: 15px; text-align: center; color: #6c757d; font-size: 12px; }
        
        /* レスポンシブ */
        @media (min-width: 768px) {
            .currency-tabs, .image-buttons { justify-content: flex-start; }
            .control-buttons { grid-template-columns: 1fr; }
            .analysis-controls { grid-template-columns: 1fr 1fr; }
            .memo-area { grid-template-columns: 1fr 1fr 1fr; }
            .analysis-memo { height: 250px; font-size: 13px; }
            .chart-container { height: 500px; }
        }
        @media (min-width: 1024px) {
            .analysis-controls { grid-template-columns: 1fr 1fr 2fr; }
        }
        @media (max-width: 767px) {
            .header h1 { font-size: 16px; }
            .btn { font-size: 11px; padding: 5px 10px; }
            .main-content { padding: 15px; }
            .chart-container { height: 50vh; min-height: 300px; }
            .currency-pair { font-size: 22px; }
            .analysis-controls { grid-template-columns: 1fr; }
            .memo-area { grid-template-columns: 1fr; }
            .copy-controls, .prompt-controls { flex-direction: column; }
            .copy-btn, .prompt-btn { width: 100%; margin-bottom: 5px; }
            .chart-navigation { flex-direction: column; gap: 10px; }
            .nav-btn { width: 100%; justify-content: center; }
            .scenario-item { flex-direction: column; align-items: flex-start; gap: 4px; }
            .debug-buttons { flex-direction: column; gap: 5px; }
            .debug-btn { width: 100%; }
            .usage-info { flex-direction: column; gap: 8px; }
            .usage-item { flex-direction: row; justify-content: space-between; min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="auto-save-indicator" id="autoSaveIndicator">💾 データを自動保存しました</div>

        <div class="header">
            <h1>🔍 FX通貨ペア分析システム</h1>
            <button class="btn" onclick="shareAnalysis()">📤 共有</button>
        </div>

        <div class="main-content">
            <!-- 通貨ペア選択 -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">通貨ペア選択</div>
                    <div>
                        <button class="mgmt-btn add-btn" onclick="showAddCurrencyModal()">➕ 通貨ペア追加</button>
                        <button class="mgmt-btn delete-btn" onclick="showDeleteCurrencyModal()">🗑️ 通貨ペア削除</button>
                    </div>
                </div>
                <div class="currency-tabs" id="currencyTabs"></div>
            </div>

            <!-- チャート選択 -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">チャート選択</div>
                    <div>
                        <button class="mgmt-btn add-btn" onclick="showAddImageModal()">➕ シナリオ追加</button>
                        <button class="mgmt-btn delete-btn" onclick="showDeleteImageModal()">🗑️ シナリオ削除</button>
                    </div>
                </div>
                <div class="image-buttons" id="imageButtons"></div>
            </div>

            <!-- 通貨ペア名表示 -->
            <div class="currency-info">
                <div class="currency-pair" id="currentPair">USD/JPY</div>
            </div>

            <!-- チャートエリア -->
            <div class="chart-area">
                <div class="chart-container" onclick="openChartModal()">
                    <div class="chart-placeholder" id="chartDisplay">
                        📈 USD/JPY チャート
                        <small style="margin-top: 10px; display: block;">画像ファイルを配置してください<br>タップで拡大表示</small>
                    </div>
                    <img id="chartImage" class="chart-image" style="display: none;" alt="チャート画像">
                </div>
                
                <div class="chart-navigation">
                    <button class="nav-btn" onclick="previousPage()" id="prevBtn" disabled>← 前のチャート</button>
                    <button class="nav-btn" onclick="nextPage()" id="nextBtn">次のチャート →</button>
                    <button class="nav-btn return-btn" onclick="returnToTop()">🏠 トップへ戻る</button>
                </div>
                
                <div class="chart-info">
                    <strong>時間軸:</strong> <span id="timeframe">4時間足</span> | 
                    <strong>更新:</strong> <span id="lastUpdate">2025-07-24 14:30</span>
                </div>
                <div class="current-image-info" id="currentImageInfo">現在の画像: USDJPY.jpeg | ステータス: 読み込み中...</div>
            </div>

            <!-- 分析コントロールエリア -->
            <div class="analysis-controls">
                <!-- 分析ステータス -->
                <div class="control-section">
                    <div class="section-title">分析ステータス</div>
                    <div class="control-buttons">
                        <div class="control-btn active" onclick="setStatus(this, 'considering')">🤔 検討中</div>
                        <div class="control-btn" onclick="setStatus(this, 'skip')">⏭️ 見送り</div>
                        <div class="control-btn" onclick="setStatus(this, 'missed')">😞 見逃し</div>
                        <div class="control-btn" onclick="setStatus(this, 'pending')">📋 指値逆指値中</div>
                        <div class="control-btn" onclick="setStatus(this, 'holding')">💼 保持中</div>
                        <div class="control-btn" onclick="setStatus(this, 'completed')">✅ 完了</div>
                    </div>
                </div>

                <!-- 狙う波 -->
                <div class="control-section">
                    <div class="section-title">狙う波</div>
                    <div class="control-buttons">
                        <div class="control-btn wave-btn unselected active" onclick="setWave(this, 'unselected')">未選択</div>
                        <div class="control-btn wave-btn wave-1h" onclick="setWave(this, '1h')">1時間足</div>
                        <div class="control-btn wave-btn wave-4h" onclick="setWave(this, '4h')">4時間足</div>
                        <div class="control-btn wave-btn wave-1d" onclick="setWave(this, '1d')">日足</div>
                    </div>
                </div>

                <!-- 分析メモ、カスタムシナリオ、固定プロンプト -->
                <div class="memo-area">
                    <div class="control-section">
                        <div class="section-title">📝 分析メモ</div>
                        <textarea class="analysis-memo" id="analysisMemo" placeholder="自由に分析内容を記入してください..."></textarea>
                    </div>

                    <div class="control-section">
                        <div class="section-title">🎯 カスタムシナリオ</div>
                        <div class="scenario-add-section">
                            <button class="add-scenario-btn" onclick="showScenarioInput()">+ シナリオ追加</button>
                            
                            <div class="scenario-input" id="scenarioInput">
                                <input type="text" id="scenarioTitle" placeholder="シナリオタイトル">
                                <textarea id="scenarioDesc" placeholder="シナリオの詳細説明"></textarea>
                                <div class="scenario-input-buttons">
                                    <button class="scenario-input-btn scenario-save-btn" onclick="saveScenario()">保存</button>
                                    <button class="scenario-input-btn scenario-cancel-btn" onclick="hideScenarioInput()">キャンセル</button>
                                </div>
                            </div>
                            
                            <div id="customScenariosContainer"></div>
                        </div>
                    </div>

                    <!-- 固定プロンプト設定 -->
                    <div class="control-section">
                        <div class="section-title">🤖 ChatGPT固定プロンプト</div>
                        <div class="prompt-settings">
                            <textarea class="prompt-textarea" id="fixedPrompt" placeholder="ChatGPTに送信する際の固定プロンプトを設定してください...">あなたは経験豊富なFXトレーダーです。以下のチャート分析データを評価し、実用的なアドバイスを提供してください。

特に以下の観点から分析をお願いします：
1. テクニカル分析の妥当性
2. リスク管理の観点
3. エントリー・エグジット戦略
4. 市場環境との整合性

具体的で実践的なアドバイスをお願いします。</textarea>
                            <div class="prompt-controls">
                                <button class="prompt-btn save-prompt-btn" onclick="saveFixedPrompt()">💾 プロンプト保存</button>
                                <button class="prompt-btn reset-prompt-btn" onclick="resetFixedPrompt()">🔄 デフォルトに戻す</button>
                                <button class="prompt-btn chatgpt-btn" onclick="sendToChatGPTBrowser()">🤖 ChatGPT分析</button>
                            </div>
                            
                            <button class="copy-text-toggle" onclick="toggleCopyTextArea()">📋 ChatGPT用テキストを表示/非表示</button>
                            
                            <div class="copy-text-area" id="copyTextArea">
                                <h3>📋 ChatGPT用テキスト</h3>
                                <p style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">以下のテキストをコピーしてChatGPTに貼り付けてください</p>
                                <textarea class="copy-textarea" id="copyTextarea" readonly></textarea>
                                <div class="copy-controls">
                                    <button class="copy-btn copy-all-btn" onclick="copyAllText()">📋 全文コピー</button>
                                    <button class="copy-btn copy-memo-btn" onclick="copyMemoOnly()">📝 分析メモのみコピー</button>
                                    <button class="copy-btn copy-scenarios-btn" onclick="copyScenariosOnly()">🎯 シナリオのみコピー</button>
                                    <button class="copy-btn close-copy-btn" onclick="closeCopyArea()">✕ 閉じる</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- フッター -->
        <div class="footer">
            <div class="page-info">
                ページ <span id="currentPage">1</span> / <span id="totalPages">14</span> | 
                最終更新: <span id="footerUpdate">2025-07-24 14:30</span>
            </div>
            
            <div class="usage-info">
                <div class="usage-item">
                    <span class="usage-label">データ使用量:</span>
                    <span id="dataUsage" class="usage-value">計算中...</span>
                </div>
                <div class="usage-item">
                    <span class="usage-label">画像数:</span>
                    <span id="imageCount" class="usage-value">0枚</span>
                </div>
                <div class="usage-item">
                    <span class="usage-label">Firebase使用率:</span>
                    <span id="firebaseUsage" class="usage-value">0%</span>
                </div>
            </div>
            
            <div class="debug-buttons">
                <button class="debug-btn debug-save" onclick="manualSave()">手動保存</button>
                <button class="debug-btn debug-check" onclick="checkDataIntegrity()">データ確認</button>
                <button class="debug-btn" style="background: #17a2b8; color: white;" onclick="showDetailedUsage()">詳細使用量</button>
                <button class="debug-btn" style="background: #ffc107; color: #212529;" onclick="showCleanupModal()">データ整理</button>
                <button class="debug-btn debug-reset" onclick="resetAllData()">リセット</button>
            </div>
        </div>
    </div>

    <!-- モーダル群 -->
    <div class="modal" id="chartModal">
        <div class="close-modal" onclick="closeChartModal()">×</div>
        <div class="modal-content"><img id="modalChart" src="" alt="Chart"></div>
    </div>

    <div class="management-modal" id="addCurrencyModal">
        <div class="management-modal-content">
            <h3>➕ 通貨ペア追加</h3>
            <input type="text" id="newCurrencyName" class="management-input" placeholder="通貨ペア名 (例: EURJPY)">
            <input type="text" id="newCurrencyDisplay" class="management-input" placeholder="表示名 (例: EUR/JPY)">
            <input type="text" id="newCurrencyTimeframe" class="management-input" placeholder="時間軸 (例: 4時間足)">
            <div class="management-buttons">
                <button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeAddCurrencyModal()">キャンセル</button>
                <button class="mgmt-btn add-currency-btn" onclick="addNewCurrency()">追加</button>
            </div>
        </div>
    </div>

    <div class="management-modal" id="addImageModal">
        <div class="management-modal-content">
            <h3>🖼️ シナリオ追加</h3>
            <select id="targetCurrency" class="management-input"></select>
            <input type="file" id="newImageFile" class="management-input" accept="image/*">
            <input type="text" id="newImageLabel" class="management-input" placeholder="シナリオ名 (例: シナリオ3)">
            <div class="management-buttons">
                <button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeAddImageModal()">キャンセル</button>
                <button class="mgmt-btn add-image-btn" onclick="addNewImage()">追加</button>
            </div>
        </div>
    </div>

    <div class="management-modal" id="deleteImageModal">
        <div class="management-modal-content">
            <h3>🗑️ シナリオ削除</h3>
            <p style="color: #dc3545; margin-bottom: 15px;">⚠️ 削除すると復元できません</p>
            <select id="deleteImageCurrency" class="management-input"></select>
            <select id="deleteImageSelect" class="management-input"></select>
            <div class="management-buttons">
                <button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeDeleteImageModal()">キャンセル</button>
                <button class="mgmt-btn delete-currency-btn" onclick="deleteImage()">削除</button>
            </div>
        </div>
    </div>

    <div class="management-modal" id="deleteCurrencyModal">
        <div class="management-modal-content">
            <h3>🗑️ 通貨ペア削除</h3>
            <p style="color: #dc3545; margin-bottom: 15px;">⚠️ 削除すると復元できません</p>
            <select id="deleteCurrency" class="management-input"></select>
            <div class="management-buttons">
                <button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeDeleteCurrencyModal()">キャンセル</button>
                <button class="mgmt-btn delete-currency-btn" onclick="deleteCurrency()">削除</button>
            </div>
        </div>
    </div>

    <script>
        // 元のデータを完全保持
        let allImages = ['USDJPY.jpeg','USDJPY2.jpeg','USDJPY3.jpeg','EURUSD.jpeg','EURUSD2.jpeg','GBPUSD.jpeg','GBPUSD2.jpeg','GBPUSD3.jpeg','GBPUSD4.jpeg','AUDUSD.jpeg','AUDUSD2.jpeg','SILVER.jpeg','SILVER2.jpeg','GOLD.png'];
        
        let currencyData = {
            'USDJPY': { pair: 'USD/JPY', status: 'considering', wave: 'unselected', timeframe: '4時間足', images: ['USDJPY.jpeg', 'USDJPY2.jpeg', 'USDJPY3.jpeg'], imageLabels: ['シナリオ1', 'シナリオ2', 'シナリオ3'], imageStatuses: { 'USDJPY.jpeg': 'considering', 'USDJPY2.jpeg': 'considering', 'USDJPY3.jpeg': 'considering' }, memo: '', customScenarios: [] },
            'EURUSD': { pair: 'EUR/USD', status: 'considering', wave: 'unselected', timeframe: '日足', images: ['EURUSD.jpeg', 'EURUSD2.jpeg'], imageLabels: ['シナリオ1', 'シナリオ2'], imageStatuses: { 'EURUSD.jpeg': 'considering', 'EURUSD2.jpeg': 'considering' }, memo: '', customScenarios: [] },
            'GBPUSD': { pair: 'GBP/USD', status: 'considering', wave: 'unselected', timeframe: '4時間足', images: ['GBPUSD.jpeg', 'GBPUSD2.jpeg', 'GBPUSD3.jpeg', 'GBPUSD4.jpeg'], imageLabels: ['シナリオ1', 'シナリオ2', 'シナリオ3', 'シナリオ4'], imageStatuses: { 'GBPUSD.jpeg': 'considering', 'GBPUSD2.jpeg': 'considering', 'GBPUSD3.jpeg': 'considering', 'GBPUSD4.jpeg': 'considering' }, memo: '', customScenarios: [] },
            'AUDUSD': { pair: 'AUD/USD', status: 'considering', wave: 'unselected', timeframe: '日足', images: ['AUDUSD.jpeg', 'AUDUSD2.jpeg'], imageLabels: ['シナリオ1', 'シナリオ2'], imageStatuses: { 'AUDUSD.jpeg': 'considering', 'AUDUSD2.jpeg': 'considering' }, memo: '', customScenarios: [] },
            'SILVER': { pair: 'SILVER', status: 'considering', wave: 'unselected', timeframe: '4時間足', images: ['SILVER.jpeg', 'SILVER2.jpeg'], imageLabels: ['シナリオ1', 'シナリオ2'], imageStatuses: { 'SILVER.jpeg': 'considering', 'SILVER2.jpeg': 'considering' }, memo: '', customScenarios: [] },
            'GOLD': { pair: 'GOLD', status: 'considering', wave: 'unselected', timeframe: '日足', images: ['GOLD.png'], imageLabels: ['シナリオ1'], imageStatuses: { 'GOLD.png': 'considering' }, memo: '', customScenarios: [] }
        };

        let currentCurrency = 'USDJPY', currentImage = 'USDJPY.jpeg', currentPageNum = 1, uploadedImages = {}, imageStatusMap = {};
        const defaultFixedPrompt = `あなたは経験豊富なFXトレーダーです。以下のチャート分析データを評価し、実用的なアドバイスを提供してください。\n\n特に以下の観点から分析をお願いします：\n1. テクニカル分析の妥当性\n2. リスク管理の観点\n3. エントリー・エグジット戦略\n4. 市場環境との整合性\n\n具体的で実践的なアドバイスをお願いします。`;

        // Firebase対応の保存機能
        function saveData() {
            const dataToSave = { currencyData, allImages, currentCurrency, currentImage, currentPageNum, uploadedImages, lastSaved: new Date().toISOString() };
            try {
                localStorage.setItem('fx_analysis_data', JSON.stringify(dataToSave));
                if (window.firebaseDatabase && window.firebaseRef && window.firebaseSet) {
                    const userRef = window.firebaseRef(window.firebaseDatabase, 'fx_analysis_data');
                    window.firebaseSet(userRef, dataToSave).then(() => { console.log('Firebase同期成功'); showSyncIndicator('同期完了'); }).catch((error) => { console.error('Firebase同期エラー:', error); showSyncIndicator('同期エラー', 'error'); });
                }
                updateUsageDisplay();
            } catch (error) { console.error('データ保存エラー:', error); }
        }

        function loadData() {
            if (window.firebaseDatabase && window.firebaseRef && window.firebaseGet) {
                const userRef = window.firebaseRef(window.firebaseDatabase, 'fx_analysis_data');
                window.firebaseGet(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        currencyData = data.currencyData || currencyData;
                        allImages = data.allImages || allImages;
                        currentCurrency = data.currentCurrency || currentCurrency;
                        currentImage = data.currentImage || currentImage;
                        currentPageNum = data.currentPageNum || currentPageNum;
                        uploadedImages = data.uploadedImages || uploadedImages;
                        console.log('Firebase データ復元成功'); showSyncIndicator('データ同期完了');
                    } else { loadFromLocalStorage(); }
                }).catch((error) => { console.error('Firebase読み込みエラー:', error); loadFromLocalStorage(); });
            } else { loadFromLocalStorage(); }
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('fx_analysis_data');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    currencyData = data.currencyData || currencyData;
                    allImages = data.allImages || allImages;
                    currentCurrency = data.currentCurrency || currentCurrency;
                    currentImage = data.currentImage || currentImage;
                    currentPageNum = data.currentPageNum || currentPageNum;
                    uploadedImages = data.uploadedImages || uploadedImages;
                    console.log('ローカルデータ復元成功');
                } catch (error) { console.error('ローカルデータの復元に失敗しました:', error); }
            }
        }

        function enableRealtimeSync() {
            if (window.firebaseDatabase && window.firebaseRef && window.firebaseOnValue) {
                const userRef = window.firebaseRef(window.firebaseDatabase, 'fx_analysis_data');
                window.firebaseOnValue(userRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const lastSyncTime = localStorage.getItem('last_sync_timestamp');
                        if (data.lastSaved !== lastSyncTime) {
                            currencyData = data.currencyData || currencyData; allImages = data.allImages || allImages; currentCurrency = data.currentCurrency || currentCurrency; currentImage = data.currentImage || currentImage; currentPageNum = data.currentPageNum || currentPageNum; uploadedImages = data.uploadedImages || uploadedImages;
                            updateCurrencyTabs(); updateDisplay(); updateImageButtons(); loadCurrentImage(); updateCustomScenarios(); updatePageInfo(); generateCopyText();
                            localStorage.setItem('last_sync_timestamp', data.lastSaved); showSyncIndicator('他のデバイスから更新');
                        }
                    }
                });
            }
        }

        function showSyncIndicator(message, type = 'success') {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.textContent = `🔄 ${message}`;
            indicator.className = `auto-save-indicator ${type}`;
            indicator.classList.add('show');
            setTimeout(() => { indicator.classList.remove('show'); }, 3000);
        }

        // 使用量監視機能
        function calculateDataUsage() {
            const dataStr = JSON.stringify({ currencyData, allImages, uploadedImages });
            const sizeInBytes = new Blob([dataStr]).size;
            const sizeInMB = sizeInBytes / 1024 / 1024;
            const imageCount = Object.keys(uploadedImages).length;
            const firebaseUsagePercent = (sizeInMB / 1024) * 100;
            return { sizeInBytes, sizeInMB, imageCount, firebaseUsagePercent };
        }

        function updateUsageDisplay() {
            const usage = calculateDataUsage();
            const dataUsageElement = document.getElementById('dataUsage');
            if (usage.sizeInMB < 1) { dataUsageElement.textContent = `${(usage.sizeInMB * 1024).toFixed(0)}KB`; dataUsageElement.className = 'usage-value'; }
            else if (usage.sizeInMB < 100) { dataUsageElement.textContent = `${usage.sizeInMB.toFixed(1)}MB`; dataUsageElement.className = 'usage-value'; }
            else if (usage.sizeInMB < 500) { dataUsageElement.textContent = `${usage.sizeInMB.toFixed(1)}MB`; dataUsageElement.className = 'usage-value warning'; }
            else { dataUsageElement.textContent = `${usage.sizeInMB.toFixed(1)}MB`; dataUsageElement.className = 'usage-value danger'; }
            document.getElementById('imageCount').textContent = `${usage.imageCount}枚`;
            const firebaseUsageElement = document.getElementById('firebaseUsage');
            if (usage.firebaseUsagePercent < 50) { firebaseUsageElement.textContent = `${usage.firebaseUsagePercent.toFixed(1)}%`; firebaseUsageElement.className = 'usage-value'; }
            else if (usage.firebaseUsagePercent < 80) { firebaseUsageElement.textContent = `${usage.firebaseUsagePercent.toFixed(1)}%`; firebaseUsageElement.className = 'usage-value warning'; }
            else { firebaseUsageElement.textContent = `${usage.firebaseUsagePercent.toFixed(1)}%`; firebaseUsageElement.className = 'usage-value danger'; }
        }

        function showDetailedUsage() {
            const usage = calculateDataUsage();
            const modalContent = `<h3>📊 詳細使用量レポート</h3><div class="usage-details"><h4>📈 全体使用量</h4><div class="usage-breakdown"><p><strong>総データサイズ:</strong> ${usage.sizeInMB.toFixed(2)}MB</p><p><strong>アップロード画像数:</strong> ${usage.imageCount}枚</p><p><strong>Firebase使用率:</strong> ${usage.firebaseUsagePercent.toFixed(2)}%</p><div class="usage-bar"><div class="usage-bar-fill" style="width: ${Math.min(usage.firebaseUsagePercent, 100)}%"></div></div><p style="font-size: 11px; color: #6c757d;">無料枠: 1GB (1024MB)</p></div></div><div class="management-buttons"><button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeUsageModal()">閉じる</button><button class="mgmt-btn" style="background: #ffc107; color: #212529;" onclick="closeUsageModal(); showCleanupModal();">データ整理</button></div>`;
            if (!document.getElementById('usageModal')) { const modal = document.createElement('div'); modal.id = 'usageModal'; modal.className = 'usage-modal'; modal.innerHTML = `<div class="usage-modal-content">${modalContent}</div>`; document.body.appendChild(modal); } else { document.querySelector('#usageModal .usage-modal-content').innerHTML = modalContent; }
            document.getElementById('usageModal').classList.add('active');
        }

        function closeUsageModal() { const modal = document.getElementById('usageModal'); if (modal) { modal.classList.remove('active'); } }

        function showCleanupModal() {
            const modalContent = `<h3>🧹 データ整理・最適化</h3><p style="color: #6c757d; margin-bottom: 20px;">データクリーンアップ機能により、ストレージ使用量を最適化できます。</p><div class="cleanup-option"><h4>💾 全データのバックアップ</h4><p>整理前に現在のデータをバックアップファイルとして保存します</p><button class="cleanup-btn cleanup-btn-info" onclick="createBackup()">バックアップ作成</button></div><div class="management-buttons"><button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeCleanupModal()">閉じる</button></div>`;
            if (!document.getElementById('cleanupModal')) { const modal = document.createElement('div'); modal.id = 'cleanupModal'; modal.className = 'cleanup-modal'; modal.innerHTML = `<div class="cleanup-modal-content">${modalContent}</div>`; document.body.appendChild(modal); } else { document.querySelector('#cleanupModal .cleanup-modal-content').innerHTML = modalContent; }
            document.getElementById('cleanupModal').classList.add('active');
        }

        function closeCleanupModal() { const modal = document.getElementById('cleanupModal'); if (modal) { modal.classList.remove('active'); } }

        function createBackup() {
            const backupData = { currencyData, allImages, uploadedImages, backupDate: new Date().toISOString(), version: "backup_1.0" };
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `fx_analysis_backup_${new Date().toISOString().split('T')[0]}_${new Date().getHours()}${new Date().getMinutes()}.json`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
            showStatus('バックアップファイルを作成しました', 'success');
        }

        // シナリオボタンの色を完全固定する監視機能
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(function() {
                document.querySelectorAll('.image-btn:not(.missing)').forEach(btn => {
                    btn.style.background = '#4285f4'; btn.style.color = 'white'; btn.style.borderColor = '#4285f4';
                });
            }, 100);
        });

        // 基本機能群
        function getTotalPages() { return allImages.length; }
        function checkDataIntegrity() { console.log('=== データ整合性チェック ==='); console.log('通貨ペアデータ:', currencyData); console.log('全画像リスト:', allImages); console.log('アップロード画像:', uploadedImages); console.log('現在の通貨:', currentCurrency); console.log('現在の画像:', currentImage); }
        function manualSave() { saveData(); alert('データを手動保存しました。コンソールを確認してください。'); }
        function resetAllData() { if (confirm('全てのデータをリセットしますか？この操作は取り消せません。')) { localStorage.removeItem('fx_analysis_data'); location.reload(); } }

        function initializePage() {
            setTimeout(() => { enableRealtimeSync(); }, 1000);
            loadData(); updateCurrencyTabs(); updateDisplay(); updatePageInfo(); updateImageButtons(); loadCurrentImage(); checkAllImageStatus(); loadFixedPrompt(); generateCopyText(); updateUsageDisplay();
            setInterval(updateUsageDisplay, 5000);
        }

        function loadFixedPrompt() { const savedPrompt = localStorage.getItem('fx_fixed_prompt'); if (savedPrompt) { document.getElementById('fixedPrompt').value = savedPrompt; } }
        function saveFixedPrompt() { const prompt = document.getElementById('fixedPrompt').value; localStorage.setItem('fx_fixed_prompt', prompt); showStatus('固定プロンプトを保存しました', 'success'); }
        function resetFixedPrompt() { document.getElementById('fixedPrompt').value = defaultFixedPrompt; localStorage.removeItem('fx_fixed_prompt'); showStatus('固定プロンプトをデフォルトに戻しました', 'info'); }

        function updateCurrencyTabs() {
            const container = document.getElementById('currencyTabs');
            container.innerHTML = '';
            Object.keys(currencyData).forEach(currency => {
                const tab = document.createElement('div');
                tab.className = 'currency-tab' + (currency === currentCurrency ? ' active' : '');
                tab.textContent = currencyData[currency].pair;
                tab.onclick = function() { selectCurrency(currency); };
                container.appendChild(tab);
            });
        }

        function checkAllImageStatus() { allImages.forEach(imageName => { checkImageStatus(imageName); }); }
        function checkImageStatus(imageName) { const img = new Image(); img.onload = function() { imageStatusMap[imageName] = 'loaded'; }; img.onerror = function() { imageStatusMap[imageName] = 'missing'; }; img.src = `images/${imageName}`; }

        function selectCurrency(currency) {
            currentCurrency = currency; currentImage = currencyData[currency].images[0];
            updateCurrencyTabs(); updateDisplay(); updateImageButtons(); loadCurrentImage(); updateCustomScenarios(); generateCopyText(); saveData();
        }

        function selectImage(element, imageName) {
            currentImage = imageName;
            updateImageButtons(); loadCurrentImage(); updateCurrentImageInfo();
            const imageIndex = allImages.indexOf(imageName);
            if (imageIndex !== -1) { currentPageNum = imageIndex + 1; updatePageInfo(); }
            generateCopyText(); saveData();
        }

        function getStatusText(status) {
            const statusTexts = { 'considering': '🤔 検討中', 'skip': '⏭️ 見送り', 'missed': '😞 見逃し', 'pending': '📋 指値逆指値中', 'holding': '💼 保持中', 'completed': '✅ 完了' };
            return statusTexts[status] || '🤔 検討中';
        }

        function updateImageButtons() {
            const data = currencyData[currentCurrency];
            const container = document.getElementById('imageButtons');
            container.innerHTML = '';
            
            data.images.forEach((image, index) => {
                const scenarioItem = document.createElement('div');
                scenarioItem.className = 'scenario-item';
                
                const btn = document.createElement('div');
                btn.className = 'image-btn';
                btn.textContent = data.imageLabels[index];
                btn.onclick = function() { selectImage(this, image); };
                
                // 選択状態は影のみで表現（色は変更しない）
                if (image === currentImage) {
                    btn.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.3)';
                    btn.style.transform = 'translateY(-3px)';
                }
                
                // 画像が見つからない場合のみ例外
                if (imageStatusMap[image] === 'missing') {
                    btn.classList.add('missing');
                    btn.title = '画像が見つかりません';
                }
                
                const imageStatus = data.imageStatuses[image] || 'considering';
                const statusLabel = document.createElement('div');
                statusLabel.className = `status-label status-${imageStatus}`;
                statusLabel.textContent = getStatusText(imageStatus);
                
                scenarioItem.appendChild(btn);
                scenarioItem.appendChild(statusLabel);
                container.appendChild(scenarioItem);
            });
        }

        function loadCurrentImage() {
            if (uploadedImages[currentImage]) { displayUploadedImage(uploadedImages[currentImage]); return; }
            const imagePaths = [`images/${currentImage}`, currentImage];
            tryLoadImage(imagePaths, 0);
        }

        function tryLoadImage(paths, index) {
            if (index >= paths.length) { showPlaceholder(); return; }
            const img = new Image();
            img.onload = function() { displayImage(paths[index]); };
            img.onerror = function() { tryLoadImage(paths, index + 1); };
            img.src = paths[index];
        }

        function displayImage(src) { const chartImage = document.getElementById('chartImage'); const placeholder = document.getElementById('chartDisplay'); chartImage.src = src; chartImage.style.display = 'block'; placeholder.style.display = 'none'; updateCurrentImageInfo('読み込み成功'); }
        function displayUploadedImage(src) { const chartImage = document.getElementById('chartImage'); const placeholder = document.getElementById('chartDisplay'); chartImage.src = src; chartImage.style.display = 'block'; placeholder.style.display = 'none'; updateCurrentImageInfo('アップロード画像'); }

        function showPlaceholder() {
            const chartImage = document.getElementById('chartImage');
            const placeholder = document.getElementById('chartDisplay');
            chartImage.style.display = 'none'; placeholder.style.display = 'flex';
            const data = currencyData[currentCurrency];
            placeholder.innerHTML = `📈 ${data.pair} チャート<small style="margin-top: 10px; display: block;">${currentImage} が見つかりません<br>imagesフォルダに画像を配置してください<br>タップで拡大表示</small>`;
            updateCurrentImageInfo('画像が見つかりません');
        }

        function updateCurrentImageInfo(status = '') { document.getElementById('currentImageInfo').textContent = `現在の画像: ${currentImage} | ステータス: ${status}`; }

        function showStatus(message, type) {
            let statusDiv = document.getElementById('globalStatus');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'globalStatus';
                statusDiv.style.cssText = `position: fixed; top: 80px; right: 20px; padding: 12px 16px; border-radius: 6px; font-size: 13px; z-index: 1500; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; transform: translateX(100%);`;
                document.body.appendChild(statusDiv);
            }
            const styles = { success: { background: '#d4edda', color: '#155724', border: '1px solid #c3e6cb' }, error: { background: '#f8d7da', color: '#721c24', border: '1px solid #f5c6cb' }, info: { background: '#d1ecf1', color: '#0c5460', border: '1px solid #bee5eb' }, warning: { background: '#fff3cd', color: '#856404', border: '1px solid #ffeaa7' } };
            const style = styles[type] || styles.info;
            statusDiv.style.background = style.background; statusDiv.style.color = style.color; statusDiv.style.border = style.border; statusDiv.textContent = message;
            statusDiv.style.transform = 'translateX(0)';
            setTimeout(() => { statusDiv.style.transform = 'translateX(100%)'; setTimeout(() => { if (statusDiv.parentNode) { statusDiv.parentNode.removeChild(statusDiv); } }, 300); }, 4000);
            console.log(`${type}: ${message}`);
        }

        function updateDisplay() {
            const data = currencyData[currentCurrency];
            document.getElementById('currentPair').textContent = data.pair;
            document.getElementById('timeframe').textContent = data.timeframe;
            const currentImageStatus = data.imageStatuses[currentImage] || 'considering';
            document.querySelectorAll('.control-btn').forEach(btn => { btn.classList.remove('active'); });
            const statusButtons = document.querySelectorAll('.control-btn');
            const statusMap = { 'considering': 0, 'skip': 1, 'missed': 2, 'pending': 3, 'holding': 4, 'completed': 5 };
            const statusIndex = statusMap[currentImageStatus] || 0;
            if (statusButtons[statusIndex]) { statusButtons[statusIndex].classList.add('active'); }
            document.querySelectorAll('.wave-btn').forEach(btn => { btn.classList.remove('active'); });
            const waveButtons = document.querySelectorAll('.wave-btn');
            const waveMap = { 'unselected': 0, '1h': 1, '4h': 2, '1d': 3 };
            const waveIndex = waveMap[data.wave] || 0;
            if (waveButtons[waveIndex]) { waveButtons[waveIndex].classList.add('active'); }
            document.getElementById('analysisMemo').value = data.memo;
        }

        function setStatus(element, status) {
            document.querySelectorAll('.control-btn').forEach(btn => { btn.classList.remove('active'); });
            element.classList.add('active');
            currencyData[currentCurrency].imageStatuses[currentImage] = status;
            updateImageButtons(); generateCopyText(); saveData();
        }

        function setWave(element, wave) {
            document.querySelectorAll('.wave-btn').forEach(btn => { btn.classList.remove('active'); });
            element.classList.add('active');
            currencyData[currentCurrency].wave = wave;
            generateCopyText(); saveData();
        }

        function showScenarioInput() { document.getElementById('scenarioInput').style.display = 'block'; document.getElementById('scenarioTitle').focus(); }
        function hideScenarioInput() { document.getElementById('scenarioInput').style.display = 'none'; document.getElementById('scenarioTitle').value = ''; document.getElementById('scenarioDesc').value = ''; }

        function saveScenario() {
            const title = document.getElementById('scenarioTitle').value.trim();
            const desc = document.getElementById('scenarioDesc').value.trim();
            if (!title || !desc) { alert('タイトルと説明の両方を入力してください。'); return; }
            const scenario = { id: Date.now(), title: title, desc: desc };
            currencyData[currentCurrency].customScenarios.push(scenario);
            updateCustomScenarios(); hideScenarioInput(); generateCopyText(); saveData();
        }

        function deleteScenario(scenarioId) {
            if (confirm('このシナリオを削除しますか？')) {
                const scenarios = currencyData[currentCurrency].customScenarios;
                const index = scenarios.findIndex(s => s.id === scenarioId);
                if (index !== -1) { scenarios.splice(index, 1); updateCustomScenarios(); generateCopyText(); saveData(); }
            }
        }

        function updateCustomScenarios() {
            const container = document.getElementById('customScenariosContainer');
            container.innerHTML = '';
            const scenarios = currencyData[currentCurrency].customScenarios || [];
            scenarios.forEach(scenario => {
                const scenarioDiv = document.createElement('div');
                scenarioDiv.className = 'custom-scenario-item';
                scenarioDiv.innerHTML = `<button class="delete-scenario-btn" onclick="deleteScenario(${scenario.id})">×</button><div class="scenario-title">${scenario.title}</div><div class="scenario-desc">${scenario.desc}</div>`;
                container.appendChild(scenarioDiv);
            });
        }

        function sendToChatGPTBrowser() { window.open('https://chat.openai.com/', '_blank'); showStatus('ChatGPTが新しいタブで開かれました。', 'success'); }
        function toggleCopyTextArea() { const copyArea = document.getElementById('copyTextArea'); if (copyArea.classList.contains('active')) { copyArea.classList.remove('active'); } else { copyArea.classList.add('active'); generateCopyText(); } }
        function closeCopyArea() { document.getElementById('copyTextArea').classList.remove('active'); }

        function generateCopyText() {
            const data = currencyData[currentCurrency];
            const currentImageStatus = data.imageStatuses[currentImage] || 'considering';
            const statusText = { 'considering': '🤔 検討中', 'skip': '⏭️ 見送り', 'missed': '😞 見逃し', 'pending': '📋 現在指値中', 'holding': '💼 保持中', 'completed': '✅ 完了' };
            const waveText = { 'unselected': '未選択', '1h': '1時間足', '4h': '4時間足', '1d': '日足' };
            const fixedPrompt = document.getElementById('fixedPrompt').value || defaultFixedPrompt;
            let message = `${fixedPrompt}\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n📊 **基本情報**\n・通貨ペア: ${data.pair}\n・現在の画像: ${currentImage}\n・分析ステータス: ${statusText[currentImageStatus]}\n・狙う波: ${waveText[data.wave]}\n・時間軸: ${data.timeframe}\n・分析日時: ${new Date().toLocaleString('ja-JP')}\n\n📝 **分析メモ**\n${document.getElementById('analysisMemo').value || '記載なし'}\n`;
            if (data.customScenarios.length > 0) { message += `\n🎯 **カスタムシナリオ**\n`; data.customScenarios.forEach((scenario, index) => { message += `${index + 1}. **${scenario.title}**: ${scenario.desc}\n`; }); }
            message += `\n**注意**: この後にチャート画像をアップロードしますので、画像と合わせて総合的な分析をお願いします。`;
            document.getElementById('copyTextarea').value = message;
        }

        function copyAllText() { const textarea = document.getElementById('copyTextarea'); textarea.select(); navigator.clipboard.writeText(textarea.value).then(() => { showStatus('全文をクリップボードにコピーしました', 'success'); }).catch(() => { document.execCommand('copy'); showStatus('全文をクリップボードにコピーしました', 'success'); }); }

        function copyMemoOnly() {
            const memo = document.getElementById('analysisMemo').value || '記載なし';
            const fixedPrompt = document.getElementById('fixedPrompt').value || defaultFixedPrompt;
            const data = currencyData[currentCurrency];
            const memoText = `${fixedPrompt}\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n📝 **${data.pair} 分析メモ**\n${memo}\n\n**注意**: この後にチャート画像をアップロードしますので、画像と合わせて総合的な分析をお願いします。`;
            navigator.clipboard.writeText(memoText).then(() => { showStatus('分析メモをクリップボードにコピーしました', 'success'); }).catch(() => { const textarea = document.createElement('textarea'); textarea.value = memoText; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); showStatus('分析メモをクリップボードにコピーしました', 'success'); });
        }

        function copyScenariosOnly() {
            const data = currencyData[currentCurrency];
            const fixedPrompt = document.getElementById('fixedPrompt').value || defaultFixedPrompt;
            let scenarioText = `${fixedPrompt}\n\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n🎯 **${data.pair} カスタムシナリオ**\n`;
            if (data.customScenarios.length > 0) { data.customScenarios.forEach((scenario, index) => { scenarioText += `${index + 1}. **${scenario.title}**: ${scenario.desc}\n`; }); } else { scenarioText += '設定されたカスタムシナリオはありません。'; }
            scenarioText += `\n**注意**: この後にチャート画像をアップロードしますので、画像と合わせて総合的な分析をお願いします。`;
            navigator.clipboard.writeText(scenarioText).then(() => { showStatus('カスタムシナリオをクリップボードにコピーしました', 'success'); }).catch(() => { const textarea = document.createElement('textarea'); textarea.value = scenarioText; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); showStatus('カスタムシナリオをクリップボードにコピーしました', 'success'); });
        }

        // 管理機能（完全実装）
        function showAddImageModal() { updateCurrencySelectors(); document.getElementById('addImageModal').classList.add('active'); }
        function closeAddImageModal() { document.getElementById('addImageModal').classList.remove('active'); document.getElementById('newImageFile').value = ''; document.getElementById('newImageLabel').value = ''; }

        function addNewImage() {
            const currency = document.getElementById('targetCurrency').value;
            const file = document.getElementById('newImageFile').files[0];
            const label = document.getElementById('newImageLabel').value.trim();
            if (!currency || !file || !label) { alert('全ての項目を入力してください。'); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageName = `${currency}_${Date.now()}.${file.name.split('.').pop()}`;
                currencyData[currency].images.push(imageName); currencyData[currency].imageLabels.push(label); currencyData[currency].imageStatuses[imageName] = 'considering'; allImages.push(imageName); uploadedImages[imageName] = e.target.result;
                if (currentCurrency === currency) { updateImageButtons(); }
                updatePageInfo(); closeAddImageModal(); showStatus(`${label} を ${currencyData[currency].pair} に追加しました！`, 'success'); saveData();
            };
            reader.readAsDataURL(file);
        }

        function showDeleteImageModal() { updateImageSelectors(); document.getElementById('deleteImageModal').classList.add('active'); }
        function closeDeleteImageModal() { document.getElementById('deleteImageModal').classList.remove('active'); }

        function updateImageSelectors() {
            const currencySelector = document.getElementById('deleteImageCurrency');
            const imageSelector = document.getElementById('deleteImageSelect');
            currencySelector.innerHTML = '';
            Object.keys(currencyData).forEach(currency => { const option = document.createElement('option'); option.value = currency; option.textContent = currencyData[currency].pair; currencySelector.appendChild(option); });
            currencySelector.onchange = function() { updateImageSelectOptions(); };
            updateImageSelectOptions();
        }

        function updateImageSelectOptions() {
            const currency = document.getElementById('deleteImageCurrency').value;
            const imageSelector = document.getElementById('deleteImageSelect');
            imageSelector.innerHTML = '';
            if (currency && currencyData[currency]) { currencyData[currency].images.forEach((image, index) => { const option = document.createElement('option'); option.value = image; option.textContent = currencyData[currency].imageLabels[index]; imageSelector.appendChild(option); }); }
        }

        function deleteImage() {
            const currency = document.getElementById('deleteImageCurrency').value;
            const imageName = document.getElementById('deleteImageSelect').value;
            if (!currency || !imageName) { alert('削除するシナリオを選択してください。'); return; }
            const data = currencyData[currency];
            const imageIndex = data.images.indexOf(imageName);
            if (imageIndex === -1) { alert('選択されたシナリオが見つかりません。'); return; }
            const scenarioName = data.imageLabels[imageIndex];
            if (!confirm(`${currencyData[currency].pair} の「${scenarioName}」を削除しますか？\nこの操作は取り消せません。`)) { return; }
            data.images.splice(imageIndex, 1); data.imageLabels.splice(imageIndex, 1); delete data.imageStatuses[imageName];
            const allImageIndex = allImages.indexOf(imageName);
            if (allImageIndex !== -1) { allImages.splice(allImageIndex, 1); }
            delete uploadedImages[imageName];
            if (currentImage === imageName) {
                if (data.images.length > 0) { currentImage = data.images[0]; } else {
                    const remainingCurrencies = Object.keys(currencyData).filter(c => currencyData[c].images.length > 0);
                    if (remainingCurrencies.length > 0) { currentCurrency = remainingCurrencies[0]; currentImage = currencyData[currentCurrency].images[0]; updateCurrencyTabs(); updateDisplay(); updateCustomScenarios(); }
                }
            }
            if (currentCurrency === currency) { updateImageButtons(); loadCurrentImage(); }
            updatePageInfo(); closeDeleteImageModal(); showStatus(`${scenarioName} を削除しました。`, 'success'); saveData();
        }

        function showAddCurrencyModal() { document.getElementById('addCurrencyModal').classList.add('active'); }
        function closeAddCurrencyModal() { document.getElementById('addCurrencyModal').classList.remove('active'); document.getElementById('newCurrencyName').value = ''; document.getElementById('newCurrencyDisplay').value = ''; document.getElementById('newCurrencyTimeframe').value = ''; }

        function addNewCurrency() {
            const name = document.getElementById('newCurrencyName').value.trim().toUpperCase();
            const display = document.getElementById('newCurrencyDisplay').value.trim();
            const timeframe = document.getElementById('newCurrencyTimeframe').value.trim();
            if (!name || !display || !timeframe) { alert('全ての項目を入力してください。'); return; }
            if (currencyData[name]) { alert('この通貨ペアは既に存在します。'); return; }
            currencyData[name] = { pair: display, status: 'considering', wave: 'unselected', timeframe: timeframe, images: [], imageLabels: [], imageStatuses: {}, memo: '', customScenarios: [] };
            updateCurrencyTabs(); updateCurrencySelectors(); closeAddCurrencyModal(); showStatus(`${display} を追加しました！`, 'success'); saveData();
        }

        function showDeleteCurrencyModal() { updateCurrencySelectors(); document.getElementById('deleteCurrencyModal').classList.add('active'); }
        function closeDeleteCurrencyModal() { document.getElementById('deleteCurrencyModal').classList.remove('active'); }

        function deleteCurrency() {
            const currency = document.getElementById('deleteCurrency').value;
            if (!currency) { alert('削除する通貨ペアを選択してください。'); return; }
            if (!confirm(`${currencyData[currency].pair} を完全に削除しますか？\nこの操作は取り消せません。`)) { return; }
            currencyData[currency].images.forEach(imageName => { const index = allImages.indexOf(imageName); if (index !== -1) { allImages.splice(index, 1); } delete uploadedImages[imageName]; });
            delete currencyData[currency];
            if (currentCurrency === currency) { const remainingCurrencies = Object.keys(currencyData); if (remainingCurrencies.length > 0) { selectCurrency(remainingCurrencies[0]); } }
            updateCurrencyTabs(); updatePageInfo(); closeDeleteCurrencyModal(); showStatus(`通貨ペアを削除しました。`, 'success'); saveData();
        }

        function updateCurrencySelectors() {
            const selectors = ['targetCurrency', 'deleteCurrency'];
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) { selector.innerHTML = ''; Object.keys(currencyData).forEach(currency => { const option = document.createElement('option'); option.value = currency; option.textContent = currencyData[currency].pair; selector.appendChild(option); }); }
            });
        }

        function returnToTop() { currentPageNum = 1; currentCurrency = 'USDJPY'; currentImage = 'USDJPY.jpeg'; updateCurrencyTabs(); updateDisplay(); updateImageButtons(); loadCurrentImage(); updateCustomScenarios(); updatePageInfo(); window.scrollTo({ top: 0, behavior: 'smooth' }); saveData(); }

        function nextPage() { const totalPages = getTotalPages(); if (currentPageNum < totalPages) { currentPageNum++; const nextImageName = allImages[currentPageNum - 1]; switchToImagePage(nextImageName); updatePageInfo(); } }
        function previousPage() { if (currentPageNum > 1) { currentPageNum--; const prevImageName = allImages[currentPageNum - 1]; switchToImagePage(prevImageName); updatePageInfo(); } }

        function switchToImagePage(imageName) {
            currentImage = imageName;
            for (const [currency, data] of Object.entries(currencyData)) {
                if (data.images.includes(imageName)) {
                    if (currentCurrency !== currency) { currentCurrency = currency; updateCurrencyTabs(); updateDisplay(); updateCustomScenarios(); }
                    updateImageButtons(); break;
                }
            }
            loadCurrentImage(); updateCurrentImageInfo(); generateCopyText(); saveData();
        }

        function updatePageInfo() { const totalPages = getTotalPages(); document.getElementById('currentPage').textContent = currentPageNum; document.getElementById('totalPages').textContent = totalPages; document.getElementById('prevBtn').disabled = currentPageNum === 1; document.getElementById('nextBtn').disabled = currentPageNum === totalPages; }

        function openChartModal() {
            const modal = document.getElementById('chartModal');
            modal.classList.add('active');
            const modalChart = document.getElementById('modalChart');
            const chartImage = document.getElementById('chartImage');
            if (chartImage.style.display !== 'none' && chartImage.src) { modalChart.src = chartImage.src; } else { modalChart.src = 'data:image/svg+xml;base64,' + btoa(`<svg width="800" height="600" xmlns="http://www.w3.org/2000/svg"><rect width="800" height="600" fill="#f8f9fa"/><text x="400" y="280" text-anchor="middle" font-size="24" fill="#6c757d">${currencyData[currentCurrency].pair} チャート</text><text x="400" y="320" text-anchor="middle" font-size="16" fill="#6c757d">${currentImage} が見つかりません</text></svg>`); }
        }

        function closeChartModal() { document.getElementById('chartModal').classList.remove('active'); }

        function shareAnalysis() {
            const data = currencyData[currentCurrency];
            const currentImageStatus = data.imageStatuses[currentImage] || 'considering';
            const statusText = { 'considering': '🤔 検討中', 'skip': '⏭️ 見送り', 'missed': '😞 見逃し', 'pending': '📋 指値逆指値中', 'holding': '💼 保持中', 'completed': '✅ 完了' };
            const waveText = { 'unselected': '未選択', '1h': '1時間足', '4h': '4時間足', '1d': '日足' };
            let shareText = `${data.pair} 分析レポート\n画像: ${currentImage}\nステータス: ${statusText[currentImageStatus]}\n狙う波: ${waveText[data.wave]}\n\n分析メモ:\n${document.getElementById('analysisMemo').value}\n\n`;
            if (data.customScenarios.length > 0) { shareText += `カスタムシナリオ:\n`; data.customScenarios.forEach(scenario => { shareText += `・${scenario.title}: ${scenario.desc}\n`; }); }
            if (navigator.share) { navigator.share({ title: `${data.pair} 分析レポート`, text: shareText, url: window.location.href }); } else { navigator.clipboard.writeText(shareText); alert('分析内容をクリップボードにコピーしました'); }
        }

        function updateTimestamp() { const now = new Date(); const timeString = now.toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); document.getElementById('lastUpdate').textContent = timeString; document.getElementById('footerUpdate').textContent = timeString; }
        function autoSaveMemo() { const currentMemo = document.getElementById('analysisMemo').value; currencyData[currentCurrency].memo = currentMemo; generateCopyText(); saveData(); }

        // イベントリスナー
        document.addEventListener('DOMContentLoaded', function() { initializePage(); updateTimestamp(); setInterval(updateTimestamp, 300000); setInterval(autoSaveMemo, 5000); });
        document.getElementById('chartModal').addEventListener('click', function(e) { if (e.target === this) { closeChartModal(); } });
        document.querySelectorAll('.management-modal').forEach(modal => { modal.addEventListener('click', function(e) { if (e.target === this) { this.classList.remove('active'); } }); });
        document.addEventListener('click', function(e) { if (e.target.classList.contains('usage-modal')) { closeUsageModal(); } if (e.target.classList.contains('cleanup-modal')) { closeCleanupModal(); } });
        document.addEventListener('keydown', function(e) { if (e.key === 'ArrowLeft') { previousPage(); } else if (e.key === 'ArrowRight') { nextPage(); } else if (e.key === 'Escape') { closeChartModal(); hideScenarioInput(); document.querySelectorAll('.management-modal').forEach(modal => { modal.classList.remove('active'); }); closeUsageModal(); closeCleanupModal(); } });
    </script>
</body>
</html>
