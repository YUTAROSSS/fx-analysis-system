<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </title>
    
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getDatabase, ref, set, get, onValue, off, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

      const firebaseConfig = {
        apiKey: "AIzaSyBMwI1i8DSnFYSBhz_zv80oGYaRmqvXEzA",
        authDomain: "fx-analysis-system.firebaseapp.com",
        databaseURL: "https://fx-analysis-system-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fx-analysis-system",
        storageBucket: "fx-analysis-system.firebasestorage.app",
        messagingSenderId: "286393020262",
        appId: "1:286393020262:web:eee0ede07040002b4762a7"
      };

      try {
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
        window.firebaseUpdate = update;
        console.log('âœ… FirebaseåˆæœŸåŒ–æˆåŠŸ');
      } catch (error) {
        console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        window.firebaseApp = null;
        window.firebaseDatabase = null;
      }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
        .container { max-width: 1280px; margin: 0 auto; background: white; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .header h1 { font-size: 20px; font-weight: 600; }
        .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: all 0.3s ease; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        
        .main-content { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .section { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #e9ecef; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .section-title { font-size: 14px; font-weight: 600; color: #495057; }
        .mgmt-btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; margin: 0 4px; }
        .add-btn { background: #28a745; color: white; }
        .delete-btn { background: #dc3545; color: white; }
        
        .currency-tabs { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .currency-tab { padding: 8px 16px; background: white; border: 2px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease; }
        .currency-tab.active { background: #4285f4; color: white; border-color: #4285f4; }
        
        .image-buttons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .scenario-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .image-btn { padding: 8px 16px !important; border: 2px solid #4285f4 !important; border-radius: 8px !important; cursor: pointer !important; font-size: 11px !important; text-align: center !important; min-width: 80px !important; font-weight: 600 !important; background: #4285f4 !important; color: white !important; transition: box-shadow 0.3s ease, transform 0.3s ease !important; }
        .image-btn.selected { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3) !important; transform: translateY(-3px) !important; }
        .image-btn:hover { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important; transform: translateY(-1px) !important; }
        
        .status-label { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; white-space: nowrap; }
        .status-considering { background: #007bff; color: white; }
        
        .sync-status { position: fixed; top: 10px; right: 20px; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 1000; }
        .sync-status.connected { background: #28a745; color: white; }
        .sync-status.disconnected { background: #dc3545; color: white; }
        .sync-status.syncing { background: #ffc107; color: #212529; }
        .sync-status.listening { background: #17a2b8; color: white; }
        
        .currency-display { text-align: center; margin: 20px 0; font-size: 24px; font-weight: 700; color: #2c3e50; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 100%; }
        .modal h3 { margin-bottom: 20px; color: #2c3e50; }
        .modal input { width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; margin-bottom: 15px; font-size: 14px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        
        .last-sync-info { position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; background: rgba(0,0,0,0.7); color: white; border-radius: 5px; font-size: 10px; z-index: 1000; }
        
        .path-fix-btn { background: #6f42c1 !important; color: white !important; font-weight: bold !important; animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @media (max-width: 767px) {
            .header h1 { font-size: 16px; }
            .btn { font-size: 11px; padding: 5px 10px; }
            .main-content { padding: 15px; }
            .currency-pair { font-size: 22px; }
            .mgmt-btn { font-size: 10px; padding: 5px 8px; margin: 2px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sync-status" id="syncStatus">æ¥ç¶šç¢ºèªä¸­...</div>
        <div class="last-sync-info" id="lastSyncInfo">æœ€çµ‚åŒæœŸ: æœªå®Ÿè¡Œ</div>
        
        <div class="header">
            <h1>ğŸ” FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
            <button class="btn" onclick="shareAnalysis()">ğŸ“¤ å…±æœ‰</button>
        </div>

        <div class="main-content">
            <!-- é€šè²¨ãƒšã‚¢é¸æŠ -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">é€šè²¨ãƒšã‚¢é¸æŠ</div>
                    <div>
                        <button class="mgmt-btn add-btn" onclick="showAddCurrencyModal()">â• é€šè²¨ãƒšã‚¢è¿½åŠ </button>
                        <button class="mgmt-btn delete-btn" onclick="showDeleteCurrencyModal()">ğŸ—‘ï¸ é€šè²¨ãƒšã‚¢å‰Šé™¤</button>
                    </div>
                </div>
                <div class="currency-tabs" id="currencyTabs"></div>
            </div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆé¸æŠ -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">ãƒãƒ£ãƒ¼ãƒˆé¸æŠ</div>
                    <div>
                        <button class="mgmt-btn add-btn" onclick="showAddImageModal()">â• ã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
                        <button class="mgmt-btn delete-btn" onclick="showDeleteImageModal()">ğŸ—‘ï¸ ã‚·ãƒŠãƒªã‚ªå‰Šé™¤</button>
                    </div>
                </div>
                <div class="image-buttons" id="imageButtons"></div>
            </div>
            
            <!-- é€šè²¨ãƒšã‚¢è¡¨ç¤º -->
            <div class="currency-display" id="currencyDisplay">USD/JPY</div>
            
            <!-- ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">ğŸ”§ ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½</div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="mgmt-btn" style="background: #17a2b8; color: white;" onclick="testFirebaseConnection()">Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                    <button class="mgmt-btn path-fix-btn" onclick="fixFirebasePath()">ğŸ”§ ãƒ‘ã‚¹çµ±ä¸€</button>
                    <button class="mgmt-btn" style="background: #28a745; color: white;" onclick="manualSave()">æ‰‹å‹•ä¿å­˜</button>
                    <button class="mgmt-btn" style="background: #6f42c1; color: white;" onclick="addTestScenario()">ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
                    <button class="mgmt-btn" style="background: #e83e8c; color: white;" onclick="mobileDebug()">ğŸ“± ã‚¹ãƒãƒ›ãƒ‡ãƒãƒƒã‚°</button>
                    <button class="mgmt-btn" style="background: #ffc107; color: #212529;" onclick="showFirebaseData()">ğŸ” Firebaseç¢ºèª</button>
                    <button class="mgmt-btn" style="background: #dc3545; color: white;" onclick="resetAllData()">å®Œå…¨ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚·ãƒŠãƒªã‚ªè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="addScenarioModal">
        <div class="modal-content">
            <h3>â• ã‚·ãƒŠãƒªã‚ªè¿½åŠ </h3>
            <input type="text" id="newScenarioName" placeholder="ã‚·ãƒŠãƒªã‚ªå (ä¾‹: ã‚·ãƒŠãƒªã‚ª4)">
            <div class="modal-buttons">
                <button class="mgmt-btn" style="background: #6c757d; color: white;" onclick="closeAddScenarioModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="mgmt-btn add-btn" onclick="addNewScenario()">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <script>
        // çµ±ä¸€ã•ã‚ŒãŸFirebaseãƒ‘ã‚¹ï¼ˆPCãƒ»ã‚¹ãƒãƒ›å…±é€šï¼‰
        const FIREBASE_PATH = 'appData';
        
        // ã‚¢ãƒ—ãƒªçŠ¶æ…‹
        let appState = {
            currentCurrency: "USDJPY",
            currentScenario: "scenario1",
            currencies: {
                USDJPY: "USD/JPY",
                EURUSD: "EUR/USD", 
                GBPUSD: "GBP/USD",
                AUDUSD: "AUD/USD",
                SILVER: "SILVER",
                GOLD: "GOLD"
            },
            scenarios: {
                USDJPY: ["scenario1", "scenario2", "scenario3"],
                EURUSD: ["scenario1", "scenario2"],
                GBPUSD: ["scenario1", "scenario2", "scenario3", "scenario4"],
                AUDUSD: ["scenario1", "scenario2"],
                SILVER: ["scenario1", "scenario2"],
                GOLD: ["scenario1"]
            },
            scenarioLabels: {
                scenario1: "ã‚·ãƒŠãƒªã‚ª1",
                scenario2: "ã‚·ãƒŠãƒªã‚ª2", 
                scenario3: "ã‚·ãƒŠãƒªã‚ª3",
                scenario4: "ã‚·ãƒŠãƒªã‚ª4"
            },
            lastUpdate: Date.now(),
            deviceId: 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            version: '2.0'
        };

        let isConnected = false;
        let realtimeListener = null;
        let lastSyncTimestamp = 0;

        function updateSyncStatus(status, message) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.textContent = message;
            statusDiv.className = `sync-status ${status}`;
            isConnected = (status === 'connected' || status === 'listening');
            
            if (status === 'connected') {
                updateLastSyncInfo();
            }
        }

        function updateLastSyncInfo() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ja-JP');
            document.getElementById('lastSyncInfo').textContent = `æœ€çµ‚åŒæœŸ: ${timeString}`;
            lastSyncTimestamp = Date.now();
        }

        // ğŸ”§ Firebaseãƒ‘ã‚¹çµ±ä¸€æ©Ÿèƒ½
        function fixFirebasePath() {
            console.log('ğŸ”§ Firebaseãƒ‘ã‚¹çµ±ä¸€é–‹å§‹...');
            updateSyncStatus('syncing', 'ğŸ”§ ãƒ‘ã‚¹çµ±ä¸€ä¸­...');
            
            if (!window.firebaseDatabase) {
                alert('âŒ FirebaseæœªåˆæœŸåŒ–ã§ã™');
                updateSyncStatus('disconnected', 'FirebaseæœªåˆæœŸåŒ–');
                return;
            }

            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
            const appDataRef = window.firebaseRef(window.firebaseDatabase, 'appData');
            const fxAppDataRef = window.firebaseRef(window.firebaseDatabase, 'fxAppData');
            
            Promise.all([
                window.firebaseGet(appDataRef),
                window.firebaseGet(fxAppDataRef)
            ]).then(([appDataSnapshot, fxAppDataSnapshot]) => {
                let sourceData = null;
                let sourcePath = '';
                
                // ã©ã¡ã‚‰ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
                if (appDataSnapshot.exists()) {
                    sourceData = appDataSnapshot.val();
                    sourcePath = 'appData';
                    console.log('ğŸ“¥ appDataã«ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹');
                } else if (fxAppDataSnapshot.exists()) {
                    sourceData = fxAppDataSnapshot.val();
                    sourcePath = 'fxAppData';
                    console.log('ğŸ“¥ fxAppDataã«ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹');
                } else {
                    console.log('âŒ ä¸¡æ–¹ã«ãƒ‡ãƒ¼ã‚¿ãªã— - æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ');
                    sourceData = appState;
                    sourcePath = 'æ–°è¦ä½œæˆ';
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’æ–°å½¢å¼ã«å¤‰æ›ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
                const unifiedData = convertToUnifiedFormat(sourceData);
                
                // appDataã«çµ±ä¸€ä¿å­˜
                window.firebaseSet(appDataRef, unifiedData)
                    .then(() => {
                        console.log('âœ… appDataã«çµ±ä¸€ä¿å­˜å®Œäº†');
                        
                        // fxAppDataãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
                        if (fxAppDataSnapshot.exists()) {
                            return window.firebaseSet(fxAppDataRef, null);
                        }
                        return Promise.resolve();
                    })
                    .then(() => {
                        console.log('âœ… ãƒ‘ã‚¹çµ±ä¸€å®Œäº†');
                        
                        // ã‚¢ãƒ—ãƒªçŠ¶æ…‹ã‚’æ›´æ–°
                        appState = unifiedData;
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚æ›´æ–°
                        localStorage.setItem('fxAppState', JSON.stringify(unifiedData));
                        
                        // UIæ›´æ–°
                        updateUI();
                        updateSyncStatus('connected', 'ğŸ”§ ãƒ‘ã‚¹çµ±ä¸€å®Œäº†');
                        
                        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸé–‹å§‹
                        setupRealtimeSync();
                        
                        alert(`âœ… Firebaseãƒ‘ã‚¹çµ±ä¸€å®Œäº†ï¼\n\nå…ƒãƒ‡ãƒ¼ã‚¿: ${sourcePath}\nçµ±ä¸€å…ˆ: appData\n\nPCãƒ»ã‚¹ãƒãƒ›é–“ã®åŒæœŸãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã™ï¼`);
                        
                    })
                    .catch(error => {
                        console.error('âŒ ãƒ‘ã‚¹çµ±ä¸€å¤±æ•—:', error);
                        updateSyncStatus('disconnected', 'ãƒ‘ã‚¹çµ±ä¸€å¤±æ•—');
                        alert(`âŒ ãƒ‘ã‚¹çµ±ä¸€å¤±æ•—: ${error.message}`);
                    });
                
            }).catch(error => {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿ç¢ºèªå¤±æ•—:', error);
                updateSyncStatus('disconnected', 'ãƒ‡ãƒ¼ã‚¿ç¢ºèªå¤±æ•—');
                alert(`âŒ ãƒ‡ãƒ¼ã‚¿ç¢ºèªå¤±æ•—: ${error.message}`);
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’çµ±ä¸€å½¢å¼ã«å¤‰æ›
        function convertToUnifiedFormat(data) {
            // ã™ã§ã«æ–°å½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
            if (data.version === '2.0' && data.scenarios && data.scenarioLabels) {
                return {
                    ...data,
                    lastUpdate: Date.now(),
                    deviceId: appState.deviceId
                };
            }
            
            // æ—§å½¢å¼ã‹ã‚‰æ–°å½¢å¼ã«å¤‰æ›
            const unifiedData = {
                currentCurrency: data.currentCurrency || "USDJPY",
                currentScenario: "scenario1",
                currencies: {},
                scenarios: {},
                scenarioLabels: {},
                lastUpdate: Date.now(),
                deviceId: appState.deviceId,
                version: '2.0'
            };

            // æ—§å½¢å¼ã®currenciesãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
            if (data.currencies) {
                Object.keys(data.currencies).forEach(currencyKey => {
                    const oldCurrency = data.currencies[currencyKey];
                    
                    // é€šè²¨è¡¨ç¤ºåã‚’è¨­å®š
                    unifiedData.currencies[currencyKey] = oldCurrency.pair || currencyKey;
                    
                    // ã‚·ãƒŠãƒªã‚ªã‚’å¤‰æ›
                    if (oldCurrency.labels && oldCurrency.labels.length > 0) {
                        unifiedData.scenarios[currencyKey] = [];
                        
                        oldCurrency.labels.forEach((label, index) => {
                            const scenarioKey = `scenario${index + 1}`;
                            unifiedData.scenarios[currencyKey].push(scenarioKey);
                            unifiedData.scenarioLabels[scenarioKey] = label;
                        });
                    } else {
                        unifiedData.scenarios[currencyKey] = ["scenario1"];
                        if (!unifiedData.scenarioLabels["scenario1"]) {
                            unifiedData.scenarioLabels["scenario1"] = "ã‚·ãƒŠãƒªã‚ª1";
                        }
                    }
                });
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€šè²¨ã‚’è¿½åŠ 
            const defaultCurrencies = {
                USDJPY: "USD/JPY",
                EURUSD: "EUR/USD", 
                GBPUSD: "GBP/USD",
                AUDUSD: "AUD/USD",
                SILVER: "SILVER",
                GOLD: "GOLD"
            };

            Object.keys(defaultCurrencies).forEach(currencyKey => {
                if (!unifiedData.currencies[currencyKey]) {
                    unifiedData.currencies[currencyKey] = defaultCurrencies[currencyKey];
                    unifiedData.scenarios[currencyKey] = ["scenario1"];
                    if (!unifiedData.scenarioLabels["scenario1"]) {
                        unifiedData.scenarioLabels["scenario1"] = "ã‚·ãƒŠãƒªã‚ª1";
                    }
                }
            });

            console.log('ğŸ”„ çµ±ä¸€å½¢å¼ã«å¤‰æ›:', unifiedData);
            return unifiedData;
        }

        // Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
        function testFirebaseConnection() {
            console.log('ğŸ”§ Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
            updateSyncStatus('syncing', 'ãƒ†ã‚¹ãƒˆä¸­...');
            
            if (!window.firebaseDatabase) {
                console.error('âŒ FirebaseæœªåˆæœŸåŒ–');
                updateSyncStatus('disconnected', 'FirebaseæœªåˆæœŸåŒ–');
                return;
            }

            const testRef = window.firebaseRef(window.firebaseDatabase, 'connectionTest');
            const testData = {
                status: "connected",
                time: Date.now(),
                deviceId: appState.deviceId,
                message: "æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ"
            };

            window.firebaseSet(testRef, testData)
                .then(() => {
                    console.log('âœ… Firebaseæ›¸ãè¾¼ã¿æˆåŠŸ');
                    return window.firebaseGet(testRef);
                })
                .then(snapshot => {
                    if (snapshot.exists()) {
                        console.log('âœ… Firebaseèª­ã¿è¾¼ã¿æˆåŠŸ:', snapshot.val());
                        updateSyncStatus('connected', 'Firebaseæ¥ç¶šOK');
                        setupRealtimeSync();
                    } else {
                        console.log('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—');
                        updateSyncStatus('disconnected', 'èª­ã¿è¾¼ã¿å¤±æ•—');
                    }
                })
                .catch(error => {
                    console.error('âŒ Firebaseæ“ä½œå¤±æ•—:', error);
                    updateSyncStatus('disconnected', 'æ¥ç¶šã‚¨ãƒ©ãƒ¼: ' + error.message);
                });
        }

        // Firebase ãƒ‡ãƒ¼ã‚¿ç¢ºèª
        function showFirebaseData() {
            if (!window.firebaseDatabase) {
                alert('âŒ FirebaseæœªåˆæœŸåŒ–ã§ã™');
                return;
            }

            const dataRef = window.firebaseRef(window.firebaseDatabase, FIREBASE_PATH);
            
            window.firebaseGet(dataRef)
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        console.log('ğŸ” Firebaseãƒ‡ãƒ¼ã‚¿:', data);
                        
                        let message = 'ğŸ” Firebase ãƒ‡ãƒ¼ã‚¿ç¢ºèª\n\n';
                        message += `âœ… ãƒ‡ãƒ¼ã‚¿å­˜åœ¨: ã‚ã‚Š\n`;
                        message += `ğŸ”§ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${data.version || 'æ—§å½¢å¼'}\n`;
                        message += `ğŸ’± ç¾åœ¨é€šè²¨: ${data.currentCurrency}\n`;
                        message += `ğŸ“Š ç¾åœ¨ã‚·ãƒŠãƒªã‚ª: ${data.currentScenario || 'ä¸æ˜'}\n`;
                        
                        if (data.version === '2.0') {
                            message += `ğŸ“Š ç·ã‚·ãƒŠãƒªã‚ªæ•°: ${Object.values(data.scenarios || {}).flat().length}å€‹\n`;
                            message += `ğŸ·ï¸ ãƒ©ãƒ™ãƒ«æ•°: ${Object.keys(data.scenarioLabels || {}).length}å€‹`;
                        } else {
                            message += `âš ï¸ æ—§å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã§ã™\nã€ŒğŸ”§ ãƒ‘ã‚¹çµ±ä¸€ã€ãƒœã‚¿ãƒ³ã§å¤‰æ›ã—ã¦ãã ã•ã„`;
                        }
                        
                        alert(message);
                    } else {
                        console.log('âŒ Firebaseãƒ‡ãƒ¼ã‚¿ãªã—');
                        alert('âŒ Firebaseã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    }
                })
                .catch(error => {
                    console.error('âŒ Firebaseç¢ºèªå¤±æ•—:', error);
                    alert(`âŒ Firebaseç¢ºèªå¤±æ•—: ${error.message}`);
                });
        }

        // ã‚¹ãƒãƒ›ãƒ‡ãƒãƒƒã‚°
        function mobileDebug() {
            const debugInfo = {
                åŸºæœ¬æƒ…å ±: {
                    Firebaseæ¥ç¶š: isConnected ? 'âœ… æ¥ç¶šä¸­' : 'âŒ æœªæ¥ç¶š',
                    Firebaseãƒ‘ã‚¹: FIREBASE_PATH,
                    ãƒ‡ãƒã‚¤ã‚¹ID: appState.deviceId.substr(-8),
                    æœ€çµ‚æ›´æ–°: new Date(appState.lastUpdate).toLocaleString('ja-JP'),
                    ãƒãƒ¼ã‚¸ãƒ§ãƒ³: appState.version || 'ä¸æ˜',
                    ç¾åœ¨é€šè²¨: appState.currentCurrency,
                    ç¾åœ¨ã‚·ãƒŠãƒªã‚ª: appState.currentScenario
                },
                ãƒ‡ãƒ¼ã‚¿çŠ¶æ³: {
                    é€šè²¨ãƒšã‚¢æ•°: Object.keys(appState.currencies).length,
                    ç·ã‚·ãƒŠãƒªã‚ªæ•°: Object.values(appState.scenarios).flat().length,
                    ç¾åœ¨é€šè²¨ã®ã‚·ãƒŠãƒªã‚ªæ•°: appState.scenarios[appState.currentCurrency]?.length || 0,
                    ã‚·ãƒŠãƒªã‚ªãƒ©ãƒ™ãƒ«æ•°: Object.keys(appState.scenarioLabels).length
                },
                ç¾åœ¨ã®ã‚·ãƒŠãƒªã‚ªä¸€è¦§: appState.scenarios[appState.currentCurrency]?.map(key => 
                    appState.scenarioLabels[key] || key
                ) || []
            };

            let alertMessage = '=== ğŸ“± ã‚¹ãƒãƒ›ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===\n\n';
            alertMessage += `ğŸ”— Firebase: ${debugInfo.åŸºæœ¬æƒ…å ±.Firebaseæ¥ç¶š}\n`;
            alertMessage += `ğŸ“‚ ãƒ‘ã‚¹: ${debugInfo.åŸºæœ¬æƒ…å ±.Firebaseãƒ‘ã‚¹}\n`;
            alertMessage += `ğŸ“± ãƒ‡ãƒã‚¤ã‚¹: ...${debugInfo.åŸºæœ¬æƒ…å ±.ãƒ‡ãƒã‚¤ã‚¹ID}\n`;
            alertMessage += `â° æœ€çµ‚æ›´æ–°: ${debugInfo.åŸºæœ¬æƒ…å ±.æœ€çµ‚æ›´æ–°}\n`;
            alertMessage += `ğŸ”§ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${debugInfo.åŸºæœ¬æƒ…å ±.ãƒãƒ¼ã‚¸ãƒ§ãƒ³}\n`;
            alertMessage += `ğŸ’± ç¾åœ¨é€šè²¨: ${debugInfo.åŸºæœ¬æƒ…å ±.ç¾åœ¨é€šè²¨}\n`;
            alertMessage += `ğŸ“Š ã‚·ãƒŠãƒªã‚ªæ•°: ${debugInfo.ãƒ‡ãƒ¼ã‚¿çŠ¶æ³.ç¾åœ¨é€šè²¨ã®ã‚·ãƒŠãƒªã‚ªæ•°}å€‹\n\n`;
            alertMessage += `ğŸ“‹ ç¾åœ¨ã®ã‚·ãƒŠãƒªã‚ª:\n${debugInfo.ç¾åœ¨ã®ã‚·ãƒŠãƒªã‚ªä¸€è¦§.join(', ')}`;

            alert(alertMessage);
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã®è¨­å®š
        function setupRealtimeSync() {
            if (!window.firebaseDatabase || !isConnected) {
                console.log('âš ï¸ Firebaseæœªæ¥ç¶š - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }

            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
            if (realtimeListener) {
                const dataRef = window.firebaseRef(window.firebaseDatabase, FIREBASE_PATH);
                window.firebaseOff(dataRef, 'value', realtimeListener);
                console.log('ğŸ“´ æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤');
            }

            const dataRef = window.firebaseRef(window.firebaseDatabase, FIREBASE_PATH);
            
            realtimeListener = window.firebaseOnValue(dataRef, (snapshot) => {
                if (snapshot.exists()) {
                    const remoteData = snapshot.val();
                    console.log('ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°å—ä¿¡:', {
                        remoteVersion: remoteData.version,
                        remoteDeviceId: remoteData.deviceId?.substr(-8),
                        remoteLastUpdate: new Date(remoteData.lastUpdate).toLocaleTimeString(),
                        currentDeviceId: appState.deviceId.substr(-8),
                        shouldUpdate: remoteData.deviceId !== appState.deviceId && remoteData.lastUpdate > appState.lastUpdate
                    });
                    
                    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³2.0ä»¥ä¸Šã§ã€ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®æ›´æ–°ã®å ´åˆã®ã¿é©ç”¨
                    if (remoteData.version === '2.0' && 
                        remoteData.deviceId !== appState.deviceId && 
                        remoteData.lastUpdate > appState.lastUpdate) {
                        
                        console.log('ğŸ“¥ ä»–ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã®æ›´æ–°ã‚’é©ç”¨');
                        
                        // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                        appState = {
                            ...remoteData,
                            deviceId: appState.deviceId // ãƒ‡ãƒã‚¤ã‚¹IDã¯ä¿æŒ
                        };
                        
                        // UIæ›´æ–°
                        updateUI();
                        updateSyncStatus('listening', 'ä»–ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰æ›´æ–°');
                        
                        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚æ›´æ–°
                        localStorage.setItem('fxAppState', JSON.stringify(appState));
                    }
                } else {
                    console.log('ğŸ“­ Firebaseãƒ‡ãƒ¼ã‚¿ãªã—');
                }
            }, (error) => {
                console.error('âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                updateSyncStatus('disconnected', 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚¨ãƒ©ãƒ¼');
            });

            updateSyncStatus('listening', 'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­');
            console.log('âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸé–‹å§‹');
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveData() {
            return new Promise((resolve, reject) => {
                console.log('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹...');
                updateSyncStatus('syncing', 'ä¿å­˜ä¸­...');

                appState.lastUpdate = Date.now();
                appState.version = '2.0';

                // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
                try {
                    localStorage.setItem('fxAppState', JSON.stringify(appState));
                    console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å®Œäº†');
                } catch (error) {
                    console.error('âŒ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å¤±æ•—:', error);
                    updateSyncStatus('disconnected', 'ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å¤±æ•—');
                    reject(error);
                    return;
                }

                // Firebaseä¿å­˜
                if (window.firebaseDatabase && isConnected) {
                    const dataRef = window.firebaseRef(window.firebaseDatabase, FIREBASE_PATH);
                    
                    window.firebaseSet(dataRef, appState)
                        .then(() => {
                            console.log('âœ… Firebaseä¿å­˜å®Œäº†');
                            updateSyncStatus('connected', 'ä¿å­˜å®Œäº†');
                            resolve();
                        })
                        .catch(error => {
                            console.error('âŒ Firebaseä¿å­˜å¤±æ•—:', error);
                            updateSyncStatus('connected', 'ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿å®Œäº†');
                            resolve();
                        });
                } else {
                    console.log('âš ï¸ Firebaseæœªæ¥ç¶š - ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ä¿å­˜');
                    updateSyncStatus('disconnected', 'ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ä¿å­˜');
                    resolve();
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadData() {
            const saved = localStorage.getItem('fxAppState');
            if (saved) {
                try {
                    const loadedState = JSON.parse(saved);
                    appState = { ...appState, ...loadedState };
                    
                    if (!appState.deviceId) {
                        appState.deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    
                    console.log('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', {
                        deviceId: appState.deviceId.substr(-8),
                        version: appState.version,
                        scenarioCount: Object.values(appState.scenarios).flat().length
                    });
                } catch (error) {
                    console.error('âŒ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—:', error);
                }
            }
            updateUI();
        }

        function updateUI() {
            updateCurrencyTabs();
            updateScenarioButtons();
            updateCurrencyDisplay();
        }

        function updateCurrencyTabs() {
            const container = document.getElementById('currencyTabs');
            container.innerHTML = '';
            
            Object.keys(appState.currencies).forEach(currencyKey => {
                const tab = document.createElement('div');
                tab.className = 'currency-tab' + (currencyKey === appState.currentCurrency ? ' active' : '');
                tab.textContent = appState.currencies[currencyKey];
                tab.onclick = function() { 
                    appState.currentCurrency = currencyKey;
                    if (appState.scenarios[currencyKey] && appState.scenarios[currencyKey].length > 0) {
                        appState.currentScenario = appState.scenarios[currencyKey][0];
                    }
                    updateUI();
                    saveData();
                };
                container.appendChild(tab);
            });
        }

        function updateScenarioButtons() {
            const container = document.getElementById('imageButtons');
            container.innerHTML = '';
            
            const currentScenarios = appState.scenarios[appState.currentCurrency] || [];
            
            currentScenarios.forEach(scenarioKey => {
                const scenarioItem = document.createElement('div');
                scenarioItem.className = 'scenario-item';
                
                const btn = document.createElement('div');
                btn.className = 'image-btn';
                btn.textContent = appState.scenarioLabels[scenarioKey] || scenarioKey;
                btn.onclick = function() { 
                    appState.currentScenario = scenarioKey;
                    updateScenarioButtons();
                    saveData();
                };
                
                if (scenarioKey === appState.currentScenario) {
                    btn.classList.add('selected');
                }
                
                const statusLabel = document.createElement('div');
                statusLabel.className = 'status-label status-considering';
                statusLabel.textContent = 'ğŸ¤” æ¤œè¨ä¸­';
                
                scenarioItem.appendChild(btn);
                scenarioItem.appendChild(statusLabel);
                container.appendChild(scenarioItem);
            });
        }

        function updateCurrencyDisplay() {
            const display = document.getElementById('currencyDisplay');
            display.textContent = appState.currencies[appState.currentCurrency] || appState.currentCurrency;
        }

        // ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªè¿½åŠ 
        function addTestScenario() {
            showAddImageModal();
        }

        function showAddImageModal() {
            document.getElementById('addScenarioModal').classList.add('active');
            document.getElementById('newScenarioName').focus();
        }

        function closeAddScenarioModal() {
            document.getElementById('addScenarioModal').classList.remove('active');
            document.getElementById('newScenarioName').value = '';
        }

        function addNewScenario() {
            const scenarioName = document.getElementById('newScenarioName').value.trim();
            if (!scenarioName) {
                alert('ã‚·ãƒŠãƒªã‚ªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const scenarioKey = 'scenario' + Date.now();
            appState.scenarioLabels[scenarioKey] = scenarioName;
            
            if (!appState.scenarios[appState.currentCurrency]) {
                appState.scenarios[appState.currentCurrency] = [];
            }
            appState.scenarios[appState.currentCurrency].push(scenarioKey);
            
            appState.currentScenario = scenarioKey;
            
            console.log('æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªè¿½åŠ :', {
                name: scenarioName,
                key: scenarioKey,
                currency: appState.currentCurrency
            });
            
            updateUI();
            saveData();
            closeAddScenarioModal();
            
            alert(`âœ… "${scenarioName}" ã‚’ ${appState.currencies[appState.currentCurrency]} ã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
        }

        // æ‰‹å‹•ä¿å­˜
        function manualSave() {
            saveData()
                .then(() => {
                    alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ä¿å­˜ã—ã¾ã—ãŸï¼');
                })
                .catch(error => {
                    alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                });
        }

        // å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
        function resetAllData() {
            if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                localStorage.clear();
                if (window.firebaseDatabase) {
                    const dataRef = window.firebaseRef(window.firebaseDatabase, FIREBASE_PATH);
                    window.firebaseSet(dataRef, null);
                }
                location.reload();
            }
        }

        // ãƒ€ãƒŸãƒ¼é–¢æ•°
        function shareAnalysis() { alert('å…±æœ‰æ©Ÿèƒ½ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        function showAddCurrencyModal() { alert('é€šè²¨ãƒšã‚¢è¿½åŠ ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        function showDeleteCurrencyModal() { alert('é€šè²¨ãƒšã‚¢å‰Šé™¤ï¼ˆé–‹ç™ºä¸­ï¼‰'); }
        function showDeleteImageModal() { alert('ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ï¼ˆé–‹ç™ºä¸­ï¼‰'); }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®é–‰ã˜ã‚‹å‡¦ç†
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ FXã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹', { 
                deviceId: appState.deviceId.substr(-8),
                firebasePath: FIREBASE_PATH
            });
            
            loadData();
            
            setTimeout(() => {
                testFirebaseConnection();
            }, 1000);
        });

        // ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã«ãªã‚‹å‰ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            if (realtimeListener && window.firebaseDatabase) {
                const dataRef = window.firebaseRef(window.firebaseDatabase, FIREBASE_PATH);
                window.firebaseOff(dataRef, 'value', realtimeListener);
                console.log('ğŸ“´ ãƒšãƒ¼ã‚¸çµ‚äº†æ™‚ã«ãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—');
            }
        });
    </script>
</body>
</html>
