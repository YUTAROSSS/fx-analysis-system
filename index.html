<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX通貨ペア分析管理システム</title>
    
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-primary: #4285f4;
            --accent-success: #28a745;
            --accent-warning: #ffc107;
            --accent-danger: #dc3545;
            --accent-info: #17a2b8;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #555555;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            background: var(--bg-primary);
            box-shadow: var(--shadow);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* ヘッダー */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            position: relative;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        /* テーマ切り替えボタン */
        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(180deg);
        }

        /* 同期状態表示 */
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
            max-width: 300px;
        }

        .sync-status.connected {
            background: var(--accent-success);
            color: white;
        }

        .sync-status.syncing {
            background: var(--accent-warning);
            color: #212529;
        }

        .sync-status.error {
            background: var(--accent-danger);
            color: white;
        }

        /* メインコンテンツ */
        .main-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* セクション共通 */
        .section {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-buttons {
            display: flex;
            gap: 8px;
        }

        .section-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .add-btn {
            background: var(--accent-success);
            color: white;
        }

        .delete-btn {
            background: var(--accent-danger);
            color: white;
        }

        .save-btn {
            background: var(--accent-primary);
            color: white;
        }

        /* 通貨ペアタブ */
        .currency-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .currency-tabs {
                justify-content: flex-start;
            }
        }

        .currency-tab {
            padding: 8px 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-primary);
        }

        .currency-tab.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* シナリオボタン */
        .scenario-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .scenario-buttons {
                justify-content: flex-start;
            }
        }

        .scenario-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .scenario-btn {
            padding: 8px 16px;
            border: 2px solid var(--accent-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 80px;
            font-weight: 600;
            background: var(--accent-primary);
            color: white;
        }

        .scenario-btn.active {
            box-shadow: 0 8px 16px rgba(66, 133, 244, 0.6);
            transform: translateY(-3px);
        }

        .status-label {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-considering { background: #007bff; color: white; }
        .status-skip { background: #6c757d; color: white; }
        .status-missed { background: #6c757d; color: white; }
        .status-pending { background: var(--accent-danger); color: white; }
        .status-holding { background: var(--accent-danger); color: white; }
        .status-completed { background: #6c757d; color: white; }

        /* 通貨ペア名表示 */
        .currency-info {
            text-align: center;
            margin: 20px 0;
        }

        .currency-pair {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* チャートエリア */
        .chart-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .chart-container {
            width: 100%;
            max-width: 800px;
            height: 60vh;
            min-height: 400px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-primary);
        }

        .chart-container:hover {
            transform: scale(1.01);
            box-shadow: var(--shadow);
        }

        .chart-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .chart-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--bg-secondary) 25%, transparent 25%), 
                        linear-gradient(-45deg, var(--bg-secondary) 25%, transparent 25%);
            background-size: 20px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 600;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        /* ナビゲーション */
        .chart-navigation {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .return-btn {
            background: var(--accent-success);
        }

        .return-btn:hover {
            background: #218838;
        }

        /* 分析コントロール */
        .analysis-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .analysis-controls {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (min-width: 1024px) {
            .analysis-controls {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        .control-section {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .status-buttons, .wave-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        @media (min-width: 768px) {
            .status-buttons, .wave-buttons {
                grid-template-columns: 1fr;
            }
        }

        .status-btn, .wave-btn {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            text-align: center;
            font-weight: 600;
            color: var(--text-primary);
        }

        .status-btn.active {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        .wave-btn.unselected.active {
            border-color: #6c757d;
            background: #6c757d;
            color: white;
        }

        .wave-btn.wave-1h.active {
            border-color: #9acd32;
            background: #9acd32;
            color: white;
        }

        .wave-btn.wave-4h.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .wave-btn.wave-1d.active {
            border-color: var(--accent-danger);
            background: var(--accent-danger);
            color: white;
        }

        /* 分析メモ */
        .memo-area {
            grid-column: 1 / -1;
        }

        .analysis-memo {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: vertical;
            font-size: 12px;
            line-height: 1.4;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .analysis-memo:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        /* ChatGPT連携 */
        .chatgpt-section {
            background: #e8f4fd;
            border: 2px solid #007bff;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
        }

        [data-theme="dark"] .chatgpt-section {
            background: #1a2332;
            border-color: #4a90e2;
        }

        .chatgpt-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chatgpt-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .chatgpt-open-btn {
            background: var(--accent-success);
            color: white;
            font-size: 14px;
            padding: 10px 20px;
        }

        .copy-btn {
            background: #007bff;
            color: white;
        }

        .prompt-textarea, .copy-textarea {
            width: 100%;
            height: 150px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: vertical;
            font-size: 12px;
            line-height: 1.4;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: monospace;
        }

        .copy-area {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .copy-area.active {
            display: block;
        }

        /* フッター */
        .footer {
            background: var(--bg-secondary);
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .page-info {
            color: var(--text-secondary);
            font-size: 12px;
            text-align: center;
        }

        .debug-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .debug-btn {
            padding: 5px 10px;
            font-size: 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .debug-save { background: #007bff; color: white; }
        .debug-check { background: var(--accent-success); color: white; }
        .debug-firebase { background: var(--accent-info); color: white; }
        .debug-reset { background: var(--accent-danger); color: white; }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 95%;
            max-height: 95%;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .modal img {
            width: 100%;
            height: auto;
            display: block;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            z-index: 1001;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .management-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .management-modal.active {
            display: flex;
        }

        .management-modal-content {
            background: var(--bg-primary);
            padding: 25px;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .management-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .management-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .mgmt-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .cancel-btn { background: #6c757d; color: white; }

        /* ドラッグ&ドロップ */
        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drop-zone.dragover {
            border-color: var(--accent-primary);
            background: rgba(66, 133, 244, 0.1);
        }

        /* レスポンシブ */
        @media (max-width: 767px) {
            .header h1 { font-size: 16px; }
            .main-content { padding: 15px; }
            .chart-container { height: 50vh; min-height: 300px; }
            .currency-pair { font-size: 22px; }
            .analysis-controls { grid-template-columns: 1fr; }
            .memo-area { grid-column: 1; }
            .chart-navigation { flex-direction: column; gap: 10px; }
            .nav-btn { width: 100%; }
            .section-buttons { flex-direction: column; gap: 5px; }
            .section-btn { width: 100%; }
            .scenario-item { flex-direction: column; align-items: flex-start; gap: 4px; }
            .debug-buttons { flex-direction: column; gap: 5px; }
            .debug-btn { width: 100%; }
            .chatgpt-controls { flex-direction: column; gap: 8px; }
            .chatgpt-btn { width: 100%; }
            .sync-status { position: relative; top: auto; right: auto; margin-bottom: 10px; max-width: 100%; }
        }
    </style>
</head>
<body>
    <!-- 同期状態表示 -->
    <div class="sync-status error" id="syncStatus">
        🔴 Supabase接続確認中...
    </div>

    <div class="container">
        <!-- ヘッダー -->
        <div class="header">
            <h1>🔍 FX通貨ペア分析システム</h1>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">🌙</span>
                </button>
                <button class="btn btn-secondary" onclick="shareAnalysis()">📤 共有</button>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- 通貨ペア選択 -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">通貨ペア選択</div>
                    <div class="section-buttons">
                        <button class="section-btn add-btn" onclick="showAddCurrencyModal()">➕ 通貨ペア追加</button>
                        <button class="section-btn delete-btn" onclick="showDeleteCurrencyModal()">🗑️ 通貨ペア削除</button>
                    </div>
                </div>
                <div class="currency-tabs" id="currencyTabs">
                    <!-- JavaScript で動的に生成 -->
                </div>
            </div>

            <!-- シナリオ選択 -->
            <div class="section">
                <div class="section-header">
                    <div class="section-title">シナリオ選択</div>
                    <div class="section-buttons">
                        <button class="section-btn add-btn" onclick="showAddScenarioModal()">➕ シナリオ追加</button>
                        <button class="section-btn delete-btn" onclick="showDeleteScenarioModal()">🗑️ シナリオ削除</button>
                        <button class="section-btn save-btn" onclick="manualSave()">💾 手動保存</button>
                    </div>
                </div>
                <div class="scenario-buttons" id="scenarioButtons">
                    <!-- JavaScript で動的に生成 -->
                </div>
            </div>

            <!-- 通貨ペア名表示 -->
            <div class="currency-info">
                <div class="currency-pair" id="currentPair">USD/JPY</div>
            </div>

            <!-- チャートエリア -->
            <div class="chart-area">
                <div class="chart-container" onclick="openChartModal()">
                    <div class="chart-placeholder" id="chartDisplay">
                        📈 USD/JPY チャート
                        <small style="margin-top: 10px; display: block;">
                            画像ファイルを配置またはドラッグ&ドロップ<br>
                            タップで拡大表示
                        </small>
                    </div>
                    <img id="chartImage" class="chart-image" style="display: none;" alt="チャート画像">
                </div>
                
                <!-- ナビゲーション -->
                <div class="chart-navigation">
                    <button class="nav-btn" onclick="previousScenario()" id="prevBtn">← 前のシナリオ</button>
                    <button class="nav-btn" onclick="nextScenario()" id="nextBtn">次のシナリオ →</button>
                    <button class="nav-btn return-btn" onclick="returnToTop()">🏠 トップへ戻る</button>
                </div>
            </div>

            <!-- 分析コントロール -->
            <div class="analysis-controls">
                <!-- 分析ステータス -->
                <div class="control-section">
                    <div class="section-title">分析ステータス</div>
                    <div class="status-buttons">
                        <div class="status-btn active" onclick="setStatus(this, 'considering')">🤔 検討中</div>
                        <div class="status-btn" onclick="setStatus(this, 'skip')">⏭️ 見送り</div>
                        <div class="status-btn" onclick="setStatus(this, 'missed')">😞 見逃し</div>
                        <div class="status-btn" onclick="setStatus(this, 'pending')">📋 指値中</div>
                        <div class="status-btn" onclick="setStatus(this, 'holding')">💼 保持中</div>
                        <div class="status-btn" onclick="setStatus(this, 'completed')">✅ 完了</div>
                    </div>
                </div>

                <!-- 狙う波 -->
                <div class="control-section">
                    <div class="section-title">狙う波</div>
                    <div class="wave-buttons">
                        <div class="wave-btn unselected active" onclick="setWave(this, 'unselected')">未選択</div>
                        <div class="wave-btn wave-1h" onclick="setWave(this, '1h')">1時間足</div>
                        <div class="wave-btn wave-4h" onclick="setWave(this, '4h')">4時間足</div>
                        <div class="wave-btn wave-1d" onclick="setWave(this, '1d')">日足</div>
                    </div>
                </div>

                <!-- 分析メモ -->
                <div class="memo-area">
                    <div class="control-section">
                        <div class="section-title">📝 分析メモ</div>
                        <textarea class="analysis-memo" id="analysisMemo" placeholder="このシナリオの分析内容を記入してください..." oninput="autoSaveMemo()"></textarea>
                    </div>
                </div>
            </div>

            <!-- ChatGPT連携 -->
            <div class="chatgpt-section">
                <div class="section-title">🤖 ChatGPT連携</div>
                
                <!-- 固定プロンプト設定 -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">固定プロンプト設定:</label>
                    <textarea class="prompt-textarea" id="fixedPrompt" placeholder="ChatGPTに送信する固定プロンプトを設定...">あなたは経験豊富なFXトレーダーです。以下のチャート分析データを評価し、実用的なアドバイスを提供してください。

特に以下の観点から分析をお願いします：
1. テクニカル分析の妥当性
2. リスク管理の観点
3. エントリー・エグジット戦略
4. 市場環境との整合性

具体的で実践的なアドバイスをお願いします。</textarea>
                </div>

                <div class="chatgpt-controls">
                    <button class="chatgpt-btn chatgpt-open-btn" onclick="openChatGPT()">🤖 ChatGPTを開く</button>
                    <button class="chatgpt-btn save-btn" onclick="saveFixedPrompt()">💾 プロンプト保存</button>
                    <button class="chatgpt-btn" style="background: #6c757d;" onclick="resetFixedPrompt()">🔄 リセット</button>
                    <button class="chatgpt-btn copy-btn" onclick="toggleCopyArea()">📋 テキスト表示</button>
                </div>

                <!-- コピーエリア -->
                <div class="copy-area" id="copyArea">
                    <h4>📋 ChatGPT用テキスト</h4>
                    <textarea class="copy-textarea" id="copyTextarea" readonly></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="chatgpt-btn copy-btn" onclick="copyAllText()">📋 全文コピー</button>
                        <button class="chatgpt-btn copy-btn" onclick="copyMemoOnly()">📝 メモのみ</button>
                        <button class="chatgpt-btn" style="background: #6c757d;" onclick="closeCopyArea()">✕ 閉じる</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- フッター -->
        <div class="footer">
            <div class="page-info">
                通貨ペア: <span id="currentCurrencyDisplay">USD/JPY</span> | 
                シナリオ: <span id="currentScenarioDisplay">シナリオ1</span> | 
                最終更新: <span id="lastUpdateDisplay">2025-01-25 14:30</span>
            </div>
            
            <div class="debug-buttons">
                <button class="debug-btn debug-save" onclick="manualSave()">手動保存</button>
                <button class="debug-btn debug-check" onclick="checkDataIntegrity()">データ確認</button>
                <button class="debug-btn debug-firebase" onclick="testSupabaseConnection()">接続テスト</button>
                <button class="debug-btn" style="background: #28a745;" onclick="createBackup()">バックアップ</button>
                <button class="debug-btn debug-reset" onclick="resetAllData()">リセット</button>
            </div>
        </div>
    </div>

    <!-- チャートモーダル -->
    <div class="modal" id="chartModal">
        <div class="close-modal" onclick="closeChartModal()">×</div>
        <div class="modal-content">
            <img id="modalChart" src="" alt="Chart">
        </div>
    </div>

    <!-- 管理モーダル群 -->
    <!-- 通貨ペア追加 -->
    <div class="management-modal" id="addCurrencyModal">
        <div class="management-modal-content">
            <h3>➕ 通貨ペア追加</h3>
            <input type="text" id="newCurrencyCode" class="management-input" placeholder="通貨ペアコード (例: EURJPY)">
            <input type="text" id="newCurrencyName" class="management-input" placeholder="表示名 (例: EUR/JPY)">
            <div class="management-buttons">
                <button class="mgmt-btn cancel-btn" onclick="closeAddCurrencyModal()">キャンセル</button>
                <button class="mgmt-btn add-btn" onclick="addNewCurrency()">追加</button>
            </div>
        </div>
    </div>

    <!-- 通貨ペア削除 -->
    <div class="management-modal" id="deleteCurrencyModal">
        <div class="management-modal-content">
            <h3>🗑️ 通貨ペア削除</h3>
            <p style="color: var(--accent-danger); margin-bottom: 15px;">⚠️ 削除すると復元できません</p>
            <select id="deleteCurrencySelect" class="management-input">
                <option value="">削除する通貨ペアを選択してください</option>
            </select>
            <div class="management-buttons">
                <button class="mgmt-btn cancel-btn" onclick="closeDeleteCurrencyModal()">キャンセル</button>
                <button class="mgmt-btn delete-btn" onclick="deleteCurrency()">削除</button>
            </div>
        </div>
    </div>

    <!-- シナリオ追加 -->
    <div class="management-modal" id="addScenarioModal">
        <div class="management-modal-content">
            <h3>➕ シナリオ追加</h3>
            <input type="text" id="newScenarioLabel" class="management-input" placeholder="シナリオ名 (例: シナリオ5)">
            
            <!-- ドラッグ&ドロップエリア -->
            <div class="drop-zone" id="dropZone" onclick="document.getElementById('newScenarioImage').click()">
                <p>📁 画像をドラッグ&ドロップまたはクリックして選択</p>
                <small>対応形式: JPEG, PNG, WebP (最大10MB)</small>
            </div>
            <input type="file" id="newScenarioImage" style="display: none;" accept="image/*">
            
            <div id="imagePreview" style="display: none; margin: 10px 0;">
                <img id="previewImg" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                <p id="imageInfo" style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;"></p>
            </div>
            
            <div class="management-buttons">
                <button class="mgmt-btn cancel-btn" onclick="closeAddScenarioModal()">キャンセル</button>
                <button class="mgmt-btn add-btn" onclick="addNewScenario()">追加</button>
            </div>
        </div>
    </div>

    <!-- シナリオ削除 -->
    <div class="management-modal" id="deleteScenarioModal">
        <div class="management-modal-content">
            <h3>🗑️ シナリオ削除</h3>
            <p style="color: var(--accent-danger); margin-bottom: 15px;">⚠️ 削除すると復元できません</p>
            <select id="deleteScenarioSelect" class="management-input">
                <option value="">削除するシナリオを選択してください</option>
            </select>
            <div class="management-buttons">
                <button class="mgmt-btn cancel-btn" onclick="closeDeleteScenarioModal()">キャンセル</button>
                <button class="mgmt-btn delete-btn" onclick="deleteScenario()">削除</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase設定
        const SUPABASE_URL = 'https://jfwvyuanautsybdjlah.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impmcnd5dW5hdWF0c3liZGxqbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTMxODksImV4cCI6MjA2OTA4OTE4OX0.cyhPTiN4WAQ2p86JBZObjSljt2i1K_bK-cGGo3soxAo';
        
        let supabase = null;
        let appData = {
            currencies: ['USDJPY', 'EURUSD', 'GBPUSD', 'AUDUSD', 'SILVER', 'GOLD'],
            currentCurrency: 'USDJPY',
            currentScenario: 'scenario1',
            scenarios: {
                'USDJPY': ['scenario1', 'scenario2', 'scenario3'],
                'EURUSD': ['scenario1', 'scenario2'],
                'GBPUSD': ['scenario1', 'scenario2', 'scenario3', 'scenario4'],
                'AUDUSD': ['scenario1', 'scenario2'],
                'SILVER': ['scenario1', 'scenario2'],
                'GOLD': ['scenario1']
            },
            scenarioLabels: {
                'scenario1': 'シナリオ1',
                'scenario2': 'シナリオ2',
                'scenario3': 'シナリオ3',
                'scenario4': 'シナリオ4'
            },
            scenarioMemos: {},
            scenarioStatuses: {},
            waveSettings: {},
            uploadedImages: {}
        };

        const currencyDisplayNames = {
            'USDJPY': 'USD/JPY',
            'EURUSD': 'EUR/USD',
            'GBPUSD': 'GBP/USD',
            'AUDUSD': 'AUD/USD',
            'SILVER': 'SILVER',
            'GOLD': 'GOLD'
        };

        let saveInProgress = false;
        let currentTheme = 'light';

        // Supabase初期化
        async function initializeSupabase() {
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase SDK not loaded');
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // 接続テスト
                const { data, error } = await supabase.from('fx_analysis_data').select('id').limit(1);
                
                if (error) {
                    throw error;
                }
                
                updateSyncStatus('connected', '🟢 Supabase接続済み');
                console.log('✅ Supabase初期化成功');
                
                // データ読み込み
                await loadData();
                
                // リアルタイム同期設定
                setupRealtimeSync();
                
                return true;
            } catch (error) {
                console.error('❌ Supabase初期化エラー:', error);
                updateSyncStatus('error', `❌ 接続エラー: ${error.message}`);
                
                // ローカルデータで継続
                loadLocalData();
                return false;
            }
        }

        // 同期状態更新
        function updateSyncStatus(status, message) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.className = `sync-status ${status}`;
            statusElement.textContent = message;
        }

        // データ読み込み
        async function loadData() {
            try {
                if (!supabase) {
                    loadLocalData();
                    return;
                }
                
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('*')
                    .eq('id', 'main')
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                if (data && data.data) {
                    appData = { ...appData, ...data.data };
                    if (data.images) {
                        appData.uploadedImages = data.images;
                    }
                    console.log('✅ Supabaseからデータ読み込み成功');
                } else {
                    console.log('ℹ️ Supabaseにデータなし - 初期データを使用');
                }
                
                // ローカルストレージにバックアップ
                localStorage.setItem('fx_analysis_data', JSON.stringify(appData));
                
            } catch (error) {
                console.error('❌ データ読み込みエラー:', error);
                loadLocalData();
            }
        }

        // ローカルデータ読み込み
        function loadLocalData() {
            try {
                const savedData = localStorage.getItem('fx_analysis_data');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    appData = { ...appData, ...parsedData };
                    console.log('✅ ローカルデータ読み込み成功');
                }
            } catch (error) {
                console.error('❌ ローカルデータ読み込みエラー:', error);
            }
        }

        // データ保存
        async function saveData() {
            if (saveInProgress) return;
            
            saveInProgress = true;
            
            try {
                // ローカルストレージに保存
                localStorage.setItem('fx_analysis_data', JSON.stringify(appData));
                
                // Supabaseに保存
                if (supabase) {
                    updateSyncStatus('syncing', '🔄 同期中...');
                    
                    const savePayload = {
                        id: 'main',
                        data: appData,
                        images: appData.uploadedImages || {},
                        updated_at: new Date().toISOString()
                    };
                    
                    const { error } = await supabase
                        .from('fx_analysis_data')
                        .upsert(savePayload);
                    
                    if (error) {
                        throw error;
                    }
                    
                    updateSyncStatus('connected', '✅ 同期完了');
                    console.log('✅ データ保存成功');
                }
                
            } catch (error) {
                console.error('❌ データ保存エラー:', error);
                updateSyncStatus('error', '❌ 同期エラー');
            } finally {
                saveInProgress = false;
            }
        }

        // リアルタイム同期
        function setupRealtimeSync() {
            if (!supabase) return;
            
            try {
                supabase
                    .channel('fx_analysis_changes')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'fx_analysis_data' },
                        (payload) => {
                            if (payload.new && payload.new.id === 'main' && payload.new.data) {
                                console.log('🔄 リアルタイム更新受信');
                                appData = { ...appData, ...payload.new.data };
                                if (payload.new.images) {
                                    appData.uploadedImages = payload.new.images;
                                }
                                refreshAllUI();
                            }
                        }
                    )
                    .subscribe();
                    
                console.log('✅ リアルタイム同期設定完了');
            } catch (error) {
                console.error('❌ リアルタイム同期設定エラー:', error);
            }
        }

        // UI更新
        function refreshAllUI() {
            updateCurrencyTabs();
            updateScenarioButtons();
            updateDisplay();
            loadCurrentChart();
            generateChatGPTText();
            updatePageInfo();
        }

        // 通貨ペアタブ更新
        function updateCurrencyTabs() {
            const container = document.getElementById('currencyTabs');
            container.innerHTML = '';
            
            appData.currencies.forEach(currency => {
                const tab = document.createElement('div');
                tab.className = 'currency-tab' + (currency === appData.currentCurrency ? ' active' : '');
                tab.textContent = currencyDisplayNames[currency] || currency;
                tab.onclick = () => selectCurrency(currency);
                container.appendChild(tab);
            });
        }

        // シナリオボタン更新
        function updateScenarioButtons() {
            const container = document.getElementById('scenarioButtons');
            container.innerHTML = '';
            
            const scenarios = appData.scenarios[appData.currentCurrency] || [];
            scenarios.forEach(scenarioId => {
                const scenarioItem = document.createElement('div');
                scenarioItem.className = 'scenario-item';
                
                const btn = document.createElement('div');
                btn.className = 'scenario-btn' + (scenarioId === appData.currentScenario ? ' active' : '');
                btn.textContent = appData.scenarioLabels[scenarioId] || scenarioId;
                btn.onclick = () => selectScenario(scenarioId);
                
                const statusKey = `${appData.currentCurrency}_${scenarioId}`;
                const status = appData.scenarioStatuses[statusKey] || 'considering';
                const statusLabel = document.createElement('div');
                statusLabel.className = `status-label status-${status}`;
                statusLabel.textContent = getStatusText(status);
                
                scenarioItem.appendChild(btn);
                scenarioItem.appendChild(statusLabel);
                container.appendChild(scenarioItem);
            });
        }

        // ステータステキスト取得
        function getStatusText(status) {
            const statusTexts = {
                'considering': '🤔 検討中',
                'skip': '⏭️ 見送り',
                'missed': '😞 見逃し',
                'pending': '📋 指値中',
                'holding': '💼 保持中',
                'completed': '✅ 完了'
            };
            return statusTexts[status] || '🤔 検討中';
        }

        // 通貨ペア選択
        function selectCurrency(currency) {
            appData.currentCurrency = currency;
            appData.currentScenario = (appData.scenarios[currency] && appData.scenarios[currency][0]) || 'scenario1';
            
            refreshAllUI();
            saveData();
        }

        // シナリオ選択
        function selectScenario(scenarioId) {
            appData.currentScenario = scenarioId;
            
            updateScenarioButtons();
            updateDisplay();
            loadCurrentChart();
            generateChatGPTText();
            saveData();
        }

        // 表示更新
        function updateDisplay() {
            // 通貨ペア名表示
            document.getElementById('currentPair').textContent = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
            
            // フッター情報更新
            document.getElementById('currentCurrencyDisplay').textContent = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
            document.getElementById('currentScenarioDisplay').textContent = appData.scenarioLabels[appData.currentScenario] || appData.currentScenario;
            
            // ステータスボタン更新
            const scenarioKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            const currentStatus = appData.scenarioStatuses[scenarioKey] || 'considering';
            
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            
            const statusButtons = document.querySelectorAll('.status-btn');
            const statusMap = {
                'considering': 0, 'skip': 1, 'missed': 2,
                'pending': 3, 'holding': 4, 'completed': 5
            };
            
            const statusIndex = statusMap[currentStatus];
            if (statusButtons[statusIndex]) {
                statusButtons[statusIndex].classList.add('active');
            }
            
            // 狙う波ボタン更新
            const currentWave = appData.waveSettings[appData.currentCurrency] || 'unselected';
            
            document.querySelectorAll('.wave-btn').forEach(btn => btn.classList.remove('active'));
            
            const waveButtons = document.querySelectorAll('.wave-btn');
            const waveMap = {
                'unselected': 0, '1h': 1, '4h': 2, '1d': 3
            };
            
            const waveIndex = waveMap[currentWave];
            if (waveButtons[waveIndex]) {
                waveButtons[waveIndex].classList.add('active');
            }
            
            // 分析メモ更新
            const memoKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            document.getElementById('analysisMemo').value = appData.scenarioMemos[memoKey] || '';
        }

        // チャート画像読み込み
        function loadCurrentChart() {
            const scenarioKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            
            // アップロード画像を優先
            if (appData.uploadedImages && appData.uploadedImages[scenarioKey]) {
                displayImage(appData.uploadedImages[scenarioKey]);
                return;
            }
            
            // 既存画像パスで検索
            const imagePaths = [];
            
            if (appData.currentCurrency === 'USDJPY') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/USDJPY.jpeg');
                if (appData.currentScenario === 'scenario2') imagePaths.push('images/USDJPY2.jpeg');
                if (appData.currentScenario === 'scenario3') imagePaths.push('images/USDJPY3.jpeg');
            } else if (appData.currentCurrency === 'EURUSD') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/EURUSD.jpeg');
                if (appData.currentScenario === 'scenario2') imagePaths.push('images/EURUSD2.jpeg');
            } else if (appData.currentCurrency === 'GBPUSD') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/GBPUSD.jpeg');
                if (appData.currentScenario === 'scenario2') imagePaths.push('images/GBPUSD2.jpeg');
                if (appData.currentScenario === 'scenario3') imagePaths.push('images/GBPUSD3.jpeg');
                if (appData.currentScenario === 'scenario4') imagePaths.push('images/GBPUSD4.jpeg');
            } else if (appData.currentCurrency === 'AUDUSD') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/AUDUSD.jpeg');
                if (appData.currentScenario === 'scenario2') imagePaths.push('images/AUDUSD2.jpeg');
            } else if (appData.currentCurrency === 'SILVER') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/SILVER.jpeg');
                if (appData.currentScenario === 'scenario2') imagePaths.push('images/SILVER2.jpeg');
            } else if (appData.currentCurrency === 'GOLD') {
                if (appData.currentScenario === 'scenario1') imagePaths.push('images/GOLD.png');
            }
            
            // 汎用パターンも追加
            imagePaths.push(`images/${appData.currentCurrency}_${appData.currentScenario}.jpeg`);
            imagePaths.push(`images/${appData.currentCurrency}.jpeg`);
            imagePaths.push(`images/${appData.currentCurrency}.png`);
            
            tryLoadImage(imagePaths, 0);
        }

        function tryLoadImage(paths, index) {
            if (index >= paths.length) {
                showPlaceholder();
                return;
            }

            const img = new Image();
            img.onload = () => displayImage(paths[index]);
            img.onerror = () => tryLoadImage(paths, index + 1);
            img.src = paths[index];
        }

        function displayImage(src) {
            const chartImage = document.getElementById('chartImage');
            const placeholder = document.getElementById('chartDisplay');
            
            chartImage.src = src;
            chartImage.style.display = 'block';
            placeholder.style.display = 'none';
        }

        function showPlaceholder() {
            const chartImage = document.getElementById('chartImage');
            const placeholder = document.getElementById('chartDisplay');
            
            chartImage.style.display = 'none';
            placeholder.style.display = 'flex';
            
            const currencyName = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
            const scenarioName = appData.scenarioLabels[appData.currentScenario] || appData.currentScenario;
            
            placeholder.innerHTML = `
                📈 ${currencyName} - ${scenarioName}
                <small style="margin-top: 10px; display: block;">
                    画像ファイルを配置またはドラッグ&ドロップ<br>
                    タップで拡大表示
                </small>
            `;
        }

        // ステータス設定
        function setStatus(element, status) {
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            
            const scenarioKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            appData.scenarioStatuses[scenarioKey] = status;
            
            updateScenarioButtons();
            generateChatGPTText();
            saveData();
        }

        // 狙う波設定
        function setWave(element, wave) {
            document.querySelectorAll('.wave-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            
            appData.waveSettings[appData.currentCurrency] = wave;
            generateChatGPTText();
            saveData();
        }

        // 分析メモ自動保存
        function autoSaveMemo() {
            const memoKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            appData.scenarioMemos[memoKey] = document.getElementById('analysisMemo').value;
            
            generateChatGPTText();
            
            // デバウンス処理
            clearTimeout(window.memoSaveTimeout);
            window.memoSaveTimeout = setTimeout(saveData, 3000);
        }

        // ナビゲーション機能
        function previousScenario() {
            const scenarios = appData.scenarios[appData.currentCurrency] || [];
            const currentIndex = scenarios.indexOf(appData.currentScenario);
            
            if (currentIndex > 0) {
                selectScenario(scenarios[currentIndex - 1]);
            } else {
                // 前の通貨ペアの最後のシナリオに移動
                const currencyIndex = appData.currencies.indexOf(appData.currentCurrency);
                if (currencyIndex > 0) {
                    const prevCurrency = appData.currencies[currencyIndex - 1];
                    const prevScenarios = appData.scenarios[prevCurrency] || [];
                    if (prevScenarios.length > 0) {
                        selectCurrency(prevCurrency);
                        selectScenario(prevScenarios[prevScenarios.length - 1]);
                    }
                }
            }
        }

        function nextScenario() {
            const scenarios = appData.scenarios[appData.currentCurrency] || [];
            const currentIndex = scenarios.indexOf(appData.currentScenario);
            
            if (currentIndex < scenarios.length - 1) {
                selectScenario(scenarios[currentIndex + 1]);
            } else {
                // 次の通貨ペアの最初のシナリオに移動
                const currencyIndex = appData.currencies.indexOf(appData.currentCurrency);
                if (currencyIndex < appData.currencies.length - 1) {
                    const nextCurrency = appData.currencies[currencyIndex + 1];
                    const nextScenarios = appData.scenarios[nextCurrency] || [];
                    if (nextScenarios.length > 0) {
                        selectCurrency(nextCurrency);
                        selectScenario(nextScenarios[0]);
                    }
                }
            }
        }

        function returnToTop() {
            appData.currentCurrency = 'USDJPY';
            appData.currentScenario = 'scenario1';
            
            refreshAllUI();
            saveData();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ChatGPT連携機能
        function generateChatGPTText() {
            const currencyName = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
            const scenarioName = appData.scenarioLabels[appData.currentScenario] || appData.currentScenario;
            const memoKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            const statusKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            
            const memo = appData.scenarioMemos[memoKey] || '';
            const status = appData.scenarioStatuses[statusKey] || 'considering';
            const wave = appData.waveSettings[appData.currentCurrency] || 'unselected';
            
            const statusTexts = {
                'considering': '🤔 検討中',
                'skip': '⏭️ 見送り',
                'missed': '😞 見逃し',
                'pending': '📋 指値中',
                'holding': '💼 保持中',
                'completed': '✅ 完了'
            };
            
            const waveTexts = {
                'unselected': '未選択',
                '1h': '1時間足',
                '4h': '4時間足',
                '1d': '日足'
            };
            
            const fixedPrompt = document.getElementById('fixedPrompt').value || '';
            
            const chatgptText = `${fixedPrompt}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 **基本情報**
・通貨ペア: ${currencyName}
・シナリオ: ${scenarioName}
・分析ステータス: ${statusTexts[status]}
・狙う波: ${waveTexts[wave]}
・分析日時: ${new Date().toLocaleString('ja-JP')}

📝 **分析メモ**
${memo || '記載なし'}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**注意**: この後にチャート画像をアップロードしますので、画像と合わせて総合的な分析をお願いします。`;

            document.getElementById('copyTextarea').value = chatgptText;
        }

        function openChatGPT() {
            window.open('https://chat.openai.com/', '_blank');
        }

        function saveFixedPrompt() {
            const prompt = document.getElementById('fixedPrompt').value;
            localStorage.setItem('fx_fixed_prompt', prompt);
            alert('固定プロンプトを保存しました');
        }

        function resetFixedPrompt() {
            const defaultPrompt = `あなたは経験豊富なFXトレーダーです。以下のチャート分析データを評価し、実用的なアドバイスを提供してください。

特に以下の観点から分析をお願いします：
1. テクニカル分析の妥当性
2. リスク管理の観点
3. エントリー・エグジット戦略
4. 市場環境との整合性

具体的で実践的なアドバイスをお願いします。`;
            
            document.getElementById('fixedPrompt').value = defaultPrompt;
            localStorage.removeItem('fx_fixed_prompt');
            generateChatGPTText();
            alert('固定プロンプトをリセットしました');
        }

        function toggleCopyArea() {
            const copyArea = document.getElementById('copyArea');
            if (copyArea.classList.contains('active')) {
                copyArea.classList.remove('active');
            } else {
                copyArea.classList.add('active');
                generateChatGPTText();
            }
        }

        function closeCopyArea() {
            document.getElementById('copyArea').classList.remove('active');
        }

        function copyAllText() {
            const textarea = document.getElementById('copyTextarea');
            textarea.select();
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert('全文をクリップボードにコピーしました');
            }).catch(() => {
                document.execCommand('copy');
                alert('全文をクリップボードにコピーしました');
            });
        }

        function copyMemoOnly() {
            const memoKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            const memo = appData.scenarioMemos[memoKey] || '記載なし';
            
            navigator.clipboard.writeText(memo).then(() => {
                alert('分析メモをクリップボードにコピーしました');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = memo;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('分析メモをクリップボードにコピーしました');
            });
        }

        // テーマ切り替え
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('themeIcon').textContent = currentTheme === 'light' ? '🌙' : '☀️';
            localStorage.setItem('theme', currentTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            currentTheme = savedTheme;
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('themeIcon').textContent = currentTheme === 'light' ? '🌙' : '☀️';
        }

        // 画像アップロード機能
        function setupImageUpload() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('newScenarioImage');
            
            // ドラッグ&ドロップ
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageFile(e.target.files[0]);
                }
            });
        }

        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('画像ファイルを選択してください');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                alert('ファイルサイズが大きすぎます（10MB以下）');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // 画像リサイズ
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // 最大サイズを設定
                    const maxWidth = 1024;
                    const maxHeight = 768;
                    
                    let { width, height } = img;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // 圧縮してBase64に変換
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // プレビュー表示
                    document.getElementById('previewImg').src = compressedDataUrl;
                    document.getElementById('imageInfo').textContent = 
                        `元サイズ: ${img.width}×${img.height} → 圧縮後: ${width}×${height} (${Math.round(compressedDataUrl.length / 1024)}KB)`;
                    document.getElementById('imagePreview').style.display = 'block';
                    
                    // 一時保存
                    window.tempImageData = compressedDataUrl;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // モーダル管理
        function showAddCurrencyModal() {
            document.getElementById('addCurrencyModal').classList.add('active');
        }

        function closeAddCurrencyModal() {
            document.getElementById('addCurrencyModal').classList.remove('active');
            document.getElementById('newCurrencyCode').value = '';
            document.getElementById('newCurrencyName').value = '';
        }

        function addNewCurrency() {
            const code = document.getElementById('newCurrencyCode').value.trim().toUpperCase();
            const name = document.getElementById('newCurrencyName').value.trim();
            
            if (!code || !name) {
                alert('通貨ペアコードと表示名の両方を入力してください');
                return;
            }
            
            if (appData.currencies.includes(code)) {
                alert('この通貨ペアは既に存在します');
                return;
            }
            
            appData.currencies.push(code);
            currencyDisplayNames[code] = name;
            appData.scenarios[code] = ['scenario1'];
            
            updateCurrencyTabs();
            closeAddCurrencyModal();
            saveData();
            
            alert(`${name} を追加しました`);
        }

        function showDeleteCurrencyModal() {
            const select = document.getElementById('deleteCurrencySelect');
            select.innerHTML = '<option value="">削除する通貨ペアを選択してください</option>';
            
            appData.currencies.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = currencyDisplayNames[currency] || currency;
                select.appendChild(option);
            });
            
            document.getElementById('deleteCurrencyModal').classList.add('active');
        }

        function closeDeleteCurrencyModal() {
            document.getElementById('deleteCurrencyModal').classList.remove('active');
        }

        function deleteCurrency() {
            const currency = document.getElementById('deleteCurrencySelect').value;
            if (!currency) {
                alert('削除する通貨ペアを選択してください');
                return;
            }
            
            if (appData.currencies.length <= 1) {
                alert('最後の通貨ペアは削除できません');
                return;
            }
            
            if (!confirm(`${currencyDisplayNames[currency]} を削除しますか？`)) {
                return;
            }
            
            const index = appData.currencies.indexOf(currency);
            if (index !== -1) {
                appData.currencies.splice(index, 1);
            }
            
            delete appData.scenarios[currency];
            delete currencyDisplayNames[currency];
            
            if (appData.currentCurrency === currency) {
                appData.currentCurrency = appData.currencies[0];
                appData.currentScenario = appData.scenarios[appData.currentCurrency][0] || 'scenario1';
            }
            
            refreshAllUI();
            closeDeleteCurrencyModal();
            saveData();
            
            alert('通貨ペアを削除しました');
        }

        function showAddScenarioModal() {
            document.getElementById('addScenarioModal').classList.add('active');
            document.getElementById('imagePreview').style.display = 'none';
            window.tempImageData = null;
        }

        function closeAddScenarioModal() {
            document.getElementById('addScenarioModal').classList.remove('active');
            document.getElementById('newScenarioLabel').value = '';
            document.getElementById('newScenarioImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            window.tempImageData = null;
        }

        function addNewScenario() {
            const label = document.getElementById('newScenarioLabel').value.trim();
            
            if (!label) {
                alert('シナリオ名を入力してください');
                return;
            }
            
            const scenarioId = `scenario${Date.now()}`;
            
            appData.scenarioLabels[scenarioId] = label;
            
            if (!appData.scenarios[appData.currentCurrency]) {
                appData.scenarios[appData.currentCurrency] = [];
            }
            appData.scenarios[appData.currentCurrency].push(scenarioId);
            
            // 画像データがある場合は保存
            if (window.tempImageData) {
                const scenarioKey = `${appData.currentCurrency}_${scenarioId}`;
                if (!appData.uploadedImages) {
                    appData.uploadedImages = {};
                }
                appData.uploadedImages[scenarioKey] = window.tempImageData;
            }
            
            updateScenarioButtons();
            closeAddScenarioModal();
            saveData();
            
            alert(`${label} を追加しました`);
        }

        function showDeleteScenarioModal() {
            const select = document.getElementById('deleteScenarioSelect');
            select.innerHTML = '<option value="">削除するシナリオを選択してください</option>';
            
            const scenarios = appData.scenarios[appData.currentCurrency] || [];
            scenarios.forEach(scenarioId => {
                const option = document.createElement('option');
                option.value = scenarioId;
                option.textContent = appData.scenarioLabels[scenarioId] || scenarioId;
                select.appendChild(option);
            });
            
            document.getElementById('deleteScenarioModal').classList.add('active');
        }

        function closeDeleteScenarioModal() {
            document.getElementById('deleteScenarioModal').classList.remove('active');
        }

        function deleteScenario() {
            const scenarioId = document.getElementById('deleteScenarioSelect').value;
            if (!scenarioId) {
                alert('削除するシナリオを選択してください');
                return;
            }
            
            if (!confirm(`${appData.scenarioLabels[scenarioId]} を削除しますか？`)) {
                return;
            }
            
            const scenarios = appData.scenarios[appData.currentCurrency] || [];
            const index = scenarios.indexOf(scenarioId);
            if (index !== -1) {
                scenarios.splice(index, 1);
            }
            
            delete appData.scenarioLabels[scenarioId];
            const scenarioKey = `${appData.currentCurrency}_${scenarioId}`;
            delete appData.scenarioMemos[scenarioKey];
            delete appData.scenarioStatuses[scenarioKey];
            if (appData.uploadedImages) {
                delete appData.uploadedImages[scenarioKey];
            }
            
            if (appData.currentScenario === scenarioId) {
                appData.currentScenario = scenarios[0] || 'scenario1';
            }
            
            refreshAllUI();
            closeDeleteScenarioModal();
            saveData();
            
            alert('シナリオを削除しました');
        }

        // チャートモーダル
        function openChartModal() {
            const modal = document.getElementById('chartModal');
            modal.classList.add('active');
            
            const modalChart = document.getElementById('modalChart');
            const chartImage = document.getElementById('chartImage');
            
            if (chartImage.style.display !== 'none' && chartImage.src) {
                modalChart.src = chartImage.src;
            } else {
                const currencyName = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
                const scenarioName = appData.scenarioLabels[appData.currentScenario] || appData.currentScenario;
                
                modalChart.src = 'data:image/svg+xml;base64,' + btoa(`
                    <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
                        <rect width="800" height="600" fill="#f8f9fa"/>
                        <text x="400" y="280" text-anchor="middle" font-size="24" fill="#6c757d">
                            ${currencyName} - ${scenarioName}
                        </text>
                        <text x="400" y="320" text-anchor="middle" font-size="16" fill="#6c757d">
                            画像が見つかりません
                        </text>
                    </svg>
                `);
            }
        }

        function closeChartModal() {
            document.getElementById('chartModal').classList.remove('active');
        }

        // デバッグ機能
        async function manualSave() {
            try {
                await saveData();
                alert('データを手動保存しました');
            } catch (error) {
                alert(`保存エラー: ${error.message}`);
            }
        }

        function checkDataIntegrity() {
            console.log('=== データ整合性チェック ===');
            console.log('appData:', appData);
            console.log('Supabase接続状態:', !!supabase);
            console.log('currencyDisplayNames:', currencyDisplayNames);
            console.log('アップロード画像数:', Object.keys(appData.uploadedImages || {}).length);
            alert('コンソールを確認してください');
        }

        async function testSupabaseConnection() {
            if (!supabase) {
                alert('Supabase未初期化');
                return;
            }
            
            try {
                updateSyncStatus('syncing', '🔄 接続テスト中...');
                
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                updateSyncStatus('connected', '✅ 接続テスト成功');
                alert('Supabase接続テスト成功！');
            } catch (error) {
                updateSyncStatus('error', `❌ 接続エラー: ${error.message}`);
                alert(`接続テストエラー: ${error.message}`);
            }
        }

        function createBackup() {
            const backupData = {
                appData: appData,
                backupDate: new Date().toISOString(),
                version: "1.0"
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `fx_analysis_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('バックアップファイルを作成しました');
        }

        function resetAllData() {
            if (confirm('全てのデータをリセットしますか？この操作は取り消せません。')) {
                localStorage.removeItem('fx_analysis_data');
                localStorage.removeItem('fx_fixed_prompt');
                localStorage.removeItem('theme');
                
                if (supabase) {
                    supabase.from('fx_analysis_data').delete().eq('id', 'main').then(() => {
                        location.reload();
                    });
                } else {
                    location.reload();
                }
            }
        }

        // 共有機能
        function shareAnalysis() {
            const currencyName = currencyDisplayNames[appData.currentCurrency] || appData.currentCurrency;
            const scenarioName = appData.scenarioLabels[appData.currentScenario] || appData.currentScenario;
            const memoKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            const statusKey = `${appData.currentCurrency}_${appData.currentScenario}`;
            
            const memo = appData.scenarioMemos[memoKey] || '';
            const status = appData.scenarioStatuses[statusKey] || 'considering';
            const wave = appData.waveSettings[appData.currentCurrency] || 'unselected';
            
            const statusTexts = {
                'considering': '🤔 検討中',
                'skip': '⏭️ 見送り',
                'missed': '😞 見逃し',
                'pending': '📋 指値中',
                'holding': '💼 保持中',
                'completed': '✅ 完了'
            };
            
            const waveTexts = {
                'unselected': '未選択',
                '1h': '1時間足',
                '4h': '4時間足',
                '1d': '日足'
            };
            
            const shareText = `${currencyName} - ${scenarioName} 分析レポート

ステータス: ${statusTexts[status]}
狙う波: ${waveTexts[wave]}
分析メモ: ${memo}

#FX分析 #${currencyName.replace('/', '')}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `${currencyName} 分析レポート`,
                    text: shareText,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(shareText);
                alert('分析内容をクリップボードにコピーしました');
            }
        }

        // ページ情報更新
        function updatePageInfo() {
            const now = new Date();
            const timeString = now.toLocaleString('ja-JP', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
            
            document.getElementById('lastUpdateDisplay').textContent = timeString;
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 アプリケーション開始');
            
            // テーマ読み込み
            loadTheme();
            
            // 固定プロンプト読み込み
            const savedPrompt = localStorage.getItem('fx_fixed_prompt');
            if (savedPrompt) {
                document.getElementById('fixedPrompt').value = savedPrompt;
            }
            
            // 画像アップロード設定
            setupImageUpload();
            
            // Supabase初期化
            await initializeSupabase();
            
            // UI初期化
            refreshAllUI();
            updatePageInfo();
            
            // 定期更新
            setInterval(updatePageInfo, 60000);
            
            console.log('✅ アプリケーション初期化完了');
        });

        // イベントリスナー
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeChartModal();
            }
            if (e.target.classList.contains('management-modal')) {
                e.target.classList.remove('active');
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                previousScenario();
            } else if (e.key === 'ArrowRight') {
                nextScenario();
            } else if (e.key === 'Escape') {
                closeChartModal();
                document.querySelectorAll('.management-modal').forEach(modal => {
                    modal.classList.remove('active');
                });
                closeCopyArea();
            } else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                manualSave();
            }
        });

        window.addEventListener('beforeunload', function() {
            if (!saveInProgress) {
                localStorage.setItem('fx_analysis_data', JSON.stringify(appData));
            }
        });
    </script>
</body>
</html>
