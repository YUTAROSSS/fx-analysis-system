<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background: #f5f5f5; 
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            min-height: 100vh; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .section { 
            padding: 20px; 
            border-bottom: 1px solid #ddd; 
        }
        
        .btn { 
            padding: 8px 15px; 
            margin: 3px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .btn-primary { 
            background: #007bff; 
            color: white; 
        }
        
        .btn-secondary { 
            background: #6c757d; 
            color: white; 
        }
        
        .btn-success { 
            background: #28a745; 
            color: white; 
        }
        
        .btn-danger { 
            background: #dc3545; 
            color: white; 
        }
        
        .btn.active { 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            transform: translateY(1px);
        }
        
        .image-area { 
            border: 2px dashed #ddd; 
            padding: 20px; 
            margin: 10px 0; 
            min-height: 200px; 
            text-align: center; 
            background: #fafafa; 
            border-radius: 5px; 
        }
        
        .image-area img { 
            max-width: 100%; 
            max-height: 300px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .image-area h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        
        textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            resize: vertical; 
            font-family: inherit;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .scenario-item { 
            display: flex; 
            align-items: center; 
            margin: 5px 0; 
            padding: 5px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .scenario-status { 
            margin-left: 10px; 
            font-size: 12px; 
            color: #666; 
            padding: 2px 6px;
            background: #e9ecef;
            border-radius: 3px;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
            display: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
            display: none;
        }
        
        #storage-history {
            max-height: 200px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            padding: 10px; 
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        .history-item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 3px;
            border-left: 3px solid #007bff;
            font-size: 12px;
        }
        
        .status-buttons, .wave-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 0;
            }
            
            .section {
                padding: 15px;
            }
            
            .btn {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            .status-buttons, .wave-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .status-buttons .btn, .wave-buttons .btn {
                width: 200px;
                margin: 2px 0;
            }
        }
        
        .dark-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .dark-mode .container {
            background: #2d2d2d;
        }
        
        .dark-mode .section {
            border-color: #555;
        }
        
        .dark-mode .image-area {
            background: #3a3a3a;
            border-color: #555;
        }
        
        .dark-mode textarea {
            background: #3a3a3a;
            color: #e0e0e0;
            border-color: #555;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div>å‡¦ç†ä¸­...</div>
    </div>
    
    <div class="container">
        <!-- 1. ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; position: relative;">
            <h1 style="margin: 0; display: inline-block; font-size: 24px;">ğŸ”„ FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
            <div style="position: absolute; top: 20px; right: 20px;">
                <button onclick="createBackup()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                <button onclick="toggleTheme()" class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);" id="theme-btn">ğŸŒ™</button>
            </div>
        </header>

        <!-- ã‚¨ãƒ©ãƒ¼ãƒ»æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>

        <!-- 2. é€šè²¨ãƒšã‚¢éƒ¨åˆ† -->
        <div class="section">
            <h3>ğŸ“ˆ é€šè²¨ãƒšã‚¢é¸æŠ</h3>
            <div id="currency-buttons">
                <button class="btn btn-primary active" onclick="selectCurrency('USDJPY')" data-currency="USDJPY">USDJPY</button>
                <button class="btn btn-primary" onclick="selectCurrency('EURUSD')" data-currency="EURUSD">EURUSD</button>
                <button class="btn btn-primary" onclick="selectCurrency('GBPUSD')" data-currency="GBPUSD">GBPUSD</button>
                <button class="btn btn-primary" onclick="selectCurrency('AUDUSD')" data-currency="AUDUSD">AUDUSD</button>
                <button class="btn btn-primary" onclick="selectCurrency('SILVER')" data-currency="SILVER">SILVER</button>
                <button class="btn btn-primary" onclick="selectCurrency('GOLD')" data-currency="GOLD">GOLD</button>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="addCurrency()" class="btn btn-success">â• é€šè²¨ãƒšã‚¢è¿½åŠ </button>
                <button onclick="removeCurrency()" class="btn btn-danger">âŒ é€šè²¨ãƒšã‚¢å‰Šé™¤</button>
            </div>
        </div>

        <!-- 3. ã‚·ãƒŠãƒªã‚ªéƒ¨åˆ† -->
        <div class="section">
            <h3>ğŸ“Š ã‚·ãƒŠãƒªã‚ªé¸æŠ</h3>
            <div id="scenario-list">
                <div class="scenario-item">
                    <button class="btn btn-success active" onclick="selectScenario('scenario1')" data-scenario="scenario1">ã‚·ãƒŠãƒªã‚ª1</button>
                    <span class="scenario-status" id="status-scenario1">ğŸ” æ¤œè¨ä¸­</span>
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button onclick="addScenario()" class="btn btn-success">â• ã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
                <button onclick="deleteScenario()" class="btn btn-danger">âŒ ã‚·ãƒŠãƒªã‚ªå‰Šé™¤</button>
            </div>
        </div>

        <!-- 4. ç”»åƒè¡¨ç¤ºéƒ¨åˆ† -->
        <div class="section">
            <h2 id="currency-name" style="text-align: center; margin-bottom: 30px; color: #333; font-size: 28px;">USDJPY</h2>
            
            <div id="image1-area" class="image-area">
                <h4>ğŸ“¸ ãƒãƒ£ãƒ¼ãƒˆç”»åƒ1æšç›®</h4>
                <div id="image1-display">
                    <p style="color: #666; margin: 50px 0;">ç”»åƒ1ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>
            
            <div id="image2-area" class="image-area">
                <h4>ğŸ“¸ ãƒãƒ£ãƒ¼ãƒˆç”»åƒ2æšç›®</h4>
                <div id="image2-display">
                    <p style="color: #666; margin: 50px 0;">ç”»åƒ2ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰</p>
                </div>
            </div>
        </div>

        <!-- 5. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="section" style="text-align: center; background: #f8f9fa;">
            <h3>ğŸ§­ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</h3>
            <button onclick="prevScenario()" class="btn btn-primary" style="margin: 0 10px;">â† å‰ã®ã‚·ãƒŠãƒªã‚ª</button>
            <button onclick="nextScenario()" class="btn btn-primary" style="margin: 0 10px;">æ¬¡ã®ã‚·ãƒŠãƒªã‚ª â†’</button>
            <button onclick="topScenario()" class="btn btn-secondary" style="margin: 0 10px;">ğŸ” æœ€åˆã«æˆ»ã‚‹</button>
        </div>

        <!-- 6. åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div class="section">
            <h3>ğŸ“‹ åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
            <div class="status-buttons">
                <button class="btn active" onclick="setStatus('æ¤œè¨ä¸­')" style="background: #007bff; color: white;" id="status-æ¤œè¨ä¸­">ğŸ” æ¤œè¨ä¸­</button>
                <button class="btn" onclick="setStatus('è¦‹é€ã‚Š')" style="background: #6c757d; color: white;" id="status-è¦‹é€ã‚Š">ğŸ™…â€â™‚ï¸ è¦‹é€ã‚Š</button>
                <button class="btn" onclick="setStatus('è¦‹é€ƒã—')" style="background: #6c757d; color: white;" id="status-è¦‹é€ƒã—">ğŸ˜… è¦‹é€ƒã—</button>
                <button class="btn" onclick="setStatus('æŒ‡å€¤é€†æŒ‡å€¤ä¸­')" style="background: #dc3545; color: white;" id="status-æŒ‡å€¤é€†æŒ‡å€¤ä¸­">ğŸ¯ æŒ‡å€¤é€†æŒ‡å€¤ä¸­</button>
                <button class="btn" onclick="setStatus('ä¿æŒä¸­')" style="background: #dc3545; color: white;" id="status-ä¿æŒä¸­">ğŸ’¼ ä¿æŒä¸­</button>
                <button class="btn" onclick="setStatus('å®Œäº†')" style="background: #28a745; color: white;" id="status-å®Œäº†">âœ… å®Œäº†</button>
            </div>
        </div>

        <!-- 7. ç‹™ã†æ³¢ -->
        <div class="section">
            <h3>ğŸŒŠ ç‹™ã†æ³¢</h3>
            <div class="wave-buttons">
                <button class="btn active" onclick="setWave('æœªé¸æŠ')" style="background: #6c757d; color: white;" id="wave-æœªé¸æŠ">æœªé¸æŠ</button>
                <button class="btn" onclick="setWave('1æ™‚é–“è¶³')" style="background: #28a745; color: white;" id="wave-1æ™‚é–“è¶³">1æ™‚é–“è¶³</button>
                <button class="btn" onclick="setWave('4æ™‚é–“è¶³')" style="background: #007bff; color: white;" id="wave-4æ™‚é–“è¶³">4æ™‚é–“è¶³</button>
                <button class="btn" onclick="setWave('æ—¥è¶³')" style="background: #dc3545; color: white;" id="wave-æ—¥è¶³">æ—¥è¶³</button>
            </div>
        </div>

        <!-- 8. ãƒ¡ãƒ¢ãƒ»ChatGPTéƒ¨åˆ† -->
        <div class="section">
            <div style="margin-bottom: 30px;">
                <h3>ğŸ“ åˆ†æãƒ¡ãƒ¢</h3>
                <textarea id="memo" rows="5" placeholder="åˆ†æãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." onchange="saveMemo()"></textarea>
                <button onclick="copyMemo()" class="btn btn-secondary" style="margin-top: 10px;">ğŸ“‹ ãƒ¡ãƒ¢ã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
            
            <div>
                <h3>ğŸ¤– ChatGPTå›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
                <textarea id="prompt" rows="5" placeholder="ChatGPTç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." onchange="savePrompt()"></textarea>
                <div style="margin-top: 10px;">
                    <button onclick="copyPrompt()" class="btn btn-secondary">ğŸ“‹ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼</button>
                    <button onclick="openChatGPT()" class="btn" style="background: #10a37f; color: white; margin-left: 10px;">ğŸ¤– CHATGPTåˆ†æ</button>
                </div>
            </div>
        </div>

        <!-- 9. STORAGEå±¥æ­´ -->
        <div class="section">
            <h3>ğŸ“š STORAGEå±¥æ­´</h3>
            <div id="storage-history">
                <p style="color: #666; text-align: center; margin: 20px 0;">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
            <button onclick="refreshHistory()" class="btn btn-secondary" style="margin-top: 10px;">ğŸ”„ å±¥æ­´æ›´æ–°</button>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let supabase;
        let currentCurrency = 'USDJPY';
        let currentScenario = 'scenario1';
        let isDarkMode = false;
        let mainData = {};

        // SupabaseåˆæœŸåŒ–
        function initSupabase() {
            try {
                const supabaseUrl = 'https://jfrwyunauatsybdljlah.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impmcnd5dW5hdWF0c3liZGxqbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTMxODksImV4cCI6MjA2OTA4OTE4OX0.cyhPTiN4WAQ2p86JBZObjSljt2i1K_bK-cGGo3soxAo';
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                console.log('Supabase initialized successfully');
                return true;
            } catch (error) {
                console.error('Supabase initialization error:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
                return false;
            }
        }

        // å®‰å…¨ãªDOMè¦ç´ å–å¾—
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element not found: ${id}`);
                return null;
            }
            return element;
        }

        // å®‰å…¨ãªå‡¦ç†å®Ÿè¡Œ
        async function safeExecute(fn, errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ') {
            try {
                showLoading();
                const result = await fn();
                hideLoading();
                return result;
            } catch (error) {
                hideLoading();
                console.error('Safe execute error:', error);
                showError(errorMessage + ': ' + error.message);
                return null;
            }
        }

        // ã‚¨ãƒ©ãƒ¼å¯¾ç­–æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadData(key) {
            try {
                console.log('Loading data for key:', key);
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('data')
                    .eq('id', key)
                    .maybeSingle();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Load error:', error);
                    return null;
                }
                
                const result = data?.data || null;
                console.log('Loaded data:', result);
                return result;
            } catch (err) {
                console.error('Load exception:', err);
                return null;
            }
        }

        // ã‚¨ãƒ©ãƒ¼å¯¾ç­–æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function saveData(key, value) {
            try {
                console.log('Saving data for key:', key, 'value:', value);
                const { error } = await supabase
                    .from('fx_analysis_data')
                    .upsert([{
                        id: key,
                        data: value,
                        updated_at: new Date().toISOString()
                    }], {
                        onConflict: 'id',
                        ignoreDuplicates: false
                    });
                
                if (error) {
                    console.error('Save error:', error);
                    return false;
                }
                console.log('Data saved successfully');
                return true;
            } catch (err) {
                console.error('Save exception:', err);
                return false;
            }
        }

        // åˆæœŸåŒ–
        async function initialize() {
            console.log('Starting initialization...');
            
            if (!initSupabase()) {
                return;
            }

            await safeExecute(async () => {
                // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                mainData = await loadData('main') || {
                    currencies: ['USDJPY', 'EURUSD', 'GBPUSD', 'AUDUSD', 'SILVER', 'GOLD'],
                    scenarios: {
                        USDJPY: ['scenario1'],
                        EURUSD: ['scenario1'],
                        GBPUSD: ['scenario1'],
                        AUDUSD: ['scenario1'],
                        SILVER: ['scenario1'],
                        GOLD: ['scenario1']
                    },
                    images: {},
                    scenarioNames: {},
                    fixedPrompt: 'FXãƒãƒ£ãƒ¼ãƒˆåˆ†æã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚'
                };

                // åˆæœŸãƒ‡ãƒ¼ã‚¿ä¿å­˜
                await saveData('main', mainData);

                // UIåˆæœŸåŒ–
                updateCurrencyButtons();
                updateScenarioButtons();
                await loadCurrentData();
                
                // å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿
                const promptElement = safeGetElement('prompt');
                if (promptElement && mainData.fixedPrompt) {
                    promptElement.value = mainData.fixedPrompt;
                }

                // å±¥æ­´æ›´æ–°
                await refreshHistory();

                showSuccess('ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
                console.log('Initialization completed');
            }, 'ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // é€šè²¨ãƒšã‚¢é¸æŠ
        async function selectCurrency(currency) {
            if (currency === currentCurrency) return;
            
            await safeExecute(async () => {
                // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                await saveCurrentData();
                
                // é€šè²¨ãƒšã‚¢åˆ‡ã‚Šæ›¿ãˆ
                currentCurrency = currency;
                
                // æœ€åˆã®ã‚·ãƒŠãƒªã‚ªã«åˆ‡ã‚Šæ›¿ãˆ
                const scenarios = mainData.scenarios[currency] || ['scenario1'];
                currentScenario = scenarios[0];
                
                // UIæ›´æ–°
                updateCurrencyButtons();
                updateScenarioButtons();
                await loadCurrentData();
                
                console.log('Currency switched to:', currency);
            }, 'é€šè²¨ãƒšã‚¢ã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // ã‚·ãƒŠãƒªã‚ªé¸æŠ
        async function selectScenario(scenario) {
            if (scenario === currentScenario) return;
            
            await safeExecute(async () => {
                // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                await saveCurrentData();
                
                // ã‚·ãƒŠãƒªã‚ªåˆ‡ã‚Šæ›¿ãˆ
                currentScenario = scenario;
                
                // UIæ›´æ–°
                updateScenarioButtons();
                await loadCurrentData();
                
                console.log('Scenario switched to:', scenario);
            }, 'ã‚·ãƒŠãƒªã‚ªã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // é€šè²¨ãƒšã‚¢ãƒœã‚¿ãƒ³æ›´æ–°
        function updateCurrencyButtons() {
            const buttons = document.querySelectorAll('#currency-buttons .btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.currency === currentCurrency) {
                    btn.classList.add('active');
                }
            });
            
            const nameElement = safeGetElement('currency-name');
            if (nameElement) {
                nameElement.textContent = currentCurrency;
            }
        }

        // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³æ›´æ–°
        function updateScenarioButtons() {
            const scenarios = mainData.scenarios[currentCurrency] || ['scenario1'];
            const container = safeGetElement('scenario-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            scenarios.forEach(scenario => {
                const item = document.createElement('div');
                item.className = 'scenario-item';
                
                const button = document.createElement('button');
                button.className = 'btn btn-success';
                button.onclick = () => selectScenario(scenario);
                button.dataset.scenario = scenario;
                button.textContent = getScenarioName(scenario);
                
                if (scenario === currentScenario) {
                    button.classList.add('active');
                }
                
                const status = document.createElement('span');
                status.className = 'scenario-status';
                status.id = `status-${scenario}`;
                status.textContent = 'ğŸ” æ¤œè¨ä¸­';
                
                item.appendChild(button);
                item.appendChild(status);
                container.appendChild(item);
            });
        }

        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadCurrentData() {
            try {
                console.log('Loading current data for:', currentCurrency, currentScenario);
                
                // ç”»åƒè¡¨ç¤º
                await displayImages();
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª­ã¿è¾¼ã¿
                const status = await loadData(`${currentCurrency}_${currentScenario}_status`) || 'æ¤œè¨ä¸­';
                updateStatusButtons(status);
                updateScenarioStatus(currentScenario, status);
                
                // æ³¢èª­ã¿è¾¼ã¿
                const wave = await loadData(`${currentCurrency}_${currentScenario}_wave`) || 'æœªé¸æŠ';
                updateWaveButtons(wave);
                
                // ãƒ¡ãƒ¢èª­ã¿è¾¼ã¿
                const memo = await loadData(`${currentCurrency}_${currentScenario}_memo`) || '';
                const memoElement = safeGetElement('memo');
                if (memoElement) {
                    memoElement.value = memo;
                }
                
                console.log('Current data loaded successfully');
            } catch (error) {
                console.error('Load current data error:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function saveCurrentData() {
            try {
                const memoElement = safeGetElement('memo');
                if (memoElement && memoElement.value.trim()) {
                    await saveData(`${currentCurrency}_${currentScenario}_memo`, memoElement.value);
                }
                console.log('Current data saved');
            } catch (error) {
                console.error('Save current data error:', error);
            }
        }

        // ç”»åƒè¡¨ç¤º
        async function displayImages() {
            const images = mainData.images?.[currentCurrency]?.[currentScenario] || [];
            
            const image1Display = safeGetElement('image1-display');
            const image2Display = safeGetElement('image2-display');
            
            if (image1Display) {
                if (images[0]) {
                    image1Display.innerHTML = `<img src="${images[0]}" alt="ãƒãƒ£ãƒ¼ãƒˆç”»åƒ1" onclick="openImageInNewTab('${images[0]}')">`;
                } else {
                    image1Display.innerHTML = '<p style="color: #666; margin: 50px 0;">ç”»åƒ1ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
                }
            }
            
            if (image2Display) {
                if (images[1]) {
                    image2Display.innerHTML = `<img src="${images[1]}" alt="ãƒãƒ£ãƒ¼ãƒˆç”»åƒ2" onclick="openImageInNewTab('${images[1]}')">`;
                } else {
                    image2Display.innerHTML = '<p style="color: #666; margin: 50px 0;">ç”»åƒ2ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰</p>';
                }
            }
        }

        // ç”»åƒã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        function openImageInNewTab(url) {
            window.open(url, '_blank');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
        async function setStatus(status) {
            await safeExecute(async () => {
                await saveData(`${currentCurrency}_${currentScenario}_status`, status);
                updateStatusButtons(status);
                updateScenarioStatus(currentScenario, status);
                showSuccess(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${status}ã€ã«è¨­å®šã—ã¾ã—ãŸ`);
            }, 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // æ³¢è¨­å®š
        async function setWave(wave) {
            await safeExecute(async () => {
                await saveData(`${currentCurrency}_${currentScenario}_wave`, wave);
                updateWaveButtons(wave);
                showSuccess(`ç‹™ã†æ³¢ã‚’ã€Œ${wave}ã€ã«è¨­å®šã—ã¾ã—ãŸ`);
            }, 'ç‹™ã†æ³¢ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³æ›´æ–°
        function updateStatusButtons(activeStatus) {
            const buttons = document.querySelectorAll('.status-buttons .btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeButton = safeGetElement(`status-${activeStatus}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // æ³¢ãƒœã‚¿ãƒ³æ›´æ–°
        function updateWaveButtons(activeWave) {
            const buttons = document.querySelectorAll('.wave-buttons .btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeButton = safeGetElement(`wave-${activeWave}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        // ã‚·ãƒŠãƒªã‚ªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateScenarioStatus(scenario, status) {
            const statusElement = safeGetElement(`status-${scenario}`);
            if (statusElement) {
                const icon = getStatusIcon(status);
                statusElement.textContent = `${icon} ${status}`;
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ã‚¤ã‚³ãƒ³å–å¾—
        function getStatusIcon(status) {
            const icons = {
                'æ¤œè¨ä¸­': 'ğŸ”',
                'è¦‹é€ã‚Š': 'ğŸ™…â€â™‚ï¸',
                'è¦‹é€ƒã—': 'ğŸ˜…',
                'æŒ‡å€¤é€†æŒ‡å€¤ä¸­': 'ğŸ¯',
                'ä¿æŒä¸­': 'ğŸ’¼',
                'å®Œäº†': 'âœ…'
            };
            return icons[status] || 'ğŸ”';
        }

        // ã‚·ãƒŠãƒªã‚ªåå–å¾—
        function getScenarioName(scenario) {
            if (mainData.scenarioNames?.[currentCurrency]?.[scenario]) {
                return mainData.scenarioNames[currentCurrency][scenario];
            }
            return scenario.replace('scenario', 'ã‚·ãƒŠãƒªã‚ª').replace('_', ' ');
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
        function prevScenario() {
            const scenarios = mainData.scenarios[currentCurrency] || ['scenario1'];
            const currentIndex = scenarios.indexOf(currentScenario);
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : scenarios.length - 1;
            selectScenario(scenarios[prevIndex]);
        }

        function nextScenario() {
            const scenarios = mainData.scenarios[currentCurrency] || ['scenario1'];
            const currentIndex = scenarios.indexOf(currentScenario);
            const nextIndex = currentIndex < scenarios.length - 1 ? currentIndex + 1 : 0;
            selectScenario(scenarios[nextIndex]);
        }

        function topScenario() {
            const scenarios = mainData.scenarios[currentCurrency] || ['scenario1'];
            selectScenario(scenarios[0]);
        }

        // ã‚·ãƒŠãƒªã‚ªè¿½åŠ ï¼ˆå®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«é¸æŠï¼‰
        function addScenario() {
            const name = prompt('ã‚·ãƒŠãƒªã‚ªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!name || name.trim() === '') {
                showError('ã‚·ãƒŠãƒªã‚ªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºä¿
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.style.display = 'none';
            
            const handleFileSelect = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) {
                    showError('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                if (files.length > 2) {
                    showError('ç”»åƒã¯æœ€å¤§2æšã¾ã§é¸æŠã§ãã¾ã™');
                    return;
                }
                
                document.body.removeChild(input);
                await uploadScenarioImages(name.trim(), files);
            };
            
            input.addEventListener('change', handleFileSelect, { once: true });
            document.body.appendChild(input);
            
            // å®‰å…¨ãªã‚¯ãƒªãƒƒã‚¯å®Ÿè¡Œ
            setTimeout(() => {
                input.click();
            }, 100);
        }

        // å®‰å…¨ãªç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadScenarioImages(scenarioName, files) {
            return await safeExecute(async () => {
                const imageUrls = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileName = `${Date.now()}_${i + 1}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                    
                    console.log('Uploading file:', fileName);
                    
                    const { data, error } = await supabase.storage
                        .from('fx-images')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: false
                        });
                    
                    if (error) {
                        console.error('Upload error:', error);
                        continue;
                    }
                    
                    const { data: { publicUrl } } = supabase.storage
                        .from('fx-images')
                        .getPublicUrl(fileName);
                    
                    imageUrls.push(publicUrl);
                    console.log('Image uploaded:', publicUrl);
                }
                
                if (imageUrls.length === 0) {
                    throw new Error('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                const scenarioId = `scenario_${Date.now()}`;
                
                if (!mainData.scenarios[currentCurrency]) {
                    mainData.scenarios[currentCurrency] = [];
                }
                mainData.scenarios[currentCurrency].push(scenarioId);
                
                if (!mainData.images[currentCurrency]) {
                    mainData.images[currentCurrency] = {};
                }
                mainData.images[currentCurrency][scenarioId] = imageUrls;
                
                if (!mainData.scenarioNames[currentCurrency]) {
                    mainData.scenarioNames[currentCurrency] = {};
                }
                mainData.scenarioNames[currentCurrency][scenarioId] = scenarioName;
                
                const success = await saveData('main', mainData);
                if (!success) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // UIæ›´æ–°
                updateScenarioButtons();
                await selectScenario(scenarioId);
                
                showSuccess(`ã‚·ãƒŠãƒªã‚ªã€Œ${scenarioName}ã€ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ`);
                console.log('Scenario added successfully');
                
            }, 'ã‚·ãƒŠãƒªã‚ªã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // ã‚·ãƒŠãƒªã‚ªå‰Šé™¤
        async function deleteScenario() {
            const scenarios = mainData.scenarios[currentCurrency] || ['scenario1'];
            if (scenarios.length <= 1) {
                showError('æœ€å¾Œã®ã‚·ãƒŠãƒªã‚ªã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
                return;
            }
            
            const scenarioName = getScenarioName(currentScenario);
            if (!confirm(`ã‚·ãƒŠãƒªã‚ªã€Œ${scenarioName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            await safeExecute(async () => {
                // ã‚·ãƒŠãƒªã‚ªã‚’ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤
                mainData.scenarios[currentCurrency] = mainData.scenarios[currentCurrency].filter(s => s !== currentScenario);
                
                // ç”»åƒãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                if (mainData.images[currentCurrency]) {
                    delete mainData.images[currentCurrency][currentScenario];
                }
                
                // ã‚·ãƒŠãƒªã‚ªåå‰Šé™¤
                if (mainData.scenarioNames[currentCurrency]) {
                    delete mainData.scenarioNames[currentCurrency][currentScenario];
                }
                
                // é–¢é€£ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                await deleteScenarioData(currentScenario);
                
                // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                await saveData('main', mainData);
                
                // åˆ¥ã®ã‚·ãƒŠãƒªã‚ªã«åˆ‡ã‚Šæ›¿ãˆ
                const remainingScenarios = mainData.scenarios[currentCurrency];
                currentScenario = remainingScenarios[0];
                
                // UIæ›´æ–°
                updateScenarioButtons();
                await loadCurrentData();
                
                showSuccess(`ã‚·ãƒŠãƒªã‚ªã€Œ${scenarioName}ã€ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ`);
                console.log('Scenario deleted successfully');
                
            }, 'ã‚·ãƒŠãƒªã‚ªã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        async function deleteScenarioData(scenario) {
            const keys = [
                `${currentCurrency}_${scenario}_status`,
                `${currentCurrency}_${scenario}_wave`,
                `${currentCurrency}_${scenario}_memo`
            ];
            
            for (const key of keys) {
                try {
                    await supabase.from('fx_analysis_data').delete().eq('id', key);
                } catch (error) {
                    console.error(`Delete error for ${key}:`, error);
                }
            }
        }

        // é€šè²¨ãƒšã‚¢è¿½åŠ 
        async function addCurrency() {
            const currency = prompt('é€šè²¨ãƒšã‚¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šEURJPYï¼‰:');
            if (!currency || currency.trim() === '') {
                showError('é€šè²¨ãƒšã‚¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const normalizedCurrency = currency.trim().toUpperCase();
            if (!/^[A-Z]{6}$/.test(normalizedCurrency)) {
                showError('é€šè²¨ãƒšã‚¢åã¯6æ–‡å­—ã®å¤§æ–‡å­—è‹±å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (mainData.currencies.includes(normalizedCurrency)) {
                showError('ã“ã®é€šè²¨ãƒšã‚¢ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
                return;
            }
            
            await safeExecute(async () => {
                mainData.currencies.push(normalizedCurrency);
                mainData.scenarios[normalizedCurrency] = ['scenario1'];
                mainData.images[normalizedCurrency] = {};
                mainData.scenarioNames[normalizedCurrency] = {};
                
                await saveData('main', mainData);
                
                // é€šè²¨ãƒšã‚¢ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«è¿½åŠ 
                const container = safeGetElement('currency-buttons');
                if (container) {
                    const button = document.createElement('button');
                    button.className = 'btn btn-primary';
                    button.onclick = () => selectCurrency(normalizedCurrency);
                    button.dataset.currency = normalizedCurrency;
                    button.textContent = normalizedCurrency;
                    
                    // è¿½åŠ ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‰ã«æŒ¿å…¥
                    const addButton = container.parentNode.querySelector('.btn-success');
                    container.appendChild(button);
                }
                
                showSuccess(`é€šè²¨ãƒšã‚¢ã€Œ${normalizedCurrency}ã€ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ`);
                console.log('Currency added successfully');
                
            }, 'é€šè²¨ãƒšã‚¢ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // é€šè²¨ãƒšã‚¢å‰Šé™¤
        async function removeCurrency() {
            if (mainData.currencies.length <= 1) {
                showError('æœ€å¾Œã®é€šè²¨ãƒšã‚¢ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
                return;
            }
            
            if (!confirm(`é€šè²¨ãƒšã‚¢ã€Œ${currentCurrency}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            await safeExecute(async () => {
                // é€šè²¨ãƒšã‚¢ã‚’ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‰Šé™¤
                mainData.currencies = mainData.currencies.filter(c => c !== currentCurrency);
                delete mainData.scenarios[currentCurrency];
                delete mainData.images[currentCurrency];
                delete mainData.scenarioNames[currentCurrency];
                
                // é–¢é€£ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                await deleteCurrencyData(currentCurrency);
                
                // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                await saveData('main', mainData);
                
                // åˆ¥ã®é€šè²¨ãƒšã‚¢ã«åˆ‡ã‚Šæ›¿ãˆ
                currentCurrency = mainData.currencies[0];
                currentScenario = mainData.scenarios[currentCurrency][0];
                
                // UIæ›´æ–°
                updateCurrencyButtons();
                updateScenarioButtons();
                await loadCurrentData();
                
                showSuccess('é€šè²¨ãƒšã‚¢ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                console.log('Currency removed successfully');
                
            }, 'é€šè²¨ãƒšã‚¢ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // é€šè²¨ãƒšã‚¢ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        async function deleteCurrencyData(currency) {
            const scenarios = mainData.scenarios[currency] || [];
            const dataTypes = ['status', 'wave', 'memo'];
            
            for (const scenario of scenarios) {
                for (const type of dataTypes) {
                    const key = `${currency}_${scenario}_${type}`;
                    try {
                        await supabase.from('fx_analysis_data').delete().eq('id', key);
                    } catch (error) {
                        console.error(`Delete error for ${key}:`, error);
                    }
                }
            }
        }

        // ãƒ¡ãƒ¢ä¿å­˜
        async function saveMemo() {
            const memoElement = safeGetElement('memo');
            if (memoElement) {
                await saveData(`${currentCurrency}_${currentScenario}_memo`, memoElement.value);
            }
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¿å­˜
        async function savePrompt() {
            const promptElement = safeGetElement('prompt');
            if (promptElement) {
                mainData.fixedPrompt = promptElement.value;
                await saveData('main', mainData);
            }
        }

        // ãƒ¡ãƒ¢ã‚³ãƒ”ãƒ¼
        async function copyMemo() {
            const memoElement = safeGetElement('memo');
            if (memoElement) {
                await copyToClipboard(memoElement.value);
                showSuccess('åˆ†æãƒ¡ãƒ¢ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼
        async function copyPrompt() {
            const promptElement = safeGetElement('prompt');
            if (promptElement) {
                await copyToClipboard(promptElement.value);
                showSuccess('å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }

        // ChatGPTåˆ†æ
        async function openChatGPT() {
            const memoElement = safeGetElement('memo');
            const promptElement = safeGetElement('prompt');
            
            const memo = memoElement ? memoElement.value : '';
            const prompt = promptElement ? promptElement.value : '';
            const combinedText = `${memo}\n\n${prompt}`;
            
            await copyToClipboard(combinedText);
            window.open('https://chat.openai.com', '_blank');
            showSuccess('åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¦ChatGPTã‚’é–‹ãã¾ã—ãŸ');
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
            } catch (err) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
        }

        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            const themeBtn = safeGetElement('theme-btn');
            if (themeBtn) {
                themeBtn.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
            }
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
        async function createBackup() {
            await safeExecute(async () => {
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('*');
                
                if (error) throw error;
                
                const backupData = {
                    timestamp: new Date().toISOString(),
                    data: data
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fx_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
                
            }, 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // å±¥æ­´æ›´æ–°
        async function refreshHistory() {
            await safeExecute(async () => {
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('id, created_at, updated_at')
                    .order('updated_at', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                const historyContainer = safeGetElement('storage-history');
                if (!historyContainer) return;
                
                if (data.length === 0) {
                    historyContainer.innerHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                const historyHTML = data.map(item => `
                    <div class="history-item">
                        <strong>${item.id}</strong><br>
                        <small>æ›´æ–°: ${new Date(item.updated_at).toLocaleString('ja-JP')}</small>
                    </div>
                `).join('');
                
                historyContainer.innerHTML = historyHTML;
                console.log('History refreshed');
                
            }, 'å±¥æ­´ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        // UIè¡¨ç¤ºé–¢æ•°
        function showLoading() {
            const loading = safeGetElement('loading');
            if (loading) {
                loading.style.display = 'block';
            }
        }

        function hideLoading() {
            const loading = safeGetElement('loading');
            if (loading) {
                loading.style.display = 'none';
            }
        }

        function showError(message) {
            console.error('Error:', message);
            const errorElement = safeGetElement('error-message');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        function showSuccess(message) {
            console.log('Success:', message);
            const successElement = safeGetElement('success-message');
            if (successElement) {
                successElement.textContent = message;
                successElement.style.display = 'block';
                setTimeout(() => {
                    successElement.style.display = 'none';
                }, 3000);
            }
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', initialize);
        
        console.log('FX Analysis System loaded successfully');
    </script>
</body>
</html>
