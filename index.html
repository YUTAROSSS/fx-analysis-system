<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            color: #333333;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        /* ãƒœã‚¿ãƒ³åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            outline: none;
        }

        button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        /* é€šè²¨ãƒšã‚¢ãƒœã‚¿ãƒ³ */
        .currency-btn {
            background-color: #6c757d;
            color: white;
            min-width: 80px;
        }

        .currency-btn.active {
            background-color: #007bff;
            color: white;
        }

        /* ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ */
        .scenario-btn {
            background-color: #007bff;
            color: white;
            min-width: 120px;
            position: relative;
        }

        .scenario-btn.active {
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            transform: translateY(-2px);
        }

        .scenario-btn .status-indicator {
            font-size: 11px;
            opacity: 0.8;
        }

        /* åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ç‹™ã†æ³¢ãƒœã‚¿ãƒ³ */
        .status-btn, .wave-btn {
            background-color: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            text-align: left;
            width: 100%;
            padding: 12px 15px;
        }

        .status-btn.active, .wave-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .status-btn:hover, .wave-btn:hover {
            background-color: #e9ecef;
        }

        .status-btn.active:hover, .wave-btn.active:hover {
            background-color: #0056b3;
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
        .dark-mode {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .dark-mode .currency-btn,
        .dark-mode .scenario-btn {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
        }

        .dark-mode .currency-btn.active,
        .dark-mode .scenario-btn.active {
            background-color: #007bff;
        }

        .dark-mode .status-btn,
        .dark-mode .wave-btn {
            background-color: #2d2d2d;
            color: #ffffff;
            border-color: #555;
        }

        .dark-mode .status-btn.active,
        .dark-mode .wave-btn.active {
            background-color: #007bff;
            color: white;
        }

        .dark-mode textarea {
            background-color: #2d2d2d;
            color: #ffffff;
            border-color: #555;
        }

        .dark-mode .history-sidebar {
            background-color: #2d2d2d;
            color: #ffffff;
        }

        .dark-mode .history-header {
            background-color: #1a1a1a;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            .currency-buttons,
            .scenario-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .currency-btn,
            .scenario-btn {
                margin-bottom: 8px;
                width: 100%;
            }
            
            .analysis-section {
                flex-direction: column;
                gap: 20px;
            }
            
            .memo-chatgpt-section {
                padding: 0 10px;
            }
            
            .history-sidebar {
                width: 100vw;
                right: -100vw;
            }
            
            .bottom-section {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .usage-monitor {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .navigation {
                flex-direction: column;
                gap: 8px;
            }
            
            .navigation button {
                width: 100%;
            }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
        .scenario-btn.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .scenario-btn.drag-over {
            border: 2px dashed #007bff;
        }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        progress {
            appearance: none;
            -webkit-appearance: none;
        }

        progress::-webkit-progress-bar {
            background-color: #f0f0f0;
            border-radius: 3px;
        }

        progress::-webkit-progress-value {
            background-color: #007bff;
            border-radius: 3px;
        }

        /* å±¥æ­´é …ç›® */
        .history-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .history-item:hover {
            background-color: #f8f9fa;
        }

        .dark-mode .history-item {
            border-bottom-color: #555;
        }

        .dark-mode .history-item:hover {
            background-color: #333;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 18px; font-weight: bold;">ğŸ”„ FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </span>
        <div>
            <button id="backup-btn" style="margin-right: 10px;">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
            <button id="theme-toggle" style="margin-right: 10px;">ğŸŒ™</button>
            <span style="font-size: 20px;">ğŸ“Š</span>
        </div>
    </header>

    <!-- é€šè²¨ãƒšã‚¢é¸æŠ -->
    <div class="currency-section" style="margin: 20px 0; padding: 0 20px;">
        <h3>é€šè²¨ãƒšã‚¢éƒ¨åˆ†</h3>
        <div class="currency-buttons" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
            <button class="currency-btn active" data-currency="USDJPY">USDJPY</button>
            <button class="currency-btn" data-currency="EURUSD">EURUSD</button>
            <button class="currency-btn" data-currency="GBPUSD">GBPUSD</button>
            <button class="currency-btn" data-currency="AUDUSD">AUDUSD</button>
            <button class="currency-btn" data-currency="SILVER">SILVER</button>
            <button class="currency-btn" data-currency="GOLD">GOLD</button>
            <button id="add-currency">é€šè²¨ãƒšã‚¢è¿½åŠ </button>
            <button id="remove-currency">é€šè²¨ãƒšã‚¢å‰Šé™¤</button>
        </div>
    </div>

    <!-- ã‚·ãƒŠãƒªã‚ªé¸æŠ -->
    <div class="scenario-section" style="margin: 20px 0; padding: 0 20px;">
        <h3>ãƒãƒ£ãƒ¼ãƒˆéƒ¨åˆ†</h3>
        <div class="scenario-buttons" id="scenario-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
            <button class="scenario-btn active" data-scenario="scenario1" draggable="true">
                ã‚·ãƒŠãƒªã‚ª1 <small class="status-indicator" style="opacity: 0.8; margin-left: 5px;">ğŸ“Š æ¤œè¨ä¸­</small>
            </button>
            <button id="add-scenario">ã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
            <button id="remove-scenario">ã‚·ãƒŠãƒªã‚ªå‰Šé™¤</button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="main-display" style="text-align: center; margin: 30px 0; padding: 0 20px;">
        <h2 id="current-pair" style="margin-bottom: 20px;">USDJPY</h2>
        <div class="image-container" id="image-container" style="min-height: 300px; border: 2px dashed #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <p style="color: #666;">ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
        <button id="high-quality-btn" style="display: none; margin-top: 10px;">é«˜ç”»è³ªè¡¨ç¤º</button>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="navigation" style="text-align: center; margin: 20px 0; display: flex; justify-content: center; flex-wrap: wrap;">
        <button id="prev-chart" style="margin: 0 10px;">â† å‰ã®ãƒãƒ£ãƒ¼ãƒˆ</button>
        <button id="next-chart" style="margin: 0 10px;">æ¬¡ã®ãƒãƒ£ãƒ¼ãƒˆ â†’</button>
        <button id="top-return" style="margin: 0 10px;">ğŸ” ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    </div>

    <!-- åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ç‹™ã†æ³¢ -->
    <div class="analysis-section" style="display: flex; gap: 30px; margin: 30px 0; flex-wrap: wrap; padding: 0 20px;">
        <div class="status-section" style="flex: 1; min-width: 250px;">
            <h3>åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="status-btn" data-status="æ¤œè¨ä¸­">ğŸ“Š æ¤œè¨ä¸­</button>
                <button class="status-btn" data-status="è¨ˆç®—ä¸­">ğŸ”„ è¨ˆç®—ä¸­</button>
                <button class="status-btn" data-status="å®Ÿæˆ¦">âš¡ å®Ÿæˆ¦</button>
                <button class="status-btn" data-status="åˆ©ç¢º">ğŸ“ˆ åˆ©ç¢º</button>
                <button class="status-btn" data-status="æåˆ‡ã‚Š">ğŸ“‰ æåˆ‡ã‚Š</button>
                <button class="status-btn" data-status="è¦‹é€ã‚Š">ğŸ‘€ è¦‹é€ã‚Š</button>
            </div>
        </div>
        <div class="wave-section" style="flex: 1; min-width: 250px;">
            <h3>ç‹™ã†æ³¢</h3>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="wave-btn active" data-wave="æœªé¸æŠ">æœªé¸æŠ</button>
                <button class="wave-btn" data-wave="1æ™‚é–“è¶³">1æ™‚é–“è¶³</button>
                <button class="wave-btn" data-wave="4æ™‚é–“è¶³">4æ™‚é–“è¶³</button>
                <button class="wave-btn" data-wave="æ—¥è¶³">æ—¥è¶³</button>
            </div>
        </div>
    </div>

    <!-- åˆ†æãƒ¡ãƒ¢ãƒ»ChatGPTé€£æºã‚¨ãƒªã‚¢ -->
    <div class="memo-chatgpt-section" style="margin: 30px 0; padding: 0 20px;">
        <div class="memo-section" style="margin-bottom: 25px;">
            <h3>åˆ†æãƒ¡ãƒ¢</h3>
            <textarea id="analysis-memo" placeholder="åˆ†æãƒ¡ãƒ¢ã‚’å…¥åŠ›..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; resize: vertical;"></textarea>
            <button id="copy-memo" style="margin-top: 10px;">åˆ†æãƒ¡ãƒ¢ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div class="chatgpt-section">
            <h3>ChatGPTå›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
            <textarea id="fixed-prompt" placeholder="å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›..." style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; resize: vertical;"></textarea>
            <div style="margin-top: 10px;">
                <button id="copy-prompt">å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼</button>
                <button id="change-prompt">å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›´</button>
                <button id="chatgpt-analysis" style="background-color: #28a745; margin-left: 10px;">CHATGPTåˆ†æ</button>
            </div>
        </div>
    </div>

    <!-- æœ€ä¸‹éƒ¨ã‚¨ãƒªã‚¢ -->
    <div class="bottom-section" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-top: 1px solid #ddd; flex-wrap: wrap; gap: 15px;">
        <div class="usage-monitor" style="display: flex; align-items: center; gap: 15px;">
            <div>
                <span style="font-size: 12px;">DB: </span>
                <progress id="db-usage" max="100" value="0" style="width: 80px;"></progress>
                <span id="db-percent" style="font-size: 12px;">0%</span>
            </div>
            <div>
                <span style="font-size: 12px;">Storage: </span>
                <progress id="storage-usage" max="100" value="0" style="width: 80px;"></progress>
                <span id="storage-percent" style="font-size: 12px;">0%</span>
            </div>
        </div>
        <div class="error-bar" id="error-bar" style="display: none; background: #dc3545; color: white; padding: 8px 12px; border-radius: 4px; font-size: 14px;">
            <span id="error-message">ãƒ‡ãƒ¼ã‚¿ã«å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ</span>
            <button id="recovery-btn" style="margin-left: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 3px;">ğŸ”™ å‰å›æ­£å¸¸æ™‚ã«æˆ»ã‚‹</button>
        </div>
        <button id="history-btn" style="opacity: 0.6; background: none; border: none; font-size: 14px; cursor: pointer;">å±¥æ­´</button>
    </div>

    <!-- å±¥æ­´ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
    <div class="history-sidebar" id="history-sidebar" style="position: fixed; right: -400px; top: 0; width: 400px; height: 100vh; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1000; overflow-y: auto;">
        <div class="history-header" style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
            <h3 style="margin: 0;">å±¥æ­´</h3>
            <button id="close-history" style="background: none; border: none; font-size: 20px; cursor: pointer;">Ã—</button>
        </div>
        <div style="padding: 20px;">
            <input type="text" id="history-search" placeholder="å±¥æ­´ã‚’æ¤œç´¢..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
            <div id="search-results-count" style="font-size: 14px; color: #666; margin-bottom: 15px;">æ¤œç´¢çµæœ: 0ä»¶</div>
            <div class="history-list" id="history-list">
                <!-- å±¥æ­´é …ç›®ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script>
        'use strict';

        // Supabaseè¨­å®šï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ãƒ»å¤‰æ›´å³ç¦ï¼‰
        const SUPABASE_URL = 'https://jfrwyunauatsybdljlah.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impmcnd5dW5hdWF0c3liZGxqbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTMxODksImV4cCI6MjA2OTA4OTE4OX0.cyhPTiN4WAQ2p86JBZObjSljt2i1K_bK-cGGo3soxAo';

        // CDNèª­ã¿è¾¼ã¿ç¢ºèªï¼ˆç¢ºå®ŸãªåˆæœŸåŒ–ï¼‰
        async function waitForSupabase() {
            let retryCount = 0;
            while (!window.supabase && retryCount < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retryCount++;
            }
            
            if (!window.supabase) {
                throw new Error('Supabase CDNã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å®‰å…¨ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç¦æ­¢ï¼‰
        async function safeSupabaseOperation(operation, operationName) {
            try {
                const result = await operation();
                if (result.error) {
                    console.error(`${operationName}ã‚¨ãƒ©ãƒ¼:`, result.error);
                    showErrorInUI(`${operationName}ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`, result.error);
                    return { success: false, error: result.error };
                }
                return { success: true, data: result.data };
            } catch (err) {
                console.error(`${operationName}ä¾‹å¤–:`, err);
                showErrorInUI(`${operationName}ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸ`, err);
                return { success: false, error: err };
            }
        }

        // UIå†…ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä¸ä½¿ç”¨ï¼‰
        function showErrorInUI(message, error) {
            const errorBar = document.getElementById('error-bar');
            const errorMessage = document.getElementById('error-message');
            if (errorBar && errorMessage) {
                errorMessage.textContent = message;
                errorBar.style.display = 'flex';
                
                // 10ç§’å¾Œã«è‡ªå‹•éè¡¨ç¤º
                setTimeout(() => {
                    errorBar.style.display = 'none';
                }, 10000);
            }
        }

        function hideError() {
            const errorBar = document.getElementById('error-bar');
            if (errorBar) {
                errorBar.style.display = 'none';
            }
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showSuccessInUI(message) {
            const errorBar = document.getElementById('error-bar');
            const errorMessage = document.getElementById('error-message');
            if (errorBar && errorMessage) {
                errorMessage.textContent = message;
                errorBar.style.background = '#28a745';
                errorBar.style.display = 'flex';
                
                setTimeout(() => {
                    errorBar.style.display = 'none';
                    errorBar.style.background = '#dc3545';
                }, 3000);
            }
        }

        // å…¥åŠ›å€¤æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ 
        function validateInput(value, type, required = true) {
            if (required && (!value || value.toString().trim() === '')) {
                throw new Error('å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            switch (type) {
                case 'currency':
                    if (!/^[A-Z]{6}$/.test(value)) {
                        throw new Error('é€šè²¨ãƒšã‚¢å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    }
                    break;
                case 'scenario':
                    if (!/^scenario/.test(value)) {
                        throw new Error('ã‚·ãƒŠãƒªã‚ªIDå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    }
                    break;
            }
            return true;
        }

        // DOMè¦ç´ ã®å®‰å…¨ã‚¢ã‚¯ã‚»ã‚¹
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${id}`);
                return null;
            }
            return element;
        }

        function safeUpdateElement(elementId, content) {
            const element = safeGetElement(elementId);
            if (!element) return false;
            
            try {
                element.innerHTML = content;
                return true;
            } catch (error) {
                console.error('DOMæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // XSSé˜²æ­¢ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
        function sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        function safeSetInnerHTML(element, content) {
            element.innerHTML = sanitizeHTML(content);
        }

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆé€šè²¨ãƒšã‚¢Ã—ã‚·ãƒŠãƒªã‚ªåˆ¥å®Œå…¨åˆ†é›¢ï¼‰
        class DataManager {
            constructor(supabase) {
                this.supabase = supabase;
                this.currentCurrency = 'USDJPY';
                this.currentScenario = 'scenario1';
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ç”Ÿæˆï¼ˆå³æ ¼ï¼‰
            getKey(currency, scenario, type) {
                if (!currency || !scenario || !type) {
                    throw new Error(`ç„¡åŠ¹ãªã‚­ãƒ¼è¦ç´ : currency=${currency}, scenario=${scenario}, type=${type}`);
                }
                return `${currency}_${scenario}_${type}`;
            }
            
            // è‡ªå‹•ä¿å­˜ï¼ˆå…¥åŠ›ã¨åŒæ™‚ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãªã—ï¼‰
            async autoSave(currency, scenario, type, value) {
                try {
                    const key = this.getKey(currency, scenario, type);
                    const result = await safeSupabaseOperation(
                        () => this.supabase.from('fx_analysis_data').upsert([{
                            id: key,
                            data: { value },
                            updated_at: new Date().toISOString()
                        }]),
                        'ãƒ‡ãƒ¼ã‚¿è‡ªå‹•ä¿å­˜'
                    );
                    
                    if (result.success) {
                        await this.saveToHistory('ãƒ‡ãƒ¼ã‚¿æ›´æ–°', key, value);
                        this.updateUsageMonitor();
                    } else {
                        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                        this.saveToLocalStorage(key, value);
                    }
                } catch (err) {
                    console.error('è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                    this.saveToLocalStorage(this.getKey(currency, scenario, type), value);
                }
            }
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async loadData(currency, scenario, type) {
                try {
                    const key = this.getKey(currency, scenario, type);
                    const result = await safeSupabaseOperation(
                        () => this.supabase.from('fx_analysis_data').select('*').eq('id', key).single(),
                        'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿'
                    );
                    
                    if (result.success && result.data) {
                        return result.data.data?.value;
                    }
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
                    return this.loadFromLocalStorage(key);
                } catch (err) {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                    return this.loadFromLocalStorage(this.getKey(currency, scenario, type));
                }
            }
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            saveToLocalStorage(key, value) {
                try {
                    localStorage.setItem(`backup_${key}`, JSON.stringify({
                        value,
                        timestamp: new Date().toISOString()
                    }));
                } catch (err) {
                    console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                }
            }
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
            loadFromLocalStorage(key) {
                try {
                    const stored = localStorage.getItem(`backup_${key}`);
                    return stored ? JSON.parse(stored).value : null;
                } catch (err) {
                    console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                    return null;
                }
            }

            // å±¥æ­´ä¿å­˜
            async saveToHistory(changeType, key, newValue, oldValue = null) {
                try {
                    if (window.app && window.app.historyManager) {
                        await window.app.historyManager.saveToHistory(changeType, key, newValue, oldValue);
                    }
                } catch (err) {
                    console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                }
            }

            // ä½¿ç”¨é‡ç›£è¦–æ›´æ–°
            updateUsageMonitor() {
                try {
                    if (window.app && window.app.usageMonitor) {
                        window.app.usageMonitor.updateUsage();
                    }
                } catch (err) {
                    console.error('ä½¿ç”¨é‡ç›£è¦–æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
                }
            }
        }

        // ã‚·ãƒŠãƒªã‚ªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        class ScenarioManager {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.scenarios = new Map();
            }
            
            // ã‚·ãƒŠãƒªã‚ªè¿½åŠ ï¼ˆåå‰å…¥åŠ›å¿…é ˆã€ç”»åƒå¿…é ˆ1-2æšï¼‰
            async addScenario(currency) {
                try {
                    // ã‚·ãƒŠãƒªã‚ªåå…¥åŠ›ï¼ˆconfirmä½¿ç”¨ã¯å‰Šé™¤æ™‚ã®ã¿è¨±å¯ï¼‰
                    const scenarioName = prompt('ã‚·ãƒŠãƒªã‚ªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', `ã‚·ãƒŠãƒªã‚ª${Date.now()}`);
                    if (!scenarioName) return;
                    
                    // ç”»åƒé¸æŠ
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = 'image/*';
                    fileInput.multiple = true;
                    
                    return new Promise((resolve) => {
                        fileInput.onchange = async (e) => {
                            const files = Array.from(e.target.files);
                            if (files.length === 0 || files.length > 2) {
                                showErrorInUI('1æšã¾ãŸã¯2æšã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                                resolve(false);
                                return;
                            }
                            
                            const scenarioId = `scenario_${Date.now()}`;
                            const success = await this.processAndUploadScenario(currency, scenarioId, scenarioName, files);
                            resolve(success);
                        };
                        
                        fileInput.click();
                    });
                } catch (err) {
                    showErrorInUI('ã‚·ãƒŠãƒªã‚ªè¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                    return false;
                }
            }
            
            // ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºï¼‰
            async deleteScenario(currency, scenarioId) {
                if (!confirm('ã“ã®ã‚·ãƒŠãƒªã‚ªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return false;
                
                try {
                    // é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨å‰Šé™¤
                    await this.deleteScenarioData(currency, scenarioId);
                    await this.deleteScenarioImages(scenarioId);
                    await this.updateScenarioUI(currency);
                    
                    await this.dataManager.saveToHistory('ã‚·ãƒŠãƒªã‚ªå‰Šé™¤', `${currency}_${scenarioId}`, null);
                    return true;
                } catch (err) {
                    showErrorInUI('ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                    return false;
                }
            }
            
            // ç”»åƒå‡¦ç†ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            async processAndUploadScenario(currency, scenarioId, scenarioName, files) {
                try {
                    const processedImages = [];
                    
                    for (const file of files) {
                        // ç”»åƒãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                        this.validateImage(file);
                        
                        // ç”»åƒåœ§ç¸®
                        const compressedImage = await this.compressImage(file);
                        
                        // Supabaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                        const uploadResult = await this.uploadImage(scenarioId, compressedImage);
                        if (uploadResult.success) {
                            processedImages.push(uploadResult.data);
                        }
                    }
                    
                    // ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ä¿å­˜
                    const scenarioData = {
                        name: scenarioName,
                        images: processedImages,
                        created: new Date().toISOString()
                    };
                    
                    await this.dataManager.autoSave(currency, scenarioId, 'scenario', scenarioData);
                    await this.updateScenarioUI(currency);
                    
                    return true;
                } catch (err) {
                    showErrorInUI('ç”»åƒå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                    return false;
                }
            }
            
            // ç”»åƒãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            validateImage(file) {
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                const maxSize = 10 * 1024 * 1024; // 10MB
                
                if (!allowedTypes.includes(file.type)) {
                    throw new Error('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç”»åƒå½¢å¼ã§ã™');
                }
                
                if (file.size > maxSize) {
                    throw new Error('ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆ10MBä»¥ä¸‹ï¼‰');
                }
            }
            
            // ç”»åƒåœ§ç¸®
            async compressImage(file) {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        // æœ€å¤§ã‚µã‚¤ã‚ºè¨­å®š
                        const maxWidth = 1200;
                        const maxHeight = 800;
                        
                        let { width, height } = img;
                        
                        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ã¦ãƒªã‚µã‚¤ã‚º
                        if (width > maxWidth || height > maxHeight) {
                            const ratio = Math.min(maxWidth / width, maxHeight / height);
                            width *= ratio;
                            height *= ratio;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // ç”»åƒã‚’æç”»
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // åœ§ç¸®ï¼ˆå“è³ª0.8ï¼‰
                        canvas.toBlob(resolve, 'image/jpeg', 0.8);
                    };
                    
                    img.src = URL.createObjectURL(file);
                });
            }

            // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒƒã‚¯å®Ÿè£…ï¼‰
            async uploadImage(scenarioId, compressedImage) {
                try {
                    // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ Supabase Storage ã‚’ä½¿ç”¨
                    const fileName = `${scenarioId}_${Date.now()}.jpg`;
                    
                    // ä¸€æ™‚çš„ãª URL ã‚’ç”Ÿæˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ Supabase Storage URLï¼‰
                    const imageUrl = URL.createObjectURL(compressedImage);
                    
                    return {
                        success: true,
                        data: {
                            url: imageUrl,
                            fileName: fileName,
                            size: compressedImage.size
                        }
                    };
                } catch (err) {
                    return { success: false, error: err };
                }
            }

            // ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿å‰Šé™¤
            async deleteScenarioData(currency, scenarioId) {
                // é–¢é€£ã™ã‚‹ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ã‚’å‰Šé™¤
                const dataTypes = ['scenario', 'memo', 'analysisStatus', 'targetWave'];
                for (const type of dataTypes) {
                    const key = this.dataManager.getKey(currency, scenarioId, type);
                    await safeSupabaseOperation(
                        () => this.dataManager.supabase.from('fx_analysis_data').delete().eq('id', key),
                        'ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿å‰Šé™¤'
                    );
                }
            }

            // ã‚·ãƒŠãƒªã‚ªç”»åƒå‰Šé™¤
            async deleteScenarioImages(scenarioId) {
                // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ Supabase Storage ã‹ã‚‰ç”»åƒã‚’å‰Šé™¤
                console.log(`ã‚·ãƒŠãƒªã‚ª ${scenarioId} ã®ç”»åƒã‚’å‰Šé™¤`);
            }

            // ã‚·ãƒŠãƒªã‚ªUIæ›´æ–°
            async updateScenarioUI(currency) {
                // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã®å†æ§‹ç¯‰
                const container = document.getElementById('scenario-container');
                if (!container) return;

                // æ—¢å­˜ã®ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã‚’å–å¾—
                const existingButtons = container.querySelectorAll('.scenario-btn');
                
                // æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã®å‡¦ç†
                showSuccessInUI('ã‚·ãƒŠãƒªã‚ªãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
            }
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ä¸¦ã³é †å¤‰æ›´
            initDragAndDrop() {
                const container = document.getElementById('scenario-container');
                if (!container) return;

                let draggedElement = null;
                
                // PC: ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
                container.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('scenario-btn')) {
                        draggedElement = e.target;
                        e.target.classList.add('dragging');
                    }
                });
                
                container.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = this.getDragAfterElement(container, e.clientY);
                    if (afterElement == null) {
                        container.appendChild(draggedElement);
                    } else {
                        container.insertBefore(draggedElement, afterElement);
                    }
                });
                
                container.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                    this.saveScenarioOrder();
                });
                
                // ã‚¹ãƒãƒ›: é•·æŠ¼ã—
                this.initTouchDragDrop(container);
            }
            
            // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            initTouchDragDrop(container) {
                let longPressTimer;
                let isDragging = false;
                
                container.addEventListener('touchstart', (e) => {
                    if (e.target.classList.contains('scenario-btn')) {
                        longPressTimer = setTimeout(() => {
                            isDragging = true;
                            e.target.classList.add('dragging');
                        }, 500);
                    }
                });
                
                container.addEventListener('touchend', () => {
                    clearTimeout(longPressTimer);
                    if (isDragging) {
                        const dragging = container.querySelector('.dragging');
                        if (dragging) {
                            dragging.classList.remove('dragging');
                        }
                        this.saveScenarioOrder();
                        isDragging = false;
                    }
                });
            }

            // ãƒ‰ãƒ©ãƒƒã‚°å¾Œã®è¦ç´ å–å¾—
            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.scenario-btn:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            // ã‚·ãƒŠãƒªã‚ªé †åºä¿å­˜
            async saveScenarioOrder() {
                try {
                    const container = document.getElementById('scenario-container');
                    if (!container) return;

                    const scenarios = [...container.querySelectorAll('.scenario-btn')].map(btn => btn.dataset.scenario);
                    await this.dataManager.autoSave('global', 'settings', 'scenarioOrder', scenarios);
                } catch (err) {
                    console.error('ã‚·ãƒŠãƒªã‚ªé †åºä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                }
            }
        }

        // å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ200ä»¶åˆ¶é™ã€æ¤œç´¢æ©Ÿèƒ½ï¼‰
        class HistoryManager {
            constructor(supabase) {
                this.supabase = supabase;
                this.maxHistories = 200;
                this.isCleaningUp = false;
            }
            
            // å±¥æ­´ä¿å­˜
            async saveToHistory(changeType, key, newValue, oldValue = null) {
                if (this.isCleaningUp) {
                    await this.waitForCleanupComplete();
                }
                
                try {
                    const historyData = {
                        timestamp: new Date().toISOString(),
                        version_id: `v_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        description: `${changeType}: ${key}`,
                        data_snapshot: { key, newValue, oldValue },
                        changes: { 
                            changeType, 
                            deviceInfo: this.getDeviceInfo(),
                            userAgent: navigator.userAgent.substring(0, 100)
                        }
                    };
                    
                    await this.supabase.from('fx_analysis_history').insert([historyData]);
                    
                    // éåŒæœŸã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    setTimeout(() => this.cleanupOldHistory(), 1000);
                    
                } catch (error) {
                    console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            // å±¥æ­´æ¤œç´¢
            async searchHistory(query) {
                try {
                    let queryBuilder = this.supabase
                        .from('fx_analysis_history')
                        .select('*')
                        .order('timestamp', { ascending: false });
                    
                    if (query && query.trim()) {
                        queryBuilder = queryBuilder.or(
                            `description.ilike.%${query}%,data_snapshot->>key.ilike.%${query}%,data_snapshot->>newValue.ilike.%${query}%`
                        );
                    }
                    
                    const { data, error } = await queryBuilder.limit(100);
                    
                    if (error) throw error;
                    
                    this.displaySearchResults(data, query);
                    return data;
                } catch (err) {
                    showErrorInUI('å±¥æ­´æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                    return [];
                }
            }
            
            // æ¤œç´¢çµæœè¡¨ç¤º
            displaySearchResults(data, query) {
                const resultsList = document.getElementById('history-list');
                const resultsCount = document.getElementById('search-results-count');
                
                if (resultsCount) {
                    resultsCount.textContent = `æ¤œç´¢çµæœ: ${data.length}ä»¶`;
                }
                
                if (resultsList) {
                    resultsList.innerHTML = '';
                    
                    data.forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        historyItem.innerHTML = `
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${new Date(item.timestamp).toLocaleString('ja-JP')}
                            </div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 8px;">
                                ${sanitizeHTML(item.description)}
                            </div>
                            <div style="font-size: 12px; color: #999;">
                                ${item.changes?.deviceInfo || 'Unknown Device'}
                            </div>
                            <button onclick="window.historyManager.restoreFromHistory('${item.version_id}')" 
                                    style="margin-top: 8px; font-size: 12px; padding: 4px 8px;">
                                ã“ã®æ™‚ç‚¹ã«æˆ»ã‚‹
                            </button>
                        `;
                        
                        resultsList.appendChild(historyItem);
                    });
                }
            }
            
            // å±¥æ­´ã‹ã‚‰å¾©å…ƒ
            async restoreFromHistory(versionId) {
                if (!confirm('ã“ã®æ™‚ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã«å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) return;
                
                try {
                    const { data, error } = await this.supabase
                        .from('fx_analysis_history')
                        .select('*')
                        .eq('version_id', versionId)
                        .single();
                    
                    if (error) throw error;
                    
                    // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå‡¦ç†
                    await this.performRestore(data.data_snapshot);
                    
                    // å¾©å…ƒæˆåŠŸ
                    showSuccessInUI('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                    this.closeHistoryPanel();
                    
                } catch (err) {
                    showErrorInUI('ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                }
            }

            // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå®Ÿè¡Œ
            async performRestore(dataSnapshot) {
                try {
                    if (dataSnapshot && dataSnapshot.key && dataSnapshot.newValue !== undefined) {
                        await this.supabase.from('fx_analysis_data').upsert([{
                            id: dataSnapshot.key,
                            data: { value: dataSnapshot.newValue },
                            updated_at: new Date().toISOString()
                        }]);
                        
                        // UIæ›´æ–°
                        if (window.app) {
                            await window.app.updateCurrentDisplay();
                        }
                    }
                } catch (err) {
                    throw new Error('å¾©å…ƒå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            }

            // å±¥æ­´ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
            closeHistoryPanel() {
                const sidebar = document.getElementById('history-sidebar');
                if (sidebar) {
                    sidebar.style.right = '-400px';
                }
            }
            
            // å¤ã„å±¥æ­´ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            async cleanupOldHistory() {
                if (this.isCleaningUp) return;
                
                this.isCleaningUp = true;
                try {
                    const { data, error } = await this.supabase
                        .from('fx_analysis_history')
                        .select('id')
                        .order('timestamp', { ascending: false })
                        .range(this.maxHistories, 1000);
                        
                    if (!error && data && data.length > 0) {
                        const idsToDelete = data.map(item => item.id);
                        await this.supabase.from('fx_analysis_history').delete().in('id', idsToDelete);
                    }
                } catch (error) {
                    console.error('å±¥æ­´ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
                } finally {
                    this.isCleaningUp = false;
                }
            }
            
            // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±å–å¾—
            getDeviceInfo() {
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                return isMobile ? 'Mobile' : 'PC';
            }
            
            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†å¾…æ©Ÿ
            async waitForCleanupComplete() {
                while (this.isCleaningUp) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆæ‰‹å‹•å®Ÿè¡Œã€å®Œäº†å ±å‘Šã®ã¿ï¼‰
        class BackupManager {
            constructor(supabase) {
                this.supabase = supabase;
            }
            
            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼ˆé€²è¡Œè¡¨ç¤ºãªã—ã€å®Œäº†å ±å‘Šã®ã¿ï¼‰
            async createBackup() {
                try {
                    // å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—
                    const { data: mainData } = await this.supabase.from('fx_analysis_data').select('*');
                    const { data: historyData } = await this.supabase.from('fx_analysis_history').select('*');
                    
                    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        version: '1.0',
                        mainData: mainData || [],
                        historyData: historyData || [],
                        metadata: {
                            totalRecords: (mainData?.length || 0) + (historyData?.length || 0),
                            exportedBy: 'FX Analysis System',
                            userAgent: navigator.userAgent
                        }
                    };
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { 
                        type: 'application/json' 
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `fx-backup-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // å®Œäº†å ±å‘Šï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãªã—ï¼‰
                    showSuccessInUI(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆ${backupData.metadata.totalRecords}ä»¶ï¼‰`);
                    
                } catch (err) {
                    showErrorInUI('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                }
            }
        }

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç®¡ç†ï¼ˆæ‰‹å‹•åˆ‡ã‚Šæ›¿ãˆã€è¨­å®šåŒæœŸï¼‰
        class ThemeManager {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.isDark = false;
                this.init();
            }
            
            async init() {
                // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿
                const savedTheme = await this.dataManager.loadData('global', 'settings', 'darkMode');
                if (savedTheme !== null) {
                    this.isDark = savedTheme;
                }
                
                this.applyTheme();
                this.updateToggleButton();
            }
            
            // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
            async toggleTheme() {
                this.isDark = !this.isDark;
                this.applyTheme();
                this.updateToggleButton();
                
                // è¨­å®šåŒæœŸï¼ˆPC/ã‚¹ãƒãƒ›é–“ï¼‰
                await this.dataManager.autoSave('global', 'settings', 'darkMode', this.isDark);
            }
            
            // ãƒ†ãƒ¼ãƒé©ç”¨
            applyTheme() {
                document.body.classList.toggle('dark-mode', this.isDark);
            }
            
            // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³æ›´æ–°
            updateToggleButton() {
                const toggleBtn = document.getElementById('theme-toggle');
                if (toggleBtn) {
                    toggleBtn.textContent = this.isDark ? 'â˜€ï¸' : 'ğŸŒ™';
                    toggleBtn.title = this.isDark ? 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' : 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ';
                }
            }
        }

        // ä½¿ç”¨é‡ç›£è¦–ï¼ˆå¸¸æ™‚è¡¨ç¤ºã€ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ï¼‰
        class UsageMonitor {
            constructor(supabase) {
                this.supabase = supabase;
                this.dbLimit = 500; // MB
                this.storageLimit = 1024; // MB
                this.init();
            }
            
            init() {
                // 30ç§’é–“éš”ã§ä½¿ç”¨é‡æ›´æ–°
                this.updateUsage();
                setInterval(() => this.updateUsage(), 30000);
            }
            
            async updateUsage() {
                try {
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½¿ç”¨é‡è¨ˆç®—
                    const { data: dbData } = await this.supabase.from('fx_analysis_data').select('*');
                    const dbUsage = this.calculateDataSize(dbData);
                    
                    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ï¼ˆæ¦‚ç®—ï¼‰
                    const storageUsage = await this.calculateStorageUsage();
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
                    this.updateProgressBar('db-usage', 'db-percent', dbUsage, this.dbLimit);
                    this.updateProgressBar('storage-usage', 'storage-percent', storageUsage, this.storageLimit);
                    
                } catch (err) {
                    console.error('ä½¿ç”¨é‡ç›£è¦–ã‚¨ãƒ©ãƒ¼:', err);
                }
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºè¨ˆç®—
            calculateDataSize(data) {
                if (!data) return 0;
                const jsonString = JSON.stringify(data);
                return (new Blob([jsonString]).size) / 1024 / 1024; // MB
            }
            
            // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡è¨ˆç®—ï¼ˆæ¦‚ç®—ï¼‰
            async calculateStorageUsage() {
                // ç”»åƒãƒ‡ãƒ¼ã‚¿ã®æ¦‚ç®—è¨ˆç®—
                try {
                    const { data } = await this.supabase.from('fx_analysis_data').select('images');
                    let totalSize = 0;
                    
                    data?.forEach(item => {
                        if (item.images) {
                            // ç”»åƒãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¦‚ç®—ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
                            Object.values(item.images).forEach(imageArray => {
                                if (Array.isArray(imageArray)) {
                                    imageArray.forEach(img => {
                                        totalSize += (img.size || 1024) / 1024; // KB to MB
                                    });
                                }
                            });
                        }
                    });
                    
                    return totalSize;
                } catch (err) {
                    console.error('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', err);
                    return 0;
                }
            }
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
            updateProgressBar(progressId, percentId, usage, limit) {
                const progressBar = document.getElementById(progressId);
                const percentSpan = document.getElementById(percentId);
                
                if (progressBar && percentSpan) {
                    const percentage = Math.min((usage / limit) * 100, 100);
                    progressBar.value = percentage;
                    percentSpan.textContent = `${percentage.toFixed(1)}%`;
                    
                    // ä½¿ç”¨é‡ã«å¿œã˜ãŸè‰²å¤‰æ›´
                    if (percentage > 90) {
                        progressBar.style.accentColor = '#dc3545'; // èµ¤
                    } else if (percentage > 70) {
                        progressBar.style.accentColor = '#ffc107'; // é»„
                    } else {
                        progressBar.style.accentColor = '#007bff'; // é’
                    }
                }
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        class KeyboardShortcuts {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.init();
            }
            
            init() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key.toLowerCase()) {
                            case 's':
                                e.preventDefault();
                                this.manualSave();
                                break;
                            case 'c':
                                if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                                    e.preventDefault();
                                    this.copySelectedElement();
                                }
                                break;
                            case 'v':
                                if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                                    e.preventDefault();
                                    this.pasteToSelectedElement();
                                }
                                break;
                        }
                    }
                });
            }
            
            // æ‰‹å‹•ä¿å­˜
            async manualSave() {
                try {
                    // ç¾åœ¨ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶ä¿å­˜
                    const memo = document.getElementById('analysis-memo')?.value || '';
                    const prompt = document.getElementById('fixed-prompt')?.value || '';
                    
                    await this.dataManager.autoSave(
                        this.dataManager.currentCurrency, 
                        this.dataManager.currentScenario, 
                        'memo', 
                        memo
                    );
                    
                    await this.dataManager.autoSave('global', 'settings', 'fixedPrompt', prompt);
                    
                    showSuccessInUI('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                } catch (err) {
                    showErrorInUI('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', err);
                }
            }
            
            // é¸æŠè¦ç´ ã®ã‚³ãƒ”ãƒ¼
            copySelectedElement() {
                const activeElement = document.activeElement;
                if (activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT') {
                    activeElement.select();
                    document.execCommand('copy');
                    showSuccessInUI('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                }
            }
            
            // é¸æŠè¦ç´ ã¸ã®è²¼ã‚Šä»˜ã‘
            async pasteToSelectedElement() {
                try {
                    const text = await navigator.clipboard.readText();
                    const activeElement = document.activeElement;
                    
                    if (activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT') {
                        activeElement.value = text;
                        activeElement.dispatchEvent(new Event('input', { bubbles: true }));
                        showSuccessInUI('è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ');
                    }
                } catch (err) {
                    console.error('è²¼ã‚Šä»˜ã‘ã‚¨ãƒ©ãƒ¼:', err);
                }
            }
        }

        // ã‚¨ãƒ©ãƒ¼ç›£è¦–
        class ErrorMonitor {
            constructor() {
                this.errorCount = 0;
                this.errors = [];
                this.init();
            }
            
            init() {
                window.addEventListener('error', (e) => {
                    this.logError('JavaScript Error', e.error);
                });
                
                window.addEventListener('unhandledrejection', (e) => {
                    this.logError('Unhandled Promise Rejection', e.reason);
                });
            }
            
            logError(type, error) {
                this.errorCount++;
                this.errors.push({
                    type,
                    message: error?.message || 'Unknown error',
                    timestamp: new Date().toISOString(),
                    stack: error?.stack || 'No stack trace'
                });
                
                // ã‚¨ãƒ©ãƒ¼ç‡ç›£è¦–
                if (this.errorCount > 10) {
                    showErrorInUI('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒå¤šç™ºã—ã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                }
            }
        }

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        class OfflineManager {
            constructor() {
                this.isOnline = navigator.onLine;
                this.init();
            }
            
            init() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.syncPendingData();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showOfflineMode();
                });
            }
            
            showOfflineMode() {
                showErrorInUI('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰: è¡¨ç¤ºã®ã¿å¯èƒ½ã§ã™');
            }

            async syncPendingData() {
                showSuccessInUI('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸ');
                // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¸­ã«è“„ç©ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸ
            }
        }

        // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹
        class FXAnalysisApp {
            constructor() {
                this.supabase = null;
                this.dataManager = null;
                this.scenarioManager = null;
                this.historyManager = null;
                this.backupManager = null;
                this.themeManager = null;
                this.usageMonitor = null;
                this.keyboardShortcuts = null;
                this.errorMonitor = null;
                this.offlineManager = null;
            }
            
            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
            async initialize() {
                try {
                    // 1. CDNèª­ã¿è¾¼ã¿ç¢ºèª
                    await waitForSupabase();
                    
                    // 2. SupabaseåˆæœŸåŒ–
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    // 3. æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    const { error } = await this.supabase.from('fx_analysis_data').select('count', { count: 'exact', head: true });
                    if (error) throw error;
                    
                    // 4. ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
                    this.dataManager = new DataManager(this.supabase);
                    this.scenarioManager = new ScenarioManager(this.dataManager);
                    this.historyManager = new HistoryManager(this.supabase);
                    this.backupManager = new BackupManager(this.supabase);
                    this.themeManager = new ThemeManager(this.dataManager);
                    this.usageMonitor = new UsageMonitor(this.supabase);
                    this.keyboardShortcuts = new KeyboardShortcuts(this.dataManager);
                    this.errorMonitor = new ErrorMonitor();
                    this.offlineManager = new OfflineManager();
                    
                    // 5. UIåˆæœŸåŒ–
                    this.initializeUI();
                    this.loadInitialData();
                    
                    // 6. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                    this.setupEventListeners();
                    
                    console.log('FX Analysis System åˆæœŸåŒ–å®Œäº†');
                    
                } catch (error) {
                    this.showFallbackUI(error);
                }
            }

            // åˆæœŸåŒ–å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            showFallbackUI(error) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                        <h2 style="color: #dc3545;">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h2>
                        <p style="margin: 20px 0;">${error.message}</p>
                        <div style="margin: 20px 0;">
                            <button onclick="location.reload()" style="padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">å†èª­ã¿è¾¼ã¿</button>
                            <button onclick="localStorage.clear(); location.reload()" style="padding: 10px 20px; margin: 5px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
                        </div>
                        <details style="margin-top: 30px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                            <summary style="cursor: pointer; color: #666;">æŠ€è¡“è©³ç´°</summary>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow: auto; font-size: 12px;">${error.stack || 'ã‚¹ã‚¿ãƒƒã‚¯æƒ…å ±ãªã—'}</pre>
                        </details>
                    </div>
                `;
            }
            
            // UIåˆæœŸåŒ–
            initializeUI() {
                // ã‚·ãƒŠãƒªã‚ªãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—åˆæœŸåŒ–
                this.scenarioManager.initDragAndDrop();
                
                // åˆæœŸçŠ¶æ…‹è¨­å®š
                this.updateCurrentDisplay();
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners() {
                // é€šè²¨ãƒšã‚¢ãƒœã‚¿ãƒ³
                document.querySelectorAll('.currency-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectCurrency(e.target.dataset.currency);
                    });
                });
                
                // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('scenario-btn')) {
                        this.selectScenario(e.target.dataset.scenario);
                    }
                });
                
                // åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³
                document.querySelectorAll('.status-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectAnalysisStatus(e.target.dataset.status);
                    });
                });
                
                // ç‹™ã†æ³¢ãƒœã‚¿ãƒ³
                document.querySelectorAll('.wave-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectTargetWave(e.target.dataset.wave);
                    });
                });
                
                // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è‡ªå‹•ä¿å­˜
                const memoElement = document.getElementById('analysis-memo');
                if (memoElement) {
                    memoElement.addEventListener('input', 
                        this.debounce((e) => {
                            this.dataManager.autoSave(
                                this.dataManager.currentCurrency,
                                this.dataManager.currentScenario,
                                'memo',
                                e.target.value
                            );
                        }, 1000)
                    );
                }
                
                const promptElement = document.getElementById('fixed-prompt');
                if (promptElement) {
                    promptElement.addEventListener('input',
                        this.debounce((e) => {
                            this.dataManager.autoSave('global', 'settings', 'fixedPrompt', e.target.value);
                        }, 1000)
                    );
                }
                
                // å„ç¨®ãƒœã‚¿ãƒ³
                const backupBtn = document.getElementById('backup-btn');
                if (backupBtn) {
                    backupBtn.addEventListener('click', () => {
                        this.backupManager.createBackup();
                    });
                }
                
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => {
                        this.themeManager.toggleTheme();
                    });
                }
                
                const addScenario = document.getElementById('add-scenario');
                if (addScenario) {
                    addScenario.addEventListener('click', () => {
                        this.scenarioManager.addScenario(this.dataManager.currentCurrency);
                    });
                }
                
                const removeScenario = document.getElementById('remove-scenario');
                if (removeScenario) {
                    removeScenario.addEventListener('click', () => {
                        this.scenarioManager.deleteScenario(
                            this.dataManager.currentCurrency,
                            this.dataManager.currentScenario
                        );
                    });
                }
                
                // å±¥æ­´é–¢é€£
                const historyBtn = document.getElementById('history-btn');
                if (historyBtn) {
                    historyBtn.addEventListener('click', () => {
                        this.openHistoryPanel();
                    });
                }
                
                const closeHistory = document.getElementById('close-history');
                if (closeHistory) {
                    closeHistory.addEventListener('click', () => {
                        this.closeHistoryPanel();
                    });
                }
                
                const historySearch = document.getElementById('history-search');
                if (historySearch) {
                    historySearch.addEventListener('input',
                        this.debounce((e) => {
                            this.historyManager.searchHistory(e.target.value);
                        }, 500)
                    );
                }
                
                // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
                const copyMemo = document.getElementById('copy-memo');
                if (copyMemo) {
                    copyMemo.addEventListener('click', () => {
                        const memoValue = document.getElementById('analysis-memo')?.value || '';
                        this.copyToClipboard(memoValue);
                    });
                }
                
                const copyPrompt = document.getElementById('copy-prompt');
                if (copyPrompt) {
                    copyPrompt.addEventListener('click', () => {
                        const promptValue = document.getElementById('fixed-prompt')?.value || '';
                        this.copyToClipboard(promptValue);
                    });
                }
                
                // ã‚¨ãƒ©ãƒ¼ãƒãƒ¼é–‰ã˜ã‚‹
                const recoveryBtn = document.getElementById('recovery-btn');
                if (recoveryBtn) {
                    recoveryBtn.addEventListener('click', () => {
                        hideError();
                    });
                }

                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
                const prevChart = document.getElementById('prev-chart');
                if (prevChart) {
                    prevChart.addEventListener('click', () => {
                        this.navigateChart(-1);
                    });
                }

                const nextChart = document.getElementById('next-chart');
                if (nextChart) {
                    nextChart.addEventListener('click', () => {
                        this.navigateChart(1);
                    });
                }

                const topReturn = document.getElementById('top-return');
                if (topReturn) {
                    topReturn.addEventListener('click', () => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                }

                // ChatGPTé–¢é€£ãƒœã‚¿ãƒ³
                const changePrompt = document.getElementById('change-prompt');
                if (changePrompt) {
                    changePrompt.addEventListener('click', () => {
                        showSuccessInUI('å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
                    });
                }

                const chatgptAnalysis = document.getElementById('chatgpt-analysis');
                if (chatgptAnalysis) {
                    chatgptAnalysis.addEventListener('click', () => {
                        this.openChatGPTAnalysis();
                    });
                }
            }
            
            // ãƒ‡ãƒã‚¦ãƒ³ã‚¹é–¢æ•°
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // é€šè²¨ãƒšã‚¢é¸æŠ
            async selectCurrency(currency) {
                // UIæ›´æ–°
                document.querySelectorAll('.currency-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.currency === currency);
                });
                
                this.dataManager.currentCurrency = currency;
                await this.updateCurrentDisplay();
            }
            
            // ã‚·ãƒŠãƒªã‚ªé¸æŠ
            async selectScenario(scenario) {
                // UIæ›´æ–°
                document.querySelectorAll('.scenario-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.scenario === scenario);
                });
                
                this.dataManager.currentScenario = scenario;
                await this.updateCurrentDisplay();
            }
            
            // è¡¨ç¤ºæ›´æ–°
            async updateCurrentDisplay() {
                const currency = this.dataManager.currentCurrency;
                const scenario = this.dataManager.currentScenario;
                
                // é€šè²¨ãƒšã‚¢åè¡¨ç¤º
                const currentPair = document.getElementById('current-pair');
                if (currentPair) {
                    currentPair.textContent = currency;
                }
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                const memo = await this.dataManager.loadData(currency, scenario, 'memo');
                const analysisStatus = await this.dataManager.loadData(currency, scenario, 'analysisStatus');
                const targetWave = await this.dataManager.loadData(currency, scenario, 'targetWave');
                
                // UIåæ˜ 
                const memoElement = document.getElementById('analysis-memo');
                if (memoElement) {
                    memoElement.value = memo || '';
                }
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³æ›´æ–°
                document.querySelectorAll('.status-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.status === analysisStatus);
                });
                
                document.querySelectorAll('.wave-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.wave === (targetWave || 'æœªé¸æŠ'));
                });
                
                // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
                this.updateScenarioStatusDisplay(scenario, analysisStatus);
            }
            
            // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
            updateScenarioStatusDisplay(scenario, status) {
                const scenarioBtn = document.querySelector(`[data-scenario="${scenario}"]`);
                if (scenarioBtn) {
                    const statusIndicator = scenarioBtn.querySelector('.status-indicator');
                    if (statusIndicator && status) {
                        const statusEmoji = {
                            'æ¤œè¨ä¸­': 'ğŸ“Š',
                            'è¨ˆç®—ä¸­': 'ğŸ”„', 
                            'å®Ÿæˆ¦': 'âš¡',
                            'åˆ©ç¢º': 'ğŸ“ˆ',
                            'æåˆ‡ã‚Š': 'ğŸ“‰',
                            'è¦‹é€ã‚Š': 'ğŸ‘€'
                        };
                        statusIndicator.textContent = `${statusEmoji[status] || 'ğŸ“Š'} ${status}`;
                    }
                }
            }
            
            // åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ
            async selectAnalysisStatus(status) {
                document.querySelectorAll('.status-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.status === status);
                });
                
                await this.dataManager.autoSave(
                    this.dataManager.currentCurrency,
                    this.dataManager.currentScenario,
                    'analysisStatus',
                    status
                );
                
                this.updateScenarioStatusDisplay(this.dataManager.currentScenario, status);
            }
            
            // ç‹™ã†æ³¢é¸æŠ
            async selectTargetWave(wave) {
                document.querySelectorAll('.wave-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.wave === wave);
                });
                
                await this.dataManager.autoSave(
                    this.dataManager.currentCurrency,
                    this.dataManager.currentScenario,
                    'targetWave',
                    wave
                );
            }

            // ãƒãƒ£ãƒ¼ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
            navigateChart(direction) {
                const scenarios = [...document.querySelectorAll('.scenario-btn')];
                const currentIndex = scenarios.findIndex(btn => btn.classList.contains('active'));
                
                if (currentIndex !== -1) {
                    const newIndex = currentIndex + direction;
                    if (newIndex >= 0 && newIndex < scenarios.length) {
                        const newScenario = scenarios[newIndex].dataset.scenario;
                        if (newScenario) {
                            this.selectScenario(newScenario);
                        }
                    }
                }
            }

            // ChatGPTåˆ†æã‚’é–‹ã
            openChatGPTAnalysis() {
                const memo = document.getElementById('analysis-memo')?.value || '';
                const prompt = document.getElementById('fixed-prompt')?.value || '';
                const combinedText = `${prompt}\n\n${memo}`.trim();
                
                if (combinedText) {
                    this.copyToClipboard(combinedText);
                    showSuccessInUI('åˆ†æå†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ChatGPTã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                } else {
                    showErrorInUI('åˆ†æå†…å®¹ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            }
            
            // å±¥æ­´ãƒ‘ãƒãƒ«é–‹ã
            openHistoryPanel() {
                const sidebar = document.getElementById('history-sidebar');
                if (sidebar) {
                    sidebar.style.right = '0';
                    this.historyManager.searchHistory(''); // å…¨å±¥æ­´è¡¨ç¤º
                }
            }
            
            // å±¥æ­´ãƒ‘ãƒãƒ«é–‰ã˜ã‚‹
            closeHistoryPanel() {
                const sidebar = document.getElementById('history-sidebar');
                if (sidebar) {
                    sidebar.style.right = '-400px';
                }
            }
            
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    showSuccessInUI('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                } catch (err) {
                    console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showSuccessInUI('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    } catch (fallbackErr) {
                        showErrorInUI('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    document.body.removeChild(textArea);
                }
            }
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async loadInitialData() {
                // å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿
                const fixedPrompt = await this.dataManager.loadData('global', 'settings', 'fixedPrompt');
                const promptElement = document.getElementById('fixed-prompt');
                if (fixedPrompt && promptElement) {
                    promptElement.value = fixedPrompt;
                }
                
                // åˆæœŸè¡¨ç¤ºæ›´æ–°
                await this.updateCurrentDisplay();
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        let app;
        window.addEventListener('DOMContentLoaded', async function() {
            app = new FXAnalysisApp();
            await app.initialize();
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§è¨­å®š
            window.app = app;
            window.historyManager = app.historyManager;
        });
    </script>
</body>
</html>
