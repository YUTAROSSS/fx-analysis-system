<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXé€šè²¨ãƒšã‚¢åˆ†æç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    
    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getDatabase, ref, set, get, onValue, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

      const firebaseConfig = {
        apiKey: "AIzaSyBMwI1i8DSnFYSBhz_zv80oGYaRmqvXEzA",
        authDomain: "fx-analysis-system.firebaseapp.com",
        databaseURL: "https://fx-analysis-system-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fx-analysis-system",
        storageBucket: "fx-analysis-system.firebasestorage.app",
        messagingSenderId: "286393020262",
        appId: "1:286393020262:web:eee0ede07040002b4762a7"
      };

      try {
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebaseOff = off;
        console.log('âœ… FirebaseåˆæœŸåŒ–æˆåŠŸ');
      } catch (error) {
        console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
      }
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; }
        .main-content { padding: 20px; }
        .section { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .section-title { font-size: 14px; font-weight: 600; color: #495057; margin-bottom: 10px; }
        
        .currency-tabs { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .currency-tab { padding: 8px 16px; background: white; border: 2px solid #dee2e6; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .currency-tab.active { background: #4285f4; color: white; border-color: #4285f4; }
        
        .scenario-buttons { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .scenario-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .scenario-btn { padding: 8px 16px; border: 2px solid #4285f4; border-radius: 8px; cursor: pointer; font-size: 11px; min-width: 80px; font-weight: 600; background: #4285f4; color: white; }
        .scenario-btn.selected { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); transform: translateY(-3px); }
        
        .status-label { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; white-space: nowrap; }
        .status-considering { background: #007bff; color: white; }
        .status-skip { background: #6c757d; color: white; }
        .status-pending { background: #dc3545; color: white; }
        .status-completed { background: #28a745; color: white; }
        
        .currency-display { text-align: center; margin: 20px 0; font-size: 24px; font-weight: 700; color: #2c3e50; }
        
        /* ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ */
        .chart-area { display: flex; flex-direction: column; align-items: center; margin: 20px 0; }
        .chart-container { width: 100%; max-width: 800px; height: 400px; border: 2px solid #e9ecef; border-radius: 12px; overflow: hidden; cursor: pointer; background: white; }
        .chart-image { width: 100%; height: 100%; object-fit: contain; display: block; }
        .chart-placeholder { width: 100%; height: 100%; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 16px; font-weight: 600; flex-direction: column; text-align: center; padding: 20px; }
        
        .control-section { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .status-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .status-btn { padding: 10px 12px; border: 2px solid #dee2e6; background: white; border-radius: 8px; cursor: pointer; font-size: 12px; text-align: center; font-weight: 600; }
        .status-btn.active { border-color: #4285f4; background: #4285f4; color: white; }
        
        .analysis-memo { height: 150px; width: 100%; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; resize: vertical; font-size: 12px; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin: 5px; }
        .btn-primary { background: #4285f4; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        
        .copy-area { background: #f8f9fa; border: 2px solid #28a745; padding: 20px; margin-top: 15px; border-radius: 12px; display: none; }
        .copy-area.active { display: block; }
        .copy-textarea { width: 100%; height: 200px; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; font-size: 12px; font-family: monospace; }
        
        .sync-status { position: fixed; top: 10px; right: 20px; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 1000; }
        .sync-status.connected { background: #28a745; color: white; }
        .sync-status.disconnected { background: #dc3545; color: white; }
        .sync-status.syncing { background: #ffc107; color: #212529; }
        
        @media (max-width: 767px) {
            .main-content { padding: 15px; }
            .status-buttons { grid-template-columns: repeat(2, 1fr); }
            .chart-container { height: 300px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sync-status" id="syncStatus">æ¥ç¶šç¢ºèªä¸­...</div>
        
        <div class="header">
            <h1>ğŸ” FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
        </div>

        <div class="main-content">
            <!-- é€šè²¨ãƒšã‚¢é¸æŠ -->
            <div class="section">
                <div class="section-title">é€šè²¨ãƒšã‚¢é¸æŠ</div>
                <div class="currency-tabs" id="currencyTabs"></div>
            </div>

            <!-- ã‚·ãƒŠãƒªã‚ªé¸æŠ -->
            <div class="section">
                <div class="section-title">ã‚·ãƒŠãƒªã‚ªé¸æŠ</div>
                <button class="btn btn-success" onclick="addScenario()">â• ã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
                <button class="btn btn-warning" onclick="forceFirebaseSave()">ğŸ”¥ Firebaseå¼·åˆ¶ä¿å­˜</button>
                <button class="btn btn-danger" onclick="fixScenarioKeys()">ğŸ”§ ã‚·ãƒŠãƒªã‚ªã‚­ãƒ¼ä¿®æ­£</button>
                <div class="scenario-buttons" id="scenarioButtons"></div>
            </div>
            
            <!-- é€šè²¨ãƒšã‚¢è¡¨ç¤º -->
            <div class="currency-display" id="currencyDisplay">USD/JPY</div>

            <!-- ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
            <div class="chart-area">
                <div class="chart-container" onclick="openChartModal()">
                    <div class="chart-placeholder" id="chartDisplay">
                        ğŸ“ˆ USD/JPY ãƒãƒ£ãƒ¼ãƒˆ
                        <small style="margin-top: 10px; display: block;">
                            ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ãã ã•ã„
                        </small>
                    </div>
                    <img id="chartImage" class="chart-image" style="display: none;" alt="ãƒãƒ£ãƒ¼ãƒˆç”»åƒ">
                </div>
            </div>

            <!-- åˆ†æã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="control-section">
                <div class="section-title">åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                <div class="status-buttons">
                    <div class="status-btn active" onclick="setStatus(this, 'considering')">ğŸ¤” æ¤œè¨ä¸­</div>
                    <div class="status-btn" onclick="setStatus(this, 'skip')">â­ï¸ è¦‹é€ã‚Š</div>
                    <div class="status-btn" onclick="setStatus(this, 'pending')">ğŸ“‹ æŒ‡å€¤ä¸­</div>
                    <div class="status-btn" onclick="setStatus(this, 'holding')">ğŸ’¼ ä¿æŒä¸­</div>
                    <div class="status-btn" onclick="setStatus(this, 'completed')">âœ… å®Œäº†</div>
                </div>
            </div>

            <div class="control-section">
                <div class="section-title">ğŸ“ åˆ†æãƒ¡ãƒ¢</div>
                <textarea class="analysis-memo" id="analysisMemo" placeholder="åˆ†æå†…å®¹ã‚’è¨˜å…¥..." onchange="saveMemo()"></textarea>
            </div>

            <div class="control-section">
                <button class="btn btn-success" onclick="toggleCopyArea()">ğŸ“‹ ChatGPTç”¨ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º</button>
                <div class="copy-area" id="copyArea">
                    <textarea class="copy-textarea" id="copyTextarea" readonly></textarea>
                    <button class="btn btn-primary" onclick="copyText()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    <button class="btn btn-danger" onclick="closeCopyArea()">âœ• é–‰ã˜ã‚‹</button>
                </div>
            </div>

            <!-- ãƒ‡ãƒãƒƒã‚° -->
            <div class="section">
                <div class="section-title">ğŸ”§ ãƒ‡ãƒãƒƒã‚°</div>
                <button class="btn btn-primary" onclick="debugData()">ğŸ“± ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
                <button class="btn btn-warning" onclick="testFirebase()">ğŸ”¥ Firebaseç¢ºèª</button>
                <button class="btn btn-danger" onclick="resetData()">ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <script>
        // â˜… å®Œå…¨ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚·ãƒŠãƒªã‚ªã‚­ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
        let appState = {
            currentCurrency: "USDJPY",
            currentScenario: "USDJPY-scenario1", // â˜… ãƒã‚¤ãƒ•ãƒ³åŒºåˆ‡ã‚Šã§ã‚ˆã‚Šæ˜ç¢ºã«
            currencies: {
                USDJPY: "USD/JPY",
                EURUSD: "EUR/USD", 
                GBPUSD: "GBP/USD"
            },
            scenarios: {
                USDJPY: ["USDJPY-scenario1", "USDJPY-scenario2", "USDJPY-scenario3"],
                EURUSD: ["EURUSD-scenario1", "EURUSD-scenario2"],
                GBPUSD: ["GBPUSD-scenario1", "GBPUSD-scenario2", "GBPUSD-scenario3"]
            },
            scenarioLabels: {
                "USDJPY-scenario1": "ã‚·ãƒŠãƒªã‚ª1", "USDJPY-scenario2": "ã‚·ãƒŠãƒªã‚ª2", "USDJPY-scenario3": "ã‚·ãƒŠãƒªã‚ª3",
                "EURUSD-scenario1": "ã‚·ãƒŠãƒªã‚ª1", "EURUSD-scenario2": "ã‚·ãƒŠãƒªã‚ª2",
                "GBPUSD-scenario1": "ã‚·ãƒŠãƒªã‚ª1", "GBPUSD-scenario2": "ã‚·ãƒŠãƒªã‚ª2", "GBPUSD-scenario3": "ã‚·ãƒŠãƒªã‚ª3"
            },
            // â˜… ç”»åƒè¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã‚’å¾©æ´»
            currencyData: {
                'USDJPY': {
                    pair: 'USD/JPY',
                    images: ['USDJPY.jpeg', 'USDJPY2.jpeg', 'USDJPY3.jpeg'],
                    imageLabels: ['ã‚·ãƒŠãƒªã‚ª1', 'ã‚·ãƒŠãƒªã‚ª2', 'ã‚·ãƒŠãƒªã‚ª3']
                },
                'EURUSD': {
                    pair: 'EUR/USD',
                    images: ['EURUSD.jpeg', 'EURUSD2.jpeg'],
                    imageLabels: ['ã‚·ãƒŠãƒªã‚ª1', 'ã‚·ãƒŠãƒªã‚ª2']
                },
                'GBPUSD': {
                    pair: 'GBP/USD',
                    images: ['GBPUSD.jpeg', 'GBPUSD2.jpeg', 'GBPUSD3.jpeg'],
                    imageLabels: ['ã‚·ãƒŠãƒªã‚ª1', 'ã‚·ãƒŠãƒªã‚ª2', 'ã‚·ãƒŠãƒªã‚ª3']
                }
            },
            scenarioMemos: {},
            scenarioStatuses: {},
            uploadedImages: {},
            lastUpdate: Date.now(),
            deviceId: 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            version: '4.0'
        };

        let isConnected = false;

        function updateSyncStatus(status, message) {
            const statusDiv = document.getElementById('syncStatus');
            statusDiv.textContent = message;
            statusDiv.className = `sync-status ${status}`;
            isConnected = (status === 'connected');
        }

        // â˜… å¤ã„ã‚·ãƒŠãƒªã‚ªã‚­ãƒ¼ã‚’æ–°ã—ã„ã‚­ãƒ¼ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function fixScenarioKeys() {
            console.log('ğŸ”§ ã‚·ãƒŠãƒªã‚ªã‚­ãƒ¼ä¿®æ­£é–‹å§‹...');
            
            const oldToNewMapping = {
                'scenario1': {
                    'USDJPY': 'USDJPY-scenario1',
                    'EURUSD': 'EURUSD-scenario1', 
                    'GBPUSD': 'GBPUSD-scenario1'
                },
                'scenario2': {
                    'USDJPY': 'USDJPY-scenario2',
                    'EURUSD': 'EURUSD-scenario2',
                    'GBPUSD': 'GBPUSD-scenario2'
                },
                'scenario3': {
                    'USDJPY': 'USDJPY-scenario3',
                    'GBPUSD': 'GBPUSD-scenario3'
                }
            };

            // å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„ã‚­ãƒ¼ã«ç§»è¡Œ
            const newScenarioMemos = {};
            const newScenarioStatuses = {};

            Object.keys(appState.scenarioMemos || {}).forEach(oldKey => {
                if (oldKey.startsWith('scenario') && !oldKey.includes('-')) {
                    // å¤ã„ã‚­ãƒ¼å½¢å¼ã®å ´åˆã€ç¾åœ¨ã®é€šè²¨ã«åŸºã¥ã„ã¦æ–°ã—ã„ã‚­ãƒ¼ã‚’ç”Ÿæˆ
                    const newKey = `${appState.currentCurrency}-${oldKey}`;
                    newScenarioMemos[newKey] = appState.scenarioMemos[oldKey];
                    console.log(`ğŸ“ ãƒ¡ãƒ¢ç§»è¡Œ: ${oldKey} â†’ ${newKey}`);
                } else {
                    newScenarioMemos[oldKey] = appState.scenarioMemos[oldKey];
                }
            });

            Object.keys(appState.scenarioStatuses || {}).forEach(oldKey => {
                if (oldKey.startsWith('scenario') && !oldKey.includes('-')) {
                    const newKey = `${appState.currentCurrency}-${oldKey}`;
                    newScenarioStatuses[newKey] = appState.scenarioStatuses[oldKey];
                    console.log(`ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç§»è¡Œ: ${oldKey} â†’ ${newKey}`);
                } else {
                    newScenarioStatuses[oldKey] = appState.scenarioStatuses[oldKey];
                }
            });

            appState.scenarioMemos = newScenarioMemos;
            appState.scenarioStatuses = newScenarioStatuses;

            // ç¾åœ¨ã®ã‚·ãƒŠãƒªã‚ªã‚‚ä¿®æ­£
            if (appState.currentScenario && !appState.currentScenario.includes('-')) {
                appState.currentScenario = `${appState.currentCurrency}-${appState.currentScenario}`;
            }

            updateUI();
            forceFirebaseSave();
            
            alert('ğŸ”§ ã‚·ãƒŠãƒªã‚ªã‚­ãƒ¼ä¿®æ­£å®Œäº†ï¼\n\nå„é€šè²¨ãƒšã‚¢ã®ã‚·ãƒŠãƒªã‚ªãŒç‹¬ç«‹ã—ã¦ç®¡ç†ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚');
        }

        // Firebaseä¿å­˜ç”¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
        function getCleanDataForFirebase() {
            return {
                currentCurrency: appState.currentCurrency,
                currentScenario: appState.currentScenario,
                currencies: appState.currencies,
                scenarios: appState.scenarios,
                scenarioLabels: appState.scenarioLabels,
                scenarioMemos: appState.scenarioMemos || {},
                scenarioStatuses: appState.scenarioStatuses || {},
                uploadedImages: appState.uploadedImages || {},
                lastUpdate: Date.now(),
                deviceId: appState.deviceId,
                version: '4.0'
            };
        }

        function forceFirebaseSave() {
            console.log('ğŸ”¥ Firebaseå¼·åˆ¶ä¿å­˜é–‹å§‹...');
            updateSyncStatus('syncing', 'ğŸ”¥ å¼·åˆ¶ä¿å­˜ä¸­...');
            
            if (!window.firebaseDatabase) {
                alert('âŒ FirebaseæœªåˆæœŸåŒ–ã§ã™');
                updateSyncStatus('disconnected', 'FirebaseæœªåˆæœŸåŒ–');
                return;
            }

            const cleanData = getCleanDataForFirebase();
            const dataRef = window.firebaseRef(window.firebaseDatabase, 'appData');
            
            window.firebaseSet(dataRef, cleanData)
                .then(() => {
                    console.log('âœ… Firebaseå¼·åˆ¶ä¿å­˜æˆåŠŸ');
                    updateSyncStatus('connected', 'ğŸ”¥ å¼·åˆ¶ä¿å­˜å®Œäº†');
                    localStorage.setItem('fxAppState', JSON.stringify(appState));
                    alert('âœ… Firebaseå¼·åˆ¶ä¿å­˜å®Œäº†ï¼');
                })
                .catch(error => {
                    console.error('âŒ Firebaseå¼·åˆ¶ä¿å­˜å¤±æ•—:', error);
                    updateSyncStatus('disconnected', 'å¼·åˆ¶ä¿å­˜å¤±æ•—');
                    alert(`âŒ ä¿å­˜å¤±æ•—: ${error.message}`);
                });
        }

        // åˆæœŸåŒ–æ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        function initializeData() {
            Object.keys(appState.scenarios).forEach(currency => {
                appState.scenarios[currency].forEach(scenarioKey => {
                    if (!appState.scenarioStatuses[scenarioKey]) {
                        appState.scenarioStatuses[scenarioKey] = 'considering';
                    }
                    if (!appState.scenarioMemos[scenarioKey]) {
                        appState.scenarioMemos[scenarioKey] = '';
                    }
                });
            });
            console.log('âœ… ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–å®Œäº†:', {
                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ•°: Object.keys(appState.scenarioStatuses).length,
                ãƒ¡ãƒ¢æ•°: Object.keys(appState.scenarioMemos).length
            });
        }

        // UIæ›´æ–°
        function updateUI() {
            updateCurrencyTabs();
            updateScenarioButtons();
            updateCurrencyDisplay();
            loadCurrentImage();
            updateDisplay();
            generateCopyText();
        }

        function updateCurrencyTabs() {
            const container = document.getElementById('currencyTabs');
            container.innerHTML = '';
            
            Object.keys(appState.currencies).forEach(currencyKey => {
                const tab = document.createElement('div');
                tab.className = 'currency-tab' + (currencyKey === appState.currentCurrency ? ' active' : '');
                tab.textContent = appState.currencies[currencyKey];
                tab.onclick = function() { 
                    appState.currentCurrency = currencyKey;
                    // â˜… é€šè²¨åˆ‡ã‚Šæ›¿ãˆæ™‚ã«æ­£ã—ã„ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠ
                    appState.currentScenario = appState.scenarios[currencyKey][0];
                    updateUI();
                    saveData();
                };
                container.appendChild(tab);
            });
        }

        function updateScenarioButtons() {
            const container = document.getElementById('scenarioButtons');
            container.innerHTML = '';
            
            const currentScenarios = appState.scenarios[appState.currentCurrency] || [];
            
            currentScenarios.forEach(scenarioKey => {
                const scenarioItem = document.createElement('div');
                scenarioItem.className = 'scenario-item';
                
                const btn = document.createElement('div');
                btn.className = 'scenario-btn';
                btn.textContent = appState.scenarioLabels[scenarioKey] || scenarioKey;
                btn.onclick = function() { 
                    appState.currentScenario = scenarioKey;
                    updateScenarioButtons();
                    updateDisplay();
                    loadCurrentImage();
                    saveData();
                };
                
                if (scenarioKey === appState.currentScenario) {
                    btn.classList.add('selected');
                }
                
                // â˜… æ­£ã—ã„ã‚·ãƒŠãƒªã‚ªã‚­ãƒ¼ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
                const scenarioStatus = appState.scenarioStatuses[scenarioKey] || 'considering';
                const statusLabel = document.createElement('div');
                statusLabel.className = `status-label status-${scenarioStatus}`;
                statusLabel.textContent = getStatusText(scenarioStatus);
                
                scenarioItem.appendChild(btn);
                scenarioItem.appendChild(statusLabel);
                container.appendChild(scenarioItem);
                
                console.log(`ğŸ”§ ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³: ${scenarioKey} = ${scenarioStatus}`);
            });
        }

        function getStatusText(status) {
            const statusTexts = {
                'considering': 'ğŸ¤” æ¤œè¨ä¸­',
                'skip': 'â­ï¸ è¦‹é€ã‚Š',
                'pending': 'ğŸ“‹ æŒ‡å€¤ä¸­',
                'holding': 'ğŸ’¼ ä¿æŒä¸­',
                'completed': 'âœ… å®Œäº†'
            };
            return statusTexts[status] || 'ğŸ¤” æ¤œè¨ä¸­';
        }

        function updateCurrencyDisplay() {
            const display = document.getElementById('currencyDisplay');
            display.textContent = appState.currencies[appState.currentCurrency] || appState.currentCurrency;
        }

        // â˜… ç”»åƒè¡¨ç¤ºæ©Ÿèƒ½ã‚’å¾©æ´»
        function loadCurrentImage() {
            const data = appState.currencyData[appState.currentCurrency];
            if (!data || !data.images || data.images.length === 0) {
                showPlaceholder();
                return;
            }

            const currentScenarios = appState.scenarios[appState.currentCurrency] || [];
            const scenarioIndex = currentScenarios.indexOf(appState.currentScenario);
            const imageIndex = Math.max(0, scenarioIndex);
            const currentImageName = data.images[imageIndex] || data.images[0];
            
            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒã‚’ãƒã‚§ãƒƒã‚¯
            if (appState.uploadedImages && appState.uploadedImages[currentImageName]) {
                displayUploadedImage(appState.uploadedImages[currentImageName]);
                return;
            }

            // é€šå¸¸ã®ç”»åƒãƒ‘ã‚¹ã‚’è©¦è¡Œ
            const imagePaths = [`images/${currentImageName}`, currentImageName];
            tryLoadImage(imagePaths, 0);
        }

        function tryLoadImage(paths, index) {
            if (index >= paths.length) {
                showPlaceholder();
                return;
            }

            const img = new Image();
            img.onload = function() {
                displayImage(paths[index]);
            };
            img.onerror = function() {
                tryLoadImage(paths, index + 1);
            };
            img.src = paths[index];
        }

        function displayImage(src) {
            const chartImage = document.getElementById('chartImage');
            const placeholder = document.getElementById('chartDisplay');
            
            chartImage.src = src;
            chartImage.style.display = 'block';
            placeholder.style.display = 'none';
        }

        function displayUploadedImage(src) {
            const chartImage = document.getElementById('chartImage');
            const placeholder = document.getElementById('chartDisplay');
            
            chartImage.src = src;
            chartImage.style.display = 'block';
            placeholder.style.display = 'none';
        }

        function showPlaceholder() {
            const chartImage = document.getElementById('chartImage');
            const placeholder = document.getElementById('chartDisplay');
            
            chartImage.style.display = 'none';
            placeholder.style.display = 'flex';
            
            const currencyName = appState.currencies[appState.currentCurrency] || appState.currentCurrency;
            placeholder.innerHTML = `
                ğŸ“ˆ ${currencyName} ãƒãƒ£ãƒ¼ãƒˆ
                <small style="margin-top: 10px; display: block;">
                    ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ãã ã•ã„
                </small>
            `;
        }

        function updateDisplay() {
            // â˜… æ­£ã—ã„ã‚·ãƒŠãƒªã‚ªã‚­ãƒ¼ã§ãƒ¡ãƒ¢ã‚’å–å¾—
            const scenarioMemo = appState.scenarioMemos[appState.currentScenario] || '';
            document.getElementById('analysisMemo').value = scenarioMemo;
            
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            
            // â˜… æ­£ã—ã„ã‚·ãƒŠãƒªã‚ªã‚­ãƒ¼ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
            const currentStatus = appState.scenarioStatuses[appState.currentScenario] || 'considering';
            const statusButtons = document.querySelectorAll('.status-btn');
            const statusMap = { 'considering': 0, 'skip': 1, 'pending': 2, 'holding': 3, 'completed': 4 };
            
            const statusIndex = statusMap[currentStatus] || 0;
            if (statusButtons[statusIndex]) {
                statusButtons[statusIndex].classList.add('active');
            }
            
            console.log('ğŸ”§ è¡¨ç¤ºæ›´æ–°:', {
                ç¾åœ¨ã‚·ãƒŠãƒªã‚ª: appState.currentScenario,
                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: currentStatus,
                ãƒ¡ãƒ¢æ–‡å­—æ•°: scenarioMemo.length
            });
        }

        function setStatus(element, status) {
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            
            // â˜… æ­£ã—ã„ã‚·ãƒŠãƒªã‚ªã‚­ãƒ¼ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿å­˜
            appState.scenarioStatuses[appState.currentScenario] = status;
            console.log(`ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š: ${appState.currentScenario} = ${status}`);
            
            updateScenarioButtons();
            generateCopyText();
            saveData();
        }

        function saveMemo() {
            const memo = document.getElementById('analysisMemo').value;
            // â˜… æ­£ã—ã„ã‚·ãƒŠãƒªã‚ªã‚­ãƒ¼ã§ãƒ¡ãƒ¢ã‚’ä¿å­˜
            appState.scenarioMemos[appState.currentScenario] = memo;
            console.log(`ğŸ“ ãƒ¡ãƒ¢ä¿å­˜: ${appState.currentScenario} = ${memo.length}æ–‡å­—`);
            generateCopyText();
            saveData();
        }

        function addScenario() {
            const scenarioName = prompt('ã‚·ãƒŠãƒªã‚ªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ã‚·ãƒŠãƒªã‚ª4');
            if (!scenarioName) return;

            // â˜… é€šè²¨ãƒšã‚¢åˆ¥ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆ
            const scenarioKey = `${appState.currentCurrency}-scenario${Date.now()}`;
            appState.scenarioLabels[scenarioKey] = scenarioName;
            
            if (!appState.scenarios[appState.currentCurrency]) {
                appState.scenarios[appState.currentCurrency] = [];
            }
            appState.scenarios[appState.currentCurrency].push(scenarioKey);
            
            appState.currentScenario = scenarioKey;
            
            updateUI();
            saveData();
            alert(`âœ… "${scenarioName}" ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);
        }

        function generateCopyText() {
            const currentStatus = appState.scenarioStatuses[appState.currentScenario] || 'considering';
            const currentMemo = appState.scenarioMemos[appState.currentScenario] || '';
            const currentLabel = appState.scenarioLabels[appState.currentScenario] || appState.currentScenario;

            const message = `ğŸ“Š **FXåˆ†æãƒ‡ãƒ¼ã‚¿**
ãƒ»é€šè²¨ãƒšã‚¢: ${appState.currencies[appState.currentCurrency]}
ãƒ»ã‚·ãƒŠãƒªã‚ª: ${currentLabel}
ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${getStatusText(currentStatus)}
ãƒ»åˆ†ææ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}

ğŸ“ **åˆ†æãƒ¡ãƒ¢**
${currentMemo || 'è¨˜è¼‰ãªã—'}`;

            document.getElementById('copyTextarea').value = message;
        }

        function toggleCopyArea() {
            const copyArea = document.getElementById('copyArea');
            if (copyArea.classList.contains('active')) {
                copyArea.classList.remove('active');
            } else {
                copyArea.classList.add('active');
                generateCopyText();
            }
        }

        function closeCopyArea() {
            document.getElementById('copyArea').classList.remove('active');
        }

        function copyText() {
            const textarea = document.getElementById('copyTextarea');
            textarea.select();
            navigator.clipboard.writeText(textarea.value).then(() => {
                alert('ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
        }

        function openChartModal() {
            // ç°¡æ˜“çš„ãªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆå®Ÿè£…çœç•¥ï¼‰
            alert('ãƒãƒ£ãƒ¼ãƒˆæ‹¡å¤§è¡¨ç¤ºï¼ˆå®Ÿè£…çœç•¥ï¼‰');
        }

        function debugData() {
            console.log('ğŸ” ç¾åœ¨ã®appState:', appState);
            const message = `=== ğŸ“± ãƒ‡ãƒ¼ã‚¿ç¢ºèª ===
ç¾åœ¨é€šè²¨: ${appState.currentCurrency}
ç¾åœ¨ã‚·ãƒŠãƒªã‚ª: ${appState.currentScenario}
ç·ã‚·ãƒŠãƒªã‚ªæ•°: ${Object.values(appState.scenarios).flat().length}å€‹
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ•°: ${Object.keys(appState.scenarioStatuses).length}å€‹
ãƒ¡ãƒ¢æ•°: ${Object.keys(appState.scenarioMemos).length}å€‹
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${appState.version}
Firebaseæ¥ç¶š: ${isConnected ? 'âœ…' : 'âŒ'}`;
            alert(message);
        }

        function testFirebase() {
            if (!window.firebaseDatabase) {
                alert('âŒ FirebaseæœªåˆæœŸåŒ–');
                return;
            }
            
            updateSyncStatus('syncing', 'ãƒ†ã‚¹ãƒˆä¸­...');
            
            const dataRef = window.firebaseRef(window.firebaseDatabase, 'appData');
            window.firebaseGet(dataRef)
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        updateSyncStatus('connected', 'Firebaseæ¥ç¶šOK');
                        alert(`âœ… Firebaseç¢ºèªOK\nãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${data.version}\næœ€çµ‚æ›´æ–°: ${new Date(data.lastUpdate).toLocaleString()}`);
                    } else {
                        updateSyncStatus('disconnected', 'ãƒ‡ãƒ¼ã‚¿ãªã—');
                        alert('âŒ Firebaseãƒ‡ãƒ¼ã‚¿ãªã—');
                    }
                })
                .catch(error => {
                    updateSyncStatus('disconnected', 'æ¥ç¶šã‚¨ãƒ©ãƒ¼');
                    alert(`âŒ Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
                });
        }

        function resetData() {
            if (confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.clear();
                if (window.firebaseDatabase) {
                    const dataRef = window.firebaseRef(window.firebaseDatabase, 'appData');
                    window.firebaseSet(dataRef, null);
                }
                location.reload();
            }
        }

        function saveData() {
            appState.lastUpdate = Date.now();
            localStorage.setItem('fxAppState', JSON.stringify(appState));
            
            if (window.firebaseDatabase && isConnected) {
                const cleanData = getCleanDataForFirebase();
                const dataRef = window.firebaseRef(window.firebaseDatabase, 'appData');
                window.firebaseSet(dataRef, cleanData)
                    .catch(error => {
                        console.error('âŒ è‡ªå‹•ä¿å­˜å¤±æ•—:', error);
                        updateSyncStatus('disconnected', 'ä¿å­˜å¤±æ•—');
                    });
            }
        }

        function loadData() {
            const saved = localStorage.getItem('fxAppState');
            if (saved) {
                try {
                    const loadedState = JSON.parse(saved);
                    appState = { ...appState, ...loadedState };
                    appState.version = '4.0'; // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
                } catch (error) {
                    console.error('âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—:', error);
                }
            }
            initializeData();
            updateUI();
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ FXã‚¢ãƒ—ãƒªåˆæœŸåŒ–é–‹å§‹');
            updateSyncStatus('disconnected', 'åˆæœŸåŒ–ä¸­...');
            loadData();
            
            setTimeout(() => {
                if (window.firebaseDatabase) {
                    testFirebase();
                } else {
                    updateSyncStatus('disconnected', 'FirebaseæœªåˆæœŸåŒ–');
                }
            }, 1000);
        });
    </script>
</body>
</html>
