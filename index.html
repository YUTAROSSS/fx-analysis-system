<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --background-color: #ffffff;
            --text-color: #333333;
            --border-color: #dee2e6;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --background-color: #1a1a1a;
            --text-color: #e0e0e0;
            --border-color: #444444;
            --light-color: #2d2d2d;
            --shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            transition: var(--transition);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--info-color));
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .usage-display {
            display: flex;
            gap: 20px;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }

        .usage-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .usage-item label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .usage-progress {
            width: 80px;
            height: 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            overflow: hidden;
        }

        .usage-progress::-webkit-progress-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }

        .usage-progress::-webkit-progress-value {
            background: #28a745;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            background: var(--secondary-color);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: var(--primary-color);
        }

        .btn-success {
            background: var(--success-color);
        }

        .btn-danger {
            background: var(--danger-color);
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .currency-section {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .currency-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }

        .currency-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            min-width: 80px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .currency-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .currency-btn.active {
            background: var(--primary-color);
            box-shadow: 0 0 20px rgba(0,123,255,0.3);
        }

        .currency-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .currency-btn:hover::before {
            left: 100%;
        }

        .currency-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .current-pair {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, rgba(0,123,255,0.1), rgba(23,162,184,0.1));
            border-radius: var(--border-radius);
            border: 2px solid var(--primary-color);
        }

        .scenarios-section {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .scenario-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .scenario-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            flex: 1;
        }

        .scenario-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .scenario-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            min-width: 100px;
            transition: var(--transition);
            position: relative;
        }

        .scenario-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        .scenario-btn.active {
            background: var(--primary-color);
            box-shadow: 0 0 20px rgba(0,123,255,0.3);
        }

        .status-indicator {
            font-size: 0.7rem;
            padding: 2px 6px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            white-space: nowrap;
            min-height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .analysis-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .status-section, .wave-section {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .status-buttons, .wave-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-btn, .wave-btn {
            background: var(--light-color);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            padding: 10px 16px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            min-width: 80px;
            text-align: center;
        }

        .status-btn:hover, .wave-btn:hover {
            border-color: var(--primary-color);
            background: rgba(0,123,255,0.1);
        }

        .status-btn.active, .wave-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .status-btn[data-status="å®Ÿæˆ¦"].active {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .status-btn[data-status="åˆ©ç¢º"].active {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .status-btn[data-status="æåˆ‡ã‚Š"].active {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }

        .images-section {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .image-areas {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .image-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
            background: var(--background-color);
        }

        .image-area:hover {
            border-color: var(--primary-color);
            background: rgba(0,123,255,0.05);
        }

        .image-area.drag-over {
            border-color: var(--success-color);
            background: rgba(40,167,69,0.1);
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 10px;
        }

        .image-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .memo-section {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .memo-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .memo-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            background: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .memo-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .prompt-section {
            background: var(--light-color);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .prompt-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            background: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .navigation {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            color: white;
            font-size: 18px;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: var(--info-color);
            transform: scale(1.1);
        }

        .history-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--background-color);
            border-left: 1px solid var(--border-color);
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .history-header {
            padding: 20px;
            background: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-content {
            padding: 20px;
        }

        .history-search {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            background: var(--background-color);
            color: var(--text-color);
        }

        .history-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--light-color);
        }

        .history-item:hover {
            background: rgba(0,123,255,0.1);
            border-color: var(--primary-color);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-item-title {
            font-weight: 600;
            color: var(--primary-color);
        }

        .history-item-date {
            font-size: 0.8rem;
            color: var(--secondary-color);
        }

        .history-item-preview {
            font-size: 0.9rem;
            color: var(--text-color);
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .error-bar {
            position: fixed;
            top: -100px;
            left: 0;
            right: 0;
            background: var(--danger-color);
            color: white;
            padding: 15px 20px;
            box-shadow: var(--shadow);
            z-index: 2000;
            transition: top 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error-bar.show {
            top: 0;
        }

        .error-message {
            flex: 1;
            margin-right: 15px;
        }

        .error-actions {
            display: flex;
            gap: 10px;
        }

        .success-bar {
            position: fixed;
            top: -100px;
            left: 0;
            right: 0;
            background: var(--success-color);
            color: white;
            padding: 15px 20px;
            box-shadow: var(--shadow);
            z-index: 2000;
            transition: top 0.3s ease;
            text-align: center;
        }

        .success-bar.show {
            top: 0;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-input {
            display: none;
        }

        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--background-color);
        }

        .drop-zone:hover {
            border-color: var(--primary-color);
            background: rgba(0,123,255,0.05);
        }

        .drop-zone.dragover {
            border-color: var(--success-color);
            background: rgba(40,167,69,0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--background-color);
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary-color);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--danger-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            background: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .usage-display {
                flex-direction: column;
                gap: 15px;
            }

            .analysis-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .image-areas {
                grid-template-columns: 1fr;
            }

            .currency-buttons, .scenario-buttons {
                justify-content: center;
            }

            .scenario-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .scenario-buttons {
                justify-content: center;
            }

            .status-buttons, .wave-buttons {
                justify-content: center;
            }

            .memo-controls, .prompt-controls {
                justify-content: center;
            }

            .navigation {
                bottom: 10px;
                right: 10px;
            }

            .history-sidebar {
                width: 100%;
                right: -100%;
            }

            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
            }
        }

        @media (max-width: 480px) {
            .currency-btn, .scenario-btn {
                min-width: 70px;
                padding: 10px 12px;
                font-size: 13px;
            }

            .status-btn, .wave-btn {
                min-width: 70px;
                padding: 8px 12px;
                font-size: 12px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }

            .section-title {
                font-size: 1.2rem;
            }

            .current-pair {
                font-size: 1.5rem;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .highlight {
            background: linear-gradient(135deg, rgba(255,193,7,0.2), rgba(255,193,7,0.1));
            border: 1px solid var(--warning-color);
            animation: highlight 1s ease-in-out;
        }

        @keyframes highlight {
            0% { background: rgba(255,193,7,0.4); }
            100% { background: rgba(255,193,7,0.1); }
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-color);
            color: white;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            z-index: 1000;
        }

        .tooltip::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--dark-color);
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .tooltip:hover::after,
        .tooltip:hover::before {
            opacity: 1;
            visibility: visible;
        }

        .status-indicator.status-å®Ÿæˆ¦ {
            background: var(--success-color);
            color: white;
        }

        .status-indicator.status-åˆ©ç¢º {
            background: var(--success-color);
            color: white;
        }

        .status-indicator.status-æåˆ‡ã‚Š {
            background: var(--danger-color);
            color: white;
        }

        .status-indicator.status-è¨ˆç®—ä¸­ {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .status-indicator.status-æ¤œè¨ä¸­ {
            background: var(--info-color);
            color: white;
        }

        .status-indicator.status-è¦‹é€ã‚Š {
            background: var(--secondary-color);
            color: white;
        }

        .drag-handle {
            cursor: grab;
            padding: 5px;
            color: var(--secondary-color);
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .scenario-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .scenario-item.drag-over {
            border: 2px dashed var(--primary-color);
            background: rgba(0,123,255,0.1);
        }

        .image-upload-progress {
            width: 100%;
            height: 4px;
            background: var(--light-color);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }

        .image-upload-progress-bar {
            height: 100%;
            background: var(--success-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            transition: var(--transition);
        }

        .connection-status.online {
            background: var(--success-color);
            color: white;
        }

        .connection-status.offline {
            background: var(--danger-color);
            color: white;
        }

        .auto-save-indicator {
            position: fixed;
            bottom: 10px;
            left: 10px;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 12px;
            background: var(--success-color);
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            z-index: 1000;
        }

        .auto-save-indicator.show {
            opacity: 1;
            visibility: visible;
        }

        .keyboard-shortcut-hint {
            font-size: 0.7rem;
            color: var(--secondary-color);
            margin-left: 5px;
            opacity: 0.7;
        }

        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: var(--secondary-color);
            border-radius: 15px;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            outline: none;
        }

        .theme-toggle::before {
            content: 'ğŸŒ™';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        [data-theme="dark"] .theme-toggle {
            background: var(--primary-color);
        }

        [data-theme="dark"] .theme-toggle::before {
            content: 'â˜€ï¸';
            transform: translateX(30px);
        }

        .backup-status {
            padding: 10px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .backup-status.success {
            background: rgba(40,167,69,0.1);
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .backup-status.error {
            background: rgba(220,53,69,0.1);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        .backup-status.info {
            background: rgba(23,162,184,0.1);
            border: 1px solid var(--info-color);
            color: var(--info-color);
        }
    </style>
</head>
<body>
    <div class="connection-status online" id="connection-status">ğŸŸ¢ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</div>
    <div class="auto-save-indicator" id="auto-save-indicator">ğŸ’¾ è‡ªå‹•ä¿å­˜å®Œäº†</div>

    <div class="error-bar" id="error-bar">
        <div class="error-message" id="error-message"></div>
        <div class="error-actions">
            <button class="btn btn-sm" id="recovery-btn">å¾©æ—§</button>
            <button class="close-btn" onclick="hideError()">Ã—</button>
        </div>
    </div>

    <div class="success-bar" id="success-bar">
        <div id="success-message"></div>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <h1>ğŸ“Š FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
                    <div class="header-controls">
                        <div class="usage-display">
                            <div class="usage-item">
                                <label>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</label>
                                <progress class="usage-progress" id="db-usage" value="0" max="100"></progress>
                                <span id="db-percent">0%</span>
                            </div>
                            <div class="usage-item">
                                <label>ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</label>
                                <progress class="usage-progress" id="storage-usage" value="0" max="100"></progress>
                                <span id="storage-percent">0%</span>
                            </div>
                        </div>
                        <button class="theme-toggle" id="theme-toggle" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ (Ctrl+D)"></button>
                        <button class="btn btn-success" id="backup-btn" title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ (Ctrl+Shift+S)">
                            ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                        </button>
                        <button class="btn btn-primary" id="history-btn" title="å±¥æ­´è¡¨ç¤º (Ctrl+H)">
                            ğŸ“š å±¥æ­´
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <section class="currency-section fade-in">
            <h2 class="section-title">
                ğŸŒ é€šè²¨ãƒšã‚¢é¸æŠ
                <span class="keyboard-shortcut-hint">Ctrl+Left/Right: å‰å¾Œç§»å‹•</span>
            </h2>
            <div class="currency-buttons">
                <button class="currency-btn active" data-currency="USDJPY">USDJPY</button>
                <button class="currency-btn" data-currency="EURUSD">EURUSD</button>
                <button class="currency-btn" data-currency="GBPUSD">GBPUSD</button>
                <button class="currency-btn" data-currency="AUDUSD">AUDUSD</button>
                <button class="currency-btn" data-currency="SILVER">SILVER</button>
                <button class="currency-btn" data-currency="GOLD">GOLD</button>
            </div>
            <div class="currency-controls">
                <button class="btn btn-primary" id="add-currency">â• é€šè²¨ãƒšã‚¢è¿½åŠ </button>
                <button class="btn btn-danger" id="remove-currency">ğŸ—‘ï¸ é€šè²¨ãƒšã‚¢å‰Šé™¤</button>
            </div>
        </section>

        <div class="current-pair" id="current-pair">USDJPY</div>

        <section class="scenarios-section fade-in">
            <h2 class="section-title">
                ğŸ“‹ ã‚·ãƒŠãƒªã‚ªç®¡ç†
                <span class="keyboard-shortcut-hint">Ctrl+N: æ–°è¦è¿½åŠ </span>
            </h2>
            <div class="scenario-controls">
                <div class="scenario-buttons" id="scenario-buttons">
                    <div class="scenario-item">
                        <button class="scenario-btn active" data-scenario="scenario1">
                            <span class="drag-handle">â‹®â‹®</span>
                            ã‚·ãƒŠãƒªã‚ª1
                        </button>
                        <div class="status-indicator">ğŸ“Š æœªè¨­å®š</div>
                    </div>
                    <div class="scenario-item">
                        <button class="scenario-btn" data-scenario="scenario2">
                            <span class="drag-handle">â‹®â‹®</span>
                            ã‚·ãƒŠãƒªã‚ª2
                        </button>
                        <div class="status-indicator">ğŸ“Š æœªè¨­å®š</div>
                    </div>
                    <div class="scenario-item">
                        <button class="scenario-btn" data-scenario="scenario3">
                            <span class="drag-handle">â‹®â‹®</span>
                            ã‚·ãƒŠãƒªã‚ª3
                        </button>
                        <div class="status-indicator">ğŸ“Š æœªè¨­å®š</div>
                    </div>
                </div>
                <div class="scenario-actions">
                    <button class="btn btn-primary" id="add-scenario">â• ã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
                    <button class="btn btn-danger" id="remove-scenario">ğŸ—‘ï¸ ã‚·ãƒŠãƒªã‚ªå‰Šé™¤</button>
                </div>
            </div>
        </section>

        <div class="analysis-section">
            <section class="status-section">
                <h3 class="section-title">ğŸ“ˆ åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
                <div class="status-buttons">
                    <button class="status-btn" data-status="æ¤œè¨ä¸­">ğŸ¤” æ¤œè¨ä¸­</button>
                    <button class="status-btn" data-status="è¨ˆç®—ä¸­">ğŸ”„ è¨ˆç®—ä¸­</button>
                    <button class="status-btn" data-status="å®Ÿæˆ¦">âš¡ å®Ÿæˆ¦</button>
                    <button class="status-btn" data-status="åˆ©ç¢º">ğŸ“ˆ åˆ©ç¢º</button>
                    <button class="status-btn" data-status="æåˆ‡ã‚Š">ğŸ“‰ æåˆ‡ã‚Š</button>
                    <button class="status-btn" data-status="è¦‹é€ã‚Š">ğŸ‘€ è¦‹é€ã‚Š</button>
                </div>
            </section>

            <section class="wave-section">
                <h3 class="section-title">ğŸŒŠ ç‹™ã†æ³¢</h3>
                <div class="wave-buttons">
                    <button class="wave-btn" data-wave="1æ³¢">1æ³¢</button>
                    <button class="wave-btn" data-wave="2æ³¢">2æ³¢</button>
                    <button class="wave-btn" data-wave="3æ³¢">3æ³¢</button>
                    <button class="wave-btn" data-wave="4æ³¢">4æ³¢</button>
                    <button class="wave-btn" data-wave="5æ³¢">5æ³¢</button>
                    <button class="wave-btn" data-wave="Aæ³¢">Aæ³¢</button>
                    <button class="wave-btn" data-wave="Bæ³¢">Bæ³¢</button>
                    <button class="wave-btn" data-wave="Cæ³¢">Cæ³¢</button>
                </div>
            </section>
        </div>

        <section class="images-section fade-in">
            <h2 class="section-title">ğŸ–¼ï¸ ãƒãƒ£ãƒ¼ãƒˆç”»åƒ</h2>
            <div class="image-areas">
                <div class="image-area" id="image-area-1">
                    <div class="drop-zone" data-area="1">
                        <p>ğŸ“· ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯<br>ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                        <input type="file" class="file-input" id="file-input-1" accept="image/*" multiple>
                        <div class="image-upload-progress" style="display: none;">
                            <div class="image-upload-progress-bar"></div>
                        </div>
                    </div>
                </div>
                <div class="image-area" id="image-area-2">
                    <div class="drop-zone" data-area="2">
                        <p>ğŸ“· ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯<br>ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                        <input type="file" class="file-input" id="file-input-2" accept="image/*" multiple>
                        <div class="image-upload-progress" style="display: none;">
                            <div class="image-upload-progress-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="memo-section fade-in">
            <h2 class="section-title">
                ğŸ“ åˆ†æãƒ¡ãƒ¢
                <span class="keyboard-shortcut-hint">Ctrl+S: æ‰‹å‹•ä¿å­˜</span>
            </h2>
            <div class="memo-controls">
                <button class="btn btn-primary" id="copy-memo" title="ãƒ¡ãƒ¢ã‚’ã‚³ãƒ”ãƒ¼ (Ctrl+C)">
                    ğŸ“‹ ã‚³ãƒ”ãƒ¼
                </button>
            </div>
            <textarea 
                class="memo-textarea" 
                id="analysis-memo" 
                placeholder="ã“ã“ã«åˆ†æå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...&#10;&#10;ä¾‹ï¼š&#10;- ç¾åœ¨ã®ç›¸å ´çŠ¶æ³&#10;- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ&#10;- åˆ©ç¢ºãƒ»æåˆ‡ã‚Šãƒ©ã‚¤ãƒ³&#10;- ãƒªã‚¹ã‚¯ç®¡ç†æ–¹é‡"
            ></textarea>
        </section>

        <section class="prompt-section fade-in">
            <h2 class="section-title">ğŸ¤– å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h2>
            <div class="prompt-controls">
                <button class="btn btn-primary" id="copy-prompt" title="ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼">
                    ğŸ“‹ ã‚³ãƒ”ãƒ¼
                </button>
                <button class="btn btn-warning" id="change-prompt">
                    âœï¸ å¤‰æ›´
                </button>
                <button class="btn btn-success" id="chatgpt-analysis">
                    ğŸš€ ChatGPTåˆ†æ
                </button>
            </div>
            <textarea 
                class="prompt-textarea" 
                id="fixed-prompt" 
                placeholder="ChatGPTç”¨ã®å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
            >ã‚ãªãŸã¯ãƒ—ãƒ­ã®FXãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®åˆ†æå†…å®¹ã‚’åŸºã«ã€å…·ä½“çš„ãªãƒˆãƒ¬ãƒ¼ãƒ‰æˆ¦ç•¥ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

åˆ†æè¦³ç‚¹ï¼š
1. ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã®å¦¥å½“æ€§
2. ãƒªã‚¹ã‚¯ç®¡ç†ã®é©åˆ‡æ€§
3. ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ»ã‚¨ã‚°ã‚¸ãƒƒãƒˆæˆ¦ç•¥
4. ç›¸å ´ç’°å¢ƒã¨ã®æ•´åˆæ€§

å›ç­”å½¢å¼ï¼š
- æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- æ ¹æ‹ 
- ãƒªã‚¹ã‚¯è¦å› 
- ä»£æ›¿ã‚·ãƒŠãƒªã‚ª</textarea>
        </section>
    </div>

    <div class="navigation">
        <button class="nav-btn tooltip" id="top-return" data-tooltip="ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ (Ctrl+Home)" title="ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹">
            ğŸ”
        </button>
        <button class="nav-btn tooltip" id="prev-chart" data-tooltip="å‰ã®ã‚·ãƒŠãƒªã‚ª" title="å‰ã®ã‚·ãƒŠãƒªã‚ª">
            â¬…ï¸
        </button>
        <button class="nav-btn tooltip" id="next-chart" data-tooltip="æ¬¡ã®ã‚·ãƒŠãƒªã‚ª" title="æ¬¡ã®ã‚·ãƒŠãƒªã‚ª">
            â¡ï¸
        </button>
    </div>

    <div class="history-sidebar" id="history-sidebar">
        <div class="history-header">
            <h3>ğŸ“š å±¥æ­´</h3>
            <button class="close-btn" id="close-history">Ã—</button>
        </div>
        <div class="history-content">
            <input type="text" class="history-search" id="history-search" placeholder="ğŸ” å±¥æ­´ã‚’æ¤œç´¢...">
            <div id="history-list">
                <!-- å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://your-supabase-url.supabase.co';
        const SUPABASE_ANON_KEY = 'your-supabase-anon-key';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let app = null;
        let isInitializing = false;

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function safeGetElement(id) {
            try {
                return document.getElementById(id);
            } catch (error) {
                console.warn(`è¦ç´ å–å¾—ã‚¨ãƒ©ãƒ¼: ${id}`, error);
                return null;
            }
        }

        function safeUpdateElement(id, content) {
            try {
                const element = safeGetElement(id);
                if (element) {
                    element.textContent = content;
                    return true;
                }
                return false;
            } catch (error) {
                console.warn(`è¦ç´ æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${id}`, error);
                return false;
            }
        }

        function validateInput(input, type, required = false) {
            if (required && (!input || input.trim() === '')) {
                throw new Error(`${type}ã¯å¿…é ˆã§ã™`);
            }
            
            if (input) {
                switch (type) {
                    case 'currency':
                        if (!/^[A-Z]{3,8}$/.test(input.trim())) {
                            throw new Error('é€šè²¨ãƒšã‚¢ã¯3-8æ–‡å­—ã®å¤§æ–‡å­—è‹±æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                        }
                        break;
                    case 'scenario':
                        if (!/^[a-zA-Z0-9_-]+$/.test(input.trim())) {
                            throw new Error('ã‚·ãƒŠãƒªã‚ªIDã¯è‹±æ•°å­—ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã€ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™');
                        }
                        break;
                }
            }
            
            return input ? input.trim() : '';
        }

        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        async function waitForSupabase(timeout = 10000) {
            const startTime = Date.now();
            
            while (!window.supabase) {
                if (Date.now() - startTime > timeout) {
                    throw new Error('Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.log('Supabaseãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†');
        }

        async function safeSupabaseOperation(operation, operationName, maxRetries = 3) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const result = await operation();
                    
                    if (result.error) {
                        throw new Error(`Supabaseã‚¨ãƒ©ãƒ¼: ${result.error.message}`);
                    }
                    
                    return {
                        success: true,
                        data: result.data,
                        count: result.count
                    };
                    
                } catch (error) {
                    console.warn(`${operationName} è©¦è¡Œ ${attempt}/${maxRetries} å¤±æ•—:`, error);
                    
                    if (attempt === maxRetries) {
                        console.error(`${operationName} æœ€çµ‚å¤±æ•—:`, error);
                        return {
                            success: false,
                            error: error.message,
                            data: null
                        };
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ»æˆåŠŸè¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ 
        function showErrorInUI(message, error = null) {
            try {
                const errorBar = safeGetElement('error-bar');
                const errorMessage = safeGetElement('error-message');
                
                if (!errorBar || !errorMessage) return;
                
                let displayMessage = message;
                if (error) {
                    displayMessage += ` (è©³ç´°: ${error.message || error})`;
                }
                
                errorMessage.textContent = displayMessage;
                errorBar.classList.add('show');
                
                console.error('UIã‚¨ãƒ©ãƒ¼è¡¨ç¤º:', displayMessage);
                
                setTimeout(() => {
                    hideError();
                }, 10000);
                
            } catch (err) {
                console.error('ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:', err);
            }
        }

        function hideError() {
            try {
                const errorBar = safeGetElement('error-bar');
                if (errorBar) {
                    errorBar.classList.remove('show');
                }
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼éè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function showSuccessInUI(message) {
            try {
                const successBar = safeGetElement('success-bar');
                const successMessage = safeGetElement('success-message');
                
                if (!successBar || !successMessage) return;
                
                successMessage.textContent = message;
                successBar.classList.add('show');
                
                const autoSaveIndicator = safeGetElement('auto-save-indicator');
                if (autoSaveIndicator && message.includes('ä¿å­˜')) {
                    autoSaveIndicator.classList.add('show');
                    setTimeout(() => {
                        autoSaveIndicator.classList.remove('show');
                    }, 2000);
                }
                
                setTimeout(() => {
                    successBar.classList.remove('show');
                }, 3000);
                
            } catch (error) {
                console.error('æˆåŠŸè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function showLoading(show = true) {
            try {
                const loadingOverlay = safeGetElement('loading-overlay');
                if (loadingOverlay) {
                    if (show) {
                        loadingOverlay.classList.add('show');
                    } else {
                        loadingOverlay.classList.remove('show');
                    }
                }
            } catch (error) {
                console.error('ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        class DataManager {
            constructor(supabase) {
                this.supabase = supabase;
                this.currentCurrency = 'USDJPY';
                this.currentScenario = 'scenario1';
                this.saveQueue = new Map();
                this.saveTimer = null;
                this.saveDelay = 2000;
                this.lastSaveTime = 0;
                this.isOnline = navigator.onLine;
                this.offlineQueue = [];
                this.init();
            }

            init() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.syncOfflineData();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                });

                console.log('DataManageråˆæœŸåŒ–å®Œäº†');
            }

            generateKey(currency, scenario, field) {
                return `${currency}_${scenario}_${field}`;
            }

            async autoSave(currency, scenario, field, value) {
                try {
                    validateInput(currency, 'currency', true);
                    validateInput(scenario, 'scenario', true);
                    
                    if (!field) {
                        throw new Error('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒå¿…è¦ã§ã™');
                    }

                    const key = this.generateKey(currency, scenario, field);
                    
                    this.saveQueue.set(key, {
                        currency,
                        scenario,
                        field,
                        value,
                        timestamp: Date.now()
                    });

                    if (this.saveTimer) {
                        clearTimeout(this.saveTimer);
                    }

                    this.saveTimer = setTimeout(() => {
                        this.processSaveQueue();
                    }, this.saveDelay);

                    console.log(`è‡ªå‹•ä¿å­˜ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ : ${key}`);

                } catch (error) {
                    console.error('è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('è‡ªå‹•ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async processSaveQueue() {
                if (this.saveQueue.size === 0) return;

                const now = Date.now();
                if (now - this.lastSaveTime < 1000) {
                    setTimeout(() => this.processSaveQueue(), 1000);
                    return;
                }

                const queueItems = Array.from(this.saveQueue.values());
                this.saveQueue.clear();

                if (!this.isOnline) {
                    this.offlineQueue.push(...queueItems);
                    console.log('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³: ä¿å­˜ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ');
                    return;
                }

                try {
                    showLoading(true);
                    
                    const savePromises = queueItems.map(item => this.saveToDatabase(item));
                    const results = await Promise.allSettled(savePromises);
                    
                    let successCount = 0;
                    let errorCount = 0;
                    
                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled' && result.value.success) {
                            successCount++;
                        } else {
                            errorCount++;
                            console.error(`ä¿å­˜å¤±æ•— ${queueItems[index].currency}-${queueItems[index].scenario}-${queueItems[index].field}:`, result.reason);
                        }
                    });

                    this.lastSaveTime = now;

                    if (successCount > 0) {
                        showSuccessInUI(`${successCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                    }
                    
                    if (errorCount > 0) {
                        showErrorInUI(`${errorCount}ä»¶ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ`);
                    }

                } catch (error) {
                    console.error('ä¿å­˜ã‚­ãƒ¥ãƒ¼å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                } finally {
                    showLoading(false);
                }
            }

            async saveToDatabase(item) {
                try {
                    const { currency, scenario, field, value, timestamp } = item;
                    const id = this.generateKey(currency, scenario, field);

                    const dataToSave = {
                        id,
                        currency,
                        scenario,
                        field,
                        data: {
                            value,
                            timestamp,
                            version: 1
                        },
                        updated_at: new Date().toISOString()
                    };

                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_analysis_data')
                            .upsert(dataToSave, { onConflict: 'id' }),
                        `ãƒ‡ãƒ¼ã‚¿ä¿å­˜: ${id}`,
                        2
                    );

                    if (result.success) {
                        console.log(`ãƒ‡ãƒ¼ã‚¿ä¿å­˜æˆåŠŸ: ${id}`);
                        return result;
                    } else {
                        throw new Error(result.error);
                    }

                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            }

            async loadData(currency, scenario, field) {
                try {
                    validateInput(currency, 'currency', true);
                    validateInput(scenario, 'scenario', true);
                    
                    if (!field) {
                        throw new Error('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒå¿…è¦ã§ã™');
                    }

                    const id = this.generateKey(currency, scenario, field);

                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_analysis_data')
                            .select('data')
                            .eq('id', id)
                            .single(),
                        `ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${id}`,
                        2
                    );

                    if (result.success && result.data) {
                        const value = result.data.data?.value;
                        console.log(`ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ: ${id} = ${value}`);
                        return value;
                    } else {
                        console.log(`ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${id}`);
                        return null;
                    }

                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }

            async forceSaveAll() {
                try {
                    if (this.saveTimer) {
                        clearTimeout(this.saveTimer);
                    }
                    await this.processSaveQueue();
                    console.log('å¼·åˆ¶ä¿å­˜å®Œäº†');
                } catch (error) {
                    console.error('å¼·åˆ¶ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            }

            async syncOfflineData() {
                if (this.offlineQueue.length === 0) return;

                try {
                    console.log(`ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿åŒæœŸé–‹å§‹: ${this.offlineQueue.length}ä»¶`);
                    
                    const syncPromises = this.offlineQueue.map(item => this.saveToDatabase(item));
                    const results = await Promise.allSettled(syncPromises);
                    
                    let successCount = 0;
                    results.forEach(result => {
                        if (result.status === 'fulfilled' && result.value.success) {
                            successCount++;
                        }
                    });

                    this.offlineQueue = [];
                    
                    if (successCount > 0) {
                        showSuccessInUI(`ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¸­ã®${successCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ`);
                    }

                } catch (error) {
                    console.error('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async deleteData(currency, scenario, field) {
                try {
                    const id = this.generateKey(currency, scenario, field);

                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_analysis_data')
                            .delete()
                            .eq('id', id),
                        `ãƒ‡ãƒ¼ã‚¿å‰Šé™¤: ${id}`,
                        2
                    );

                    if (result.success) {
                        console.log(`ãƒ‡ãƒ¼ã‚¿å‰Šé™¤æˆåŠŸ: ${id}`);
                        return true;
                    } else {
                        throw new Error(result.error);
                    }

                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    return false;
                }
            }

            async getAllData(currency) {
                try {
                    validateInput(currency, 'currency', true);

                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_analysis_data')
                            .select('*')
                            .eq('currency', currency)
                            .order('updated_at', { ascending: false }),
                        `å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—: ${currency}`,
                        2
                    );

                    if (result.success) {
                        return result.data || [];
                    } else {
                        throw new Error(result.error);
                    }

                } catch (error) {
                    console.error('å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    return [];
                }
            }
        }

        // ã‚·ãƒŠãƒªã‚ªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        class ScenarioManager {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.draggedElement = null;
                this.init();
            }

            init() {
                this.setupDragAndDrop();
                this.setupScenarioButtons();
                console.log('ScenarioManageråˆæœŸåŒ–å®Œäº†');
            }

            setupScenarioButtons() {
                document.querySelectorAll('.scenario-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const scenarioId = btn.dataset.scenario;
                        if (scenarioId && app) {
                            await app.selectScenario(scenarioId);
                        }
                    });
                });
            }

            setupDragAndDrop() {
                const scenarioButtons = document.getElementById('scenario-buttons');
                if (!scenarioButtons) return;

                scenarioButtons.addEventListener('dragstart', (e) => {
                    if (e.target.closest('.scenario-item')) {
                        this.draggedElement = e.target.closest('.scenario-item');
                        this.draggedElement.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                    }
                });

                scenarioButtons.addEventListener('dragend', (e) => {
                    if (this.draggedElement) {
                        this.draggedElement.classList.remove('dragging');
                        document.querySelectorAll('.scenario-item').forEach(item => {
                            item.classList.remove('drag-over');
                        });
                        this.draggedElement = null;
                    }
                });

                scenarioButtons.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = this.getDragAfterElement(scenarioButtons, e.clientX);
                    const draggedItem = this.draggedElement;
                    
                    if (afterElement == null) {
                        scenarioButtons.appendChild(draggedItem);
                    } else {
                        scenarioButtons.insertBefore(draggedItem, afterElement);
                    }
                });

                scenarioButtons.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    const item = e.target.closest('.scenario-item');
                    if (item && item !== this.draggedElement) {
                        item.classList.add('drag-over');
                    }
                });

                scenarioButtons.addEventListener('dragleave', (e) => {
                    const item = e.target.closest('.scenario-item');
                    if (item) {
                        item.classList.remove('drag-over');
                    }
                });
            }

            getDragAfterElement(container, x) {
                const draggableElements = [...container.querySelectorAll('.scenario-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = x - box.left - box.width / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            async addScenario(currency) {
                try {
                    validateInput(currency, 'currency', true);

                    const scenarioName = prompt('æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
                    if (!scenarioName) return;

                    const sanitizedName = scenarioName.trim();
                    if (!sanitizedName) {
                        showErrorInUI('ã‚·ãƒŠãƒªã‚ªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        return;
                    }

                    const scenarioId = `scenario_${Date.now()}`;
                    
                    const scenarioButtons = document.getElementById('scenario-buttons');
                    if (!scenarioButtons) {
                        showErrorInUI('ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        return;
                    }

                    const scenarioItem = document.createElement('div');
                    scenarioItem.className = 'scenario-item slide-in';
                    scenarioItem.draggable = true;

                    scenarioItem.innerHTML = `
                        <button class="scenario-btn" data-scenario="${scenarioId}">
                            <span class="drag-handle">â‹®â‹®</span>
                            ${sanitizeHTML(sanitizedName)}
                        </button>
                        <div class="status-indicator">ğŸ“Š æœªè¨­å®š</div>
                    `;

                    scenarioButtons.appendChild(scenarioItem);

                    const newBtn = scenarioItem.querySelector('.scenario-btn');
                    newBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        if (app) {
                            await app.selectScenario(scenarioId);
                        }
                    });

                    await this.dataManager.autoSave(currency, scenarioId, 'name', sanitizedName);
                    await this.dataManager.autoSave(currency, scenarioId, 'created', new Date().toISOString());

                    showSuccessInUI(`ã‚·ãƒŠãƒªã‚ªã€Œ${sanitizedName}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
                    console.log(`ã‚·ãƒŠãƒªã‚ªè¿½åŠ : ${scenarioId} - ${sanitizedName}`);

                } catch (error) {
                    console.error('ã‚·ãƒŠãƒªã‚ªè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ã‚·ãƒŠãƒªã‚ªã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async deleteScenario(currency, scenarioId) {
                try {
                    validateInput(currency, 'currency', true);
                    validateInput(scenarioId, 'scenario', true);

                    const scenarioBtn = document.querySelector(`[data-scenario="${scenarioId}"]`);
                    if (!scenarioBtn) {
                        showErrorInUI('å‰Šé™¤å¯¾è±¡ã®ã‚·ãƒŠãƒªã‚ªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        return;
                    }

                    const scenarioName = scenarioBtn.textContent.replace('â‹®â‹®', '').trim();
                    
                    if (!confirm(`ã‚·ãƒŠãƒªã‚ªã€Œ${scenarioName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                        return;
                    }

                    const scenarioButtons = document.querySelectorAll('.scenario-btn');
                    if (scenarioButtons.length <= 1) {
                        showErrorInUI('æœ€å¾Œã®ã‚·ãƒŠãƒªã‚ªã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
                        return;
                    }

                    const scenarioItem = scenarioBtn.closest('.scenario-item');
                    if (scenarioItem) {
                        scenarioItem.remove();
                    }

                    const fields = ['name', 'memo', 'analysisStatus', 'targetWave', 'images', 'created'];
                    const deletePromises = fields.map(field => 
                        this.dataManager.deleteData(currency, scenarioId, field)
                    );
                    
                    await Promise.all(deletePromises);

                    if (this.dataManager.currentScenario === scenarioId) {
                        const firstBtn = document.querySelector('.scenario-btn');
                        if (firstBtn && app) {
                            await app.selectScenario(firstBtn.dataset.scenario);
                        }
                    }

                    showSuccessInUI(`ã‚·ãƒŠãƒªã‚ªã€Œ${scenarioName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                    console.log(`ã‚·ãƒŠãƒªã‚ªå‰Šé™¤: ${scenarioId}`);

                } catch (error) {
                    console.error('ã‚·ãƒŠãƒªã‚ªå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ã‚·ãƒŠãƒªã‚ªã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async updateScenarioUI(currency) {
                try {
                    const scenarioButtons = document.querySelectorAll('.scenario-btn');
                    
                    for (const btn of scenarioButtons) {
                        const scenarioId = btn.dataset.scenario;
                        if (!scenarioId) continue;

                        const [name, status] = await Promise.all([
                            this.dataManager.loadData(currency, scenarioId, 'name'),
                            this.dataManager.loadData(currency, scenarioId, 'analysisStatus')
                        ]);

                        if (name) {
                            const dragHandle = btn.querySelector('.drag-handle');
                            const handleText = dragHandle ? dragHandle.outerHTML : '<span class="drag-handle">â‹®â‹®</span>';
                            btn.innerHTML = handleText + sanitizeHTML(name);
                        }

                        const statusIndicator = btn.parentNode?.querySelector('.status-indicator');
                        if (statusIndicator) {
                            if (status) {
                                const statusEmoji = {
                                    'æ¤œè¨ä¸­': 'ğŸ¤”',
                                    'è¨ˆç®—ä¸­': 'ğŸ”„',
                                    'å®Ÿæˆ¦': 'âš¡',
                                    'åˆ©ç¢º': 'ğŸ“ˆ',
                                    'æåˆ‡ã‚Š': 'ğŸ“‰',
                                    'è¦‹é€ã‚Š': 'ğŸ‘€'
                                };
                                statusIndicator.textContent = `${statusEmoji[status] || 'ğŸ“Š'} ${status}`;
                                statusIndicator.className = `status-indicator status-${status}`;
                            } else {
                                statusIndicator.textContent = 'ğŸ“Š æœªè¨­å®š';
                                statusIndicator.className = 'status-indicator';
                            }
                        }
                    }

                    console.log(`ã‚·ãƒŠãƒªã‚ªUIæ›´æ–°å®Œäº†: ${currency}`);

                } catch (error) {
                    console.error('ã‚·ãƒŠãƒªã‚ªUIæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async displayScenarioImages(currency, scenarioId) {
                try {
                    const images = await this.dataManager.loadData(currency, scenarioId, 'images');
                    
                    [1, 2].forEach(areaNum => {
                        const imageArea = safeGetElement(`image-area-${areaNum}`);
                        if (!imageArea) return;

                        const dropZone = imageArea.querySelector('.drop-zone');
                        if (!dropZone) return;

                        if (images && images[areaNum - 1]) {
                            const imageData = images[areaNum - 1];
                            this.displayImageInArea(dropZone, imageData.url, imageData.name);
                        } else {
                            this.resetImageArea(dropZone, areaNum);
                        }
                    });

                    console.log(`ç”»åƒè¡¨ç¤ºæ›´æ–°: ${currency} - ${scenarioId}`);

                } catch (error) {
                    console.error('ç”»åƒè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            displayImageInArea(dropZone, imageUrl, imageName) {
                try {
                    dropZone.innerHTML = `
                        <img src="${imageUrl}" alt="${imageName}" class="image-preview">
                        <div class="image-controls">
                            <button class="btn btn-sm btn-danger" onclick="this.closest('.drop-zone').parentNode.querySelector('input').click()">
                                ğŸ”„ å¤‰æ›´
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removeImage(this)">
                                ğŸ—‘ï¸ å‰Šé™¤
                            </button>
                        </div>
                        <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 5px;">
                            ${sanitizeHTML(imageName)}
                        </p>
                    `;
                } catch (error) {
                    console.error('ç”»åƒã‚¨ãƒªã‚¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            resetImageArea(dropZone, areaNum) {
                try {
                    dropZone.innerHTML = `
                        <p>ğŸ“· ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯<br>ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                        <input type="file" class="file-input" id="file-input-${areaNum}" accept="image/*" multiple>
                        <div class="image-upload-progress" style="display: none;">
                            <div class="image-upload-progress-bar"></div>
                        </div>
                    `;

                    this.setupImageUpload(areaNum);
                } catch (error) {
                    console.error('ç”»åƒã‚¨ãƒªã‚¢ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            setupImageUpload(areaNum) {
                try {
                    const dropZone = document.querySelector(`#image-area-${areaNum} .drop-zone`);
                    const fileInput = safeGetElement(`file-input-${areaNum}`);
                    
                    if (!dropZone || !fileInput) return;

                    dropZone.addEventListener('click', () => {
                        fileInput.click();
                    });

                    fileInput.addEventListener('change', (e) => {
                        this.handleFileSelect(e.target.files, areaNum);
                    });

                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('dragover');
                    });

                    dropZone.addEventListener('dragleave', () => {
                        dropZone.classList.remove('dragover');
                    });

                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('dragover');
                        this.handleFileSelect(e.dataTransfer.files, areaNum);
                    });

                } catch (error) {
                    console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async handleFileSelect(files, areaNum) {
                try {
                    if (!files || files.length === 0) return;

                    const file = files[0];
                    
                    if (!file.type.startsWith('image/')) {
                        showErrorInUI('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                        return;
                    }

                    if (file.size > 10 * 1024 * 1024) {
                        showErrorInUI('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
                        return;
                    }

                    const progressBar = document.querySelector(`#image-area-${areaNum} .image-upload-progress`);
                    const progressBarFill = document.querySelector(`#image-area-${areaNum} .image-upload-progress-bar`);
                    
                    if (progressBar) {
                        progressBar.style.display = 'block';
                        progressBarFill.style.width = '0%';
                    }

                    showLoading(true);

                    const fileName = `${this.dataManager.currentCurrency}_${this.dataManager.currentScenario}_area${areaNum}_${Date.now()}.${file.name.split('.').pop()}`;

                    const uploadResult = await this.uploadImageToSupabase(file, fileName, (progress) => {
                        if (progressBarFill) {
                            progressBarFill.style.width = `${progress}%`;
                        }
                    });

                    if (uploadResult.success) {
                        const imageData = {
                            url: uploadResult.url,
                            name: file.name,
                            fileName: fileName,
                            uploadedAt: new Date().toISOString()
                        };

                        await this.saveImageData(areaNum, imageData);
                        
                        const dropZone = document.querySelector(`#image-area-${areaNum} .drop-zone`);
                        if (dropZone) {
                            this.displayImageInArea(dropZone, imageData.url, imageData.name);
                        }

                        showSuccessInUI('ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                    } else {
                        throw new Error(uploadResult.error);
                    }

                } catch (error) {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                } finally {
                    showLoading(false);
                    const progressBar = document.querySelector(`#image-area-${areaNum} .image-upload-progress`);
                    if (progressBar) {
                        progressBar.style.display = 'none';
                    }
                }
            }

            async uploadImageToSupabase(file, fileName, onProgress) {
                try {
                    const result = await safeSupabaseOperation(
                        () => this.dataManager.supabase.storage
                            .from('fx-images')
                            .upload(fileName, file, {
                                cacheControl: '3600',
                                upsert: true
                            }),
                        `ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: ${fileName}`,
                        2
                    );

                    if (result.success) {
                        const urlResult = await safeSupabaseOperation(
                            () => this.dataManager.supabase.storage
                                .from('fx-images')
                                .getPublicUrl(fileName),
                            `ç”»åƒURLå–å¾—: ${fileName}`,
                            2
                        );

                        if (urlResult.success && urlResult.data) {
                            onProgress(100);
                            return {
                                success: true,
                                url: urlResult.data.publicUrl,
                                fileName: fileName
                            };
                        } else {
                            throw new Error('ç”»åƒURLã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    } else {
                        throw new Error(result.error);
                    }

                } catch (error) {
                    console.error('Supabaseç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            async saveImageData(areaNum, imageData) {
                try {
                    const currentImages = await this.dataManager.loadData(
                        this.dataManager.currentCurrency,
                        this.dataManager.currentScenario,
                        'images'
                    ) || [];

                    currentImages[areaNum - 1] = imageData;

                    await this.dataManager.autoSave(
                        this.dataManager.currentCurrency,
                        this.dataManager.currentScenario,
                        'images',
                        currentImages
                    );

                    console.log(`ç”»åƒãƒ‡ãƒ¼ã‚¿ä¿å­˜: ã‚¨ãƒªã‚¢${areaNum}`);

                } catch (error) {
                    console.error('ç”»åƒãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            }

            async removeImage(areaNum) {
                try {
                    const currentImages = await this.dataManager.loadData(
                        this.dataManager.currentCurrency,
                        this.dataManager.currentScenario,
                        'images'
                    ) || [];

                    if (currentImages[areaNum - 1]) {
                        const imageData = currentImages[areaNum - 1];
                        
                        if (imageData.fileName) {
                            await safeSupabaseOperation(
                                () => this.dataManager.supabase.storage
                                    .from('fx-images')
                                    .remove([imageData.fileName]),
                                `ç”»åƒå‰Šé™¤: ${imageData.fileName}`,
                                2
                            );
                        }

                        currentImages[areaNum - 1] = null;

                        await this.dataManager.autoSave(
                            this.dataManager.currentCurrency,
                            this.dataManager.currentScenario,
                            'images',
                            currentImages
                        );

                        const dropZone = document.querySelector(`#image-area-${areaNum} .drop-zone`);
                        if (dropZone) {
                            this.resetImageArea(dropZone, areaNum);
                        }

                        showSuccessInUI('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    }

                } catch (error) {
                    console.error('ç”»åƒå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦ç”»åƒå‰Šé™¤ã‚’è¿½åŠ 
        window.removeImage = function(button) {
            const imageArea = button.closest('.image-area');
            if (!imageArea) return;
            
            const areaNum = imageArea.id.includes('1') ? 1 : 2;
            
            if (app && app.scenarioManager) {
                app.scenarioManager.removeImage(areaNum);
            }
        };

        // å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        class HistoryManager {
            constructor(supabase) {
                this.supabase = supabase;
                this.maxHistoryItems = 200;
                this.searchTimeout = null;
                this.currentSearchTerm = '';
                this.init();
            }

            init() {
                this.setupHistorySearch();
                console.log('HistoryManageråˆæœŸåŒ–å®Œäº†');
            }

            setupHistorySearch() {
                const searchInput = safeGetElement('history-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        clearTimeout(this.searchTimeout);
                        this.searchTimeout = setTimeout(() => {
                            this.searchHistory(e.target.value);
                        }, 300);
                    });
                }
            }

            async saveToHistory(currency, scenario, field, value, action = 'update') {
                try {
                    if (!value || (typeof value === 'string' && value.trim() === '')) {
                        return;
                    }

                    const historyItem = {
                        id: generateId(),
                        currency,
                        scenario,
                        field,
                        value: typeof value === 'object' ? JSON.stringify(value) : value,
                        action,
                        timestamp: new Date().toISOString(),
                        preview: this.generatePreview(value)
                    };

                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_analysis_history')
                            .insert(historyItem),
                        'å±¥æ­´ä¿å­˜',
                        2
                    );

                    if (result.success) {
                        console.log(`å±¥æ­´ä¿å­˜æˆåŠŸ: ${currency}-${scenario}-${field}`);
                        await this.cleanupOldHistory();
                    } else {
                        console.warn('å±¥æ­´ä¿å­˜å¤±æ•—:', result.error);
                    }

                } catch (error) {
                    console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            generatePreview(value) {
                try {
                    if (!value) return '';
                    
                    let text = typeof value === 'object' ? JSON.stringify(value) : String(value);
                    
                    text = text.replace(/\s+/g, ' ').trim();
                    
                    return text.length > 100 ? text.substring(0, 100) + '...' : text;
                    
                } catch (error) {
                    console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    return 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼';
                }
            }

            async searchHistory(searchTerm = '') {
                try {
                    this.currentSearchTerm = searchTerm;
                    
                    let query = this.supabase
                        .from('fx_analysis_history')
                        .select('*')
                        .order('timestamp', { ascending: false })
                        .limit(50);

                    if (searchTerm.trim()) {
                        query = query.or(`currency.ilike.%${searchTerm}%,scenario.ilike.%${searchTerm}%,field.ilike.%${searchTerm}%,preview.ilike.%${searchTerm}%`);
                    }

                    const result = await safeSupabaseOperation(
                        () => query,
                        'å±¥æ­´æ¤œç´¢',
                        2
                    );

                    if (result.success) {
                        await this.displayHistoryResults(result.data || []);
                    } else {
                        console.error('å±¥æ­´æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', result.error);
                        this.displayHistoryResults([]);
                    }

                } catch (error) {
                    console.error('å±¥æ­´æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                    this.displayHistoryResults([]);
                }
            }

            async displayHistoryResults(historyItems) {
                try {
                    const historyList = safeGetElement('history-list');
                    if (!historyList) return;

                    if (historyItems.length === 0) {
                        historyList.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--secondary-color);">
                                <p>ğŸ“ å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                                ${this.currentSearchTerm ? '<p>æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãŠè©¦ã—ãã ã•ã„</p>' : '<p>ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†ã™ã‚‹ã¨å±¥æ­´ãŒä½œæˆã•ã‚Œã¾ã™</p>'}
                            </div>
                        `;
                        return;
                    }

                    const historyHTML = historyItems.map(item => {
                        const date = new Date(item.timestamp);
                        const formattedDate = date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        
                        const fieldDisplayName = {
                            'memo': 'ãƒ¡ãƒ¢',
                            'analysisStatus': 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
                            'targetWave': 'ç‹™ã†æ³¢',
                            'images': 'ç”»åƒ',
                            'fixedPrompt': 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ'
                        }[item.field] || item.field;

                        return `
                            <div class="history-item" onclick="restoreHistoryItem('${item.id}')">
                                <div class="history-item-header">
                                    <div class="history-item-title">
                                        ${sanitizeHTML(item.currency)} - ${sanitizeHTML(item.scenario)} - ${fieldDisplayName}
                                    </div>
                                    <div class="history-item-date">${formattedDate}</div>
                                </div>
                                <div class="history-item-preview">
                                    ${sanitizeHTML(item.preview)}
                                </div>
                            </div>
                        `;
                    }).join('');

                    historyList.innerHTML = historyHTML;

                } catch (error) {
                    console.error('å±¥æ­´è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                    const historyList = safeGetElement('history-list');
                    if (historyList) {
                        historyList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger-color);">å±¥æ­´ã®è¡¨ç¤ºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
                    }
                }
            }

            async restoreHistoryItem(historyId) {
                try {
                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_analysis_history')
                            .select('*')
                            .eq('id', historyId)
                            .single(),
                        'å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ å–å¾—',
                        2
                    );

                    if (!result.success || !result.data) {
                        showErrorInUI('å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        return;
                    }

                    const historyItem = result.data;
                    
                    if (!confirm(`ä»¥ä¸‹ã®å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\né€šè²¨ãƒšã‚¢: ${historyItem.currency}\nã‚·ãƒŠãƒªã‚ª: ${historyItem.scenario}\nãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰: ${historyItem.field}\n\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                        return;
                    }

                    let valueToRestore = historyItem.value;
                    
                    try {
                        valueToRestore = JSON.parse(historyItem.value);
                    } catch {
                        // JSONå½¢å¼ã§ãªã„å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
                    }

                    if (app && app.dataManager) {
                        await app.dataManager.autoSave(
                            historyItem.currency,
                            historyItem.scenario,
                            historyItem.field,
                            valueToRestore
                        );

                        await app.dataManager.forceSaveAll();

                        if (historyItem.currency === app.dataManager.currentCurrency && 
                            historyItem.scenario === app.dataManager.currentScenario) {
                            await app.updateCurrentDisplay();
                        }

                        showSuccessInUI('å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                        
                        if (app.closeHistoryPanel) {
                            app.closeHistoryPanel();
                        }
                    }

                } catch (error) {
                    console.error('å±¥æ­´å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('å±¥æ­´ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async cleanupOldHistory() {
                try {
                    const countResult = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_analysis_history')
                            .select('id', { count: 'exact', head: true }),
                        'å±¥æ­´ä»¶æ•°å–å¾—',
                        1
                    );

                    if (countResult.success && countResult.count > this.maxHistoryItems) {
                        const deleteCount = countResult.count - this.maxHistoryItems;
                        
                        const oldItemsResult = await safeSupabaseOperation(
                            () => this.supabase
                                .from('fx_analysis_history')
                                .select('id')
                                .order('timestamp', { ascending: true })
                                .limit(deleteCount),
                            'å¤ã„å±¥æ­´å–å¾—',
                            1
                        );

                        if (oldItemsResult.success && oldItemsResult.data) {
                            const idsToDelete = oldItemsResult.data.map(item => item.id);
                            
                            await safeSupabaseOperation(
                                () => this.supabase
                                    .from('fx_analysis_history')
                                    .delete()
                                    .in('id', idsToDelete),
                                'å¤ã„å±¥æ­´å‰Šé™¤',
                                1
                            );

                            console.log(`å¤ã„å±¥æ­´ã‚’${deleteCount}ä»¶å‰Šé™¤ã—ã¾ã—ãŸ`);
                        }
                    }

                } catch (error) {
                    console.error('å±¥æ­´ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async clearAllHistory() {
                try {
                    if (!confirm('ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                        return;
                    }

                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_analysis_history')
                            .delete()
                            .neq('id', ''),
                        'å…¨å±¥æ­´å‰Šé™¤',
                        2
                    );

                    if (result.success) {
                        showSuccessInUI('ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                        await this.searchHistory('');
                    } else {
                        throw new Error(result.error);
                    }

                } catch (error) {
                    console.error('å…¨å±¥æ­´å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('å±¥æ­´ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å±¥æ­´å¾©å…ƒã‚’è¿½åŠ 
        window.restoreHistoryItem = function(historyId) {
            if (app && app.historyManager) {
                app.historyManager.restoreHistoryItem(historyId);
            }
        };

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
        class BackupManager {
            constructor(supabase) {
                this.supabase = supabase;
                this.maxBackups = 10;
                this.init();
            }

            init() {
                console.log('BackupManageråˆæœŸåŒ–å®Œäº†');
            }

            async createBackup() {
                try {
                    showLoading(true);
                    
                    const backupData = await this.collectAllData();
                    
                    if (!backupData || Object.keys(backupData).length === 0) {
                        showErrorInUI('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                        return;
                    }

                    const backupItem = {
                        id: generateId(),
                        name: `ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_${new Date().toLocaleDateString('ja-JP').replace(/\//g, '')}_${new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }).replace(/:/g, '')}`,
                        data: backupData,
                        created_at: new Date().toISOString(),
                        size: JSON.stringify(backupData).length
                    };

                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_backups')
                            .insert(backupItem),
                        'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ',
                        2
                    );

                    if (result.success) {
                        await this.cleanupOldBackups();
                        showSuccessInUI(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€Œ${backupItem.name}ã€ã‚’ä½œæˆã—ã¾ã—ãŸ`);
                        console.log('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆæˆåŠŸ:', backupItem.name);
                    } else {
                        throw new Error(result.error);
                    }

                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                } finally {
                    showLoading(false);
                }
            }

            async collectAllData() {
                try {
                    const [analysisData, historyData] = await Promise.all([
                        safeSupabaseOperation(
                            () => this.supabase
                                .from('fx_analysis_data')
                                .select('*')
                                .order('updated_at', { ascending: false }),
                            'åˆ†æãƒ‡ãƒ¼ã‚¿å–å¾—',
                            2
                        ),
                        safeSupabaseOperation(
                            () => this.supabase
                                .from('fx_analysis_history')
                                .select('*')
                                .order('timestamp', { ascending: false })
                                .limit(100),
                            'å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—',
                            2
                        )
                    ]);

                    const backupData = {
                        version: '1.0',
                        timestamp: new Date().toISOString(),
                        analysisData: analysisData.success ? analysisData.data : [],
                        historyData: historyData.success ? historyData.data : [],
                        metadata: {
                            totalAnalysisItems: analysisData.success ? analysisData.data?.length || 0 : 0,
                            totalHistoryItems: historyData.success ? historyData.data?.length || 0 : 0,
                            currencies: this.extractCurrencies(analysisData.success ? analysisData.data : [])
                        }
                    };

                    console.log('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†:', {
                        analysisItems: backupData.metadata.totalAnalysisItems,
                        historyItems: backupData.metadata.totalHistoryItems,
                        currencies: backupData.metadata.currencies
                    });

                    return backupData;

                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿åé›†ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            }

            extractCurrencies(analysisData) {
                try {
                    const currencies = new Set();
                    analysisData.forEach(item => {
                        if (item.currency) {
                            currencies.add(item.currency);
                        }
                    });
                    return Array.from(currencies);
                } catch (error) {
                    console.error('é€šè²¨æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
                    return [];
                }
            }

            async cleanupOldBackups() {
                try {
                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_backups')
                            .select('id, created_at')
                            .order('created_at', { ascending: false }),
                        'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§å–å¾—',
                        1
                    );

                    if (result.success && result.data && result.data.length > this.maxBackups) {
                        const backupsToDelete = result.data.slice(this.maxBackups);
                        const idsToDelete = backupsToDelete.map(backup => backup.id);

                        await safeSupabaseOperation(
                            () => this.supabase
                                .from('fx_backups')
                                .delete()
                                .in('id', idsToDelete),
                            'å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‰Šé™¤',
                            1
                        );

                        console.log(`å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’${backupsToDelete.length}ä»¶å‰Šé™¤ã—ã¾ã—ãŸ`);
                    }

                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async listBackups() {
                try {
                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_backups')
                            .select('id, name, created_at, size')
                            .order('created_at', { ascending: false }),
                        'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§å–å¾—',
                        2
                    );

                    if (result.success) {
                        return result.data || [];
                    } else {
                        throw new Error(result.error);
                    }

                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    return [];
                }
            }

            async restoreBackup(backupId) {
                try {
                    if (!confirm('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\nç¾åœ¨ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                        return;
                    }

                    showLoading(true);

                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_backups')
                            .select('*')
                            .eq('id', backupId)
                            .single(),
                        'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿å–å¾—',
                        2
                    );

                    if (!result.success || !result.data) {
                        throw new Error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }

                    const backupData = result.data.data;
                    
                    if (!backupData || !backupData.analysisData) {
                        throw new Error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™');
                    }

                    await this.clearCurrentData();

                    if (backupData.analysisData.length > 0) {
                        const analysisResult = await safeSupabaseOperation(
                            () => this.supabase
                                .from('fx_analysis_data')
                                .insert(backupData.analysisData),
                            'åˆ†æãƒ‡ãƒ¼ã‚¿å¾©å…ƒ',
                            2
                        );

                        if (!analysisResult.success) {
                            throw new Error('åˆ†æãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                    }

                    if (backupData.historyData && backupData.historyData.length > 0) {
                        const historyResult = await safeSupabaseOperation(
                            () => this.supabase
                                .from('fx_analysis_history')
                                .insert(backupData.historyData),
                            'å±¥æ­´ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ',
                            2
                        );

                        if (!historyResult.success) {
                            console.warn('å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ:', historyResult.error);
                        }
                    }

                    showSuccessInUI('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã„ã¾ã™...');
                    
                    setTimeout(() => {
                        location.reload();
                    }, 2000);

                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                } finally {
                    showLoading(false);
                }
            }

            async clearCurrentData() {
                try {
                    await Promise.all([
                        safeSupabaseOperation(
                            () => this.supabase
                                .from('fx_analysis_data')
                                .delete()
                                .neq('id', ''),
                            'ç¾åœ¨ã®åˆ†æãƒ‡ãƒ¼ã‚¿å‰Šé™¤',
                            2
                        ),
                        safeSupabaseOperation(
                            () => this.supabase
                                .from('fx_analysis_history')
                                .delete()
                                .neq('id', ''),
                            'ç¾åœ¨ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿å‰Šé™¤',
                            2
                        )
                    ]);

                    console.log('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†');

                } catch (error) {
                    console.error('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    throw error;
                }
            }

            async downloadBackup(backupId) {
                try {
                    const result = await safeSupabaseOperation(
                        () => this.supabase
                            .from('fx_backups')
                            .select('*')
                            .eq('id', backupId)
                            .single(),
                        'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
                        2
                    );

                    if (!result.success || !result.data) {
                        throw new Error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }

                    const backupData = result.data;
                    const jsonData = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${backupData.name}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    showSuccessInUI('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');

                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }
        }

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        class ThemeManager {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.currentTheme = 'light';
                this.init();
            }

            async init() {
                try {
                    const savedTheme = await this.dataManager.loadData('global', 'settings', 'theme');
                    
                    if (savedTheme) {
                        this.currentTheme = savedTheme;
                    } else {
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        this.currentTheme = prefersDark ? 'dark' : 'light';
                    }

                    this.applyTheme(this.currentTheme);

                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                        if (!await this.dataManager.loadData('global', 'settings', 'theme')) {
                            this.currentTheme = e.matches ? 'dark' : 'light';
                            this.applyTheme(this.currentTheme);
                        }
                    });

                    console.log('ThemeManageråˆæœŸåŒ–å®Œäº†:', this.currentTheme);

                } catch (error) {
                    console.error('ãƒ†ãƒ¼ãƒåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    this.applyTheme('light');
                }
            }

            applyTheme(theme) {
                try {
                    document.documentElement.setAttribute('data-theme', theme);
                    
                    const themeToggle = safeGetElement('theme-toggle');
                    if (themeToggle) {
                        themeToggle.setAttribute('aria-label', 
                            theme === 'dark' ? 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ' : 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ'
                        );
                    }

                    const connectionStatus = safeGetElement('connection-status');
                    if (connectionStatus) {
                        connectionStatus.style.background = theme === 'dark' ? 
                            'rgba(40, 167, 69, 0.9)' : 'var(--success-color)';
                    }

                    console.log(`ãƒ†ãƒ¼ãƒé©ç”¨: ${theme}`);

                } catch (error) {
                    console.error('ãƒ†ãƒ¼ãƒé©ç”¨ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async toggleTheme() {
                try {
                    this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                    this.applyTheme(this.currentTheme);

                    await this.dataManager.autoSave('global', 'settings', 'theme', this.currentTheme);

                    showSuccessInUI(`${this.currentTheme === 'dark' ? 'ãƒ€ãƒ¼ã‚¯' : 'ãƒ©ã‚¤ãƒˆ'}ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`);

                } catch (error) {
                    console.error('ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ãƒ†ãƒ¼ãƒã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            getCurrentTheme() {
                return this.currentTheme;
            }
        }

        // ä½¿ç”¨é‡ç›£è¦–
        class UsageMonitor {
            constructor(supabase) {
                this.supabase = supabase;
                this.dbLimit = 500;
                this.storageLimit = 1024;
                this.updateInterval = 30000;
                this.isUpdating = false;
                this.lastUpdate = 0;
                this.init();
            }

            init() {
                try {
                    this.updateUsage();
                    this.startPeriodicUpdate();

                    document.addEventListener('visibilitychange', () => {
                        if (!document.hidden) {
                            this.updateUsage();
                        }
                    });

                    console.log('ä½¿ç”¨é‡ç›£è¦–åˆæœŸåŒ–å®Œäº†');

                } catch (error) {
                    console.error('ä½¿ç”¨é‡ç›£è¦–åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            startPeriodicUpdate() {
                setInterval(() => {
                    if (!this.isUpdating && !document.hidden) {
                        this.updateUsage();
                    }
                }, this.updateInterval);
            }

            async updateUsage() {
                if (this.isUpdating) return;

                const now = Date.now();
                if (now - this.lastUpdate < 5000) return;

                this.isUpdating = true;
                this.lastUpdate = now;

                try {
                    console.log('ä½¿ç”¨é‡æ›´æ–°é–‹å§‹');

                    const [dbUsage, storageUsage] = await Promise.all([
                        this.calculateDatabaseUsage(),
                        this.calculateStorageUsage()
                    ]);

                    this.updateProgressBar('db-usage', 'db-percent', dbUsage, this.dbLimit, 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹');
                    this.updateProgressBar('storage-usage', 'storage-percent', storageUsage, this.storageLimit, 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸');

                    this.checkUsageWarnings(dbUsage, storageUsage);

                    console.log(`ä½¿ç”¨é‡æ›´æ–°å®Œäº†: DB=${dbUsage.toFixed(1)}MB, Storage=${storageUsage.toFixed(1)}MB`);

                } catch (error) {
                    console.error('ä½¿ç”¨é‡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);

                    this.updateProgressBar('db-usage', 'db-percent', 0, this.dbLimit, 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹');
                    this.updateProgressBar('storage-usage', 'storage-percent', 0, this.storageLimit, 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸');

                } finally {
                    this.isUpdating = false;
                }
            }

            async calculateDatabaseUsage() {
                try {
                    const result = await safeSupabaseOperation(
                        () => this.supabase.from('fx_analysis_data').select('*'),
                        'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½¿ç”¨é‡è¨ˆç®—',
                        1
                    );

                    if (!result.success || !result.data) {
                        return 0;
                    }

                    const dataSize = this.calculateDataSize(result.data);

                    const historyResult = await safeSupabaseOperation(
                        () => this.supabase.from('fx_analysis_history').select('*').limit(100),
                        'å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºè¨ˆç®—',
                        1
                    );

                    if (historyResult.success && historyResult.data) {
                        const historySize = this.calculateDataSize(historyResult.data);
                        return dataSize + historySize;
                    }

                    return dataSize;

                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½¿ç”¨é‡è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                    return 0;
                }
            }

            async calculateStorageUsage() {
                try {
                    const result = await safeSupabaseOperation(
                        () => this.supabase.storage.from('fx-images').list(),
                        'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—',
                        1
                    );

                    if (!result.success || !result.data) {
                        return 0;
                    }

                    let totalSize = 0;
                    for (const file of result.data) {
                        if (file.metadata && file.metadata.size) {
                            totalSize += file.metadata.size;
                        } else {
                            totalSize += 1024 * 1024;
                        }
                    }

                    return totalSize / (1024 * 1024);

                } catch (error) {
                    console.error('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                    return this.estimateStorageUsageFromDatabase();
                }
            }

            async estimateStorageUsageFromDatabase() {
                try {
                    const result = await safeSupabaseOperation(
                        () => this.supabase.from('fx_analysis_data').select('data').like('id', '%_scenario_%_images'),
                        'ç”»åƒãƒ‡ãƒ¼ã‚¿æ¨å®š',
                        1
                    );

                    if (!result.success || !result.data) {
                        return 0;
                    }

                    let imageCount = 0;
                    for (const item of result.data) {
                        const imagesData = item.data?.value;
                        if (imagesData && Array.isArray(imagesData)) {
                            imageCount += imagesData.filter(img => img).length;
                        }
                    }

                    return imageCount * 2;

                } catch (error) {
                    console.error('ç”»åƒä½¿ç”¨é‡æ¨å®šã‚¨ãƒ©ãƒ¼:', error);
                    return 0;
                }
            }

            calculateDataSize(data) {
                try {
                    if (!data || !Array.isArray(data)) return 0;

                    const jsonString = JSON.stringify(data);
                    const sizeInBytes = new Blob([jsonString]).size;

                    return sizeInBytes / (1024 * 1024);

                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
                    return 0;
                }
            }

            updateProgressBar(progressId, percentId, usage, limit, label) {
                try {
                    const progressBar = safeGetElement(progressId);
                    const percentSpan = safeGetElement(percentId);

                    if (!progressBar || !percentSpan) {
                        console.warn(`ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${progressId}, ${percentId}`);
                        return;
                    }

                    const percentage = Math.min((usage / limit) * 100, 100);
                    const displayPercentage = Math.round(percentage * 10) / 10;

                    progressBar.value = percentage;
                    progressBar.max = 100;

                    percentSpan.textContent = `${displayPercentage}%`;

                    let color = '#007bff';
                    if (percentage > 90) {
                        color = '#dc3545';
                    } else if (percentage > 70) {
                        color = '#ffc107';
                    }

                    progressBar.style.accentColor = color;

                    const style = document.createElement('style');
                    style.textContent = `
                        #${progressId}::-webkit-progress-value {
                            background-color: ${color};
                            transition: background-color 0.3s ease;
                        }
                    `;

                    const existingStyle = document.querySelector(`style[data-progress="${progressId}"]`);
                    if (existingStyle) {
                        existingStyle.remove();
                    }

                    style.setAttribute('data-progress', progressId);
                    document.head.appendChild(style);

                    const tooltip = `${label}: ${usage.toFixed(1)}MB / ${limit}MB (${displayPercentage}%)`;
                    progressBar.title = tooltip;
                    percentSpan.title = tooltip;

                } catch (error) {
                    console.error('ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            checkUsageWarnings(dbUsage, storageUsage) {
                try {
                    const dbPercentage = (dbUsage / this.dbLimit) * 100;
                    const storagePercentage = (storageUsage / this.storageLimit) * 100;

                    const warningLevel = 80;
                    const criticalLevel = 90;

                    let warningMessage = '';

                    if (dbPercentage > criticalLevel) {
                        warningMessage += `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½¿ç”¨é‡ãŒå±é™ºãƒ¬ãƒ™ãƒ«ã§ã™ (${dbPercentage.toFixed(1)}%)ã€‚`;
                    } else if (dbPercentage > warningLevel) {
                        warningMessage += `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½¿ç”¨é‡ãŒè­¦å‘Šãƒ¬ãƒ™ãƒ«ã§ã™ (${dbPercentage.toFixed(1)}%)ã€‚`;
                    }

                    if (storagePercentage > criticalLevel) {
                        warningMessage += `ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ãŒå±é™ºãƒ¬ãƒ™ãƒ«ã§ã™ (${storagePercentage.toFixed(1)}%)ã€‚`;
                    } else if (storagePercentage > warningLevel) {
                        warningMessage += `ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ãŒè­¦å‘Šãƒ¬ãƒ™ãƒ«ã§ã™ (${storagePercentage.toFixed(1)}%)ã€‚`;
                    }

                    if (warningMessage) {
                        const lastWarning = localStorage.getItem('fx_last_usage_warning');
                        const now = Date.now();

                        if (!lastWarning || now - parseInt(lastWarning) > 60 * 60 * 1000) {
                            showErrorInUI(warningMessage + ' ãƒ‡ãƒ¼ã‚¿ã®æ•´ç†ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚');
                            localStorage.setItem('fx_last_usage_warning', now.toString());
                        }
                    }

                } catch (error) {
                    console.error('ä½¿ç”¨é‡è­¦å‘Šãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async forceUpdate() {
                this.lastUpdate = 0;
                await this.updateUsage();
                showSuccessInUI('ä½¿ç”¨é‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            }

            async getUsageDetails() {
                try {
                    const [dbUsage, storageUsage] = await Promise.all([
                        this.calculateDatabaseUsage(),
                        this.calculateStorageUsage()
                    ]);

                    return {
                        database: {
                            usage: dbUsage,
                            limit: this.dbLimit,
                            percentage: (dbUsage / this.dbLimit) * 100
                        },
                        storage: {
                            usage: storageUsage,
                            limit: this.storageLimit,
                            percentage: (storageUsage / this.storageLimit) * 100
                        },
                        lastUpdate: new Date(this.lastUpdate).toISOString()
                    };

                } catch (error) {
                    console.error('ä½¿ç”¨é‡è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        class KeyboardShortcuts {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.shortcuts = new Map();
                this.isEnabled = true;
                this.init();
            }

            init() {
                try {
                    this.defineShortcuts();
                    document.addEventListener('keydown', this.handleKeyDown.bind(this));
                    document.addEventListener('keyup', this.handleKeyUp.bind(this));
                    this.createHelpModal();

                    console.log('ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆåˆæœŸåŒ–å®Œäº†');

                } catch (error) {
                    console.error('ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            defineShortcuts() {
                this.shortcuts.set('ctrl+s', {
                    description: 'ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ä¿å­˜',
                    action: () => this.manualSave(),
                    preventDefault: true
                });

                this.shortcuts.set('ctrl+shift+s', {
                    description: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ',
                    action: () => this.createBackup(),
                    preventDefault: true
                });

                this.shortcuts.set('ctrl+c', {
                    description: 'é¸æŠè¦ç´ ã‚’ã‚³ãƒ”ãƒ¼',
                    action: () => this.copySelectedElement(),
                    preventDefault: true,
                    condition: () => this.isTextAreaFocused()
                });

                this.shortcuts.set('ctrl+v', {
                    description: 'é¸æŠè¦ç´ ã«è²¼ã‚Šä»˜ã‘',
                    action: () => this.pasteToSelectedElement(),
                    preventDefault: true,
                    condition: () => this.isTextAreaFocused()
                });

                this.shortcuts.set('ctrl+left', {
                    description: 'å‰ã®ã‚·ãƒŠãƒªã‚ª',
                    action: () => this.previousScenario(),
                    preventDefault: true
                });

                this.shortcuts.set('ctrl+right', {
                    description: 'æ¬¡ã®ã‚·ãƒŠãƒªã‚ª',
                    action: () => this.nextScenario(),
                    preventDefault: true
                });

                this.shortcuts.set('ctrl+home', {
                    description: 'ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹',
                    action: () => this.goToTop(),
                    preventDefault: true
                });

                this.shortcuts.set('ctrl+d', {
                    description: 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ',
                    action: () => this.toggleDarkMode(),
                    preventDefault: true
                });

                this.shortcuts.set('ctrl+h', {
                    description: 'å±¥æ­´ãƒ‘ãƒãƒ«åˆ‡ã‚Šæ›¿ãˆ',
                    action: () => this.toggleHistory(),
                    preventDefault: true
                });

                this.shortcuts.set('ctrl+n', {
                    description: 'æ–°ã—ã„ã‚·ãƒŠãƒªã‚ªè¿½åŠ ',
                    action: () => this.addNewScenario(),
                    preventDefault: true
                });

                this.shortcuts.set('f1', {
                    description: 'ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒ˜ãƒ«ãƒ—è¡¨ç¤º',
                    action: () => this.showHelp(),
                    preventDefault: true
                });

                this.shortcuts.set('escape', {
                    description: 'ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹',
                    action: () => this.closeModals(),
                    preventDefault: false
                });
            }

            handleKeyDown(event) {
                try {
                    if (!this.isEnabled) return;

                    const activeElement = document.activeElement;
                    const isInputElement = activeElement && (
                        activeElement.tagName === 'INPUT' ||
                        activeElement.tagName === 'TEXTAREA' ||
                        activeElement.contentEditable === 'true'
                    );

                    const keyCombo = this.generateKeyCombo(event);
                    const shortcut = this.shortcuts.get(keyCombo);

                    if (shortcut) {
                        if (shortcut.condition && !shortcut.condition()) {return;
                        }

                        if (isInputElement && !this.isAllowedInInput(keyCombo)) {
                            return;
                        }

                        if (shortcut.preventDefault) {
                            event.preventDefault();
                            event.stopPropagation();
                        }

                        shortcut.action();

                        console.log(`ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå®Ÿè¡Œ: ${keyCombo}`);
                    }

                } catch (error) {
                    console.error('ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ãƒãƒ³ãƒ‰ãƒ©ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            handleKeyUp(event) {
                // å¿…è¦ã«å¿œã˜ã¦å®Ÿè£…
            }

            generateKeyCombo(event) {
                const keys = [];

                if (event.ctrlKey || event.metaKey) keys.push('ctrl');
                if (event.shiftKey) keys.push('shift');
                if (event.altKey) keys.push('alt');

                let keyName = event.key.toLowerCase();

                const keyMap = {
                    'arrowleft': 'left',
                    'arrowright': 'right',
                    'arrowup': 'up',
                    'arrowdown': 'down',
                    ' ': 'space'
                };

                keyName = keyMap[keyName] || keyName;
                keys.push(keyName);

                return keys.join('+');
            }

            isAllowedInInput(keyCombo) {
                const allowedInInput = [
                    'ctrl+s',
                    'ctrl+shift+s',
                    'ctrl+c',
                    'ctrl+v',
                    'ctrl+a',
                    'ctrl+z',
                    'ctrl+y',
                    'f1',
                    'escape'
                ];

                return allowedInInput.includes(keyCombo);
            }

            isTextAreaFocused() {
                const activeElement = document.activeElement;
                return activeElement && (
                    activeElement.tagName === 'TEXTAREA' ||
                    (activeElement.tagName === 'INPUT' && activeElement.type === 'text')
                );
            }

            async manualSave() {
                try {
                    if (!this.dataManager) {
                        showErrorInUI('ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        return;
                    }

                    const memo = safeGetElement('analysis-memo')?.value || '';
                    const prompt = safeGetElement('fixed-prompt')?.value || '';

                    await Promise.all([
                        this.dataManager.autoSave(
                            this.dataManager.currentCurrency,
                            this.dataManager.currentScenario,
                            'memo',
                            memo
                        ),
                        this.dataManager.autoSave('global', 'settings', 'fixedPrompt', prompt)
                    ]);

                    await this.dataManager.forceSaveAll();

                } catch (error) {
                    console.error('æ‰‹å‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async createBackup() {
                try {
                    if (app && app.backupManager) {
                        await app.backupManager.createBackup();
                    } else {
                        showErrorInUI('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    }
                } catch (error) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async copySelectedElement() {
                try {
                    const activeElement = document.activeElement;

                    if (this.isTextAreaFocused()) {
                        if (activeElement.selectionStart !== activeElement.selectionEnd) {
                            const selectedText = activeElement.value.substring(
                                activeElement.selectionStart,
                                activeElement.selectionEnd
                            );
                            await navigator.clipboard.writeText(selectedText);
                            showSuccessInUI('é¸æŠãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                        } else {
                            await navigator.clipboard.writeText(activeElement.value);
                            showSuccessInUI('å…¨æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                        }
                    }
                } catch (error) {
                    console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            async pasteToSelectedElement() {
                try {
                    const text = await navigator.clipboard.readText();
                    const activeElement = document.activeElement;

                    if (this.isTextAreaFocused()) {
                        const start = activeElement.selectionStart;
                        const end = activeElement.selectionEnd;
                        const value = activeElement.value;

                        const newValue = value.substring(0, start) + text + value.substring(end);
                        activeElement.value = newValue;

                        const newCursorPos = start + text.length;
                        activeElement.setSelectionRange(newCursorPos, newCursorPos);

                        activeElement.dispatchEvent(new Event('input', { bubbles: true }));

                        showSuccessInUI('è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('è²¼ã‚Šä»˜ã‘ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('è²¼ã‚Šä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            previousScenario() {
                try {
                    if (app && app.navigateToPreviousScenario) {
                        app.navigateToPreviousScenario();
                    }
                } catch (error) {
                    console.error('å‰ã®ã‚·ãƒŠãƒªã‚ªç§»å‹•ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            nextScenario() {
                try {
                    if (app && app.navigateToNextScenario) {
                        app.navigateToNextScenario();
                    }
                } catch (error) {
                    console.error('æ¬¡ã®ã‚·ãƒŠãƒªã‚ªç§»å‹•ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            goToTop() {
                try {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    if (app && app.selectScenario) {
                        app.selectScenario('scenario1');
                    }
                } catch (error) {
                    console.error('ãƒˆãƒƒãƒ—ç§»å‹•ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            toggleDarkMode() {
                try {
                    if (app && app.themeManager) {
                        app.themeManager.toggleTheme();
                    }
                } catch (error) {
                    console.error('ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            toggleHistory() {
                try {
                    const historyPanel = safeGetElement('history-sidebar');
                    if (!historyPanel) return;

                    const isOpen = historyPanel.style.right === '0px';

                    if (isOpen) {
                        if (app && app.closeHistoryPanel) {
                            app.closeHistoryPanel();
                        }
                    } else {
                        if (app && app.openHistoryPanel) {
                            app.openHistoryPanel();
                        }
                    }
                } catch (error) {
                    console.error('å±¥æ­´ãƒ‘ãƒãƒ«åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            addNewScenario() {
                try {
                    if (app && app.scenarioManager) {
                        app.scenarioManager.addScenario(app.dataManager.currentCurrency);
                    }
                } catch (error) {
                    console.error('ã‚·ãƒŠãƒªã‚ªè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            closeModals() {
                try {
                    const historyPanel = safeGetElement('history-sidebar');
                    if (historyPanel && historyPanel.style.right === '0px') {
                        if (app && app.closeHistoryPanel) {
                            app.closeHistoryPanel();
                        }
                        return;
                    }

                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        if (modal.style.display !== 'none') {
                            modal.remove();
                        }
                    });

                    hideError();

                } catch (error) {
                    console.error('ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            showHelp() {
                try {
                    const helpModal = safeGetElement('shortcut-help-modal');
                    if (helpModal) {
                        helpModal.style.display = 'flex';
                    }
                } catch (error) {
                    console.error('ãƒ˜ãƒ«ãƒ—è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            createHelpModal() {
                try {
                    const modal = document.createElement('div');
                    modal.id = 'shortcut-help-modal';
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center;';

                    const shortcuts = Array.from(this.shortcuts.entries())
                        .map(([key, shortcut]) => `
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #ddd; font-family: monospace; background: #f8f9fa;">${key}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${shortcut.description}</td>
                            </tr>
                        `).join('');

                    modal.innerHTML = `
                        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; max-height: 80vh; overflow-y: auto; margin: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="margin: 0; color: #333;">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h2>
                                <button onclick="this.closest('#shortcut-help-modal').style.display='none'" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
                            </div>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">ã‚­ãƒ¼</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">æ©Ÿèƒ½</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${shortcuts}
                                </tbody>
                            </table>
                            <div style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 5px; font-size: 14px; color: #666;">
                                <strong>æ³¨æ„:</strong> å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã€ä¸€éƒ¨ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);

                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });

                } catch (error) {
                    console.error('ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            setEnabled(enabled) {
                this.isEnabled = enabled;
                console.log(`ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: ${enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`);
            }
        }

        // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹
        class FXAnalysisApp {
            constructor() {
                this.supabase = null;
                this.dataManager = null;
                this.scenarioManager = null;
                this.historyManager = null;
                this.backupManager = null;
                this.themeManager = null;
                this.usageMonitor = null;
                this.keyboardShortcuts = null;
                this.eventManager = new EventManager();
                this.offlineManager = new OfflineManager();
                this.errorMonitor = new ErrorMonitor();
                this.isInitialized = false;
            }

            async initialize() {
                if (isInitializing) {
                    console.warn('åˆæœŸåŒ–ãŒæ—¢ã«å®Ÿè¡Œä¸­ã§ã™');
                    return;
                }

                isInitializing = true;

                try {
                    console.log('FX Analysis System åˆæœŸåŒ–é–‹å§‹');

                    await waitForSupabase();

                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                    const connectionTest = await safeSupabaseOperation(
                        () => this.supabase.from('fx_analysis_data').select('count', { count: 'exact', head: true }),
                        'Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆ',
                        3
                    );

                    if (!connectionTest.success) {
                        throw new Error('Supabaseã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }

                    console.log('Supabaseæ¥ç¶šæˆåŠŸ');

                    this.dataManager = new DataManager(this.supabase);
                    this.scenarioManager = new ScenarioManager(this.dataManager);
                    this.historyManager = new HistoryManager(this.supabase);
                    this.backupManager = new BackupManager(this.supabase);
                    this.themeManager = new ThemeManager(this.dataManager);
                    this.usageMonitor = new UsageMonitor(this.supabase);
                    this.keyboardShortcuts = new KeyboardShortcuts(this.dataManager);

                    await this.initializeUI();
                    this.setupEventListeners();
                    await this.loadInitialData();

                    window.historyManager = this.historyManager;

                    this.isInitialized = true;
                    console.log('FX Analysis System åˆæœŸåŒ–å®Œäº†');

                    showSuccessInUI('ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');

                } catch (error) {
                    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    this.showFallbackUI(error);
                } finally {
                    isInitializing = false;
                }
            }

            async initializeUI() {
                try {
                    this.initHistoryPanel();
                    await this.updateCurrentDisplay();
                    this.initProgressBars();

                    console.log('UIåˆæœŸåŒ–å®Œäº†');

                } catch (error) {
                    console.error('UIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            initProgressBars() {
                try {
                    const dbProgress = safeGetElement('db-usage');
                    const storageProgress = safeGetElement('storage-usage');

                    if (dbProgress) {
                        dbProgress.value = 0;
                        dbProgress.max = 100;
                    }

                    if (storageProgress) {
                        storageProgress.value = 0;
                        storageProgress.max = 100;
                    }

                } catch (error) {
                    console.error('ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            initHistoryPanel() {
                try {
                    const historyPanel = safeGetElement('history-sidebar');
                    if (historyPanel) {
                        historyPanel.style.right = '-400px';
                    }
                } catch (error) {
                    console.error('å±¥æ­´ãƒ‘ãƒãƒ«åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            setupEventListeners() {
                try {
                    document.querySelectorAll('.currency-btn').forEach(btn => {
                        this.eventManager.addListener(btn, 'click', (e) => {
                            this.selectCurrency(e.target.dataset.currency);
                        });
                    });

                    document.querySelectorAll('.status-btn').forEach(btn => {
                        this.eventManager.addListener(btn, 'click', (e) => {
                            this.selectAnalysisStatus(e.target.dataset.status);
                        });
                    });

                    document.querySelectorAll('.wave-btn').forEach(btn => {
                        this.eventManager.addListener(btn, 'click', (e) => {
                            this.selectTargetWave(e.target.dataset.wave);
                        });
                    });

                    const memoElement = safeGetElement('analysis-memo');
                    if (memoElement) {
                        this.eventManager.addListener(memoElement, 'input', 
                            this.debounce((e) => {
                                this.dataManager.autoSave(
                                    this.dataManager.currentCurrency,
                                    this.dataManager.currentScenario,
                                    'memo',
                                    e.target.value
                                );
                            }, 1000)
                        );
                    }

                    const promptElement = safeGetElement('fixed-prompt');
                    if (promptElement) {
                        this.eventManager.addListener(promptElement, 'input',
                            this.debounce((e) => {
                                this.dataManager.autoSave('global', 'settings', 'fixedPrompt', e.target.value);
                            }, 1000)
                        );
                    }

                    this.setupButtonListeners();
                    this.setupNavigationListeners();
                    this.setupHistoryListeners();
                    this.setupCopyListeners();
                    this.setupErrorBarListeners();

                    console.log('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');

                } catch (error) {
                    console.error('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            setupButtonListeners() {
                const backupBtn = safeGetElement('backup-btn');
                if (backupBtn) {
                    this.eventManager.addListener(backupBtn, 'click', () => {
                        this.backupManager.createBackup();
                    });
                }

                const themeToggle = safeGetElement('theme-toggle');
                if (themeToggle) {
                    this.eventManager.addListener(themeToggle, 'click', () => {
                        this.themeManager.toggleTheme();
                    });
                }

                const addScenarioBtn = safeGetElement('add-scenario');
                if (addScenarioBtn) {
                    this.eventManager.addListener(addScenarioBtn, 'click', () => {
                        this.scenarioManager.addScenario(this.dataManager.currentCurrency);
                    });
                }

                const removeScenarioBtn = safeGetElement('remove-scenario');
                if (removeScenarioBtn) {
                    this.eventManager.addListener(removeScenarioBtn, 'click', () => {
                        this.scenarioManager.deleteScenario(
                            this.dataManager.currentCurrency,
                            this.dataManager.currentScenario
                        );
                    });
                }

                const addCurrencyBtn = safeGetElement('add-currency');
                if (addCurrencyBtn) {
                    this.eventManager.addListener(addCurrencyBtn, 'click', () => {
                        this.addCurrency();
                    });
                }

                const removeCurrencyBtn = safeGetElement('remove-currency');
                if (removeCurrencyBtn) {
                    this.eventManager.addListener(removeCurrencyBtn, 'click', () => {
                        this.removeCurrency();
                    });
                }
            }

            setupNavigationListeners() {
                const prevBtn = safeGetElement('prev-chart');
                if (prevBtn) {
                    this.eventManager.addListener(prevBtn, 'click', () => {
                        this.navigateToPreviousScenario();
                    });
                }

                const nextBtn = safeGetElement('next-chart');
                if (nextBtn) {
                    this.eventManager.addListener(nextBtn, 'click', () => {
                        this.navigateToNextScenario();
                    });
                }

                const topBtn = safeGetElement('top-return');
                if (topBtn) {
                    this.eventManager.addListener(topBtn, 'click', () => {
                        this.returnToTop();
                    });
                }
            }

            setupHistoryListeners() {
                const historyBtn = safeGetElement('history-btn');
                if (historyBtn) {
                    this.eventManager.addListener(historyBtn, 'click', () => {
                        this.openHistoryPanel();
                    });
                }

                const closeHistoryBtn = safeGetElement('close-history');
                if (closeHistoryBtn) {
                    this.eventManager.addListener(closeHistoryBtn, 'click', () => {
                        this.closeHistoryPanel();
                    });
                }

                const historySearchInput = safeGetElement('history-search');
                if (historySearchInput) {
                    this.eventManager.addListener(historySearchInput, 'input',
                        this.debounce((e) => {
                            this.historyManager.searchHistory(e.target.value);
                        }, 500)
                    );
                }
            }

            setupCopyListeners() {
                const copyMemoBtn = safeGetElement('copy-memo');
                if (copyMemoBtn) {
                    this.eventManager.addListener(copyMemoBtn, 'click', () => {
                        const memo = safeGetElement('analysis-memo')?.value || '';
                        this.copyToClipboard(memo);
                    });
                }

                const copyPromptBtn = safeGetElement('copy-prompt');
                if (copyPromptBtn) {
                    this.eventManager.addListener(copyPromptBtn, 'click', () => {
                        const prompt = safeGetElement('fixed-prompt')?.value || '';
                        this.copyToClipboard(prompt);
                    });
                }

                const changePromptBtn = safeGetElement('change-prompt');
                if (changePromptBtn) {
                    this.eventManager.addListener(changePromptBtn, 'click', () => {
                        this.changeFixedPrompt();
                    });
                }

                const chatgptBtn = safeGetElement('chatgpt-analysis');
                if (chatgptBtn) {
                    this.eventManager.addListener(chatgptBtn, 'click', () => {
                        this.openChatGPTAnalysis();
                    });
                }
            }

            setupErrorBarListeners() {
                const recoveryBtn = safeGetElement('recovery-btn');
                if (recoveryBtn) {
                    this.eventManager.addListener(recoveryBtn, 'click', () => {
                        hideError();
                    });
                }
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            async selectCurrency(currency) {
                try {
                    validateInput(currency, 'currency', true);

                    document.querySelectorAll('.currency-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.currency === currency);
                    });

                    this.dataManager.currentCurrency = currency;
                    await this.updateCurrentDisplay();

                    console.log(`é€šè²¨ãƒšã‚¢é¸æŠ: ${currency}`);

                } catch (error) {
                    console.error('é€šè²¨ãƒšã‚¢é¸æŠã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('é€šè²¨ãƒšã‚¢ã®é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async selectScenario(scenarioId) {
                try {
                    validateInput(scenarioId, 'scenario', true);

                    document.querySelectorAll('.scenario-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.scenario === scenarioId);
                    });

                    this.dataManager.currentScenario = scenarioId;
                    await this.updateCurrentDisplay();

                    console.log(`ã‚·ãƒŠãƒªã‚ªé¸æŠ: ${scenarioId}`);

                } catch (error) {
                    console.error('ã‚·ãƒŠãƒªã‚ªé¸æŠã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ã‚·ãƒŠãƒªã‚ªã®é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async updateCurrentDisplay() {
                try {
                    const currency = this.dataManager.currentCurrency;
                    const scenario = this.dataManager.currentScenario;

                    safeUpdateElement('current-pair', currency);

                    const [memo, analysisStatus, targetWave] = await Promise.all([
                        this.dataManager.loadData(currency, scenario, 'memo'),
                        this.dataManager.loadData(currency, scenario, 'analysisStatus'),
                        this.dataManager.loadData(currency, scenario, 'targetWave')
                    ]);

                    const memoElement = safeGetElement('analysis-memo');
                    if (memoElement) {
                        memoElement.value = memo || '';
                    }

                    document.querySelectorAll('.status-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.status === analysisStatus);
                    });

                    document.querySelectorAll('.wave-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.wave === targetWave);
                    });

                    if (this.scenarioManager) {
                        await this.scenarioManager.displayScenarioImages(currency, scenario);
                    }

                    this.updateScenarioStatusDisplay(scenario, analysisStatus);

                    if (this.scenarioManager) {
                        await this.scenarioManager.updateScenarioUI(currency);
                    }

                    console.log(`è¡¨ç¤ºæ›´æ–°å®Œäº†: ${currency} - ${scenario}`);

                } catch (error) {
                    console.error('è¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('è¡¨ç¤ºã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            updateScenarioStatusDisplay(scenario, status) {
                try {
                    const scenarioBtn = document.querySelector(`[data-scenario="${scenario}"]`);
                    if (!scenarioBtn) return;

                    const statusIndicator = scenarioBtn.parentNode?.querySelector('.status-indicator');
                    if (statusIndicator && status) {
                        const statusEmoji = {
                            'æ¤œè¨ä¸­': 'ğŸ¤”',
                            'è¨ˆç®—ä¸­': 'ğŸ”„',
                            'å®Ÿæˆ¦': 'âš¡',
                            'åˆ©ç¢º': 'ğŸ“ˆ',
                            'æåˆ‡ã‚Š': 'ğŸ“‰',
                            'è¦‹é€ã‚Š': 'ğŸ‘€'
                        };
                        statusIndicator.textContent = `${statusEmoji[status] || 'ğŸ“Š'} ${status}`;
                    }
                } catch (error) {
                    console.error('ã‚·ãƒŠãƒªã‚ªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async selectAnalysisStatus(status) {
                try {
                    document.querySelectorAll('.status-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.status === status);
                    });

                    await this.dataManager.autoSave(
                        this.dataManager.currentCurrency,
                        this.dataManager.currentScenario,
                        'analysisStatus',
                        status
                    );

                    this.updateScenarioStatusDisplay(this.dataManager.currentScenario, status);

                    console.log(`åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ: ${status}`);

                } catch (error) {
                    console.error('åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async selectTargetWave(wave) {
                try {
                    document.querySelectorAll('.wave-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.wave === wave);
                    });

                    await this.dataManager.autoSave(
                        this.dataManager.currentCurrency,
                        this.dataManager.currentScenario,
                        'targetWave',
                        wave
                    );

                    console.log(`ç‹™ã†æ³¢é¸æŠ: ${wave}`);

                } catch (error) {
                    console.error('ç‹™ã†æ³¢é¸æŠã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ç‹™ã†æ³¢ã®é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async addCurrency() {
                try {
                    const newCurrency = prompt('æ–°ã—ã„é€šè²¨ãƒšã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: EURJPYï¼‰:');
                    if (!newCurrency) return;

                    const currency = newCurrency.trim().toUpperCase();
                    validateInput(currency, 'currency', true);

                    const existingBtn = document.querySelector(`[data-currency="${currency}"]`);
                    if (existingBtn) {
                        showErrorInUI('ã“ã®é€šè²¨ãƒšã‚¢ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
                        return;
                    }

                    const currencyButtons = document.querySelector('.currency-buttons');
                    if (currencyButtons) {
                        const newBtn = document.createElement('button');
                        newBtn.className = 'currency-btn';
                        newBtn.dataset.currency = currency;
                        newBtn.textContent = currency;
                        newBtn.style.cssText = 'background-color: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; min-width: 80px; transition: all 0.2s;';

                        this.eventManager.addListener(newBtn, 'click', (e) => {
                            this.selectCurrency(e.target.dataset.currency);
                        });

                        currencyButtons.appendChild(newBtn);

                        showSuccessInUI(`é€šè²¨ãƒšã‚¢ã€Œ${currency}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
                        console.log(`é€šè²¨ãƒšã‚¢è¿½åŠ : ${currency}`);
                    }

                } catch (error) {
                    console.error('é€šè²¨ãƒšã‚¢è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('é€šè²¨ãƒšã‚¢ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async removeCurrency() {
                try {
                    const currentCurrency = this.dataManager.currentCurrency;

                    const defaultCurrencies = ['USDJPY', 'EURUSD', 'GBPUSD', 'AUDUSD', 'SILVER', 'GOLD'];
                    if (defaultCurrencies.includes(currentCurrency)) {
                        showErrorInUI('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€šè²¨ãƒšã‚¢ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
                        return;
                    }

                    if (!confirm(`é€šè²¨ãƒšã‚¢ã€Œ${currentCurrency}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                        return;
                    }

                    const currencyBtn = document.querySelector(`[data-currency="${currentCurrency}"]`);
                    if (currencyBtn) {
                        currencyBtn.remove();
                    }

                    const firstBtn = document.querySelector('.currency-btn');
                    if (firstBtn) {
                        await this.selectCurrency(firstBtn.dataset.currency);
                    }

                    showSuccessInUI(`é€šè²¨ãƒšã‚¢ã€Œ${currentCurrency}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                    console.log(`é€šè²¨ãƒšã‚¢å‰Šé™¤: ${currentCurrency}`);

                } catch (error) {
                    console.error('é€šè²¨ãƒšã‚¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('é€šè²¨ãƒšã‚¢ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async navigateToPreviousScenario() {
                try {
                    const scenarioButtons = document.querySelectorAll('.scenario-btn');
                    const currentIndex = Array.from(scenarioButtons).findIndex(btn => 
                        btn.classList.contains('active')
                    );

                    if (currentIndex > 0) {
                        const prevBtn = scenarioButtons[currentIndex - 1];
                        await this.selectScenario(prevBtn.dataset.scenario);
                    } else if (scenarioButtons.length > 0) {
                        const lastBtn = scenarioButtons[scenarioButtons.length - 1];
                        await this.selectScenario(lastBtn.dataset.scenario);
                    }
                } catch (error) {
                    console.error('å‰ã®ã‚·ãƒŠãƒªã‚ªç§»å‹•ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async navigateToNextScenario() {
                try {
                    const scenarioButtons = document.querySelectorAll('.scenario-btn');
                    const currentIndex = Array.from(scenarioButtons).findIndex(btn => 
                        btn.classList.contains('active')
                    );

                    if (currentIndex < scenarioButtons.length - 1) {
                        const nextBtn = scenarioButtons[currentIndex + 1];
                        await this.selectScenario(nextBtn.dataset.scenario);
                    } else if (scenarioButtons.length > 0) {
                        const firstBtn = scenarioButtons[0];
                        await this.selectScenario(firstBtn.dataset.scenario);
                    }
                } catch (error) {
                    console.error('æ¬¡ã®ã‚·ãƒŠãƒªã‚ªç§»å‹•ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async returnToTop() {
                try {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });

                    await this.selectScenario('scenario1');
                } catch (error) {
                    console.error('ãƒˆãƒƒãƒ—æˆ»ã‚Šã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            openHistoryPanel() {
                try {
                    const sidebar = safeGetElement('history-sidebar');
                    if (sidebar) {
                        sidebar.style.right = '0';
                        this.historyManager.searchHistory('');
                    }
                } catch (error) {
                    console.error('å±¥æ­´ãƒ‘ãƒãƒ«é–‹ãã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            closeHistoryPanel() {
                try {
                    const sidebar = safeGetElement('history-sidebar');
                    if (sidebar) {
                        sidebar.style.right = '-400px';
                    }
                } catch (error) {
                    console.error('å±¥æ­´ãƒ‘ãƒãƒ«é–‰ã˜ã‚‹ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    showSuccessInUI('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                } catch (error) {
                    console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            async changeFixedPrompt() {
                try {
                    const currentPrompt = safeGetElement('fixed-prompt')?.value || '';
                    const newPrompt = prompt('å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentPrompt);

                    if (newPrompt !== null) {
                        const promptElement = safeGetElement('fixed-prompt');
                        if (promptElement) {
                            promptElement.value = newPrompt;

                            await this.dataManager.autoSave('global', 'settings', 'fixedPrompt', newPrompt);

                            showSuccessInUI('å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                        }
                    }
                } catch (error) {
                    console.error('å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            openChatGPTAnalysis() {
                try {
                    const memo = safeGetElement('analysis-memo')?.value || '';
                    const prompt = safeGetElement('fixed-prompt')?.value || '';

                    const analysisText = prompt + '\n\n' + memo;

                    const chatgptUrl = 'https://chat.openai.com/';
                    const newWindow = window.open(chatgptUrl, '_blank');

                    if (newWindow) {
                        this.copyToClipboard(analysisText);
                        showSuccessInUI('ChatGPTã‚’é–‹ãã€åˆ†æå†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    } else {
                        showErrorInUI('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ã§ChatGPTã‚’é–‹ã„ã¦ãã ã•ã„ã€‚');
                    }

                } catch (error) {
                    console.error('ChatGPTåˆ†æé–‹ãã‚¨ãƒ©ãƒ¼:', error);
                    showErrorInUI('ChatGPTåˆ†æã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', error);
                }
            }

            async loadInitialData() {
                try {
                    const fixedPrompt = await this.dataManager.loadData('global', 'settings', 'fixedPrompt');
                    if (fixedPrompt) {
                        const promptElement = safeGetElement('fixed-prompt');
                        if (promptElement) {
                            promptElement.value = fixedPrompt;
                        }
                    }

                    await this.updateCurrentDisplay();

                    console.log('åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');

                } catch (error) {
                    console.error('åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            showFallbackUI(error) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif; background: #f8f9fa; min-height: 100vh; display: flex; flex-direction: column; justify-content: center;">
                        <div style="max-width: 600px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                            <h1 style="color: #dc3545; margin-bottom: 20px;">âš ï¸ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h1>
                            <p style="margin: 20px 0; font-size: 16px; line-height: 1.6; color: #333;">
                                ${sanitizeHTML(error.message)}
                            </p>
                            <div style="margin: 30px 0;">
                                <button onclick="location.reload()" style="padding: 12px 24px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                    ğŸ”„ å†èª­ã¿è¾¼ã¿
                                </button>
                                <button onclick="clearLocalStorage()" style="padding: 12px 24px; margin: 8px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                    ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
                                </button>
                            </div>
                            <details style="margin-top: 30px; text-align: left;">
                                <summary style="cursor: pointer; color: #666; font-size: 14px; margin-bottom: 10px;">ğŸ”§ æŠ€è¡“è©³ç´°</summary>
                                <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow: auto; font-size: 12px; color: #333; border: 1px solid #dee2e6;">${sanitizeHTML(error.stack || 'ã‚¹ã‚¿ãƒƒã‚¯æƒ…å ±ãªã—')}</pre>
                            </details>
                            <div style="margin-top: 30px; padding: 15px; background: #e9ecef; border-radius: 5px; font-size: 14px; color: #666;">
                                <strong>å¯¾å‡¦æ³•:</strong><br>
                                1. ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„<br>
                                2. å•é¡ŒãŒç¶šãå ´åˆã¯ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã‚’è©¦ã—ã¦ãã ã•ã„<br>
                                3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„
                            </div>
                        </div>
                    </div>
                `;

                window.clearLocalStorage = () => {
                    if (confirm('ã™ã¹ã¦ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                        try {
                            localStorage.clear();
                            sessionStorage.clear();
                            location.reload();
                        } catch (err) {
                            alert('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                        }
                    }
                };
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã‚¯ãƒ©ã‚¹
        class EventManager {
            constructor() {
                this.boundEvents = new Map();
            }

            addListener(element, event, handler, options = {}) {
                if (!element) {
                    console.warn('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ : è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                const key = `${element.id || 'anonymous'}_${event}_${Date.now()}`;

                try {
                    element.addEventListener(event, handler, options);
                    this.boundEvents.set(key, { element, event, handler, options });
                } catch (error) {
                    console.error('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            removeAllListeners() {
                try {
                    for (const [key, { element, event, handler, options }] of this.boundEvents) {
                        element.removeEventListener(event, handler, options);
                    }
                    this.boundEvents.clear();
                    console.log('å…¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤å®Œäº†');
                } catch (error) {
                    console.error('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
        }

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç®¡ç†ã‚¯ãƒ©ã‚¹
        class OfflineManager {
            constructor() {
                this.isOnline = navigator.onLine;
                this.pendingOperations = [];
                this.init();
            }

            init() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.hideOfflineMode();
                    this.syncPendingData();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.showOfflineMode();
                });
            }

            showOfflineMode() {
                showErrorInUI('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰: è¡¨ç¤ºã®ã¿å¯èƒ½ã§ã™ã€‚æ¥ç¶šãŒå¾©æ—§ã™ã‚‹ã¨è‡ªå‹•çš„ã«åŒæœŸã•ã‚Œã¾ã™ã€‚');
            }

            hideOfflineMode() {
                hideError();
                showSuccessInUI('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸ');
            }

            async syncPendingData() {
                if (this.pendingOperations.length === 0) return;

                console.log(`ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¸­ã®æ“ä½œã‚’åŒæœŸä¸­: ${this.pendingOperations.length}ä»¶`);

                for (const operation of this.pendingOperations) {
                    try {
                        await operation();
                    } catch (error) {
                        console.error('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    }
                }

                this.pendingOperations = [];
                showSuccessInUI('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ');
            }

            addPendingOperation(operation) {
                this.pendingOperations.push(operation);
            }
        }

        // ã‚¨ãƒ©ãƒ¼ç›£è¦–ã‚¯ãƒ©ã‚¹
        class ErrorMonitor {
            constructor() {
                this.errorCount = 0;
                this.errors = [];
                this.maxErrors = 50;
                this.init();
            }

            init() {
                window.addEventListener('error', (e) => {
                    this.logError('JavaScript Error', e.error || e.message, e.filename, e.lineno);
                });

                window.addEventListener('unhandledrejection', (e) => {
                    this.logError('Unhandled Promise Rejection', e.reason);
                });
            }

            logError(type, error, filename = '', lineno = 0) {
                this.errorCount++;

                const errorInfo = {
                    type,
                    message: error?.message || error,
                    stack: error?.stack,
                    filename,
                    lineno,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };

                this.errors.push(errorInfo);

                if (this.errors.length > this.maxErrors) {
                    this.errors.shift();
                }

                console.error('ç›£è¦–ã‚¨ãƒ©ãƒ¼:', errorInfo);

                if (this.errorCount > 10) {
                    showErrorInUI('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒå¤šç™ºã—ã¦ã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                }
            }

            getErrorReport() {
                return {
                    totalErrors: this.errorCount,
                    recentErrors: this.errors.slice(-10),
                    timestamp: new Date().toISOString()
                };
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                app = new FXAnalysisApp();
                await app.initialize();
            } catch (error) {
                console.error('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);

                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: red;">
                        <h1>ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼</h1>
                        <p>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
                        <button onclick="location.reload()">å†èª­ã¿è¾¼ã¿</button>
                    </div>
                `;
            }
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            try {
                if (app && app.eventManager) {
                    app.eventManager.removeAllListeners();
                }
            } catch (error) {
                console.error('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
            }
        });
    </script>
</body>
</html>
