<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”„ FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        :root {
            --bg-color: #f8f9fa;
            --text-color: #333;
            --card-bg: white;
            --border-color: #dee2e6;
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --secondary-color: #6c757d;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e9ecef;
            --card-bg: #2d2d2d;
            --border-color: #495057;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #212529;
        }

        .main-content {
            flex: 1;
            padding: 20px;
        }

        .currency-selection {
            margin-bottom: 25px;
        }

        .currency-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .currency-btn {
            padding: 12px 20px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .currency-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .currency-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .analysis-section {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-area {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .currency-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-align: center;
        }

        .image-container {
            position: relative;
            margin-bottom: 20px;
        }

        .chart-image {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .image-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            background: var(--border-color);
            border-radius: 8px;
            color: var(--secondary-color);
            font-size: 16px;
        }

        .high-quality-btn {
            background: rgba(0,123,255,0.9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
        }

        .controls-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .scenario-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .scenario-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .scenario-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scenario-btn {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .scenario-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        .scenario-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .status-indicator-btn {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: var(--secondary-color);
            color: white;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        .analysis-status {
            margin-bottom: 25px;
        }

        .status-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .status-btn {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .status-btn:hover {
            border-color: var(--primary-color);
            transform: translateX(3px);
        }

        .status-btn.active {
            border-color: var(--primary-color);
            border-width: 3px;
            background: rgba(0,123,255,0.05);
        }

        .status-btn.status-considering {
            border-color: var(--primary-color);
        }

        .status-btn.status-skip, .status-btn.status-missed, .status-btn.status-completed {
            border-color: var(--secondary-color);
        }

        .status-btn.status-pending, .status-btn.status-holding {
            border-color: var(--danger-color);
        }

        .wave-target {
            margin-bottom: 25px;
        }

        .wave-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .wave-btn {
            padding: 10px 15px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
        }

        .wave-btn:hover {
            transform: translateX(3px);
        }

        .wave-btn.active {
            border-width: 3px;
        }

        .wave-btn.wave-none {
            border-color: var(--secondary-color);
        }

        .wave-btn.wave-1h {
            border-color: var(--success-color);
        }

        .wave-btn.wave-4h {
            border-color: var(--primary-color);
        }

        .wave-btn.wave-1d {
            border-color: var(--danger-color);
        }

        .memo-section {
            margin-bottom: 25px;
        }

        .memo-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.2s ease;
        }

        .memo-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .chatgpt-section {
            margin-bottom: 25px;
        }

        .chatgpt-prompt {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-color);
            font-family: inherit;
            font-size: 12px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .navigation-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-btn {
            flex: 1;
            padding: 10px;
            font-size: 12px;
        }

        .bottom-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }

        .usage-monitor {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }

        .usage-monitor progress {
            width: 60px;
            height: 8px;
        }

        .error-bar {
            background: var(--danger-color);
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 14px;
            max-width: 400px;
            text-align: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .history-item:hover {
            background: rgba(0,123,255,0.05);
        }

        @media (max-width: 768px) {
            .analysis-section {
                grid-template-columns: 1fr;
            }
            
            .controls-panel {
                order: -1;
            }
            
            .currency-buttons {
                flex-direction: column;
            }
            
            .currency-btn {
                width: 100%;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .bottom-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .navigation-section {
                flex-direction: column;
            }
        }

        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            background: rgba(0,123,255,0.1);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">ğŸ”„ FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </div>
                <div class="header-controls">
                    <button id="backup-btn" class="btn btn-secondary">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
                    <button id="theme-toggle" class="btn btn-secondary">ğŸŒ™</button>
                    <span>ğŸ“Š</span>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="currency-selection">
                <div class="currency-buttons">
                    <button class="currency-btn" data-currency="USDJPY">USDJPY</button>
                    <button class="currency-btn" data-currency="EURUSD">EURUSD</button>
                    <button class="currency-btn" data-currency="GBPUSD">GBPUSD</button>
                    <button class="currency-btn" data-currency="AUDUSD">AUDUSD</button>
                    <button class="currency-btn" data-currency="SILVER">SILVER</button>
                    <button class="currency-btn" data-currency="GOLD">GOLD</button>
                </div>
            </div>

            <div class="analysis-section">
                <div class="chart-area">
                    <h2 class="currency-title" id="currency-title">é€šè²¨ãƒšã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
                    <div class="image-container" id="image-container">
                        <div class="image-error">ç”»åƒã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯é€šè²¨ãƒšã‚¢ã¨ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                    </div>
                </div>

                <div class="controls-panel">
                    <div class="scenario-section">
                        <h3 class="section-title">ğŸ“‹ ã‚·ãƒŠãƒªã‚ª</h3>
                        <div class="scenario-list" id="scenario-list">
                            <!-- ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                        </div>
                    </div>

                    <div class="analysis-status">
                        <h3 class="section-title">ğŸ“Š åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
                        <div class="status-buttons">
                            <button class="status-btn status-considering" data-status="considering">ğŸ” æ¤œè¨ä¸­</button>
                            <button class="status-btn status-skip" data-status="skip">ğŸ™…â€â™‚ï¸ è¦‹é€ã‚Š</button>
                            <button class="status-btn status-missed" data-status="missed">ğŸ˜… è¦‹é€ƒã—</button>
                            <button class="status-btn status-pending" data-status="pending">ğŸ¯ æŒ‡å€¤é€†æŒ‡å€¤ä¸­</button>
                            <button class="status-btn status-holding" data-status="holding">ğŸ’¼ ä¿æŒä¸­</button>
                            <button class="status-btn status-completed" data-status="completed">âœ… å®Œäº†</button>
                        </div>
                    </div>

                    <div class="wave-target">
                        <h3 class="section-title">ğŸŒŠ ç‹™ã†æ³¢</h3>
                        <div class="wave-buttons">
                            <button class="wave-btn wave-none" data-wave="none">æœªé¸æŠ</button>
                            <button class="wave-btn wave-1h" data-wave="1h">1æ™‚é–“è¶³</button>
                            <button class="wave-btn wave-4h" data-wave="4h">4æ™‚é–“è¶³</button>
                            <button class="wave-btn wave-1d" data-wave="1d">æ—¥è¶³</button>
                        </div>
                    </div>

                    <div class="memo-section">
                        <h3 class="section-title">ğŸ“ åˆ†æãƒ¡ãƒ¢</h3>
                        <textarea id="analysis-memo" class="memo-textarea" placeholder="åˆ†æå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                    </div>

                    <div class="chatgpt-section">
                        <h3 class="section-title">ğŸ¤– ChatGPTé€£æº</h3>
                        <textarea id="chatgpt-prompt" class="chatgpt-prompt" placeholder="ChatGPTã«é€ä¿¡ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·¨é›†ã§ãã¾ã™...">ä»¥ä¸‹ã®FXåˆ†æã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„ï¼š

</textarea>
                        <button id="chatgpt-btn" class="btn btn-success" style="width: 100%;">ChatGPTã§åˆ†æ</button>
                    </div>

                    <div class="navigation-section">
                        <button id="prev-chart" class="btn btn-secondary nav-btn">â† å‰ã®ãƒãƒ£ãƒ¼ãƒˆ</button>
                        <button id="next-chart" class="btn btn-secondary nav-btn">æ¬¡ã®ãƒãƒ£ãƒ¼ãƒˆ â†’</button>
                        <button id="top-chart" class="btn btn-primary nav-btn">ğŸ” ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
                    </div>
                </div>
            </div>
        </main>

        <div class="bottom-section">
            <div class="usage-monitor">
                <span>DB: </span><progress id="db-usage" max="100" value="0"></progress>
                <span>Storage: </span><progress id="storage-usage" max="100" value="0"></progress>
            </div>
            <div class="error-bar" id="error-bar" style="display: none;"></div>
            <button id="history-btn" class="btn btn-secondary">ğŸ“œ å±¥æ­´</button>
        </div>
    </div>

    <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“œ å¤‰æ›´å±¥æ­´</h3>
            <div class="history-list" id="history-list"></div>
            <button id="close-history" class="btn btn-secondary" style="margin-top: 15px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // Supabaseè¨­å®šï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ãƒ»å¤‰æ›´å³ç¦ï¼‰
        const SUPABASE_URL = 'https://jfrwyunauatsybdljlah.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impmcnd5dW5hdWF0c3liZGxqbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTMxODksImV4cCI6MjA2OTA4OTE4OX0.cyhPTiN4WAQ2p86JBZObjSljt2i1K_bK-cGGo3soxAo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentCurrency = '';
        let currentScenario = 'scenario1';
        let mainData = {};
        let scenarioOrder = {};
        let isLoading = false;

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
        const statusConfig = {
            considering: { emoji: 'ğŸ”', text: 'æ¤œè¨ä¸­', color: '#007bff' },
            skip: { emoji: 'ğŸ™…â€â™‚ï¸', text: 'è¦‹é€ã‚Š', color: '#6c757d' },
            missed: { emoji: 'ğŸ˜…', text: 'è¦‹é€ƒã—', color: '#6c757d' },
            pending: { emoji: 'ğŸ¯', text: 'æŒ‡å€¤é€†æŒ‡å€¤ä¸­', color: '#dc3545' },
            holding: { emoji: 'ğŸ’¼', text: 'ä¿æŒä¸­', color: '#dc3545' },
            completed: { emoji: 'âœ…', text: 'å®Œäº†', color: '#6c757d' }
        };

        // æ³¢è¨­å®š
        const waveConfig = {
            none: { text: 'æœªé¸æŠ', color: '#6c757d' },
            '1h': { text: '1æ™‚é–“è¶³', color: '#28a745' },
            '4h': { text: '4æ™‚é–“è¶³', color: '#007bff' },
            '1d': { text: 'æ—¥è¶³', color: '#dc3545' }
        };

        // ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ç”Ÿæˆ
        function getDataKey(currency, scenario, type) {
            return `${currency}_${scenario}_${type}`;
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const errorBar = document.getElementById('error-bar');
            if (errorBar) {
                errorBar.textContent = message;
                errorBar.style.display = 'block';
                setTimeout(() => {
                    errorBar.style.display = 'none';
                }, 5000);
            }
        }

        // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadMainData() {
            try {
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('*')
                    .eq('id', 'main')
                    .single();
                
                if (error) {
                    throw new Error('ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
                
                if (!data || !data.data) {
                    throw new Error('ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                mainData = data.data;
                return mainData;
            } catch (error) {
                console.error('ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                return {};
            }
        }

        // å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadData(key) {
            try {
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('*')
                    .eq('id', key)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                return data ? data.data.value : null;
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // è‡ªå‹•ä¿å­˜
        async function autoSave(currency, scenario, type, value) {
            if (isLoading) return;
            
            try {
                const key = getDataKey(currency, scenario, type);
                const { error } = await supabase
                    .from('fx_analysis_data')
                    .upsert([{
                        id: key,
                        data: { value },
                        updated_at: new Date().toISOString()
                    }]);
                
                if (error) {
                    throw error;
                }
                
                // å±¥æ­´ä¿å­˜
                await saveHistory(currency, scenario, type, value);
                
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å±¥æ­´ä¿å­˜
        async function saveHistory(currency, scenario, type, value) {
            try {
                const { error } = await supabase
                    .from('fx_analysis_history')
                    .insert([{
                        timestamp: new Date().toISOString(),
                        version_id: `${currency}_${scenario}`,
                        description: `${type}ã‚’æ›´æ–°`,
                        data_snapshot: { currency, scenario, type, value },
                        changes: `${type}: ${value}`
                    }]);
                
                if (error) {
                    console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                }
            } catch (error) {
                console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚·ãƒŠãƒªã‚ªä¸€è¦§ç”Ÿæˆ
        function generateScenarios(currency) {
            const scenarioList = document.getElementById('scenario-list');
            if (!scenarioList) return;
            
            scenarioList.innerHTML = '';
            
            if (!currency || !mainData.images || !mainData.images[currency]) {
                return;
            }
            
            const scenarios = Object.keys(mainData.images[currency]);
            scenarios.forEach((scenario, index) => {
                const container = document.createElement('div');
                container.className = 'scenario-container';
                container.draggable = true;
                container.dataset.scenario = scenario;
                
                const btn = document.createElement('button');
                btn.className = 'scenario-btn';
                btn.textContent = `ã‚·ãƒŠãƒªã‚ª${index + 1}`;
                btn.dataset.scenario = scenario;
                
                const statusIndicator = document.createElement('small');
                statusIndicator.className = 'status-indicator-btn';
                statusIndicator.textContent = 'ğŸ” æ¤œè¨ä¸­';
                
                container.appendChild(btn);
                container.appendChild(statusIndicator);
                scenarioList.appendChild(container);
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                btn.addEventListener('click', () => selectScenario(scenario));
                
                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
                container.addEventListener('dragstart', handleDragStart);
                container.addEventListener('dragover', handleDragOver);
                container.addEventListener('drop', handleDrop);
                container.addEventListener('dragend', handleDragEnd);
            });
            
            updateScenarioStatus();
        }

        // ã‚·ãƒŠãƒªã‚ªé¸æŠ
        async function selectScenario(scenario) {
            currentScenario = scenario;
            
            // UIæ›´æ–°
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.scenario === scenario);
            });
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadCurrentData();
            updateImageDisplay();
        }

        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadCurrentData() {
            if (!currentCurrency || !currentScenario) return;
            
            isLoading = true;
            
            try {
                // åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                const status = await loadData(getDataKey(currentCurrency, currentScenario, 'analysisStatus')) || 'considering';
                updateAnalysisStatus(status);
                
                // ç‹™ã†æ³¢
                const wave = await loadData(getDataKey(currentCurrency, currentScenario, 'targetWave')) || 'none';
                updateWaveTarget(wave);
                
                // åˆ†æãƒ¡ãƒ¢
                const memo = await loadData(getDataKey(currentCurrency, currentScenario, 'analysisMemo')) || '';
                const memoTextarea = document.getElementById('analysis-memo');
                if (memoTextarea) {
                    memoTextarea.value = memo;
                }
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                isLoading = false;
            }
        }

        // åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateAnalysisStatus(status) {
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === status);
            });
            updateScenarioStatus();
        }

        // ç‹™ã†æ³¢æ›´æ–°
        function updateWaveTarget(wave) {
            document.querySelectorAll('.wave-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.wave === wave);
            });
        }

        // ã‚·ãƒŠãƒªã‚ªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
        async function updateScenarioStatus() {
            if (!currentCurrency) return;
            
            const indicators = document.querySelectorAll('.status-indicator-btn');
            for (let indicator of indicators) {
                const container = indicator.parentElement;
                const scenario = container.dataset.scenario;
                
                if (scenario) {
                    const status = await loadData(getDataKey(currentCurrency, scenario, 'analysisStatus')) || 'considering';
                    const config = statusConfig[status];
                    indicator.textContent = `${config.emoji} ${config.text}`;
                    indicator.style.backgroundColor = config.color;
                }
            }
        }

        // ç”»åƒè¡¨ç¤ºæ›´æ–°
        function updateImageDisplay() {
            const container = document.getElementById('image-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!currentCurrency || !currentScenario || !mainData.images || !mainData.images[currentCurrency] || !mainData.images[currentCurrency][currentScenario]) {
                container.innerHTML = '<div class="image-error">ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            const images = mainData.images[currentCurrency][currentScenario];
            
            images.forEach((imageUrl, index) => {
                const img = document.createElement('img');
                img.className = 'chart-image';
                img.src = imageUrl;
                img.alt = `${currentCurrency} ${currentScenario} Chart ${index + 1}`;
                
                img.onerror = () => {
                    img.style.display = 'none';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'image-error';
                    errorDiv.textContent = 'ç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“';
                    container.appendChild(errorDiv);
                };
                
                container.appendChild(img);
                
                // é«˜ç”»è³ªãƒœã‚¿ãƒ³
                const highQualityBtn = document.createElement('button');
                highQualityBtn.className = 'high-quality-btn';
                highQualityBtn.textContent = 'é«˜ç”»è³ªã§è¡¨ç¤º';
                highQualityBtn.onclick = () => window.open(imageUrl, '_blank');
                container.appendChild(highQualityBtn);
            });
        }

        // é€šè²¨ãƒšã‚¢é¸æŠ
        async function selectCurrency(currency) {
            currentCurrency = currency;
            currentScenario = 'scenario1';
            
            // UIæ›´æ–°
            document.querySelectorAll('.currency-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.currency === currency);
            });
            
            const title = document.getElementById('currency-title');
            if (title) {
                title.textContent = currency;
            }
            
            // ã‚·ãƒŠãƒªã‚ªç”Ÿæˆ
            generateScenarios(currency);
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadCurrentData();
            updateImageDisplay();
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        function navigateScenario(direction) {
            if (!currentCurrency || !mainData.images || !mainData.images[currentCurrency]) return;
            
            const scenarios = Object.keys(mainData.images[currentCurrency]);
            const currentIndex = scenarios.indexOf(currentScenario);
            
            let newIndex;
            if (direction === 'prev') {
                newIndex = currentIndex > 0 ? currentIndex - 1 : scenarios.length - 1;
            } else if (direction === 'next') {
                newIndex = currentIndex < scenarios.length - 1 ? currentIndex + 1 : 0;
            } else if (direction === 'top') {
                newIndex = 0;
            }
            
            if (newIndex !== undefined && scenarios[newIndex]) {
                selectScenario(scenarios[newIndex]);
            }
        }

        // ChatGPTé€£æº
        function openChatGPT() {
            const memo = document.getElementById('analysis-memo')?.value || '';
            const prompt = document.getElementById('chatgpt-prompt')?.value || '';
            const fullPrompt = prompt + '\n\n' + memo;
            
            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            navigator.clipboard.writeText(fullPrompt).then(() => {
                // æ–°ã—ã„ã‚¿ãƒ–ã§ChatGPTã‚’é–‹ã
                window.open('https://chat.openai.com', '_blank');
            }).catch(err => {
                console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
                window.open('https://chat.openai.com', '_blank');
            });
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        async function createBackup() {
            try {
                const { data, error } = await supabase
                    .from('fx_analysis_data')
                    .select('*');
                
                if (error) {
                    throw error;
                }
                
                const backup = {
                    timestamp: new Date().toISOString(),
                    data: data
                };
                
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fx-analysis-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å±¥æ­´è¡¨ç¤º
        async function showHistory() {
            try {
                const { data, error } = await supabase
                    .from('fx_analysis_history')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(200);
                
                if (error) {
                    throw error;
                }
                
                const historyList = document.getElementById('history-list');
                const modal = document.getElementById('history-modal');
                
                if (historyList && modal) {
                    historyList.innerHTML = '';
                    
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        div.innerHTML = `
                            <div><strong>${item.version_id}</strong> - ${item.description}</div>
                            <div><small>${new Date(item.timestamp).toLocaleString()}</small></div>
                            <div><small>${item.changes}</small></div>
                        `;
                        historyList.appendChild(div);
                    });
                    
                    modal.style.display = 'block';
                }
                
            } catch (error) {
                console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? '' : 'dark');
            
            const btn = document.getElementById('theme-toggle');
            if (btn) {
                btn.textContent = isDark ? 'ğŸŒ™' : 'ğŸŒ';
            }
            
            // è¨­å®šä¿å­˜
            autoSave('global', 'settings', 'darkMode', !isDark);
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedElement !== this) {
                const list = this.parentNode;
                const draggedIndex = Array.from(list.children).indexOf(draggedElement);
                const targetIndex = Array.from(list.children).indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    list.insertBefore(draggedElement, this.nextSibling);
                } else {
                    list.insertBefore(draggedElement, this);
                }
            }
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            draggedElement = null;
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            // æ‰‹å‹•ä¿å­˜ï¼ˆç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶ä¿å­˜ï¼‰
                            if (currentCurrency && currentScenario) {
                                const memo = document.getElementById('analysis-memo')?.value || '';
                                autoSave(currentCurrency, currentScenario, 'analysisMemo', memo);
                            }
                            break;
                    }
                }
            });
        }

        // åˆæœŸåŒ–
        async function initialize() {
            try {
                // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                await loadMainData();
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                setupEventListeners();
                
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆè¨­å®š
                setupKeyboardShortcuts();
                
                // åˆæœŸè¨­å®šèª­ã¿è¾¼ã¿
                const darkMode = await loadData('global_settings_darkMode');
                if (darkMode) {
                    document.body.setAttribute('data-theme', 'dark');
                    const btn = document.getElementById('theme-toggle');
                    if (btn) btn.textContent = 'ğŸŒ';
                }
                
                // ChatGPTãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆæœŸå€¤è¨­å®š
                const promptTextarea = document.getElementById('chatgpt-prompt');
                if (promptTextarea && !promptTextarea.value.trim()) {
                    promptTextarea.value = 'ä»¥ä¸‹ã®FXåˆ†æã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„ï¼š\n\n';
                }
                
                console.log('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // é€šè²¨ãƒšã‚¢ãƒœã‚¿ãƒ³
            document.querySelectorAll('.currency-btn').forEach(btn => {
                btn.addEventListener('click', () => selectCurrency(btn.dataset.currency));
            });
            
            // åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (currentCurrency && currentScenario) {
                        updateAnalysisStatus(btn.dataset.status);
                        autoSave(currentCurrency, currentScenario, 'analysisStatus', btn.dataset.status);
                    }
                });
            });
            
            // ç‹™ã†æ³¢ãƒœã‚¿ãƒ³
            document.querySelectorAll('.wave-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (currentCurrency && currentScenario) {
                        updateWaveTarget(btn.dataset.wave);
                        autoSave(currentCurrency, currentScenario, 'targetWave', btn.dataset.wave);
                    }
                });
            });
            
            // åˆ†æãƒ¡ãƒ¢
            const memoTextarea = document.getElementById('analysis-memo');
            if (memoTextarea) {
                memoTextarea.addEventListener('input', () => {
                    if (currentCurrency && currentScenario) {
                        autoSave(currentCurrency, currentScenario, 'analysisMemo', memoTextarea.value);
                    }
                });
            }
            
            // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
            const prevBtn = document.getElementById('prev-chart');
            const nextBtn = document.getElementById('next-chart');
            const topBtn = document.getElementById('top-chart');
            
            if (prevBtn) prevBtn.addEventListener('click', () => navigateScenario('prev'));
            if (nextBtn) nextBtn.addEventListener('click', () => navigateScenario('next'));
            if (topBtn) topBtn.addEventListener('click', () => navigateScenario('top'));
            
            // ChatGPTãƒœã‚¿ãƒ³
            const chatgptBtn = document.getElementById('chatgpt-btn');
            if (chatgptBtn) {
                chatgptBtn.addEventListener('click', openChatGPT);
            }
            
            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³
            const backupBtn = document.getElementById('backup-btn');
            if (backupBtn) {
                backupBtn.addEventListener('click', createBackup);
            }
            
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            const themeBtn = document.getElementById('theme-toggle');
            if (themeBtn) {
                themeBtn.addEventListener('click', toggleTheme);
            }
            
            // å±¥æ­´ãƒœã‚¿ãƒ³
            const historyBtn = document.getElementById('history-btn');
            if (historyBtn) {
                historyBtn.addEventListener('click', showHistory);
            }
            
            // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
            const closeHistoryBtn = document.getElementById('close-history');
            if (closeHistoryBtn) {
                closeHistoryBtn.addEventListener('click', () => {
                    const modal = document.getElementById('history-modal');
                    if (modal) modal.style.display = 'none';
                });
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            const historyModal = document.getElementById('history-modal');
            if (historyModal) {
                historyModal.addEventListener('click', (e) => {
                    if (e.target === historyModal) {
                        historyModal.style.display = 'none';
                    }
                });
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
