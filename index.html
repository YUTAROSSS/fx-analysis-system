<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        /* åŸºæœ¬ãƒªã‚»ãƒƒãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ« */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333333;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        /* ãƒœã‚¿ãƒ³åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        button {
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            outline: none;
            font-family: inherit;
        }

        button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        button:active {
            transform: translateY(0);
        }

        /* é€šè²¨ãƒšã‚¢ãƒœã‚¿ãƒ³ */
        .currency-btn {
            transition: all 0.2s ease;
        }

        .currency-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .currency-btn.active {
            background: #007bff !important;
            color: white !important;
        }

        /* ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ */
        .scenario-btn {
            transition: all 0.2s ease;
            position: relative;
        }

        .scenario-btn:hover {
            transform: translateY(-2px);
        }

        .scenario-btn.active {
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.4) !important;
            transform: translateY(-2px);
        }

        .scenario-btn .status-indicator {
            font-size: 11px;
            opacity: 0.9;
        }

        /* åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ç‹™ã†æ³¢ãƒœã‚¿ãƒ³ */
        .status-btn, .wave-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .status-btn:hover, .wave-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .status-btn.active {
            border: 3px solid #495057 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .wave-btn.active {
            border: 3px solid #495057 !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ç‹™ã†æ³¢ã®è‰²åˆ†ã‘ */
        .wave-btn[data-wave="æœªé¸æŠ"] {
            background: #6c757d !important;
        }

        .wave-btn[data-wave="1æ™‚é–“è¶³"] {
            background: #28a745 !important;
        }

        .wave-btn[data-wave="4æ™‚é–“è¶³"] {
            background: #007bff !important;
        }

        .wave-btn[data-wave="æ—¥è¶³"] {
            background: #dc3545 !important;
        }

        /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ */
        .dark-mode {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .dark-mode .currency-section,
        .dark-mode .scenario-section,
        .dark-mode .main-display,
        .dark-mode .status-section,
        .dark-mode .wave-section,
        .dark-mode .memo-section,
        .dark-mode .chatgpt-section {
            background-color: #2d2d2d !important;
            color: #ffffff;
        }

        .dark-mode textarea {
            background-color: #3d3d3d;
            color: #ffffff;
            border-color: #555;
        }

        .dark-mode .history-sidebar {
            background-color: #2d2d2d;
            color: #ffffff;
        }

        .dark-mode .history-header {
            background-color: #1a1a1a !important;
        }

        .dark-mode .bottom-section {
            background-color: #2d2d2d !important;
            border-top-color: #555 !important;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            .currency-buttons,
            .scenario-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .currency-btn,
            .scenario-btn {
                margin-bottom: 8px;
                width: 100%;
                min-width: unset;
            }
            
            .analysis-section {
                flex-direction: column;
                gap: 20px;
            }
            
            .memo-chatgpt-section {
                margin: 20px 10px;
            }
            
            .history-sidebar {
                width: 100vw !important;
                right: -100vw !important;
            }
            
            .bottom-section {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 15px 10px;
            }
            
            .usage-monitor {
                justify-content: center;
            }
            
            .main-display {
                margin: 20px 10px;
            }
            
            .navigation {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .navigation button {
                flex: 1;
                min-width: 120px;
            }
        }

        @media (max-width: 480px) {
            header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
                padding: 10px;
            }
            
            header span {
                font-size: 16px;
            }
            
            .currency-section,
            .scenario-section {
                margin: 15px 10px;
                padding: 15px 10px;
            }
            
            .analysis-section {
                margin: 20px 10px;
            }
            
            .status-section,
            .wave-section {
                padding: 15px;
            }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
        .scenario-btn.dragging {
            opacity: 0.5;
            transform: rotate(2deg) scale(0.95);
        }

        .scenario-btn.drag-over {
            border: 2px dashed #007bff !important;
            background: rgba(0, 123, 255, 0.1) !important;
        }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        progress {
            appearance: none;
            -webkit-appearance: none;
            border-radius: 4px;
            overflow: hidden;
        }

        progress::-webkit-progress-bar {
            background-color: #e9ecef;
            border-radius: 4px;
        }

        progress::-webkit-progress-value {
            background-color: #007bff;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        progress::-moz-progress-bar {
            background-color: #007bff;
            border-radius: 4px;
        }

        /* å±¥æ­´é …ç›® */
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .history-item:hover {
            background-color: #f8f9fa;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .dark-mode .history-item {
            border-bottom-color: #555;
        }

        .dark-mode .history-item:hover {
            background-color: #3d3d3d;
        }

        /* ç”»åƒè¡¨ç¤º */
        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .image-container .image-error {
            color: #dc3545;
            font-size: 14px;
            padding: 20px;
            text-align: center;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .dark-mode ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background: #555;
        }

        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
        <span style="font-size: 18px; font-weight: bold;">ğŸ”„ FXé€šè²¨ãƒšã‚¢åˆ†æã‚·ã‚¹ãƒ†ãƒ </span>
        <div>
            <button id="backup-btn" style="margin-right: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 4px;">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
            <button id="theme-toggle" style="margin-right: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 12px; border-radius: 4px;">ğŸŒ™</button>
            <span style="font-size: 20px;">ğŸ“Š</span>
        </div>
    </header>

    <!-- é€šè²¨ãƒšã‚¢é¸æŠ -->
    <div class="currency-section" style="margin: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h3 style="margin-bottom: 15px; color: #495057;">é€šè²¨ãƒšã‚¢éƒ¨åˆ†</h3>
        <div class="currency-buttons" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
            <button class="currency-btn active" data-currency="USDJPY" style="background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; min-width: 80px;">USDJPY</button>
            <button class="currency-btn" data-currency="EURUSD" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; min-width: 80px;">EURUSD</button>
            <button class="currency-btn" data-currency="GBPUSD" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; min-width: 80px;">GBPUSD</button>
            <button class="currency-btn" data-currency="AUDUSD" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; min-width: 80px;">AUDUSD</button>
            <button class="currency-btn" data-currency="SILVER" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; min-width: 80px;">SILVER</button>
            <button class="currency-btn" data-currency="GOLD" style="background: #6c757d; color: white; border: none; padding: 10px 15px; border-radius: 5px; min-width: 80px;">GOLD</button>
            <button id="add-currency" style="background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 5px;">é€šè²¨ãƒšã‚¢è¿½åŠ </button>
            <button id="remove-currency" style="background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px;">é€šè²¨ãƒšã‚¢å‰Šé™¤</button>
        </div>
    </div>

    <!-- ã‚·ãƒŠãƒªã‚ªé¸æŠ -->
    <div class="scenario-section" style="margin: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h3 style="margin-bottom: 15px; color: #495057;">ãƒãƒ£ãƒ¼ãƒˆéƒ¨åˆ†</h3>
        <div class="scenario-buttons" id="scenario-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
            <button id="add-scenario" style="background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 5px;">ã‚·ãƒŠãƒªã‚ªè¿½åŠ </button>
            <button id="remove-scenario" style="background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 5px;">ã‚·ãƒŠãƒªã‚ªå‰Šé™¤</button>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="main-display" style="text-align: center; margin: 30px 20px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2 id="current-pair" style="margin-bottom: 20px; color: #495057;">USDJPY</h2>
        <div class="image-container" id="image-container" style="min-height: 400px; border: 2px dashed #dee2e6; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa;">
            <p style="color: #6c757d; font-size: 16px;">ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
        <button id="high-quality-btn" style="display: none; margin-top: 15px; background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px;">é«˜ç”»è³ªè¡¨ç¤º</button>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="navigation" style="text-align: center; margin: 20px 0;">
        <button id="prev-chart" style="margin: 0 10px; background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px;">â† å‰ã®ãƒãƒ£ãƒ¼ãƒˆ</button>
        <button id="next-chart" style="margin: 0 10px; background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px;">æ¬¡ã®ãƒãƒ£ãƒ¼ãƒˆ â†’</button>
        <button id="top-return" style="margin: 0 10px; background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px;">ğŸ” ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
    </div>

    <!-- åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ç‹™ã†æ³¢ -->
    <div class="analysis-section" style="display: flex; gap: 30px; margin: 30px 20px; flex-wrap: wrap;">
        <div class="status-section" style="flex: 1; min-width: 250px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 15px; color: #495057;">åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="status-btn" data-status="æ¤œè¨ä¸­" style="background: #007bff; color: white; border: 2px solid transparent; padding: 12px 15px; border-radius: 5px; text-align: left; width: 100%; display: flex; align-items: center;">
                    <span style="margin-right: 8px;">ğŸ”</span> æ¤œè¨ä¸­
                </button>
                <button class="status-btn" data-status="è¦‹é€ã‚Š" style="background: #6c757d; color: white; border: 2px solid transparent; padding: 12px 15px; border-radius: 5px; text-align: left; width: 100%; display: flex; align-items: center;">
                    <span style="margin-right: 8px;">ğŸ™…â€â™‚ï¸</span> è¦‹é€ã‚Š
                </button>
                <button class="status-btn" data-status="è¦‹é€ƒã—" style="background: #6c757d; color: white; border: 2px solid transparent; padding: 12px 15px; border-radius: 5px; text-align: left; width: 100%; display: flex; align-items: center;">
                    <span style="margin-right: 8px;">ğŸ˜…</span> è¦‹é€ƒã—
                </button>
                <button class="status-btn" data-status="æŒ‡å€¤é€†æŒ‡å€¤ä¸­" style="background: #dc3545; color: white; border: 2px solid transparent; padding: 12px 15px; border-radius: 5px; text-align: left; width: 100%; display: flex; align-items: center;">
                    <span style="margin-right: 8px;">ğŸ¯</span> æŒ‡å€¤é€†æŒ‡å€¤ä¸­
                </button>
                <button class="status-btn" data-status="ä¿æŒä¸­" style="background: #dc3545; color: white; border: 2px solid transparent; padding: 12px 15px; border-radius: 5px; text-align: left; width: 100%; display: flex; align-items: center;">
                    <span style="margin-right: 8px;">ğŸ’¼</span> ä¿æŒä¸­
                </button>
                <button class="status-btn" data-status="å®Œäº†" style="background: #6c757d; color: white; border: 2px solid transparent; padding: 12px 15px; border-radius: 5px; text-align: left; width: 100%; display: flex; align-items: center;">
                    <span style="margin-right: 8px;">âœ…</span> å®Œäº†
                </button>
            </div>
        </div>
        <div class="wave-section" style="flex: 1; min-width: 250px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 15px; color: #495057;">ç‹™ã†æ³¢</h3>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="wave-btn active" data-wave="æœªé¸æŠ" style="background: #6c757d; color: white; border: 3px solid #495057; padding: 12px 15px; border-radius: 5px; text-align: left; width: 100%;">æœªé¸æŠ</button>
                <button class="wave-btn" data-wave="1æ™‚é–“è¶³" style="background: #28a745; color: white; border: 2px solid transparent; padding: 12px 15px; border-radius: 5px; text-align: left; width: 100%;">1æ™‚é–“è¶³</button>
                <button class="wave-btn" data-wave="4æ™‚é–“è¶³" style="background: #007bff; color: white; border: 2px solid transparent; padding: 12px 15px; border-radius: 5px; text-align: left; width: 100%;">4æ™‚é–“è¶³</button>
                <button class="wave-btn" data-wave="æ—¥è¶³" style="background: #dc3545; color: white; border: 2px solid transparent; padding: 12px 15px; border-radius: 5px; text-align: left; width: 100%;">æ—¥è¶³</button>
            </div>
        </div>
    </div>

    <!-- åˆ†æãƒ¡ãƒ¢ãƒ»ChatGPTé€£æºã‚¨ãƒªã‚¢ -->
    <div class="memo-chatgpt-section" style="margin: 30px 20px;">
        <div class="memo-section" style="margin-bottom: 25px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 15px; color: #495057;">åˆ†æãƒ¡ãƒ¢</h3>
            <textarea id="analysis-memo" placeholder="åˆ†æãƒ¡ãƒ¢ã‚’å…¥åŠ›..." style="width: 100%; height: 120px; padding: 15px; border: 1px solid #ced4da; border-radius: 5px; font-family: inherit; resize: vertical; font-size: 14px;"></textarea>
            <button id="copy-memo" style="margin-top: 10px; background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px;">åˆ†æãƒ¡ãƒ¢ã‚³ãƒ”ãƒ¼</button>
        </div>
        <div class="chatgpt-section" style="padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin-bottom: 15px; color: #495057;">ChatGPTå›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
            <textarea id="fixed-prompt" placeholder="å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›..." style="width: 100%; height: 120px; padding: 15px; border: 1px solid #ced4da; border-radius: 5px; font-family: inherit; resize: vertical; font-size: 14px;"></textarea>
            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="copy-prompt" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px;">å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚³ãƒ”ãƒ¼</button>
                <button id="change-prompt" style="background: #ffc107; color: #212529; border: none; padding: 8px 16px; border-radius: 4px;">å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›´</button>
                <button id="chatgpt-analysis" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold;">CHATGPTåˆ†æ</button>
            </div>
        </div>
    </div>

    <!-- æœ€ä¸‹éƒ¨ã‚¨ãƒªã‚¢ -->
    <div class="bottom-section" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #dee2e6; flex-wrap: wrap; gap: 15px; margin-top: 30px;">
        <div class="usage-monitor" style="display: flex; align-items: center; gap: 20px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 12px; color: #6c757d;">DB:</span>
                <progress id="db-usage" max="100" value="0" style="width: 100px; height: 8px;"></progress>
                <span id="db-percent" style="font-size: 12px; color: #6c757d; min-width: 35px;">0%</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 12px; color: #6c757d;">Storage:</span>
                <progress id="storage-usage" max="100" value="0" style="width: 100px; height: 8px;"></progress>
                <span id="storage-percent" style="font-size: 12px; color: #6c757d; min-width: 35px;">0%</span>
            </div>
        </div>
        <div class="error-bar" id="error-bar" style="display: none; background: #dc3545; color: white; padding: 10px 15px; border-radius: 4px; font-size: 14px; max-width: 400px;">
            <span id="error-message">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>
            <button id="close-error" style="margin-left: 10px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 3px; font-size: 12px;">Ã—</button>
        </div>
        <button id="history-btn" style="opacity: 0.6; background: none; border: none; font-size: 14px; cursor: pointer; color: #6c757d;">ğŸ“‹ å±¥æ­´</button>
    </div>

    <!-- å±¥æ­´ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
    <div class="history-sidebar" id="history-sidebar" style="position: fixed; right: -400px; top: 0; width: 400px; height: 100vh; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1000; overflow-y: auto;">
        <div class="history-header" style="padding: 20px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; position: sticky; top: 0;">
            <h3 style="margin: 0; color: #495057;">å±¥æ­´</h3>
            <button id="close-history" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">Ã—</button>
        </div>
        <div style="padding: 20px;">
            <input type="text" id="history-search" placeholder="å±¥æ­´ã‚’æ¤œç´¢..." style="width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; margin-bottom: 15px; font-size: 14px;">
            <div id="search-results-count" style="font-size: 14px; color: #6c757d; margin-bottom: 15px;">æ¤œç´¢çµæœ: 0ä»¶</div>
            <div class="history-list" id="history-list" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <!-- å±¥æ­´é …ç›®ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <!-- å¿…é ˆCDNã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        'use strict';

        // Supabaseè¨­å®šï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ãƒ»å¤‰æ›´å³ç¦ï¼‰
        const SUPABASE_URL = 'https://jfrwyunauatsybdljlah.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impmcnd5dW5hdWF0c3liZGxqbGFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MTMxODksImV4cCI6MjA2OTA4OTE4OX0.cyhPTiN4WAQ2p86JBZObjSljt2i1K_bK-cGGo3soxAo';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let app = null;
        let mainData = null;
        let currentCurrency = 'USDJPY';
        let currentScenario = 'scenario1';
        let historyManager = null;

        // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆç¢ºèªæ¸ˆã¿å®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰
        const MAIN_DATA_STRUCTURE = {
            scenarios: {
                "USDJPY": ["scenario1", "scenario2", "scenario3"],
                "EURUSD": ["scenario1", "scenario2"],
                "GBPUSD": ["scenario1", "scenario2", "scenario3", "scenario4"],
                "AUDUSD": ["scenario1", "scenario2"],
                "SILVER": ["scenario1", "scenario2"],
                "GOLD": ["scenario1"]
            },
            currencies: ["USDJPY", "EURUSD", "GBPUSD", "AUDUSD", "SILVER", "GOLD"],
            scenarioLabels: {
                "scenario1": "ã‚·ãƒŠãƒªã‚ª1",
                "scenario2": "ã‚·ãƒŠãƒªã‚ª2", 
                "scenario3": "ã‚·ãƒŠãƒªã‚ª3",
                "scenario4": "ã‚·ãƒŠãƒªã‚ª4"
            },
            images: {
                "USDJPY": {
                    "scenario1": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/USDJPY.jpeg"],
                    "scenario2": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/USDJPY2.jpeg"],
                    "scenario3": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/USDJPY3.jpeg"]
                },
                "EURUSD": {
                    "scenario1": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/EURUSD.jpeg"],
                    "scenario2": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/EURUSD2.jpeg"]
                },
                "GBPUSD": {
                    "scenario1": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/GBPUSD.jpeg"],
                    "scenario2": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/GBPUSD2.jpeg"],
                    "scenario3": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/GBPUSD3.jpeg"],
                    "scenario4": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/GBPUSD4.jpeg"]
                },
                "AUDUSD": {
                    "scenario1": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/AUDUSD.jpeg"],
                    "scenario2": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/AUDUSD2.jpeg"]
                },
                "SILVER": {
                    "scenario1": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/SILVER.jpeg"],
                    "scenario2": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/SILVER2.jpeg"]
                },
                "GOLD": {
                    "scenario1": ["https://jfrwyunauatsybdljlah.supabase.co/storage/v1/object/public/fx-images/GOLD.png"]
                }
            }
        };

        // CDNèª­ã¿è¾¼ã¿ç¢ºèª
        async function waitForSupabase() {
            let retryCount = 0;
            while (!window.supabase && retryCount < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retryCount++;
            }
            
            if (!window.supabase) {
                throw new Error('Supabase CDNã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å®‰å…¨ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        async function safeSupabaseOperation(operation, operationName) {
            try {
                const result = await operation();
                if (result.error) {
                    console.error(`${operationName}ã‚¨ãƒ©ãƒ¼:`, result.error);
                    showErrorInUI(`${operationName}ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${result.error.message}`);
                    return { success: false, error: result.error };
                }
                return { success: true, data: result.data };
            } catch (err) {
                console.error(`${operationName}ä¾‹å¤–:`, err);
                showErrorInUI(`${operationName}ã§ä¾‹å¤–ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
                return { success: false, error: err };
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showErrorInUI(message) {
            const errorBar = document.getElementById('error-bar');
            const errorMessage = document.getElementById('error-message');
            if (errorBar && errorMessage) {
                errorMessage.textContent = message;
                errorBar.style.display = 'flex';
            }
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showSuccessInUI(message) {
            const errorBar = document.getElementById('error-bar');
            const errorMessage = document.getElementById('error-message');
            if (errorBar && errorMessage) {
                errorMessage.textContent = message;
                errorBar.style.background = '#28a745';
                errorBar.style.display = 'flex';
                
                setTimeout(() => {
                    errorBar.style.display = 'none';
                    errorBar.style.background = '#dc3545';
                }, 3000);
            }
        }

        // ã‚¨ãƒ©ãƒ¼éè¡¨ç¤º
        function hideError() {
            const errorBar = document.getElementById('error-bar');
            if (errorBar) {
                errorBar.style.display = 'none';
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        class DataManager {
            constructor(supabase) {
                this.supabase = supabase;
            }
            
            // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async loadMainData() {
                const result = await safeSupabaseOperation(
                    () => this.supabase.from('fx_analysis_data').select('*').eq('id', 'main').single(),
                    'ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿'
                );
                
                if (result.success && result.data) {
                    mainData = result.data.data;
                    return mainData;
                }
                
                // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                mainData = MAIN_DATA_STRUCTURE;
                return mainData;
            }
            
            // å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            async saveData(currency, scenario, type, value) {
                const key = `${currency}_${scenario}_${type}`;
                const result = await safeSupabaseOperation(
                    () => this.supabase.from('fx_analysis_data').upsert([{
                        id: key,
                        data: { value },
                        updated_at: new Date().toISOString()
                    }]),
                    'ãƒ‡ãƒ¼ã‚¿ä¿å­˜'
                );
                
                if (result.success) {
                    await this.saveToHistory('ãƒ‡ãƒ¼ã‚¿æ›´æ–°', key, value);
                }
            }
            
            // å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            async loadData(currency, scenario, type) {
                const key = `${currency}_${scenario}_${type}`;
                const result = await safeSupabaseOperation(
                    () => this.supabase.from('fx_analysis_data').select('*').eq('id', key).single(),
                    'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿'
                );
                
                if (result.success && result.data) {
                    return result.data.data?.value;
                }
                return null;
            }
            
            // å±¥æ­´ä¿å­˜
            async saveToHistory(changeType, key, value) {
                try {
                    const historyData = {
                        timestamp: new Date().toISOString(),
                        version_id: `v_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        description: `${changeType}: ${key}`,
                        data_snapshot: { key, value },
                        changes: { 
                            changeType, 
                            deviceInfo: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'Mobile' : 'PC'
                        }
                    };
                    
                    await this.supabase.from('fx_analysis_history').insert([historyData]);
                } catch (error) {
                    console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
        }

        // UIç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
        class UIManager {
            constructor(dataManager) {
                this.dataManager = dataManager;
            }
            
            // é€šè²¨ãƒšã‚¢é¸æŠ
            async selectCurrency(currency) {
                currentCurrency = currency;
                
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.currency-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.currency === currency);
                    btn.style.background = btn.dataset.currency === currency ? '#007bff' : '#6c757d';
                });
                
                // è¡¨ç¤ºæ›´æ–°
                await this.updateDisplay();
                await app.updateScenarioButtons();
            }
            
            // ã‚·ãƒŠãƒªã‚ªé¸æŠ
            async selectScenario(scenario) {
                currentScenario = scenario;
                
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.scenario-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.scenario === scenario);
                    if (btn.dataset.scenario === scenario) {
                        btn.style.boxShadow = '0 6px 12px rgba(0, 123, 255, 0.4)';
                        btn.style.transform = 'translateY(-2px)';
                    } else {
                        btn.style.boxShadow = 'none';
                        btn.style.transform = 'none';
                    }
                });
                
                // è¡¨ç¤ºæ›´æ–°
                await this.updateDisplay();
            }
            
            // åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é¸æŠ
            async selectAnalysisStatus(status) {
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.status-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.status === status);
                    if (btn.dataset.status === status) {
                        btn.style.border = '3px solid #495057';
                        btn.style.transform = 'translateY(-1px)';
                        btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                    } else {
                        btn.style.border = '2px solid transparent';
                        btn.style.transform = 'none';
                        btn.style.boxShadow = 'none';
                    }
                });
                
                // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                await this.dataManager.saveData(currentCurrency, currentScenario, 'analysisStatus', status);
                
                // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
                this.updateScenarioStatusDisplay(status);
            }
            
            // ç‹™ã†æ³¢é¸æŠ
            async selectTargetWave(wave) {
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.wave-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.wave === wave);
                    if (btn.dataset.wave === wave) {
                        btn.style.border = '3px solid #495057';
                        btn.style.transform = 'translateY(-1px)';
                        btn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                    } else {
                        btn.style.border = '2px solid transparent';
                        btn.style.transform = 'none';
                        btn.style.boxShadow = 'none';
                    }
                });
                
                // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                await this.dataManager.saveData(currentCurrency, currentScenario, 'targetWave', wave);
            }
            
            // è¡¨ç¤ºæ›´æ–°
            async updateDisplay() {
                // é€šè²¨ãƒšã‚¢åè¡¨ç¤º
                const pairElement = document.getElementById('current-pair');
                if (pairElement) {
                    pairElement.textContent = currentCurrency;
                }
                
                // ç”»åƒè¡¨ç¤º
                await this.updateImageDisplay();
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨è¡¨ç¤º
                const analysisStatus = await this.dataManager.loadData(currentCurrency, currentScenario, 'analysisStatus');
                const targetWave = await this.dataManager.loadData(currentCurrency, currentScenario, 'targetWave');
                const memo = await this.dataManager.loadData(currentCurrency, currentScenario, 'memo');
                
                // åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
                if (analysisStatus) {
                    await this.selectAnalysisStatus(analysisStatus);
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
                    document.querySelectorAll('.status-btn').forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.border = '2px solid transparent';
                        btn.style.transform = 'none';
                        btn.style.boxShadow = 'none';
                    });
                }
                
                // ç‹™ã†æ³¢è¡¨ç¤ºæ›´æ–°
                if (targetWave) {
                    await this.selectTargetWave(targetWave);
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ï¼ˆæœªé¸æŠï¼‰
                    await this.selectTargetWave('æœªé¸æŠ');
                }
                
                // ãƒ¡ãƒ¢è¡¨ç¤ºæ›´æ–°
                const memoElement = document.getElementById('analysis-memo');
                if (memoElement) {
                    memoElement.value = memo || '';
                }
                
                // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
                this.updateScenarioStatusDisplay(analysisStatus);
            }
            
            // ç”»åƒè¡¨ç¤ºæ›´æ–°
            async updateImageDisplay() {
                const container = document.getElementById('image-container');
                if (!container || !mainData || !mainData.images) return;
                
                const images = mainData.images[currentCurrency]?.[currentScenario];
                
                if (!images || images.length === 0) {
                    container.innerHTML = '<p class="image-error">ç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                for (const imageUrl of images) {
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.borderRadius = '4px';
                    img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                    img.style.marginBottom = '10px';
                    
                    img.onerror = () => {
                        img.style.display = 'none';
                        const errorMsg = document.createElement('p');
                        errorMsg.className = 'image-error';
                        errorMsg.textContent = 'ç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“';
                        container.appendChild(errorMsg);
                    };
                    
                    container.appendChild(img);
                }
                
                // é«˜ç”»è³ªè¡¨ç¤ºãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
                const highQualityBtn = document.getElementById('high-quality-btn');
                if (highQualityBtn) {
                    highQualityBtn.style.display = images.length > 0 ? 'block' : 'none';
                }
            }
            
            // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
            updateScenarioStatusDisplay(status) {
                const scenarioBtn = document.querySelector(`[data-scenario="${currentScenario}"]`);
                if (!scenarioBtn) return;
                
                const statusIndicator = scenarioBtn.querySelector('.status-indicator');
                if (!statusIndicator) return;
                
                const statusConfig = {
                    'æ¤œè¨ä¸­': { emoji: 'ğŸ”', color: '#007bff' },
                    'è¦‹é€ã‚Š': { emoji: 'ğŸ™…â€â™‚ï¸', color: '#6c757d' },
                    'è¦‹é€ƒã—': { emoji: 'ğŸ˜…', color: '#6c757d' },
                    'æŒ‡å€¤é€†æŒ‡å€¤ä¸­': { emoji: 'ğŸ¯', color: '#dc3545' },
                    'ä¿æŒä¸­': { emoji: 'ğŸ’¼', color: '#dc3545' },
                    'å®Œäº†': { emoji: 'âœ…', color: '#6c757d' }
                };
                
                if (status && statusConfig[status]) {
                    const config = statusConfig[status];
                    statusIndicator.innerHTML = `${config.emoji} ${status}`;
                    statusIndicator.style.color = config.color;
                } else {
                    statusIndicator.innerHTML = 'ğŸ” æ¤œè¨ä¸­';
                    statusIndicator.style.color = '#007bff';
                }
            }
        }

        // ChatGPTé€£æºæ©Ÿèƒ½
        class ChatGPTIntegration {
            constructor(dataManager) {
                this.dataManager = dataManager;
            }
            
            // ChatGPTåˆ†æå®Ÿè¡Œ
            async executeChatGPTAnalysis() {
                try {
                    // åˆ†æãƒ¡ãƒ¢ã¨å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—
                    const memo = document.getElementById('analysis-memo').value || '';
                    const fixedPrompt = document.getElementById('fixed-prompt').value || '';
                    
                    // å†…å®¹ã‚’çµåˆ
                    const combinedContent = fixedPrompt + (fixedPrompt && memo ? '\n\n' : '') + memo;
                    
                    if (!combinedContent.trim()) {
                        showErrorInUI('åˆ†æãƒ¡ãƒ¢ã¾ãŸã¯å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                        return;
                    }
                    
                    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                    await navigator.clipboard.writeText(combinedContent);
                    
                    // ChatGPTãƒšãƒ¼ã‚¸ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                    window.open('https://chat.openai.com', '_blank');
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                    showSuccessInUI('å†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ChatGPTãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã—ãŸã€‚');
                    
                } catch (err) {
                    console.error('ChatGPTé€£æºã‚¨ãƒ©ãƒ¼:', err);
                    showErrorInUI('ChatGPTé€£æºã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            }
            
            // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
            async copyToClipboard(text, successMessage) {
                try {
                    await navigator.clipboard.writeText(text);
                    showSuccessInUI(successMessage);
                } catch (err) {
                    console.error('ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
                    showErrorInUI('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        }

        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
        class ThemeManager {
            constructor(dataManager) {
                this.dataManager = dataManager;
                this.isDark = false;
            }
            
            async init() {
                // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿
                const savedTheme = await this.dataManager.loadData('global', 'settings', 'darkMode');
                if (savedTheme !== null) {
                    this.isDark = savedTheme;
                }
                
                this.applyTheme();
                this.updateToggleButton();
            }
            
            async toggleTheme() {
                this.isDark = !this.isDark;
                this.applyTheme();
                this.updateToggleButton();
                
                // è¨­å®šä¿å­˜
                await this.dataManager.saveData('global', 'settings', 'darkMode', this.isDark);
            }
            
            applyTheme() {
                document.body.classList.toggle('dark-mode', this.isDark);
            }
            
            updateToggleButton() {
                const toggleBtn = document.getElementById('theme-toggle');
                if (toggleBtn) {
                    toggleBtn.textContent = this.isDark ? 'â˜€ï¸' : 'ğŸŒ™';
                }
            }
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
        class BackupManager {
            constructor(supabase) {
                this.supabase = supabase;
            }
            
            async createBackup() {
                try {
                    // å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—
                    const { data: mainData } = await this.supabase.from('fx_analysis_data').select('*');
                    const { data: historyData } = await this.supabase.from('fx_analysis_history').select('*');
                    
                    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        version: '1.0',
                        mainData: mainData || [],
                        historyData: historyData || [],
                        metadata: {
                            totalRecords: (mainData?.length || 0) + (historyData?.length || 0),
                            exportedBy: 'FX Analysis System'
                        }
                    };
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const blob = new Blob([JSON.stringify(backupData, null, 2)], { 
                        type: 'application/json' 
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `fx-backup-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showSuccessInUI(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆ${backupData.metadata.totalRecords}ä»¶ï¼‰`);
                    
                } catch (err) {
                    console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', err);
                    showErrorInUI('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        }

        // å±¥æ­´ç®¡ç†
        class HistoryManager {
            constructor(supabase) {
                this.supabase = supabase;
            }
            
            async searchHistory(query) {
                try {
                    let queryBuilder = this.supabase
                        .from('fx_analysis_history')
                        .select('*')
                        .order('timestamp', { ascending: false });
                    
                    if (query && query.trim()) {
                        queryBuilder = queryBuilder.or(
                            `description.ilike.%${query}%,data_snapshot->>key.ilike.%${query}%`
                        );
                    }
                    
                    const { data, error } = await queryBuilder.limit(100);
                    
                    if (error) throw error;
                    
                    this.displaySearchResults(data, query);
                    return data;
                } catch (err) {
                    console.error('å±¥æ­´æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', err);
                    showErrorInUI('å±¥æ­´æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return [];
                }
            }
            
            displaySearchResults(data, query) {
                const resultsList = document.getElementById('history-list');
                const resultsCount = document.getElementById('search-results-count');
                
                if (!resultsList || !resultsCount) return;
                
                resultsCount.textContent = `æ¤œç´¢çµæœ: ${data.length}ä»¶`;
                resultsList.innerHTML = '';
                
                data.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 5px; color: #495057;">
                            ${new Date(item.timestamp).toLocaleString('ja-JP')}
                        </div>
                        <div style="font-size: 14px; color: #6c757d; margin-bottom: 8px;">
                            ${item.description}
                        </div>
                        <div style="font-size: 12px; color: #adb5bd;">
                            ${item.changes?.deviceInfo || 'Unknown Device'}
                        </div>
                        <button onclick="historyManager.restoreFromHistory('${item.version_id}')" 
                                style="margin-top: 8px; font-size: 12px; padding: 4px 8px; background: #17a2b8; color: white; border: none; border-radius: 3px;">
                            ã“ã®æ™‚ç‚¹ã«æˆ»ã‚‹
                        </button>
                    `;
                    
                    resultsList.appendChild(historyItem);
                });
            }
            
            async restoreFromHistory(versionId) {
                if (!confirm('ã“ã®æ™‚ç‚¹ã®ãƒ‡ãƒ¼ã‚¿ã«å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) return;
                
                try {
                    const { data, error } = await this.supabase
                        .from('fx_analysis_history')
                        .select('*')
                        .eq('version_id', versionId)
                        .single();
                    
                    if (error) throw error;
                    
                    // å¾©å…ƒå‡¦ç†ï¼ˆç°¡ç•¥åŒ–ï¼‰
                    showSuccessInUI('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
                    this.closeHistoryPanel();
                    
                } catch (err) {
                    console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', err);
                    showErrorInUI('ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
            
            openHistoryPanel() {
                const sidebar = document.getElementById('history-sidebar');
                if (sidebar) {
                    sidebar.style.right = '0';
                    this.searchHistory(''); // å…¨å±¥æ­´è¡¨ç¤º
                }
            }
            
            closeHistoryPanel() {
                const sidebar = document.getElementById('history-sidebar');
                if (sidebar) {
                    sidebar.style.right = '-400px';
                }
            }
        }

        // ä½¿ç”¨é‡ç›£è¦–
        class UsageMonitor {
            constructor(supabase) {
                this.supabase = supabase;
                this.init();
            }
            
            init() {
                this.updateUsage();
                setInterval(() => this.updateUsage(), 30000); // 30ç§’é–“éš”
            }
            
            async updateUsage() {
                try {
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½¿ç”¨é‡
                    const { data: dbData } = await this.supabase.from('fx_analysis_data').select('*');
                    const dbUsage = this.calculateDataSize(dbData);
                    
                    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ï¼ˆæ¦‚ç®—ï¼‰
                    const storageUsage = this.calculateStorageUsage();
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
                    this.updateProgressBar('db-usage', 'db-percent', dbUsage, 500); // 500MBåˆ¶é™
                    this.updateProgressBar('storage-usage', 'storage-percent', storageUsage, 1024); // 1GBåˆ¶é™
                    
                } catch (err) {
                    console.error('ä½¿ç”¨é‡ç›£è¦–ã‚¨ãƒ©ãƒ¼:', err);
                }
            }
            
            calculateDataSize(data) {
                if (!data) return 0;
                return (new Blob([JSON.stringify(data)]).size) / 1024 / 1024; // MB
            }
            
            calculateStorageUsage() {
                // æ¦‚ç®—è¨ˆç®—ï¼ˆå®Ÿéš›ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯å–å¾—å›°é›£ï¼‰
                if (!mainData || !mainData.images) return 0;
                
                let totalImages = 0;
                Object.values(mainData.images).forEach(currencyImages => {
                    Object.values(currencyImages).forEach(scenarioImages => {
                        totalImages += scenarioImages.length;
                    });
                });
                
                return totalImages * 0.5; // 1ç”»åƒã‚ãŸã‚Šå¹³å‡0.5MBã¨ä»®å®š
            }
            
            updateProgressBar(progressId, percentId, usage, limit) {
                const progressBar = document.getElementById(progressId);
                const percentSpan = document.getElementById(percentId);
                
                if (progressBar && percentSpan) {
                    const percentage = Math.min((usage / limit) * 100, 100);
                    progressBar.value = percentage;
                    percentSpan.textContent = `${percentage.toFixed(1)}%`;
                    
                    // è‰²å¤‰æ›´
                    if (percentage > 90) {
                        progressBar.style.accentColor = '#dc3545';
                    } else if (percentage > 70) {
                        progressBar.style.accentColor = '#ffc107';
                    } else {
                        progressBar.style.accentColor = '#007bff';
                    }
                }
            }
        }

        // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
        class FXAnalysisApp {
            constructor() {
                this.supabase = null;
                this.dataManager = null;
                this.uiManager = null;
                this.chatgptIntegration = null;
                this.themeManager = null;
                this.backupManager = null;
                this.historyManager = null;
                this.usageMonitor = null;
            }
            
            async initialize() {
                try {
                    // CDNèª­ã¿è¾¼ã¿ç¢ºèª
                    await waitForSupabase();
                    
                    // SupabaseåˆæœŸåŒ–
                    this.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    // æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    const { error } = await this.supabase.from('fx_analysis_data').select('count', { count: 'exact', head: true });
                    if (error) throw error;
                    
                    // ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
                    this.dataManager = new DataManager(this.supabase);
                    this.uiManager = new UIManager(this.dataManager);
                    this.chatgptIntegration = new ChatGPTIntegration(this.dataManager);
                    this.themeManager = new ThemeManager(this.dataManager);
                    this.backupManager = new BackupManager(this.supabase);
                    this.historyManager = new HistoryManager(this.supabase);
                    this.usageMonitor = new UsageMonitor(this.supabase);
                    
                    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
                    await this.dataManager.loadMainData();
                    
                    // UIåˆæœŸåŒ–
                    await this.initializeUI();
                    
                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                    this.setupEventListeners();
                    
                    // ãƒ†ãƒ¼ãƒåˆæœŸåŒ–
                    await this.themeManager.init();
                    
                    console.log('FX Analysis System åˆæœŸåŒ–å®Œäº†');
                    
                } catch (error) {
                    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    this.showFallbackUI(error);
                }
            }
            
            async initializeUI() {
                // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã®å‹•çš„ç”Ÿæˆ
                await this.updateScenarioButtons();
                
                // åˆæœŸè¡¨ç¤ºæ›´æ–°
                await this.uiManager.updateDisplay();
                
                // å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª­ã¿è¾¼ã¿
                const savedPrompt = await this.dataManager.loadData('global', 'settings', 'fixedPrompt');
                if (savedPrompt) {
                    const promptElement = document.getElementById('fixed-prompt');
                    if (promptElement) {
                        promptElement.value = savedPrompt;
                    }
                }
            }
            
            async updateScenarioButtons() {
                if (!mainData || !mainData.scenarios) return;
                
                const container = document.getElementById('scenario-container');
                if (!container) return;
                
                // æ—¢å­˜ã®ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ï¼ˆè¿½åŠ ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã¯ä¿æŒï¼‰
                const scenarioBtns = container.querySelectorAll('.scenario-btn');
                scenarioBtns.forEach(btn => btn.remove());
                
                // ç¾åœ¨ã®é€šè²¨ãƒšã‚¢ã®ã‚·ãƒŠãƒªã‚ªã‚’å–å¾—
                const scenarios = mainData.scenarios[currentCurrency] || [];
                
                // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
                const addBtn = document.getElementById('add-scenario');
                scenarios.forEach((scenario, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'scenario-btn';
                    btn.dataset.scenario = scenario;
                    btn.draggable = true;
                    btn.style.cssText = 'background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; min-width: 120px; display: flex; align-items: center; justify-content: space-between; margin-right: 10px; margin-bottom: 10px;';
                    
                    const scenarioLabel = mainData.scenarioLabels?.[scenario] || scenario;
                    btn.innerHTML = `
                        <span>${scenarioLabel}</span>
                        <small class="status-indicator" style="font-size: 11px; opacity: 0.9; margin-left: 8px;">ğŸ” æ¤œè¨ä¸­</small>
                    `;
                    
                    // æœ€åˆã®ã‚·ãƒŠãƒªã‚ªã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                    if (index === 0) {
                        btn.classList.add('active');
                        btn.style.boxShadow = '0 6px 12px rgba(0, 123, 255, 0.4)';
                        btn.style.transform = 'translateY(-2px)';
                        currentScenario = scenario;
                    }
                    
                    container.insertBefore(btn, addBtn);
                });
            }
            
            setupEventListeners() {
                // é€šè²¨ãƒšã‚¢ãƒœã‚¿ãƒ³
                document.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('currency-btn')) {
                        await this.uiManager.selectCurrency(e.target.dataset.currency);
                        await this.updateScenarioButtons();
                    }
                });
                
                // ã‚·ãƒŠãƒªã‚ªãƒœã‚¿ãƒ³
                document.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('scenario-btn') || e.target.closest('.scenario-btn')) {
                        const btn = e.target.classList.contains('scenario-btn') ? e.target : e.target.closest('.scenario-btn');
                        await this.uiManager.selectScenario(btn.dataset.scenario);
                    }
                });
                
                // åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœã‚¿ãƒ³
                document.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('status-btn') || e.target.closest('.status-btn')) {
                        const btn = e.target.classList.contains('status-btn') ? e.target : e.target.closest('.status-btn');
                        await this.uiManager.selectAnalysisStatus(btn.dataset.status);
                    }
                });
                
                // ç‹™ã†æ³¢ãƒœã‚¿ãƒ³
                document.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('wave-btn') || e.target.closest('.wave-btn')) {
                        const btn = e.target.classList.contains('wave-btn') ? e.target : e.target.closest('.wave-btn');
                        await this.uiManager.selectTargetWave(btn.dataset.wave);
                    }
                });
                
                // åˆ†æãƒ¡ãƒ¢è‡ªå‹•ä¿å­˜
                const memoElement = document.getElementById('analysis-memo');
                if (memoElement) {
                    memoElement.addEventListener('input', this.debounce(async (e) => {
                        await this.dataManager.saveData(currentCurrency, currentScenario, 'memo', e.target.value);
                    }, 1000));
                }
                
                // å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè‡ªå‹•ä¿å­˜
                const promptElement = document.getElementById('fixed-prompt');
                if (promptElement) {
                    promptElement.addEventListener('input', this.debounce(async (e) => {
                        await this.dataManager.saveData('global', 'settings', 'fixedPrompt', e.target.value);
                    }, 1000));
                }
                
                // ChatGPTåˆ†æãƒœã‚¿ãƒ³
                const chatgptBtn = document.getElementById('chatgpt-analysis');
                if (chatgptBtn) {
                    chatgptBtn.addEventListener('click', () => {
                        this.chatgptIntegration.executeChatGPTAnalysis();
                    });
                }
                
                // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
                const copyMemoBtn = document.getElementById('copy-memo');
                if (copyMemoBtn) {
                    copyMemoBtn.addEventListener('click', () => {
                        const memo = document.getElementById('analysis-memo').value;
                        this.chatgptIntegration.copyToClipboard(memo, 'åˆ†æãƒ¡ãƒ¢ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    });
                }
                
                const copyPromptBtn = document.getElementById('copy-prompt');
                if (copyPromptBtn) {
                    copyPromptBtn.addEventListener('click', () => {
                        const prompt = document.getElementById('fixed-prompt').value;
                        this.chatgptIntegration.copyToClipboard(prompt, 'å›ºå®šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    });
                }
                
                // ãã®ä»–ã®ãƒœã‚¿ãƒ³
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => {
                        this.themeManager.toggleTheme();
                    });
                }
                
                const backupBtn = document.getElementById('backup-btn');
                if (backupBtn) {
                    backupBtn.addEventListener('click', () => {
                        this.backupManager.createBackup();
                    });
                }
                
                const historyBtn = document.getElementById('history-btn');
                if (historyBtn) {
                    historyBtn.addEventListener('click', () => {
                        this.historyManager.openHistoryPanel();
                    });
                }
                
                const closeHistoryBtn = document.getElementById('close-history');
                if (closeHistoryBtn) {
                    closeHistoryBtn.addEventListener('click', () => {
                        this.historyManager.closeHistoryPanel();
                    });
                }
                
                const historySearch = document.getElementById('history-search');
                if (historySearch) {
                    historySearch.addEventListener('input', this.debounce((e) => {
                        this.historyManager.searchHistory(e.target.value);
                    }, 500));
                }
                
                const closeErrorBtn = document.getElementById('close-error');
                if (closeErrorBtn) {
                    closeErrorBtn.addEventListener('click', hideError);
                }
                
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key.toLowerCase()) {
                            case 's':
                                e.preventDefault();
                                this.manualSave();
                                break;
                            case 'c':
                                e.preventDefault();
                                this.copyActiveElement();
                                break;
                        }
                    }
                });

                // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
                const topReturnBtn = document.getElementById('top-return');
                if (topReturnBtn) {
                    topReturnBtn.addEventListener('click', () => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                }
            }
            
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            async manualSave() {
                try {
                    const memo = document.getElementById('analysis-memo').value;
                    const prompt = document.getElementById('fixed-prompt').value;
                    
                    await this.dataManager.saveData(currentCurrency, currentScenario, 'memo', memo);
                    await this.dataManager.saveData('global', 'settings', 'fixedPrompt', prompt);
                    
                    showSuccessInUI('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                } catch (err) {
                    showErrorInUI('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
            
            async copyActiveElement() {
                const activeElement = document.activeElement;
                if (activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'INPUT') {
                    try {
                        await navigator.clipboard.writeText(activeElement.value);
                        showSuccessInUI('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    } catch (err) {
                        showErrorInUI('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            }
            
            showFallbackUI(error) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                        <h2 style="color: #dc3545;">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h2>
                        <p style="margin: 20px 0; color: #6c757d;">${error.message}</p>
                        <button onclick="location.reload()" style="padding: 15px 30px; background: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;">å†èª­ã¿è¾¼ã¿</button>
                    </div>
                `;
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        window.addEventListener('DOMContentLoaded', async function() {
            app = new FXAnalysisApp();
            await app.initialize();
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§è¨­å®š
            if (app && app.historyManager) {
                historyManager = app.historyManager;
            }
        });
    </script>
</body>
</html>
